<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/logos/golf.png" />
  <title>Super League</title>

  <style>
    :root{
      --bg1:#061C3B; --bg2:#04142E; --bg3:#020B18;

      --card-bg: rgba(15,23,42,1);
      --card-shadow: 0 32px 32px rgba(0,0,0,0.65);
      --header-bg: rgba(148,163,184,0.12);
      --row-bg: rgba(255,255,255,0.06);

      --text: #e9eef8;
      --title: #c7d7ff;
      --muted: #9ca3c7;

      --border-lite: rgba(148,163,184,0.20);
      --btn-bg: rgba(255,255,255,0.06);
      --btn-bg-hover: rgba(255,255,255,0.10);
      --btn-border: rgba(255,255,255,0.15);
      --btn-border-hover: rgba(255,255,255,0.28);

      --division-1-bg: rgba(234,179,8,0.32);
      --division-2-bg: rgba(203,213,225,0.32);
      --division-3-bg: rgba(180,83,9,0.32);

      --row-highlight-gold: rgba(234,179,8,0.32);
      --row-highlight-green: rgba(34,197,94,0.32);
      --row-highlight-blue: rgba(56,189,248,0.32);
      --row-highlight-orange: rgba(251,146,60,0.32);
      --row-highlight-red: rgba(239,68,68,0.32);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(to bottom, var(--bg1), var(--bg2), var(--bg3));
    }

    .topbar{
      position: sticky; top:0; z-index:10;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(3,18,42,.70);
      backdrop-filter: blur(10px);
    }
    .topbar-inner{
      max-width:1100px;
      margin:0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .topbar-actions{
      display:flex;
      gap:8px;
      align-items:center;
    }

    .view-btn{
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: rgba(255,255,255,.92);
      border-radius: 999px;
      padding: 9px 14px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
      font-weight: 850;
      cursor: pointer;
    }
    .view-btn:hover{
      background: var(--btn-bg-hover);
      border-color: var(--btn-border-hover);
    }
    .view-btn.is-active{
      background: rgba(255,255,255,0.18);
      border-color: rgba(255,255,255,0.45);
      color: #fff;
    }
    .home-badge{
      width:40px; height:40px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.05);
      display:grid; place-items:center;
      overflow:hidden;
      user-select:none;
    }
    .home-badge img{
      width:70%;
      height:70%;
      object-fit: contain;
      display:block;
      pointer-events:none;
    }

    .kicker{
      font-size:11px;
      letter-spacing:.25em;
      text-transform:uppercase;
      color: rgba(255,255,255,.65);
      font-weight:900;
    }
    .page-nav-select{
      background: rgba(2,6,23,.85);
      color: inherit;
      border: 1px solid rgba(125,211,252,.35);
      border-radius: 10px;
      padding: 6px 32px 6px 10px;
      font: inherit;
      letter-spacing: inherit;
      text-transform: uppercase;
      max-width: min(56vw, 420px);
      cursor: pointer;
    }
    .page-nav-select:focus-visible{
      outline: 2px solid rgba(125,211,252,.6);
      outline-offset: 2px;
    }


    .container{
      max-width:1100px;
      margin:0 auto;
      padding: 28px 18px 56px;
      display:grid;
      gap: 12px;
      justify-items:center;
    }

    .main-view-switch{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .card{
      width: min(920px, 100%);
      background: var(--card-bg);
      border-radius: 20px;
      padding: 12px 20px 20px;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255,255,255,0.10);
      display:grid;
      gap:16px;
    }

    .headline{
      font-size: 22px;
      font-weight: 950;
      color: var(--title);
      letter-spacing: .035em;
      text-transform: uppercase;
      margin: 0;
      text-align: center;
    }

    .season-head{
      min-height: 44px;
      padding: 2px 0;
      margin-bottom: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .subhead{
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.45;
    }

    .status{
      color: var(--muted);
      font-size: 13px;
      margin: 0;
    }

    .division-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
      align-items:start;
    }

    .division-card{
      border: 1px solid var(--border-lite);
      border-radius: 16px;
      padding: 10px 12px 12px;
      background: rgba(15,23,42,0.55);
      overflow-x: auto;
    }

    .division-title{
      margin: 0 0 4px;
      min-height: 20px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: rgba(231,238,255,0.92);
    }
    .division-title.division-1,
    .schedule-division-title.division-1{ color: #fcd34d; }
    .division-title.division-2,
    .schedule-division-title.division-2{ color: #e5e7eb; }
    .division-title.division-3,
    .schedule-division-title.division-3{ color: #fdba74; }

    table.rankings{
      width:100%;
      border-collapse: separate;
      border-spacing: 0 6px;
      min-width: 0;
      table-layout: fixed;
      font-size: 12px;
    }

    .rankings thead th{
      text-align:center;
      color: var(--muted);
      font-weight: 800;
      letter-spacing: .03em;
      font-size: 8px;
      text-transform: uppercase;
      padding: 8px 6px;
      background: var(--header-bg);
    }

    .rankings thead th:first-child{
      border-radius: 10px 0 0 10px;
    }

    .rankings thead th:last-child{
      border-radius: 0 10px 10px 0;
    }

    .rankings tbody td{
      padding: 8px 6px;
      border-bottom: 0;
      background: var(--row-bg);
      color: var(--text);
      white-space: nowrap;
      font-size: 12px;
    }

    .rankings tbody tr.row-highlight-gold td{ background: var(--row-highlight-gold); }
    .rankings tbody tr.row-highlight-green td{ background: var(--row-highlight-green); }
    .rankings tbody tr.row-highlight-silver td{ background: rgba(203,213,225,0.32); }
    .rankings tbody tr.row-highlight-bronze td{ background: rgba(180,83,9,0.32); }
    .rankings tbody tr.row-highlight-blue td{ background: var(--row-highlight-blue); }
    .rankings tbody tr.row-highlight-orange td{ background: var(--row-highlight-orange); }
    .rankings tbody tr.row-highlight-red td{ background: var(--row-highlight-red); }

    .rankings tbody td:first-child{
      border-radius: 10px 0 0 10px;
    }

    .rankings tbody td:last-child{
      border-radius: 0 10px 10px 0;
    }

    .col-rank,
    .col-matches,
    .col-games,
    .col-diff{
      width: 42px;
      text-align: center;
    }

    .col-player{
      width: calc(100% - 132px);
      min-width: 0;
      text-align: center;
    }

    .rankings tbody .col-player{
      text-transform: uppercase;
      font-weight: 800;
      white-space: normal;
      overflow-wrap: anywhere;
    }

    .player-btn{
      border: 0;
      background: transparent;
      color: inherit;
      padding: 0;
      margin: 0;
      font: inherit;
      text-transform: inherit;
      letter-spacing: inherit;
      font-weight: inherit;
      cursor: pointer;
      text-align: inherit;
    }

    .rankings .player-btn{
      text-align: center;
      width: 100%;
      display: block;
    }

    .player-btn:hover,
    .player-btn:focus-visible{
      text-decoration: none;
      outline: none;
    }

    .rankings tbody .col-player.qf-player{
      color: #9ca3af;
    }

    .error{
      margin: 0;
      color: #fecaca;
      font-size: 13px;
      background: rgba(127,29,29,0.22);
      border: 1px solid rgba(248,113,113,0.45);
      border-radius: 10px;
      padding: 10px 12px;
      display:none;
    }

    .error.show{ display:block; }

    .schedule-wrap{
      margin-top: 8px;
      display:grid;
      gap:12px;
    }

    .standings-legend{
      margin-top: 8px;
      border: 1px solid var(--border-lite);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(15,23,42,0.55);
      display:flex;
      gap:10px 14px;
      align-items:center;
      justify-content:center;
      flex-wrap: wrap;
    }

    .legend-item{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size: 11px;
      font-weight: 800;
      color: rgba(233,238,248,0.92);
      text-transform: uppercase;
      letter-spacing: .03em;
      white-space: nowrap;
    }

    .legend-swatches{
      display:inline-flex;
      align-items:center;
      gap:4px;
      flex-shrink: 0;
    }

    .legend-swatch{
      width: 10px;
      height: 10px;
      border-radius: 2px;
      border: 1px solid rgba(255,255,255,0.25);
      flex: 0 0 10px;
    }

    .legend-swatch.gold{ background: var(--row-highlight-gold); }
    .legend-swatch.green{ background: var(--row-highlight-green); }
    .legend-swatch.blue{ background: var(--row-highlight-blue); }
    .legend-swatch.orange{ background: var(--row-highlight-orange); }
    .legend-swatch.none{ background: var(--row-bg); }
    .legend-swatch.red{ background: var(--row-highlight-red); }

    .schedule-head{
      position: relative;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: 44px;
      padding: 2px 0;
    }

    .schedule-title{
      margin:0;
      font-size: 22px;
      font-weight: 950;
      color: var(--title);
      letter-spacing: .035em;
      text-transform: uppercase;
      text-align:center;
      width:100%;
      padding: 0 54px;
      line-height: 1.1;
    }

    .nav-btn{
      position:absolute;
      top:50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      font-weight: 950;
      display:grid;
      place-items:center;
      user-select:none;
    }
    .nav-btn:hover{
      background: var(--btn-bg-hover);
      border-color: var(--btn-border-hover);
    }
    .nav-btn:disabled{ opacity:.35; cursor:not-allowed; }
    .nav-left{ left:0; }
    .nav-right{ right:0; }

    .schedule-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
      align-items:start;
    }

    .schedule-division{
      border: 1px solid var(--border-lite);
      border-radius: 16px;
      padding: 12px;
      background: rgba(15,23,42,0.55);
      min-height: 90px;
      display:grid;
      gap: 10px;
      align-content:start;
    }

    .schedule-division-title{
      text-align:center;
      margin:0;
      font-size: 12px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: rgba(231,238,255,0.92);
    }

    .schedule-empty{
      margin:0;
      color: var(--muted);
      font-size: 12px;
    }

    .match-grid{
      display:grid;
      gap:10px;
    }

    .match-labeled{
      display:grid;
      gap:4px;
    }

    .match-label{
      margin:0;
      font-size: 9px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .1em;
      color: var(--muted);
      text-align: center;
    }

    .match-card{
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      overflow:hidden;
    }

    .match-row{
      display:flex;
      align-items:stretch;
      min-height: 36px;
      background: rgba(255,255,255,0.06);
      border: 1px solid transparent;
    }
    .match-row + .match-row{
      border-top: 1px solid rgba(148,163,184,0.28);
    }
    .match-row:nth-child(2){ background: rgba(255,255,255,0.045); }
    .match-row.winner{
      background: rgba(34,197,94,0.12);
      border-color: rgba(34,197,94,0.55);
    }
    .match-row.highlight-gold{
      background: rgba(234,179,8,0.16);
      border-color: rgba(234,179,8,0.72);
    }
    .match-row.highlight-silver{
      background: rgba(203,213,225,0.16);
      border-color: rgba(203,213,225,0.72);
    }
    .match-row.highlight-bronze{
      background: rgba(180,83,9,0.18);
      border-color: rgba(180,83,9,0.74);
    }
    .match-row:is(.winner, .highlight-gold, .highlight-silver, .highlight-bronze):first-child{
      border-top-left-radius: 13px;
      border-top-right-radius: 13px;
    }
    .match-row:is(.winner, .highlight-gold, .highlight-silver, .highlight-bronze):last-child{
      border-bottom-left-radius: 13px;
      border-bottom-right-radius: 13px;
    }

    .match-player{
      flex: 1 1 auto;
      min-width: 0;
      padding: 8px 10px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .02em;
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      word-break: break-word;
      display:flex;
      align-items:center;
      font-size: 11px;
    }

    .match-seed{
      width: 28px;
      flex: 0 0 28px;
      display:grid;
      place-items:center;
      font-size: 11px;
      font-weight: 850;
      color: var(--muted);
      font-variant-numeric: tabular-nums;
    }

    .match-player.qf-player{
      color: #9ca3af;
    }

    .match-player .player-btn{
      white-space: normal;
      overflow-wrap: anywhere;
    }

    .player-modal{
      position: fixed;
      inset: 0;
      border: 0;
      width: 100%;
      height: 100%;
      max-width: none;
      max-height: none;
      margin: 0;
      padding: 0;
      background: rgba(2, 8, 24, 0.72);
      backdrop-filter: blur(4px);
    }

    .player-modal::backdrop{
      background: rgba(2, 8, 24, 0.72);
    }

    .player-modal-content{
      width: min(820px, calc(100% - 24px));
      border: 1px solid var(--border-lite);
      border-radius: 16px;
      background: rgba(15,23,42,0.98);
      color: #fff;
      padding: 18px;
      display: grid;
      gap: 12px;
    }

    .player-modal-shell{
      width: min(820px, calc(100% - 24px));
      margin: 28px auto;
      display:grid;
      gap: 10px;
    }

    .player-modal-close{
      justify-self: end;
      width: 32px;
      height: 32px;
      border-radius: 10px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: rgba(255,255,255,.92);
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
    }

    .player-modal-meta{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }

    .player-modal-meta-cell{
      background: var(--row-bg);
      border-radius: 10px;
      padding: 8px 6px;
      text-align:center;
    }

    .player-modal-meta-label{
      margin: 0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .03em;
      color: var(--muted);
      font-weight: 800;
    }

    .player-modal-meta-value{
      margin: 4px 0 0;
      font-size: 18px;
      font-weight: 900;
      color: #fff;
      font-variant-numeric: tabular-nums;
    }

    .player-modal-name{
      margin: 0;
      text-align: center;
      font-size: 18px;
      font-weight: 950;
      text-transform: uppercase;
      letter-spacing: .03em;
    }

    .player-modal-head{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
    }

    .player-modal-division{
      margin: 0;
      text-align: center;
      font-size: 18px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .08em;
    }

    .player-modal-divider{
      color: var(--muted);
      font-size: 18px;
      font-weight: 800;
      line-height: 1;
    }

    .player-modal-division.division-1{ color: #fcd34d; }
    .player-modal-division.division-2{ color: #e5e7eb; }
    .player-modal-division.division-3{ color: #fdba74; }

    table.player-weekly{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
      table-layout: fixed;
      font-size: 18px;
    }

    .player-weekly th,
    .player-weekly td{
      padding: 8px 6px;
      color: #fff;
      background: var(--row-bg);
      border: 0;
      vertical-align: middle;
      text-align: center;
      font-variant-numeric: tabular-nums;
    }

    .player-weekly th{
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: 15px;
      font-weight: 800;
      background: var(--header-bg);
      color: var(--muted);
    }

    .player-weekly thead th:first-child{
      border-radius: 10px 0 0 10px;
    }

    .player-weekly thead th:last-child{
      border-radius: 0 10px 10px 0;
    }

    .player-weekly tbody td:first-child{
      border-radius: 10px 0 0 10px;
    }

    .player-weekly tbody td:last-child{
      border-radius: 0 10px 10px 0;
    }

    .player-weekly tbody tr.weekly-section-row td{
      border-radius: 10px;
      background: rgba(148,163,184,0.18);
      color: rgba(231,238,255,0.95);
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      text-align: left;
      padding: 9px 10px;
    }

    .weekly-col-week{ width: 80px; }
    .weekly-col-opponent{ width: 160px; text-align: left; }
    .weekly-col-result{ width: 90px; }
    .weekly-col-games{ width: 90px; }
    .weekly-col-round{ width: 90px; }

    .weekly-round-group{ text-align: center; }

    .round-pair{
      display:inline-flex;
      align-items:center;
      gap:4px;
      justify-content:center;
    }

    .round-sep{
      color: rgba(233,238,248,0.72);
      font-weight: inherit;
    }

    .player-weekly .opponent-name{
      text-transform: uppercase;
      font-weight: 900;
      white-space: normal;
      overflow-wrap: anywhere;
    }

    .player-weekly .opponent-name.qf-player{
      color: #9ca3af;
    }

    .score-win{ color: #86efac; }
    .score-loss{ color: #fca5a5; }

    .score-dash{
      color: #fff;
      font-weight: 900;
    }

    .result-win{ color: #86efac; font-weight: 900; }
    .result-loss{ color: #fca5a5; font-weight: 900; }
    .result-pending{ color: #fff; font-weight: 900; }

    .qualifiers-wrap{
      margin-top: 4px;
      display:grid;
      gap:10px;
    }

    .page-switch{
      min-height: 44px;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom: 8px;
    }

    .qualifiers-layout{
      display:grid;
      grid-template-columns: minmax(180px, 240px) minmax(0, 1fr);
      gap: 12px;
      align-items: stretch;
    }

    .qualifier-seeds,
    .qualifier-bracket{
      border: 1px solid var(--border-lite);
      border-radius: 16px;
      padding: 12px;
      background: rgba(15,23,42,0.55);
      display:grid;
      gap:10px;
      align-content:start;
    }

    .qualifier-bracket{
      overflow-x: auto;
      overflow-y: hidden;
    }

    .qualifier-title{
      margin:0;
      font-size: 12px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .12em;
      text-align: center;
      color: rgba(231,238,255,0.92);
    }

    .qualifier-seed-list{
      display:grid;
      gap:6px;
    }

    .qualifier-seed-head,
    .qualifier-seed-row{
      display:grid;
      grid-template-columns: 36px 1fr;
      align-items:center;
      text-align:center;
    }

    .qualifier-seed-head{
      background: var(--header-bg);
      border-radius: 10px;
      padding: 8px 6px;
      color: var(--muted);
      font-size: 8px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: .03em;
    }

    .qualifier-seed-row{
      background: var(--row-bg);
      border-radius: 10px;
      padding: 8px 6px;
    }

    .qualifier-seed-number{
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .03em;
      text-transform: uppercase;
      color: #93c5fd;
    }

    .qualifier-seed-player{
      font-size: 13px;
      font-weight: 850;
      text-transform: uppercase;
      overflow-wrap:anywhere;
      text-align:center;
    }

    .qualifier-bracket-scroll{
      width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 4px;
    }

    .qualifier-bracket-grid{
      display:grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax(172px, 196px);
      gap: 14px;
      align-items: start;
      min-width: max-content;
      padding: 2px;
    }

    .qualifier-round-column{
      display:flex;
      flex-direction:column;
      gap: 8px;
      min-width: 0;
    }

    .qualifier-round-title{
      margin:0;
      font-size: 10px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .09em;
      color: var(--muted);
      text-align:center;
      min-height: 16px;
    }

    .qualifier-round-stack{
      display:flex;
      flex-direction:column;
      gap: 8px;
    }

    .qualifier-bracket-match{
      display:flex;
      align-items:center;
      gap: 3px;
      min-height: 52px;
    }

    .qualifier-match-number{
      width: 20px;
      flex: 0 0 20px;
      text-align:center;
      color: rgba(233,238,248,0.68);
      font-size: 10px;
      font-weight: 900;
      letter-spacing: .02em;
    }

    .qualifier-match-card{
      width: 100%;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.05);
    }

    .qualifier-match-row{
      display:grid;
      grid-template-columns: 24px minmax(0, 1fr) 24px;
      align-items:center;
      gap: 6px;
      min-height: 24px;
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      padding: 3px 6px;
      border: 1px solid transparent;
      font-size: 10px;
    }

    .qualifier-match-row:nth-child(2){
      background: rgba(255,255,255,0.045);
    }

    .qualifier-match-row + .qualifier-match-row{
      border-top: 1px solid rgba(148,163,184,0.38);
    }

    .qualifier-match-row.winner{
      background: rgba(34,197,94,0.12);
      border-color: rgba(34,197,94,0.55);
    }

    .qualifier-player-seed,
    .qualifier-player-score{
      text-align:center;
      font-variant-numeric: tabular-nums;
      font-weight: 800;
    }

    .qualifier-player-seed{
      color: #93c5fd;
    }

    .qualifier-player-score{
      color: #000;
      background: #fff;
      border-radius: 4px;
      min-height: 16px;
      display:grid;
      place-items:center;
    }

    .qualifier-player-name{
      min-width: 0;
      font-weight: 900;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      letter-spacing: .02em;
      color: #fff;
    }

    .qualifier-player-name.is-bye{
      color: #9ca3af;
    }

    .qualifier-bracket-empty{
      margin: 0;
      min-height: 180px;
      border: 1px dashed rgba(148,163,184,0.45);
      border-radius: 12px;
      display:grid;
      place-items:center;
      color: var(--muted);
      text-align:center;
      font-size: 12px;
    }

    .playoffs-wrap{
      margin-top: 4px;
      display:grid;
      gap:12px;
    }

    .format-wrap{
      margin-top: 4px;
      display:grid;
      gap:12px;
    }

    .format-copy,
    .format-note{
      margin: 0;
      color: var(--text);
      font-size: 14px;
      line-height: 1.6;
    }

    .format-note{
      color: rgba(233,238,248,0.92);
      font-weight: 800;
    }

    .format-table-wrap{
      border: 1px solid var(--border-lite);
      border-radius: 16px;
      padding: 12px;
      background: rgba(15,23,42,0.55);
      overflow-x: auto;
    }

    table.format-table{
      width: 100%;
      min-width: 760px;
      border-collapse: collapse;
      font-size: 12px;
      text-align: center;
    }

    .format-table th,
    .format-table td{
      border: 1px solid rgba(148,163,184,0.35);
      padding: 8px 10px;
      background: rgba(255,255,255,0.04);
      vertical-align: middle;
    }

    .format-table th{
      background: var(--header-bg);
      color: rgba(231,238,255,0.95);
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .05em;
    }

    .format-table .axis-rank,
    .format-table .axis-division{
      color: var(--muted);
      font-size: 11px;
    }

    .format-table .rank-label{
      font-weight: 900;
      color: rgba(231,238,255,0.95);
      width: 54px;
    }

    .format-table td{
      white-space: nowrap;
      font-weight: 700;
    }

    .format-table td.fill-gold{ background: var(--row-highlight-gold); }
    .format-table td.fill-green{ background: var(--row-highlight-green); }
    .format-table td.fill-blue{ background: var(--row-highlight-blue); }
    .format-table td.fill-orange{ background: var(--row-highlight-orange); }
    .format-table td.fill-red{ background: var(--row-highlight-red); }

    .playoffs-layout{
      --playoff-cell-width: clamp(220px, 31vw, 320px);
      border: 1px solid var(--border-lite);
      border-radius: 16px;
      padding: 12px;
      background: rgba(15,23,42,0.55);
      display:grid;
      gap:18px;
    }

    .playoff-bracket-row{
      --playoff-finals-offset: 0px;
      --semi-top-center: 58px;
      --semi-bottom-center: 186px;
      --champ-center: 122px;
      --connector-merge-x: 56%;
      display:grid;
      grid-template-columns: minmax(220px, var(--playoff-cell-width)) 78px minmax(220px, var(--playoff-cell-width));
      grid-template-rows: auto;
      align-items:start;
      justify-content: center;
      column-gap:0;
    }

    .playoff-semifinals{
      display:grid;
      gap:16px;
    }

    .playoff-finals{
      display:grid;
      gap:16px;
      align-self:start;
      padding-top: var(--playoff-finals-offset);
    }

    .playoff-championship-slot{
      align-self:center;
    }

    .playoff-connector{
      align-self:start;
      height: 100%;
      min-height: 170px;
      position:relative;
    }

    .playoff-connector-line{
      position:absolute;
      background: rgba(148,163,184,0.72);
      box-shadow: 0 0 0 1px rgba(148,163,184,0.2);
    }

    .playoff-connector-line.top,
    .playoff-connector-line.bottom{
      left: 0;
      width: var(--connector-merge-x);
      height: 2px;
      border-radius: 999px;
    }

    .playoff-connector-line.top{
      top: var(--semi-top-center);
      transform: translateY(-1px);
    }

    .playoff-connector-line.bottom{
      top: var(--semi-bottom-center);
      transform: translateY(-1px);
    }

    .playoff-connector-line.vertical{
      left: var(--connector-merge-x);
      top: var(--semi-top-center);
      width: 2px;
      height: calc(var(--semi-bottom-center) - var(--semi-top-center));
      transform: translateX(-1px);
      border-radius: 999px;
    }

    .playoff-connector-line.to-final{
      left: var(--connector-merge-x);
      right: 0;
      height: 2px;
      top: var(--champ-center);
      transform: translateY(-1px);
      border-radius: 999px;
    }

    .playoff-divider{
      border-top: 1px solid var(--border-lite);
      width: 100%;
    }

    .playoff-oneoffs{
      display:grid;
      grid-template-columns: repeat(2, minmax(220px, var(--playoff-cell-width)));
      justify-content:center;
      gap:16px;
      margin: 0 auto;
    }

    .match-stats{
      display:grid;
      grid-template-columns: 36px repeat(3, 22px);
      gap:8px;
      padding: 6px 8px;
      min-width: 124px;
      align-items:center;
      justify-items:center;
      font-size: 10px;
      font-weight: 850;
      font-variant-numeric: tabular-nums;
    }

    .match-stats{ background: transparent; }

    .stat.games{
      border-radius: 4px;
      min-height: 18px;
      width: 40px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,0.95);
      color: #000;
      padding: 4px 8px;
      font-size: 16px;
      font-weight: 800;
    }

    .round-score{
      display:inline-flex;
      width: 28px;
      justify-content:center;
      color: rgba(233,238,248,0.9);
      line-height: 1;
      font-size: 11px;
    }

    .round-score.losing-score{
      color: #9ca3af;
    }

    @media (max-width: 1080px){
      .division-grid{ grid-template-columns: 1fr; }
      .schedule-grid{ grid-template-columns: 1fr; }
      .qualifiers-layout{ grid-template-columns: 1fr; }
      .playoff-bracket-row{ grid-template-columns: 1fr; }
      .playoff-connector{ display:none; }
      .playoff-finals{ grid-template-columns: 1fr; padding-top: 16px; }
      .playoff-oneoffs{ grid-template-columns: 1fr; width: 100%; }
    }

    @media (max-width: 760px){
      .container{ padding: 20px 12px 44px; }
      .topbar-inner{ padding: 12px 12px; flex-wrap: nowrap; }
      .playoffs-layout{ padding: 8px; }
      .brand{ flex: 1; min-width: 0; }
      .brand > div{ min-width: 0; }
      .page-nav-select{ width: min(100%, 420px); max-width: 100%; }
      .topbar-actions{ gap:6px; }
      .view-btn{ font-size: 11px; padding: 8px 10px; }
      .headline{ font-size: 18px; }
      .card{ padding: 12px 14px 20px; border-radius: 18px; }
      .division-card{ padding: 10px; }
      .format-table-wrap{ padding: 8px; }
      table.format-table{ min-width: 680px; font-size: 11px; }
      .qualifier-round-stack{ gap: var(--qualifier-round-gap, 8px); }
      .qualifier-round-stack .qualifier-bracket-match:first-child{
        padding-top: var(--qualifier-round-padding-top, 0px);
      }
      .qualifier-round-stack .qualifier-bracket-match + .qualifier-bracket-match{
        padding-top: var(--qualifier-round-gap, 8px);
      }

      .player-modal-content{
        width: calc(100% - 16px);
        padding: 12px;
      }

      .player-modal-shell{
        width: calc(100% - 16px);
        margin: 12px auto;
      }

      .player-modal-meta{
        gap: 6px;
      }

      .player-modal-head{
        gap: 6px;
      }

      .player-modal-name,
      .player-modal-division,
      .player-modal-divider{
        font-size: 14px;
      }

      .player-modal-meta-label{
        font-size: 8px;
        letter-spacing: .03em;
      }

      .player-modal-meta-value{
        font-size: 12px;
      }

      table.player-weekly{
        font-size: 10px;
        border-spacing: 0 6px;
      }

      .player-weekly th,
      .player-weekly td{
        padding: 6px 4px;
      }

      .player-weekly th{
        font-size: 8px;
        letter-spacing: .04em;
      }

      .player-weekly tbody tr.weekly-section-row td{
        font-size: 8px;
      }

      .weekly-col-week{ width: 40px; }
      .weekly-col-opponent{ width: 75px; }
      .weekly-col-result{ width: 46px; }
      .weekly-col-games{ width: 46px; }
      .weekly-col-round{ width: 40px; }

      .round-pair{
        display:flex;
        align-items:center;
        justify-content:center;
        gap: 1px;
        font-size: 8px;
        letter-spacing: 0em;
        line-height: 1;
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
      }

      .round-pair > span{
        display:inline-flex;
        align-items:center;
      }

      .player-weekly .opponent-name{
        font-size: 10px;
      }

      .main-view-switch{
        margin-bottom: 2px;
      }

      .standings-legend{
        gap: 8px;
        justify-content:flex-start;
      }

      .legend-item{
        white-space: normal;
        line-height: 1.3;
        min-width: 0;
      }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="home-badge" aria-hidden="true">
          <img src="/logos/golf.png" alt="Home" loading="eager" decoding="async" />
        </div>
        <div>
                    <select class="kicker page-nav-select" aria-label="Select page" onchange="if (this.value) window.location.href=this.value;">
            <option value="/index.html">Home</option>
            <option value="/worldopen/index.html">World Open</option>
            <option value="/proleague/index.html">Shotgun Pro League</option>
            <option value="/superleague/index.html" selected>Super League</option>
            <option value="/lightningcup/index.html">Lightning Cup</option>
            <option value="/beataidan/index.html">Beat Aidan</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="main-view-switch" role="tablist" aria-label="Super League page selector">
      <button class="view-btn is-active" id="seasonViewBtn" type="button">Super League</button>
      <button class="view-btn" id="qualifiersViewBtn" type="button">Qualifiers</button>
      <button class="view-btn" id="playoffsViewBtn" type="button">Playoffs</button>
      <button class="view-btn" id="formatViewBtn" type="button">Format</button>
    </div>

    <div class="card">
      <section id="seasonPage">
        <div class="season-head">
          <h1 class="headline">Season 6 Standings</h1>
        </div>

        <p class="status" id="status"></p>
        <p class="error" id="error"></p>

        <div class="division-grid" id="divisionGrid"></div>

        <div class="standings-legend" aria-label="Standings legend">
          <span class="legend-item" id="legendD1Playoff"><span class="legend-swatch gold" aria-hidden="true"></span>Super League D1 Playoffs</span>
          <span class="legend-item"><span class="legend-swatch green" aria-hidden="true"></span>Moves up division</span>
          <span class="legend-item"><span class="legend-swatches" aria-hidden="true"><span class="legend-swatch blue"></span><span class="legend-swatch orange"></span></span>Playoff to move up/down division</span>
          <span class="legend-item"><span class="legend-swatch none" aria-hidden="true"></span>Remains in division, or tied between multiple outcomes</span>
          <span class="legend-item"><span class="legend-swatch red" aria-hidden="true"></span>Moves down division, or to qualifier tournament</span>
        </div>

        <section class="schedule-wrap" id="scheduleWrap" hidden>
          <div class="schedule-head">
            <button class="nav-btn nav-left" id="weekPrev" type="button" aria-label="Previous week">←</button>
            <h2 class="schedule-title" id="scheduleTitle">Week</h2>
            <button class="nav-btn nav-right" id="weekNext" type="button" aria-label="Next week">→</button>
          </div>
          <div class="schedule-grid" id="scheduleGrid"></div>
        </section>
      </section>

      <section id="qualifiersPage" hidden>
        <div class="season-head">
          <h1 class="headline">Season 6 Qualifiers</h1>
        </div>

        <div class="qualifiers-layout">
          <aside class="qualifier-seeds" aria-label="Qualifier seeds">
            <h2 class="qualifier-title">Open Signups</h2>
            <div class="qualifier-seed-list" id="qualifierSeedList"></div>
          </aside>

          <section class="qualifier-bracket" aria-label="Qualifier bracket">
            <h2 class="qualifier-title">Double-Elimination Bracket</h2>
            <div class="qualifier-bracket-scroll">
              <div class="qualifier-bracket-grid" id="qualifierBracketGrid"></div>
            </div>
          </section>
        </div>
      </section>

      <section id="playoffsPage" hidden>
        <div class="season-head">
          <h1 class="headline">Season 6 Playoffs</h1>
        </div>

        <div class="playoffs-wrap">
          <section class="playoffs-layout" aria-label="Playoff matchups">
            <div class="playoff-bracket-row">
              <div class="playoff-semifinals" id="playoffSemifinals"></div>
              <div class="playoff-connector" aria-hidden="true">
                <span class="playoff-connector-line top"></span>
                <span class="playoff-connector-line bottom"></span>
                <span class="playoff-connector-line vertical"></span>
                <span class="playoff-connector-line to-final"></span>
              </div>
              <div class="playoff-finals">
                <div class="playoff-championship-slot" id="playoffChampionship"></div>
                <div id="playoffThirdPlace"></div>
              </div>
            </div>
            <div class="playoff-divider" aria-hidden="true"></div>
            <div class="playoff-oneoffs" id="playoffOneOffs"></div>
          </section>
        </div>
      </section>

      <section id="formatPage" hidden>
        <div class="season-head">
          <h1 class="headline">Season 6 Format</h1>
        </div>

        <div class="format-wrap">
          <p class="format-copy">Super League is an exclusive, twice-yearly, round-robin 1v1 tournament.</p>
          <p class="format-copy">Match format:<br />- Each match is best-of-3.<br />- Games are played on random 9-hole courses.</p>
          <p class="format-copy">Tiebreaker:<br />- If a round finishes in a tie, players go to a playoff on a new random 9-hole course. Closest-to-pin is not used.<br />- Once the playoff ends, the playoff course is discarded.<br />- If another game is still needed, it is played on a new random 9-hole course.</p>
          <p class="format-copy">Playoffs:<br />- Following the regular season, the top 4 players in Division 1 advance to a single-elimination playoff to determine the Super League champion.<br />- Playoffs to determine movement between divisions consist of a single match.<br />- All playoff matches use the same match format and tiebreaker rules as the regular season.</p>
          <p class="format-note">Note:<br />To support a smooth expansion to 10 players per division in Season 7, movement based on divisional standings has been updated as follows for Season 6:</p>

          <div class="format-table-wrap" aria-label="Division movement table">
            <table class="format-table">
              <thead>
                <tr>
                  <th rowspan="2" class="axis-rank">Rank</th>
                  <th colspan="3" class="axis-division">Division</th>
                </tr>
                <tr>
                  <th>1</th>
                  <th>2</th>
                  <th>3</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <th class="rank-label">1</th>
                  <td class="fill-gold">D1 Playoff</td>
                  <td class="fill-green">Moves to D1</td>
                  <td class="fill-green">Moves to D2</td>
                </tr>
                <tr>
                  <th class="rank-label">2</th>
                  <td class="fill-gold">D1 Playoff</td>
                  <td class="fill-green">Moves to D1</td>
                  <td class="fill-green">Moves to D2</td>
                </tr>
                <tr>
                  <th class="rank-label">3</th>
                  <td class="fill-gold">D1 Playoff</td>
                  <td class="fill-blue">Playoff for D1</td>
                  <td class="fill-blue">Playoff for D2</td>
                </tr>
                <tr>
                  <th class="rank-label">4</th>
                  <td class="fill-gold">D1 Playoff</td>
                  <td>Stays in D2</td>
                  <td>Stays in D3</td>
                </tr>
                <tr>
                  <th class="rank-label">5</th>
                  <td>Stays in D1</td>
                  <td>Stays in D2</td>
                  <td>Stays in D3</td>
                </tr>
                <tr>
                  <th class="rank-label">6</th>
                  <td>Stays in D1</td>
                  <td>Stays in D2</td>
                  <td>Stays in D3</td>
                </tr>
                <tr>
                  <th class="rank-label">7</th>
                  <td class="fill-orange">Playoff for D1</td>
                  <td class="fill-orange">Playoff for D2</td>
                  <td class="fill-red">Must re-qualify</td>
                </tr>
                <tr>
                  <th class="rank-label">8</th>
                  <td class="fill-red">Moves to D2</td>
                  <td class="fill-red">Moves to D3</td>
                  <td class="fill-red">Must re-qualify</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <dialog class="player-modal" id="playerModal" aria-labelledby="playerModalName">
        <div class="player-modal-shell">
          <button class="player-modal-close" id="playerModalClose" type="button" aria-label="Close player details">×</button>
          <div class="player-modal-content">
          <div class="player-modal-head">
            <h2 class="player-modal-name" id="playerModalName"></h2>
            <span class="player-modal-divider" aria-hidden="true">•</span>
            <p class="player-modal-division" id="playerModalDivision"></p>
          </div>
          <div class="player-modal-meta" id="playerModalMeta">
            <div class="player-modal-meta-cell">
              <p class="player-modal-meta-label">Rank</p>
              <p class="player-modal-meta-value" id="playerMetaRank">—</p>
            </div>
            <div class="player-modal-meta-cell">
              <p class="player-modal-meta-label">W-L</p>
              <p class="player-modal-meta-value" id="playerMetaMatches">—</p>
            </div>
            <div class="player-modal-meta-cell">
              <p class="player-modal-meta-label">Games</p>
              <p class="player-modal-meta-value" id="playerMetaGames">—</p>
            </div>
            <div class="player-modal-meta-cell">
              <p class="player-modal-meta-label">Diff.</p>
              <p class="player-modal-meta-value" id="playerMetaDiff">—</p>
            </div>
          </div>
          <table class="player-weekly" id="playerWeeklyTable">
            <thead>
              <tr>
                <th class="weekly-col-week">Week</th>
                <th class="weekly-col-opponent">Opponent</th>
                <th class="weekly-col-result">Result</th>
                <th class="weekly-col-games">Games</th>
                <th class="weekly-round-group">R1</th>
                <th class="weekly-round-group">R2</th>
                <th class="weekly-round-group">R3</th>
              </tr>
            </thead>
            <tbody id="playerWeeklyBody"></tbody>
          </table>
          </div>
        </div>
      </dialog>
    </div>
  </div>

  <script>
    const WORKER_URL = "https://small-mud-2771.nextweekmedia.workers.dev/";
    const SHEET_ID = "1BbT8t6erCVdx-Bdshv_hax9r9JSRzU1WygjWxW3vPkY";
    const SHEET_NAME = "Season 6";

    const DIVISIONS = [
      { title: "Division 1", range: "B3:G10" },
      { title: "Division 2", range: "B13:G20" },
      { title: "Division 3", range: "B23:G30" },
    ];
    const SCHEDULE_RANGE = "I2:AB85";
    const QUALIFIER_LIST_RANGE = "A:B";
    const QUALIFIER_BRACKET_RANGE = "A3:H80";
    const QUALIFIER_BRACKET_SHEET = "S6 Winners Bracket";
    const PLAYOFF_RANGE = "I87:AB92";
    let scheduleWeeks = [];
    let playoffMatchups = [];
    let currentWeekIdx = 0;
    const playerDivisionLookup = new Map();
    const playerStatsLookup = new Map();

    function divisionClassFromLabel(label){
      const normalized = String(label ?? "").toLowerCase();
      if(normalized.includes("1")) return "division-1";
      if(normalized.includes("2")) return "division-2";
      if(normalized.includes("3")) return "division-3";
      return "";
    }

    function setupViewNav(){
      const seasonBtn = document.getElementById("seasonViewBtn");
      const qualifiersBtn = document.getElementById("qualifiersViewBtn");
      const playoffsBtn = document.getElementById("playoffsViewBtn");
      const formatBtn = document.getElementById("formatViewBtn");
      const seasonPage = document.getElementById("seasonPage");
      const qualifiersPage = document.getElementById("qualifiersPage");
      const playoffsPage = document.getElementById("playoffsPage");
      const formatPage = document.getElementById("formatPage");
      const validPages = new Set(["season", "qualifiers", "playoffs", "format"]);

      const setPage = (page, options = {}) => {
        const nextPage = validPages.has(page) ? page : "season";
        const showSeason = nextPage === "season";
        const showQualifiers = nextPage === "qualifiers";
        const showPlayoffs = nextPage === "playoffs";
        const showFormat = nextPage === "format";
        seasonPage.hidden = !showSeason;
        qualifiersPage.hidden = !showQualifiers;
        playoffsPage.hidden = !showPlayoffs;
        formatPage.hidden = !showFormat;
        seasonBtn.classList.toggle("is-active", showSeason);
        qualifiersBtn.classList.toggle("is-active", showQualifiers);
        playoffsBtn.classList.toggle("is-active", showPlayoffs);
        formatBtn.classList.toggle("is-active", showFormat);

        const url = new URL(window.location.href);
        url.searchParams.set("page", nextPage);
        window.history.replaceState({}, "", url);

        if(showPlayoffs){
          requestAnimationFrame(updatePlayoffBracketLayout);
        }

        if(options.scroll !== false){
          window.scrollTo({ top: 0, behavior: "smooth" });
        }
      };

      const initialPage = new URLSearchParams(window.location.search).get("page");
      setPage(initialPage, { scroll: false });

      seasonBtn.addEventListener("click", () => setPage("season"));
      qualifiersBtn.addEventListener("click", () => setPage("qualifiers"));
      playoffsBtn.addEventListener("click", () => setPage("playoffs"));
      formatBtn.addEventListener("click", () => setPage("format"));
    }

    function normalizeValues(resp){
      if(!resp) return [];
      if(Array.isArray(resp)) return resp;
      if(Array.isArray(resp.values)) return resp.values;
      if(Array.isArray(resp.data?.values)) return resp.data.values;
      if(Array.isArray(resp.result?.values)) return resp.result.values;
      return [];
    }

    async function fetchRange(a1, sheetName = SHEET_NAME){
      const range = `'${sheetName}'!${a1}`;
      const payload = { sheetId: SHEET_ID, range };

      try{
        const r = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if(r.ok) return normalizeValues(await r.json());
      }catch(e){}

      const u = new URL(WORKER_URL);
      u.searchParams.set("sheetId", SHEET_ID);
      u.searchParams.set("range", range);
      const r2 = await fetch(u.toString());
      if(!r2.ok){
        const text = await r2.text().catch(() => "");
        throw new Error(`Worker request failed (${r2.status}). ${text}`.trim());
      }
      return normalizeValues(await r2.json());
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&39;");
    }

    function numOrZero(value){
      const n = Number(String(value ?? "").trim());
      return Number.isFinite(n) ? n : 0;
    }

    function formatDiff(value){
      const n = numOrZero(value);
      if(n > 0) return `+${n}`;
      if(n < 0) return `${n}`;
      return "0";
    }

    function normalizeDivisionValue(value){
      const divText = String(value ?? "").trim();
      const match = divText.match(/(\d+)/);
      return match ? match[1] : divText;
    }

    function comparePctDesc(aWins, aLosses, bWins, bLosses){
      const aTotal = aWins + aLosses;
      const bTotal = bWins + bLosses;
      if(aTotal === 0 && bTotal === 0) return 0;
      if(aTotal === 0) return bWins > 0 ? 1 : -1;
      if(bTotal === 0) return aWins > 0 ? -1 : 1;

      const left = aWins * bTotal;
      const right = bWins * aTotal;
      if(left === right) return 0;
      return left > right ? -1 : 1;
    }

    function getHeadToHeadOutcome(headToHeadMap, playerA, playerB){
      const aKey = String(playerA ?? "").trim().toUpperCase();
      const bKey = String(playerB ?? "").trim().toUpperCase();
      if(!aKey || !bKey) return null;

      const aVs = headToHeadMap.get(aKey);
      if(aVs?.has(bKey)) return aVs.get(bKey);

      const bVs = headToHeadMap.get(bKey);
      if(bVs?.has(aKey)) return bVs.get(aKey) === 1 ? -1 : 1;
      return null;
    }

    function buildHeadToHeadByDivision(scheduleRows){
      const byDivision = new Map();

      scheduleRows.forEach((row = []) => {
        const division = normalizeDivisionValue(row[1]);
        const p1Name = String(row[3] ?? "").trim();
        const p2Name = String(row[12] ?? "").trim();
        const p1Result = String(row[10] ?? "").trim().toUpperCase();
        const p2Result = String(row[19] ?? "").trim().toUpperCase();

        if(!division || !p1Name || !p2Name) return;
        if(!((p1Result === "W" && p2Result === "L") || (p1Result === "L" && p2Result === "W"))) return;

        if(!byDivision.has(division)) byDivision.set(division, new Map());
        const divisionMap = byDivision.get(division);

        const p1Key = p1Name.toUpperCase();
        const p2Key = p2Name.toUpperCase();
        if(!divisionMap.has(p1Key)) divisionMap.set(p1Key, new Map());
        if(!divisionMap.has(p2Key)) divisionMap.set(p2Key, new Map());

        const p1Won = p1Result === "W";
        divisionMap.get(p1Key).set(p2Key, p1Won ? 1 : -1);
        divisionMap.get(p2Key).set(p1Key, p1Won ? -1 : 1);
      });

      return byDivision;
    }

    function computeHeadToHeadPct(row, group, headToHeadMap){
      let wins = 0;
      let losses = 0;

      group.forEach((other) => {
        if(other.playerKey === row.playerKey) return;
        const outcome = getHeadToHeadOutcome(headToHeadMap, row.playerKey, other.playerKey);
        if(outcome === 1) wins += 1;
        if(outcome === -1) losses += 1;
      });

      const played = wins + losses;
      if(played === 0) return null;
      return wins / played;
    }

    function rankDivisionRows(rows, divisionTitle, headToHeadByDivision){
      const divisionKey = normalizeDivisionValue(divisionTitle);
      const headToHeadMap = headToHeadByDivision.get(divisionKey) || new Map();

      const withKeys = rows.map((row) => ({ ...row, playerKey: row.player.toUpperCase() }));
      withKeys.sort((a, b) => comparePctDesc(a.matchesWon, a.matchesLost, b.matchesWon, b.matchesLost));

      const ranked = [];
      for(let i = 0; i < withKeys.length;){
        const group = [withKeys[i]];
        let j = i + 1;
        while(
          j < withKeys.length &&
          comparePctDesc(
            withKeys[i].matchesWon,
            withKeys[i].matchesLost,
            withKeys[j].matchesWon,
            withKeys[j].matchesLost,
          ) === 0
        ){
          group.push(withKeys[j]);
          j += 1;
        }

        if(group.length === 2){
          const h2h = getHeadToHeadOutcome(headToHeadMap, group[0].playerKey, group[1].playerKey);
          if(h2h === -1) group.reverse();
          group[0].tied = h2h === null;
          group[1].tied = h2h === null;
        }else if(group.length > 2){
          const withHeadToHead = group.map((row) => ({
            ...row,
            headToHeadPct: computeHeadToHeadPct(row, group, headToHeadMap),
          }));

          const uniqueHeadToHeadPcts = new Set(withHeadToHead.map((row) => row.headToHeadPct));
          const canUseHeadToHead = !(uniqueHeadToHeadPcts.size === 1 && uniqueHeadToHeadPcts.has(null));

          withHeadToHead.sort((a, b) => {
            if(canUseHeadToHead){
              const aPct = a.headToHeadPct;
              const bPct = b.headToHeadPct;
              if(aPct !== bPct){
                if(aPct === null) return 1;
                if(bPct === null) return -1;
                return bPct - aPct;
              }
            }

            const gamesCmp = comparePctDesc(a.gamesWon, a.gamesLost, b.gamesWon, b.gamesLost);
            if(gamesCmp !== 0) return gamesCmp;
            if(a.diff !== b.diff) return a.diff - b.diff;
            return a.sourceOrder - b.sourceOrder;
          });

          for(let k = 0; k < withHeadToHead.length; k += 1){
            const current = withHeadToHead[k];
            const prev = withHeadToHead[k - 1];
            if(!prev){
              current.tied = false;
              continue;
            }
            const sameHeadToHead = current.headToHeadPct === prev.headToHeadPct;
            const sameGames = comparePctDesc(current.gamesWon, current.gamesLost, prev.gamesWon, prev.gamesLost) === 0;
            const sameDiff = current.diff === prev.diff;
            current.tied = sameHeadToHead && sameGames && sameDiff;
            if(current.tied) prev.tied = true;
          }

          group.splice(0, group.length, ...withHeadToHead);
        }else{
          group[0].tied = false;
        }

        ranked.push(...group);
        i = j;
      }

      let displayRank = 1;
      ranked.forEach((row, idx) => {
        if(idx > 0){
          const prev = ranked[idx - 1];
          const samePrimary = comparePctDesc(row.matchesWon, row.matchesLost, prev.matchesWon, prev.matchesLost) === 0;
          const sameGames = comparePctDesc(row.gamesWon, row.gamesLost, prev.gamesWon, prev.gamesLost) === 0;
          if(!(row.tied && prev.tied && samePrimary && sameGames && row.diff === prev.diff)){
            displayRank = idx + 1;
          }
        }
        row.rank = row.tied ? `T${displayRank}` : String(displayRank);
      });

      return ranked;
    }

    function mapRows(values){
      return values
        .map((row = [], idx) => {
          const player = String(row[0] ?? "").trim();
          const matchesWon = numOrZero(row[1]);
          const matchesLost = numOrZero(row[2]);
          const gamesWon = numOrZero(row[3]);
          const gamesLost = numOrZero(row[4]);
          const diff = row[5];

          return {
            player,
            matchesWon,
            matchesLost,
            gamesWon,
            gamesLost,
            diff: numOrZero(diff),
            sourceOrder: idx,
            matches: `${matchesWon}-${matchesLost}`,
            games: `${gamesWon}-${gamesLost}`,
            diffText: formatDiff(diff),
          };
        })
        .filter((row) => row.player !== "");
    }

    function getDivisionRankHighlight(divisionTitle, rankPosition, metadata){
      const normalized = String(divisionTitle ?? "").toLowerCase();
      if(normalized.includes("1")){
        if(metadata){
          if(rankPosition === 6) return "row-highlight-orange";
          if(rankPosition >= 7 && rankPosition <= 8) return "row-highlight-red";
          return "";
        }
        if(rankPosition >= 1 && rankPosition <= 4) return "row-highlight-gold";
        if(rankPosition === 6) return "row-highlight-orange";
        if(rankPosition >= 7 && rankPosition <= 8) return "row-highlight-red";
        return "";
      }

      if(normalized.includes("2")){
        if(rankPosition >= 1 && rankPosition <= 2) return "row-highlight-green";
        if(rankPosition === 3) return "row-highlight-blue";
        if(rankPosition === 6) return "row-highlight-orange";
        if(rankPosition >= 7 && rankPosition <= 8) return "row-highlight-red";
        return "";
      }

      if(normalized.includes("3")){
        if(rankPosition >= 1 && rankPosition <= 2) return "row-highlight-green";
        if(rankPosition === 3) return "row-highlight-blue";
        if(rankPosition >= 5 && rankPosition <= 8) return "row-highlight-red";
        return "";
      }

      return "";
    }

    function applyPlayoffMedalHighlight(row, metadata){
      if(!row || !metadata || !(metadata.championshipComplete && metadata.thirdPlaceComplete)) return;
      const rank = metadata.d1FinalRanks.get(row.playerKey);
      if(rank === 1) row.highlightClass = "row-highlight-gold";
      if(rank === 2) row.highlightClass = "row-highlight-silver";
      if(rank === 3) row.highlightClass = "row-highlight-bronze";
      if(rank === 4) row.highlightClass = "";
    }

    function applyRowHighlights(rows, divisionTitle, metadata){
      for(let idx = 0; idx < rows.length;){
        const row = rows[idx];
        const isTied = String(row.rank ?? "").startsWith("T");

        if(!isTied){
          row.highlightClass = getDivisionRankHighlight(divisionTitle, idx + 1, metadata);
          applyPlayoffMedalHighlight(row, metadata);
          idx += 1;
          continue;
        }

        let end = idx + 1;
        while(end < rows.length && rows[end].rank === row.rank){
          end += 1;
        }

        const groupClasses = new Set();
        for(let pos = idx + 1; pos <= end; pos += 1){
          groupClasses.add(getDivisionRankHighlight(divisionTitle, pos, metadata));
        }
        const groupHighlight = groupClasses.size === 1 ? [...groupClasses][0] : "";
        for(let i = idx; i < end; i += 1){
          rows[i].highlightClass = groupHighlight;
          applyPlayoffMedalHighlight(rows[i], metadata);
        }
        idx = end;
      }
    }


    function isMatchComplete(matchup){
      if(!matchup) return false;
      return matchup.p1.result === "W" || matchup.p2.result === "W";
    }

    function getMatchWinnerKey(matchup){
      if(!isMatchComplete(matchup)) return "";
      const p1Key = String(matchup.p1.name ?? "").trim().toUpperCase();
      const p2Key = String(matchup.p2.name ?? "").trim().toUpperCase();
      if(matchup.p1.result === "W") return p1Key;
      if(matchup.p2.result === "W") return p2Key;
      if(matchup.p1.result === "L") return p2Key;
      if(matchup.p2.result === "L") return p1Key;
      return "";
    }

    function getMatchLoserKey(matchup){
      if(!isMatchComplete(matchup)) return "";
      const p1Key = String(matchup.p1.name ?? "").trim().toUpperCase();
      const p2Key = String(matchup.p2.name ?? "").trim().toUpperCase();
      if(matchup.p1.result === "L") return p1Key;
      if(matchup.p2.result === "L") return p2Key;
      if(matchup.p1.result === "W") return p2Key;
      if(matchup.p2.result === "W") return p1Key;
      return "";
    }

    function derivePlayoffMetadata(matchups){
      if(!Array.isArray(matchups) || matchups.length < 6) return null;

      const championship = matchups[2];
      const thirdPlace = matchups[3];
      const oneOffs = [
        { matchup: matchups[4], label: "Division 1/2 Playoff" },
        { matchup: matchups[5], label: "Division 2/3 Playoff" },
      ];

      const championshipComplete = isMatchComplete(championship);
      const thirdPlaceComplete = isMatchComplete(thirdPlace);
      const d1FinalRanks = new Map();

      if(championshipComplete && thirdPlaceComplete){
        const championKey = getMatchWinnerKey(championship);
        const runnerUpKey = getMatchLoserKey(championship);
        const thirdKey = getMatchWinnerKey(thirdPlace);
        const fourthKey = getMatchLoserKey(thirdPlace);

        const topFour = [championKey, runnerUpKey, thirdKey, fourthKey].filter(Boolean);
        const hasUniqueTopFour = topFour.length === 4 && new Set(topFour).size === 4;

        if(hasUniqueTopFour){
          d1FinalRanks.set(championKey, 1);
          d1FinalRanks.set(runnerUpKey, 2);
          d1FinalRanks.set(thirdKey, 3);
          d1FinalRanks.set(fourthKey, 4);
        }
      }

      return {
        championship,
        thirdPlace,
        oneOffs,
        championshipComplete,
        thirdPlaceComplete,
        d1FinalRanks,
      };
    }

    function applyDivisionOnePlayoffOverrides(rows, metadata){
      if(!metadata || !(metadata.championshipComplete && metadata.thirdPlaceComplete)) return;
      if(metadata.d1FinalRanks.size !== 4) return;

      const rankOrder = [];
      rows.forEach((row, idx) => {
        const playoffRank = metadata.d1FinalRanks.get(row.playerKey);
        if(playoffRank){
          row._forcedRank = playoffRank;
          rankOrder.push({ row, playoffRank, idx });
        }
      });

      if(!rankOrder.length) return;

      rankOrder.sort((a, b) => a.playoffRank - b.playoffRank || a.idx - b.idx);

      const orderedRows = rankOrder.map((entry) => entry.row);
      const remainingRows = rows.filter((row) => !row._forcedRank);
      rows.splice(0, rows.length, ...orderedRows, ...remainingRows);

      rows.forEach((row, idx) => {
        if(row._forcedRank){
          row.rank = String(row._forcedRank);
          row.tied = false;
        }else{
          row.rank = String(idx + 1);
          row.tied = false;
        }
      });
    }

    function updateStandingsLegend(metadata){
      const d1PlayoffLegendEl = document.getElementById("legendD1Playoff");
      if(!d1PlayoffLegendEl) return;
      d1PlayoffLegendEl.hidden = Boolean(metadata);
    }

    function applyPlayoffStatTotals(baseRows, metadata){
      const rows = baseRows.map((row) => ({ ...row }));
      if(!metadata) return rows;

      const statDeltas = new Map();
      const addResult = (playerKey, matchWon, matchLost, gamesWon, gamesLost) => {
        if(!playerKey) return;
        if(!statDeltas.has(playerKey)){
          statDeltas.set(playerKey, { matchesWon: 0, matchesLost: 0, gamesWon: 0, gamesLost: 0, diff: 0 });
        }
        const totals = statDeltas.get(playerKey);
        totals.matchesWon += matchWon;
        totals.matchesLost += matchLost;
        totals.gamesWon += gamesWon;
        totals.gamesLost += gamesLost;
        totals.diff += gamesWon - gamesLost;
      };

      const addMatch = (matchup) => {
        if(!isMatchComplete(matchup)) return;
        const p1Key = String(matchup.p1.name ?? "").trim().toUpperCase();
        const p2Key = String(matchup.p2.name ?? "").trim().toUpperCase();
        const p1Games = numOrZero(matchup.p1.gamesWon);
        const p2Games = numOrZero(matchup.p2.gamesWon);
        const p1Win = matchup.p1.result === "W";
        const p2Win = matchup.p2.result === "W";
        addResult(p1Key, p1Win ? 1 : 0, p1Win ? 0 : 1, p1Games, p2Games);
        addResult(p2Key, p2Win ? 1 : 0, p2Win ? 0 : 1, p2Games, p1Games);
      };

      addMatch(metadata.championship);
      addMatch(metadata.thirdPlace);
      metadata.oneOffs.forEach((entry) => addMatch(entry.matchup));

      rows.forEach((row) => {
        const delta = statDeltas.get(row.player.toUpperCase());
        if(!delta) return;
        row.matchesWon += delta.matchesWon;
        row.matchesLost += delta.matchesLost;
        row.gamesWon += delta.gamesWon;
        row.gamesLost += delta.gamesLost;
        row.diff += delta.diff;
        row.matches = `${row.matchesWon}-${row.matchesLost}`;
        row.games = `${row.gamesWon}-${row.gamesLost}`;
        row.diffText = formatDiff(row.diff);
      });

      return rows;
    }

    function renderDivision(division, values, headToHeadByDivision, metadata){
      const baseRows = mapRows(values);
      const rowsWithPlayoffs = applyPlayoffStatTotals(baseRows, metadata);
      const rows = rankDivisionRows(rowsWithPlayoffs, division.title, headToHeadByDivision);
      if(normalizeDivisionValue(division.title) === "1") applyDivisionOnePlayoffOverrides(rows, metadata);
      applyRowHighlights(rows, division.title, metadata);
      const divisionClass = divisionClassFromLabel(division.title);

      const wrapper = document.createElement("section");
      wrapper.className = `division-card ${divisionClass}`.trim();

      const title = document.createElement("h2");
      title.className = `division-title ${divisionClass}`.trim();
      title.textContent = division.title;
      wrapper.appendChild(title);

      const table = document.createElement("table");
      table.className = "rankings";
      table.innerHTML = `
        <thead>
          <tr>
            <th class="col-rank">Rank</th>
            <th class="col-player">Player</th>
            <th class="col-matches">W-L</th>
            <th class="col-games">Games</th>
            <th class="col-diff">Diff.</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tbody = table.querySelector("tbody");

      rows.forEach((row) => {
        const tr = document.createElement("tr");
        if(row.highlightClass) tr.classList.add(row.highlightClass);
        const qfPlayerClass = row.player.toUpperCase().startsWith("QF") ? " qf-player" : "";
        if(row.player){
          playerDivisionLookup.set(row.player.toUpperCase(), {
            divisionTitle: division.title,
            divisionClass,
          });
        }
        tr.innerHTML = `
          <td class="col-rank">${escapeHtml(row.rank)}</td>
          <td class="col-player${qfPlayerClass}"><button class="player-btn" type="button" data-player="${escapeHtml(row.player)}">${escapeHtml(row.player)}</button></td>
          <td class="col-matches">${escapeHtml(row.matches)}</td>
          <td class="col-games">${escapeHtml(row.games)}</td>
          <td class="col-diff">${escapeHtml(row.diffText)}</td>
        `;
        tbody.appendChild(tr);
      });

      if(rows.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" style="text-align:center; color: var(--muted);">No data available.</td>`;
        tbody.appendChild(tr);
      }

      wrapper.appendChild(table);
      return wrapper;
    }

    function formatStatValue(value, placeholder = "-"){
      const str = String(value ?? "").trim();
      return str === "" ? placeholder : escapeHtml(str);
    }

    function formatPlayerLabel(name){
      const value = String(name ?? "").trim();
      if(!value) return "TBD";
      return `<button class="player-btn" type="button" data-player="${escapeHtml(value)}">${escapeHtml(value)}</button>`;
    }

    function isQfPlayerName(name){
      return /^QF\b/i.test(String(name ?? "").trim());
    }

    function formatResultChip(value, isWin){
      const cls = isWin ? "result-win" : "result-loss";
      return `<span class="${cls}">${escapeHtml(value)}</span>`;
    }

    function getRoundCellHtml(playerScore, opponentScore, side){
      const score = side === "player" ? playerScore : opponentScore;
      const safeScore = formatStatValue(score, "–");

      if(side !== "player") return `<span>${safeScore}</span>`;

      const winners = isRoundWinner(playerScore, opponentScore);
      if(winners.a && !winners.b) return `<span class="score-win">${safeScore}</span>`;
      if(!winners.a && winners.b) return `<span class="score-loss">${safeScore}</span>`;
      return `<span>${safeScore}</span>`;
    }

    function formatRoundPair(roundCell){
      return `<span class="round-pair">${roundCell.player}<span class="round-sep">|</span>${roundCell.opponent}</span>`;
    }

    function getPlayerWeekResult(playerName, weekData){
      const playerKey = String(playerName ?? "").trim().toUpperCase();
      const matchup = weekData.matchups.find((m) => (
        String(m.p1.name ?? "").trim().toUpperCase() === playerKey ||
        String(m.p2.name ?? "").trim().toUpperCase() === playerKey
      ));

      if(!matchup) return null;

      const isP1 = String(matchup.p1.name ?? "").trim().toUpperCase() === playerKey;
      const playerSide = isP1 ? matchup.p1 : matchup.p2;
      const opponentSide = isP1 ? matchup.p2 : matchup.p1;
      const isWin = playerSide.result === "W";
      const hasRecordedResult = [
        playerSide.result,
        playerSide.gamesWon,
        opponentSide.gamesWon,
        ...playerSide.rounds,
        ...opponentSide.rounds,
      ].some((value) => String(value ?? "").trim() !== "");

      const round3NotPlayed =
        String(playerSide.rounds[2] ?? "").trim() === "" &&
        String(opponentSide.rounds[2] ?? "").trim() === "" &&
        (numOrZero(playerSide.gamesWon) === 2 || numOrZero(opponentSide.gamesWon) === 2);

      const resultHtml = hasRecordedResult
        ? formatResultChip(isWin ? "W" : "L", isWin)
        : '<span class="result-pending">—</span>';
      const gamesRecord = `${formatStatValue(playerSide.gamesWon, "—")}-${formatStatValue(opponentSide.gamesWon, "—")}`;
      const gamesHtml = hasRecordedResult
        ? formatResultChip(gamesRecord, isWin)
        : '<span class="result-pending">—</span>';

      return {
        opponent: opponentSide.name || "TBD",
        resultHtml,
        gamesHtml,
        roundCells: [0, 1, 2].map((idx) => {
          if(idx === 2 && round3NotPlayed){
            return { player: '<span class="score-dash">–</span>', opponent: '<span class="score-dash">–</span>' };
          }
          return {
            player: getRoundCellHtml(playerSide.rounds[idx], opponentSide.rounds[idx], "player"),
            opponent: getRoundCellHtml(playerSide.rounds[idx], opponentSide.rounds[idx], "opponent"),
          };
        }),
      };
    }

    function openPlayerModal(playerName){
      const modal = document.getElementById("playerModal");
      const nameEl = document.getElementById("playerModalName");
      const divisionEl = document.getElementById("playerModalDivision");
      const tbody = document.getElementById("playerWeeklyBody");
      const lookup = playerDivisionLookup.get(String(playerName ?? "").trim().toUpperCase());
      const stats = playerStatsLookup.get(String(playerName ?? "").trim().toUpperCase());

      nameEl.textContent = playerName;
      divisionEl.className = "player-modal-division";
      divisionEl.textContent = lookup?.divisionTitle || "Division unavailable";
      if(lookup?.divisionClass) divisionEl.classList.add(lookup.divisionClass);

      document.getElementById("playerMetaRank").textContent = stats?.rank || "—";
      document.getElementById("playerMetaMatches").textContent = stats?.matches || "—";
      document.getElementById("playerMetaGames").textContent = stats?.games || "—";
      document.getElementById("playerMetaDiff").textContent = stats?.diff || "—";

      tbody.innerHTML = "";
      const appendSectionRow = (label) => {
        const sectionRow = document.createElement("tr");
        sectionRow.className = "weekly-section-row";
        sectionRow.innerHTML = `<td colspan="7">${escapeHtml(label)}</td>`;
        tbody.appendChild(sectionRow);
      };

      const appendResultRow = (label, result) => {
        const row = document.createElement("tr");
        if(!result){
          row.innerHTML = `
            <td class="weekly-col-week">${escapeHtml(label)}</td>
            <td class="weekly-col-opponent"><span class="opponent-name">—</span></td>
            <td class="weekly-col-result"><span class="result-pending">—</span></td>
            <td class="weekly-col-games"><span class="result-pending">—</span></td>
            <td class="weekly-col-round"><span class="score-dash">–</span></td>
            <td class="weekly-col-round"><span class="score-dash">–</span></td>
            <td class="weekly-col-round"><span class="score-dash">–</span></td>
          `;
          tbody.appendChild(row);
          return;
        }

        const opponentQfClass = isQfPlayerName(result.opponent) ? " qf-player" : "";
        row.innerHTML = `
          <td class="weekly-col-week">${escapeHtml(label)}</td>
          <td class="weekly-col-opponent"><button class="player-btn opponent-name${opponentQfClass}" type="button" data-player="${escapeHtml(result.opponent)}">${escapeHtml(result.opponent)}</button></td>
          <td class="weekly-col-result">${result.resultHtml}</td>
          <td class="weekly-col-games">${result.gamesHtml}</td>
          <td class="weekly-col-round">${formatRoundPair(result.roundCells[0])}</td>
          <td class="weekly-col-round">${formatRoundPair(result.roundCells[1])}</td>
          <td class="weekly-col-round">${formatRoundPair(result.roundCells[2])}</td>
        `;
        tbody.appendChild(row);
      };

      for(let week = 1; week <= 7; week += 1){
        const weekData = scheduleWeeks.find((w) => Number(w.week) === week);
        const result = weekData ? getPlayerWeekResult(playerName, weekData) : null;
        appendResultRow(String(week), result);
      }

      if(playoffMetadata){
        const playerKey = String(playerName ?? "").trim().toUpperCase();
        const playoffEntries = [
          { label: "Division 1 Championship", matchup: playoffMetadata.championship },
          { label: "Division 1 3rd Place", matchup: playoffMetadata.thirdPlace },
          ...playoffMetadata.oneOffs.map((entry) => ({ label: entry.label, matchup: entry.matchup })),
        ];

        playoffEntries.forEach((entry) => {
          const result = entry.matchup ? getPlayerWeekResult(playerName, { matchups: [entry.matchup] }) : null;
          if(!result) return;
          appendSectionRow(entry.label);
          appendResultRow("-", result);
        });
      }

      if(typeof modal.showModal === "function"){
        modal.showModal();
      }else{
        modal.setAttribute("open", "open");
      }
    }

    function closePlayerModal(){
      const modal = document.getElementById("playerModal");
      if(typeof modal.close === "function"){
        modal.close();
      }else{
        modal.removeAttribute("open");
      }
    }

    function setupPlayerModal(){
      const modal = document.getElementById("playerModal");
      const closeBtn = document.getElementById("playerModalClose");

      document.addEventListener("click", (event) => {
        const trigger = event.target.closest(".player-btn[data-player]");
        if(!trigger) return;
        const player = String(trigger.getAttribute("data-player") || "").trim();
        if(!player || /^TBD$/i.test(player) || /^QF\b/i.test(player)) return;
        openPlayerModal(player);
      });

      closeBtn.addEventListener("click", closePlayerModal);

      modal.addEventListener("click", (event) => {
        if(event.target === modal) closePlayerModal();
      });
    }

    function numericScore(value){
      const str = String(value ?? "").trim();
      if(str === "") return null;
      const n = Number(str);
      return Number.isFinite(n) ? n : null;
    }

    function parseScheduleRows(values){
      const byWeek = new Map();

      values.forEach((row = []) => {
        const week = String(row[0] ?? "").trim();
        const division = String(row[1] ?? "").trim();

        const p1Name = String(row[3] ?? "").trim();
        const p2Name = String(row[12] ?? "").trim();
        if(!week || !division || (!p1Name && !p2Name)) return;

        const round1P1 = row[4];
        const round2P1 = row[5];
        const round3P1 = row[6];
        const gamesWonP1 = row[7];
        const resultP1 = String(row[10] ?? "").trim().toUpperCase();

        const round1P2 = row[13];
        const round2P2 = row[14];
        const round3P2 = row[15];
        const gamesWonP2 = row[16];
        const resultP2 = String(row[19] ?? "").trim().toUpperCase();

        const matchup = {
          division,
          p1: { name: p1Name, rounds: [round1P1, round2P1, round3P1], gamesWon: gamesWonP1, result: resultP1 },
          p2: { name: p2Name, rounds: [round1P2, round2P2, round3P2], gamesWon: gamesWonP2, result: resultP2 },
        };

        if(!byWeek.has(week)) byWeek.set(week, []);
        byWeek.get(week).push(matchup);
      });

      const weekSort = (a, b) => {
        const an = Number(a), bn = Number(b);
        if(Number.isFinite(an) && Number.isFinite(bn)) return an - bn;
        return a.localeCompare(b, undefined, { numeric: true, sensitivity: "base" });
      };

      return Array.from(byWeek.keys())
        .sort(weekSort)
        .map((week) => ({ week, matchups: byWeek.get(week) || [] }));
    }

    function isRoundWinner(roundA, roundB){
      const a = numericScore(roundA);
      const b = numericScore(roundB);
      if(a === null || b === null) return { a: false, b: false };
      if(a < b) return { a: true, b: false };
      if(b < a) return { a: false, b: true };
      return { a: true, b: true };
    }

    function renderMatchup(matchup){
      return renderMatchupCard(matchup);
    }

    function renderMatchupCard(matchup, options = {}){
      const showSeeds = options.showSeeds === true;
      const winnerHighlight = options.winnerHighlight || "";
      const loserHighlight = options.loserHighlight || "";
      const card = document.createElement("article");
      card.className = "match-card";

      const roundWinners = [
        isRoundWinner(matchup.p1.rounds[0], matchup.p2.rounds[0]),
        isRoundWinner(matchup.p1.rounds[1], matchup.p2.rounds[1]),
        isRoundWinner(matchup.p1.rounds[2], matchup.p2.rounds[2]),
      ];

      const p1Winner = matchup.p1.result === "W";
      const p2Winner = matchup.p2.result === "W";
      const p1QfClass = isQfPlayerName(matchup.p1.name) ? " qf-player" : "";
      const p2QfClass = isQfPlayerName(matchup.p2.name) ? " qf-player" : "";

      const p1Row = document.createElement("div");
      const p1HighlightClass = p1Winner ? winnerHighlight : (p2Winner ? loserHighlight : "");
      p1Row.className = `match-row${p1Winner ? " winner" : ""}${p1HighlightClass ? ` ${p1HighlightClass}` : ""}`;
      p1Row.innerHTML = `
        ${showSeeds ? `<div class="match-seed">${formatStatValue(matchup.p1.seed, "—")}</div>` : ""}
        <div class="match-player${p1QfClass}">${formatPlayerLabel(matchup.p1.name)}</div>
        <div class="match-stats">
          <div class="stat games">${formatStatValue(matchup.p1.gamesWon, "–")}</div>
          <span class="round-score${(!roundWinners[0].a && roundWinners[0].b) ? " losing-score" : ""}">${formatStatValue(matchup.p1.rounds[0], "–")}</span>
          <span class="round-score${(!roundWinners[1].a && roundWinners[1].b) ? " losing-score" : ""}">${formatStatValue(matchup.p1.rounds[1], "–")}</span>
          <span class="round-score${(!roundWinners[2].a && roundWinners[2].b) ? " losing-score" : ""}">${formatStatValue(matchup.p1.rounds[2], "–")}</span>
        </div>
      `;

      const p2Row = document.createElement("div");
      const p2HighlightClass = p2Winner ? winnerHighlight : (p1Winner ? loserHighlight : "");
      p2Row.className = `match-row${p2Winner ? " winner" : ""}${p2HighlightClass ? ` ${p2HighlightClass}` : ""}`;
      p2Row.innerHTML = `
        ${showSeeds ? `<div class="match-seed">${formatStatValue(matchup.p2.seed, "—")}</div>` : ""}
        <div class="match-player${p2QfClass}">${formatPlayerLabel(matchup.p2.name)}</div>
        <div class="match-stats">
          <div class="stat games">${formatStatValue(matchup.p2.gamesWon, "–")}</div>
          <span class="round-score${(!roundWinners[0].b && roundWinners[0].a) ? " losing-score" : ""}">${formatStatValue(matchup.p2.rounds[0], "–")}</span>
          <span class="round-score${(!roundWinners[1].b && roundWinners[1].a) ? " losing-score" : ""}">${formatStatValue(matchup.p2.rounds[1], "–")}</span>
          <span class="round-score${(!roundWinners[2].b && roundWinners[2].a) ? " losing-score" : ""}">${formatStatValue(matchup.p2.rounds[2], "–")}</span>
        </div>
      `;

      card.appendChild(p1Row);
      card.appendChild(p2Row);
      return card;
    }

    function renderLabeledMatch(matchup, labelText, options = {}){
      const wrap = document.createElement("section");
      wrap.className = "match-labeled";

      const label = document.createElement("p");
      label.className = "match-label";
      label.textContent = labelText;

      wrap.appendChild(label);
      wrap.appendChild(renderMatchupCard(matchup, { showSeeds: true, ...options }));
      return wrap;
    }

    function parsePlayoffRows(values){
      return values.map((row = []) => ({
        p1: {
          seed: String(row[2] ?? "").trim(),
          name: String(row[3] ?? "").trim(),
          rounds: [row[4], row[5], row[6]],
          gamesWon: row[7],
          result: String(row[10] ?? "").trim().toUpperCase(),
        },
        p2: {
          seed: String(row[11] ?? "").trim(),
          name: String(row[12] ?? "").trim(),
          rounds: [row[13], row[14], row[15]],
          gamesWon: row[16],
          result: String(row[19] ?? "").trim().toUpperCase(),
        },
      }));
    }

    function renderPlayoffs(){
      const semifinalsEl = document.getElementById("playoffSemifinals");
      const championshipEl = document.getElementById("playoffChampionship");
      const thirdPlaceEl = document.getElementById("playoffThirdPlace");
      const oneOffsEl = document.getElementById("playoffOneOffs");

      semifinalsEl.innerHTML = "";
      championshipEl.innerHTML = "";
      thirdPlaceEl.innerHTML = "";
      oneOffsEl.innerHTML = "";

      if(playoffMatchups.length < 6) return;

      semifinalsEl.appendChild(renderLabeledMatch(playoffMatchups[0], "Division 1 Semi-Final"));
      semifinalsEl.appendChild(renderLabeledMatch(playoffMatchups[1], "Division 1 Semi-Final"));
      championshipEl.appendChild(renderLabeledMatch(playoffMatchups[2], "Division 1 Championship", { winnerHighlight: "highlight-gold", loserHighlight: "highlight-silver" }));
      thirdPlaceEl.appendChild(renderLabeledMatch(playoffMatchups[3], "Division 1 3rd Place", { winnerHighlight: "highlight-bronze" }));
      oneOffsEl.appendChild(renderLabeledMatch(playoffMatchups[4], "Division 1/2 Playoff"));
      oneOffsEl.appendChild(renderLabeledMatch(playoffMatchups[5], "Division 2/3 Playoff"));
      requestAnimationFrame(updatePlayoffBracketLayout);
    }

    function updatePlayoffBracketLayout(){
      const bracketRow = document.querySelector(".playoff-bracket-row");
      const semifinalsEl = document.getElementById("playoffSemifinals");
      const championshipEl = document.getElementById("playoffChampionship");
      const connectorEl = document.querySelector(".playoff-connector");
      if(!bracketRow || !semifinalsEl || !championshipEl || !connectorEl) return;

      bracketRow.style.setProperty("--playoff-finals-offset", "0px");

      if(getComputedStyle(connectorEl).display === "none") return;

      const semifinalMatches = semifinalsEl.querySelectorAll(".match-labeled");
      const championshipMatch = championshipEl.querySelector(".match-labeled");
      if(semifinalMatches.length < 2 || !championshipMatch) return;

      const topSemiRect = semifinalMatches[0].getBoundingClientRect();
      const bottomSemiRect = semifinalMatches[1].getBoundingClientRect();
      const champRect = championshipMatch.getBoundingClientRect();

      if(!topSemiRect.height || !bottomSemiRect.height || !champRect.height) return;

      const targetChampCenter = (topSemiRect.top + topSemiRect.height / 2 + bottomSemiRect.top + bottomSemiRect.height / 2) / 2;
      const currentChampCenter = champRect.top + champRect.height / 2;
      bracketRow.style.setProperty("--playoff-finals-offset", `${targetChampCenter - currentChampCenter}px`);

      const rowRect = bracketRow.getBoundingClientRect();
      const topSemiRectShifted = semifinalMatches[0].getBoundingClientRect();
      const bottomSemiRectShifted = semifinalMatches[1].getBoundingClientRect();
      const champRectShifted = championshipMatch.getBoundingClientRect();

      const connectorYOffset = 8;
      bracketRow.style.setProperty("--semi-top-center", `${topSemiRectShifted.top + topSemiRectShifted.height / 2 - rowRect.top + connectorYOffset}px`);
      bracketRow.style.setProperty("--semi-bottom-center", `${bottomSemiRectShifted.top + bottomSemiRectShifted.height / 2 - rowRect.top + connectorYOffset}px`);
      bracketRow.style.setProperty("--champ-center", `${champRectShifted.top + champRectShifted.height / 2 - rowRect.top + connectorYOffset}px`);
    }

    function renderScheduleWeek(){
      const wrap = document.getElementById("scheduleWrap");
      const titleEl = document.getElementById("scheduleTitle");
      const gridEl = document.getElementById("scheduleGrid");
      const prevBtn = document.getElementById("weekPrev");
      const nextBtn = document.getElementById("weekNext");

      if(!scheduleWeeks.length){
        wrap.hidden = true;
        return;
      }

      wrap.hidden = false;
      const weekData = scheduleWeeks[currentWeekIdx];
      titleEl.textContent = `Week ${weekData.week} Schedule & Results`;
      prevBtn.disabled = currentWeekIdx <= 0;
      nextBtn.disabled = currentWeekIdx >= scheduleWeeks.length - 1;

      const divisionMap = new Map([
        ["1", []], ["2", []], ["3", []],
        ["Division 1", []], ["Division 2", []], ["Division 3", []],
      ]);

      weekData.matchups.forEach((m) => {
        if(divisionMap.has(m.division)) divisionMap.get(m.division).push(m);
      });

      const normalizeDivision = (idx) => {
        if(divisionMap.get(String(idx)).length) return divisionMap.get(String(idx));
        return divisionMap.get(`Division ${idx}`);
      };

      gridEl.innerHTML = "";
      [1, 2, 3].forEach((divNum) => {
        const pane = document.createElement("section");
        pane.className = `schedule-division ${divisionClassFromLabel(divNum)}`.trim();

        const h3 = document.createElement("h3");
        h3.className = `schedule-division-title ${divisionClassFromLabel(divNum)}`.trim();
        h3.textContent = `Division ${divNum}`;
        pane.appendChild(h3);

        const matchups = normalizeDivision(divNum) || [];
        if(!matchups.length){
          const empty = document.createElement("p");
          empty.className = "schedule-empty";
          empty.textContent = "No matchups available.";
          pane.appendChild(empty);
        }else{
          const matchGrid = document.createElement("div");
          matchGrid.className = "match-grid";
          matchups.forEach((m) => matchGrid.appendChild(renderMatchup(m)));
          pane.appendChild(matchGrid);
        }

        gridEl.appendChild(pane);
      });
    }

    function setupScheduleNav(){
      const prevBtn = document.getElementById("weekPrev");
      const nextBtn = document.getElementById("weekNext");

      prevBtn.addEventListener("click", () => {
        if(currentWeekIdx <= 0) return;
        currentWeekIdx -= 1;
        renderScheduleWeek();
      });

      nextBtn.addEventListener("click", () => {
        if(currentWeekIdx >= scheduleWeeks.length - 1) return;
        currentWeekIdx += 1;
        renderScheduleWeek();
      });
    }

    function renderQualifierSeeds(values){
      const listEl = document.getElementById("qualifierSeedList");
      const rows = values
        .slice(1)
        .map((row = []) => ({
          seed: String(row[0] ?? "").trim(),
          player: String(row[1] ?? "").trim(),
        }))
        .filter((row) => row.seed || row.player);

      listEl.innerHTML = "";
      if(!rows.length){
        listEl.innerHTML = '<p class="schedule-empty" style="text-align:center;">No qualifier signups available.</p>';
        return;
      }

      const head = document.createElement("div");
      head.className = "qualifier-seed-head";
      head.innerHTML = "<div>Seed</div><div>Player</div>";
      listEl.appendChild(head);

      rows.forEach((row) => {
        const item = document.createElement("article");
        item.className = "qualifier-seed-row";
        item.innerHTML = `
          <div class="qualifier-seed-number">${escapeHtml(row.seed || "—")}</div>
          <div class="qualifier-seed-player">${escapeHtml(row.player || "TBD")}</div>
        `;
        listEl.appendChild(item);
      });
    }

    function parseQualifierBracketRows(values){
      return values
        .map((row = []) => ({
          matchNumber: String(row[0] ?? "").trim(),
          round: String(row[1] ?? "").trim().toUpperCase(),
          p1: {
            seed: String(row[2] ?? "").trim(),
            name: String(row[3] ?? "").trim(),
            score: String(row[4] ?? "").trim(),
          },
          p2: {
            seed: String(row[5] ?? "").trim(),
            name: String(row[6] ?? "").trim(),
            score: String(row[7] ?? "").trim(),
          },
        }))
        .filter((row) => row.matchNumber && row.round);
    }

    function isQualifierRowWinner(playerScore, opponentScore){
      const p = Number(String(playerScore ?? "").trim());
      const o = Number(String(opponentScore ?? "").trim());
      if(!Number.isFinite(p) || !Number.isFinite(o)) return false;
      return p > o;
    }

    function normalizeQualifierRoundLabel(round){
      const text = String(round ?? "").trim().toUpperCase();
      if(text === "R64" || text === "R32" || text === "R16" || text === "QF" || text === "SF" || text === "FINAL") return text;
      if(text === "R8") return "QF";
      if(text === "R4") return "SF";
      if(text === "R2") return "FINAL";
      return "";
    }

    function isByePlayer(name){
      return String(name ?? "").trim().toUpperCase() === "BYE";
    }

    function renderQualifierBracketMatch(matchup){
      const wrap = document.createElement("article");
      wrap.className = "qualifier-bracket-match";

      const label = document.createElement("div");
      label.className = "qualifier-match-number";
      label.textContent = matchup.matchNumber || "—";

      const card = document.createElement("div");
      card.className = "qualifier-match-card";

      const p1Winner = isQualifierRowWinner(matchup.p1.score, matchup.p2.score);
      const p2Winner = isQualifierRowWinner(matchup.p2.score, matchup.p1.score);
      const p1ByeClass = isByePlayer(matchup.p1.name) ? " is-bye" : "";
      const p2ByeClass = isByePlayer(matchup.p2.name) ? " is-bye" : "";

      const p1 = document.createElement("div");
      p1.className = `qualifier-match-row${p1Winner ? " winner" : ""}`;
      p1.innerHTML = `
        <div class="qualifier-player-seed">${escapeHtml(matchup.p1.seed)}</div>
        <div class="qualifier-player-name${p1ByeClass}">${escapeHtml(matchup.p1.name)}</div>
        <div class="qualifier-player-score">${escapeHtml(matchup.p1.score)}</div>
      `;

      const p2 = document.createElement("div");
      p2.className = `qualifier-match-row${p2Winner ? " winner" : ""}`;
      p2.innerHTML = `
        <div class="qualifier-player-seed">${escapeHtml(matchup.p2.seed)}</div>
        <div class="qualifier-player-name${p2ByeClass}">${escapeHtml(matchup.p2.name)}</div>
        <div class="qualifier-player-score">${escapeHtml(matchup.p2.score)}</div>
      `;

      card.appendChild(p1);
      card.appendChild(p2);
      wrap.appendChild(label);
      wrap.appendChild(card);
      return wrap;
    }

   function renderQualifierBracket(values) {
      const bracketEl = document.getElementById("qualifierBracketGrid");
      const rounds = ["R64", "R32", "R16", "QF", "SF", "FINAL"];
      const rows = parseQualifierBracketRows(values);
    
      bracketEl.innerHTML = "";
    
      if (!rows.length) {
        bracketEl.innerHTML =
          '<p class="qualifier-bracket-empty">No qualifier bracket data available yet.</p>';
        return;
      }
    
      const baseGap = 8;
    
      // Previous round measurements (measured AFTER styles are applied)
      let prevStep = null;         // top-to-top distance between consecutive matches in previous round
      let prevMatchHeight = null;  // height of a match in previous round
    
      // ✅ Cumulative top offset so later rounds don't "reset" to baseline
      let cumulativeTopPadding = 0;
    
      rounds.forEach((roundLabel, idx) => {
        const matches = rows.filter(
          (row) => normalizeQualifierRoundLabel(row.round) === roundLabel
        );
        if (!matches.length) return;
    
        const col = document.createElement("section");
        col.className = "qualifier-round-column";
    
        const title = document.createElement("h3");
        title.className = "qualifier-round-title";
        title.textContent = roundLabel;
    
        const stack = document.createElement("div");
        stack.className = "qualifier-round-stack";
    
        // Render matches first
        matches.forEach((matchup) => {
          stack.appendChild(renderQualifierBracketMatch(matchup));
        });
    
        col.appendChild(title);
        col.appendChild(stack);
        bracketEl.appendChild(col);
    
        const matchEls = Array.from(stack.children);
        if (!matchEls.length) return;
    
        // Measure current match height
        const r0Pre = matchEls[0].getBoundingClientRect();
        const currMatchHeight = r0Pre.height;
    
        const hasPrev = idx > 0 && prevStep != null && prevMatchHeight != null;
    
        // Gap growth: doubles previous step, then subtract current match height
        const roundGap = hasPrev
          ? (2 * prevStep) - currMatchHeight
          : baseGap;

        stack.style.gap = `${roundGap}px`;
        stack.style.setProperty("--qualifier-round-gap", `${roundGap}px`);
    
        // ✅ Keep R32 exactly as before, but increase padding for later rounds by accumulating.
        if (hasPrev) {
          cumulativeTopPadding += (prevStep / 2);
        } else {
          cumulativeTopPadding = 0;
        }
        stack.style.paddingTop = `${cumulativeTopPadding}px`;
        stack.style.setProperty("--qualifier-round-padding-top", `${cumulativeTopPadding}px`);
    
        // IMPORTANT: re-measure AFTER applying gap + paddingTop
        const r0 = matchEls[0].getBoundingClientRect();
        prevMatchHeight = r0.height;
    
        if (matchEls.length >= 2) {
          const r1 = matchEls[1].getBoundingClientRect();
          prevStep = r1.top - r0.top;
        } else {
          prevStep = prevMatchHeight + roundGap;
        }
      });
    }

    async function loadQualifiers(){
      const [qualifierValues, bracketValues] = await Promise.all([
        fetchRange(QUALIFIER_LIST_RANGE, "Season 6 Qualifiers"),
        fetchRange(QUALIFIER_BRACKET_RANGE, QUALIFIER_BRACKET_SHEET),
      ]);
      renderQualifierSeeds(qualifierValues);
      renderQualifierBracket(bracketValues);
    }

    async function loadRankings(){
      const statusEl = document.getElementById("status");
      const errorEl = document.getElementById("error");
      const gridEl = document.getElementById("divisionGrid");

      try{
        const all = await Promise.all([
          ...DIVISIONS.map((division) => fetchRange(division.range)),
          fetchRange(SCHEDULE_RANGE),
          fetchRange(PLAYOFF_RANGE),
          loadQualifiers(),
        ]);
        const scheduleRows = all[DIVISIONS.length] || [];
        const playoffRows = all[DIVISIONS.length + 1] || [];
        const headToHeadByDivision = buildHeadToHeadByDivision(scheduleRows);
        playoffMatchups = parsePlayoffRows(playoffRows);
        playoffMetadata = derivePlayoffMetadata(playoffMatchups);
        updateStandingsLegend(playoffMetadata);

        gridEl.innerHTML = "";
        playerDivisionLookup.clear();

        DIVISIONS.forEach((division, idx) => {
          gridEl.appendChild(renderDivision(division, all[idx], headToHeadByDivision, playoffMetadata));
        });

        playerStatsLookup.clear();
        Array.from(gridEl.querySelectorAll(".rankings tbody tr")).forEach((tr) => {
          const playerName = tr.querySelector(".col-player .player-btn")?.textContent?.trim();
          if(!playerName) return;
          playerStatsLookup.set(playerName.toUpperCase(), {
            rank: tr.querySelector(".col-rank")?.textContent?.trim() || "—",
            matches: tr.querySelector(".col-matches")?.textContent?.trim() || "—",
            games: tr.querySelector(".col-games")?.textContent?.trim() || "—",
            diff: tr.querySelector(".col-diff")?.textContent?.trim() || "—",
          });
        });

        scheduleWeeks = parseScheduleRows(scheduleRows);
        currentWeekIdx = 0;
        renderScheduleWeek();
        renderPlayoffs();

        statusEl.textContent = "";
      }catch(err){
        statusEl.textContent = "Could not load rankings.";
        errorEl.textContent = String(err?.message || err || "Unknown error");
        errorEl.classList.add("show");
      }
    }

    setupViewNav();
    setupScheduleNav();
    setupPlayerModal();
    window.addEventListener("resize", updatePlayoffBracketLayout);
    loadRankings();
  </script>
</body>
</html>

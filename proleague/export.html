<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shotgun Pro League — PNG Exports</title>

  <!-- html2canvas for PNG rendering -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg1:#061C3B; --bg2:#04142E; --bg3:#020B18;

      --card-bg: rgba(15,23,42,1);
      --card-shadow: 0 32px 32px rgba(0,0,0,0.65);
      --header-bg: rgba(148,163,184,0.12);
      --row-bg: rgba(255,255,255,0.06);

      --text: #e9eef8;
      --title: #c7d7ff;
      --muted: #9ca3c7;

      --gold:  #ffd700;
      --silver:#c0c0c0;
      --bronze:#cd7f32;

      --logo-slot: 40px;

      /* Columns (reduced name column) */
      --rank-col: 100px;
      --score-col: 120px;
      --name-col: 460px;

      /* Weekly (desktop includes 2 rounds; name reduced so TOTAL matches other cards) */
      --wk-rank-col: 100px;
      --wk-round-col: 88px;
      --wk-score-col: 120px;
      --wk-name-col: calc(var(--name-col) - var(--wk-round-col) - var(--wk-round-col));

      /* Mobile weekly: no rounds => name fills full name-col */
      --wk-name-col-mobile: var(--name-col);

      /* (Nudge removed) */
      --text-nudge: 0px;
    }

    *{ box-sizing:border-box; }

    /* ✅ Mobile text autosizing control (prevents iOS/Safari “helpful” changes) */
    html{
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    body{
      margin:0;
      min-height:100vh;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(to bottom, var(--bg1), var(--bg2), var(--bg3));
    }

    .topbar{
      position: sticky; top:0; z-index:10;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(3,18,42,.70);
      backdrop-filter: blur(10px);
    }
    .topbar-inner{
      max-width:1200px;
      margin:0 auto;
      padding: 14px 18px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .kicker{
      font-size:11px;
      letter-spacing:.25em;
      text-transform:uppercase;
      color: rgba(255,255,255,.65);
      font-weight:900;
    }
    .status{
      margin-top: 6px;
      font-size: 12px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .14em;
      color: rgba(255,255,255,0.75);
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .select{
      appearance:none;
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      padding: 10px 38px 10px 12px;
      border-radius: 12px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: 12px;
      cursor:pointer;
      outline:none;
    }
    .btn{
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 900; /* was 950 */
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: 11px;
      cursor: pointer;
      line-height: 1;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.28); }

    .container{
      max-width:1200px;
      margin:0 auto;
      padding: 18px 18px 48px;
      display:grid;
      gap: 16px;
    }

    /* PNG previews (right-click save) */
    .png-grid{
      display:grid;
      gap: 16px;
      justify-items: start;
    }

    /* ✅ Allow horizontal scroll on mobile instead of squishing */
    .png-wrap{
      display:inline-block;
      width: fit-content;
      max-width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
    }

    /* ✅ Don’t force max-width:100% scaling (can cause resampling artifacts) */
    .png-img{
      display:block;
      width: auto;        /* JS sets exact pixel width */
      max-width: none;    /* was 100% */
      height: auto;
      border-radius: 20px;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255,255,255,0.10);
      user-select: none;
      -webkit-user-drag: none;
      cursor: context-menu;
    }

    /* Hidden render surface */
    .render-surface{
      position:absolute;
      left:-10000px;
      top:0;
      width: max-content;
      height: max-content;
      opacity: 0;
      pointer-events:none;
    }

    .card{
      background: var(--card-bg);
      border-radius: 20px;
      padding: 18px 18px;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255,255,255,0.08);
      width: fit-content;
    }
    .card-head{
      display:flex;
      gap:14px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .h2{
      font-size: 22px;
      font-weight: 900;
      color: var(--title);
      letter-spacing: .035em;
      text-transform: uppercase;
      margin: 0;
    }

    /* Rows */
    .header-row, .entry{
      display:grid;
      grid-template-columns: var(--rank-col) minmax(0, var(--name-col)) var(--score-col);
      align-items:center;
      min-width: 0;
    }
    .header-row{
      height: 40px;
      background: var(--header-bg);
      border-radius: 10px;
      font-size: 14px;
      font-weight: 800;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: .08em;
      margin-bottom: 8px;
    }
    .header-row span{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0 10px;
      height: 18px;
      min-width: 0;
    }
    .header-row span:nth-child(2){
      justify-content:flex-start;
      padding-left: 18px;
    }

    .resultsList{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }

    .entry{
      height: 48px;
      background: var(--row-bg);
      border-radius: 10px;
      overflow:hidden;
      font-size: 18px;
      font-weight: 700;
      min-width: 0;
    }

    .place{
      font-size: 22px;
      font-weight: 900;
      text-align:center;
      color: var(--title);
      padding: 0 10px;
      min-width: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      height: 100%;
      line-height: 1;
    }
    .gold{color:var(--gold);}
    .silver{color:var(--silver);}
    .bronze{color:var(--bronze);}

    .team-cell{
      width: 100%;
      height: 100%;
      padding: 0 12px;
      border:none;
      background: rgba(255,255,255,0.08);
      color:#fff;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .02em;
      overflow:hidden;
      gap: 0;
      min-width: 0;
      display:flex;
      align-items:center;
      justify-content:flex-start;
    }
    .team-logo-slot{
      width: var(--logo-slot);
      height: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0;
      flex: 0 0 auto;
    }
    .team-logo{
      height: calc(100% - 10px);
      width: auto;
      aspect-ratio: 1 / 1;
      object-fit: contain;
      display:block;
      border:none;
      outline:none;
      box-shadow:none;
    }
    .name-text{
      font-size: 20px;
      font-weight: 900; /* was 950 */
      text-transform: uppercase;
      flex: 1 1 auto;
      min-width: 0;
      padding-left: 10px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      display:flex;
      align-items:center;
      height: 100%;
      line-height: 1;
    }

    .score-col{
      background:#d9d9d9;
      color:#000;
      font-size: 20px;
      font-weight: 900;
      padding: 0 10px;
      min-width: 0;
      font-variant-numeric: tabular-nums;
      display:flex;
      align-items:center;
      justify-content:center;
      height: 100%;
      line-height: 1;
      /* (Optional spacing consistency) */
      letter-spacing: .08em;
    }

    /* Weekly (desktop default: includes rounds) */
    .weekly-header-row, .weekly-entry{
      display:grid;
      grid-template-columns: var(--wk-rank-col) minmax(0, var(--wk-name-col)) var(--wk-round-col) var(--wk-round-col) var(--wk-score-col);
      align-items:center;
      min-width: 0;
    }
    .weekly-header-row{
      height: 40px;
      background: var(--header-bg);
      border-radius: 10px;
      font-size: 14px;
      font-weight: 800;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: .08em;
      margin-bottom: 8px;
    }
    .weekly-header-row span{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0 10px;
      height: 18px;
      white-space: nowrap;
      min-width: 0;
    }
    .weekly-header-row span:nth-child(2){
      justify-content:flex-start;
      padding-left: 18px;
    }
    .weekly-entry{
      height: 48px;
      background: var(--row-bg);
      border-radius: 10px;
      overflow:hidden;
      font-size: 18px;
      font-weight: 700;
      min-width: 0;
    }
    .weekly-round{
      background: rgba(255,255,255,0.06);
      color: #ffffff;
      font-size: 16px;
      font-weight: 900;
      min-width: 0;
      font-variant-numeric: tabular-nums;
      display:flex;
      align-items:center;
      justify-content:center;
      height: 100%;
      line-height: 1;
      letter-spacing: .08em;
    }

    /* ✅ Mobile weekly: hide rounds; 3 columns only; keep width consistent */
    @media (max-width: 760px){
      .weekly-hide-mobile{ display:none !important; }
      .weekly-header-row, .weekly-entry{
        grid-template-columns: var(--wk-rank-col) minmax(0, var(--wk-name-col-mobile)) var(--wk-score-col);
      }
    }

    .hidden{ display:none !important; }

    /* Lobby Builder UI */
    .lobby-grid{
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 12px;
      align-items:start;
    }
    .lobby-box{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 12px;
    }
    .lobby-label{
      font-size: 11px;
      font-weight: 900; /* was 950 */
      text-transform: uppercase;
      letter-spacing: .14em;
      color: rgba(255,255,255,0.75);
      margin-bottom: 8px;
    }
    textarea.lobby-input{
      width: 100%;
      min-height: 140px;
      resize: vertical;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.20);
      color: rgba(255,255,255,0.92);
      padding: 10px 12px;
      outline: none;
      font-weight: 800;
      letter-spacing: .02em;
      line-height: 1.35;
    }
    .mini-status{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,0.75);
      font-weight: 800;
      line-height: 1.35;
    }
    @media (max-width: 860px){
      .lobby-grid{ grid-template-columns: 1fr; }
    }

    /* Round Lobby render card */
    .lobby-card .lobby-list{
      width: calc(var(--rank-col) + var(--name-col) + var(--score-col));
    }
    .lobby-entry{
      height: 48px;
      border-radius: 10px;
      overflow: hidden;
      background: var(--row-bg);
    }

    @media (max-width: 760px){
      :root{
        --rank-col: 72px;
        --score-col: 82px;
        --name-col: 240px;

        --wk-rank-col: 72px;
        --wk-round-col: 64px;
        --wk-score-col: 92px;
        --wk-name-col: calc(var(--name-col) - var(--wk-round-col) - var(--wk-round-col));
        --wk-name-col-mobile: var(--name-col);

        --logo-slot: 34px;
      }
      .h2{ font-size: 18px; }
      .header-row, .weekly-header-row{ height: 36px; font-size: 12px; }
      .entry, .weekly-entry{ height: 44px; }
      .lobby-entry{ height: 44px; }

      .place{ font-size: 18px; padding: 0 6px; }
      .score-col{ font-size: 16px; padding: 0 6px; }
      .name-text{ font-size: 16px; padding-left: 8px; }
      .weekly-round{ font-size: 14px; }
      .team-logo{ height: calc(100% - 8px); }
    }

    /* (nudge class remains but does nothing) */
    .txt-nudge{
      display: inline-block;
      transform: translateY(var(--text-nudge));
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div>
        <div class="kicker"><span class="txt-nudge">Shotgun Pro League — PNG Exports</span></div>
        <div class="status" id="status"><span class="txt-nudge">Loading…</span></div>
      </div>

      <div class="controls">
        <select id="seasonSelect" class="select" aria-label="Season">
          <option value="6">Season 6, Stage 1</option>
          <option value="5">Season 5</option>
          <option value="4">Season 4</option>
          <option value="3">Season 3</option>
          <option value="2">Season 2</option>
          <option value="1">Season 1</option>
        </select>
        <button id="reloadBtn" class="btn" type="button"><span class="txt-nudge">Reload Data</span></button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="png-grid" id="pngGrid">
      <div class="png-wrap"><img id="pngTeams" class="png-img" alt="Team Rankings PNG" /></div>
      <div class="png-wrap"><img id="pngPlayers" class="png-img" alt="Player Rankings PNG" /></div>
      <div class="png-wrap"><img id="pngWeekly" class="png-img" alt="Weekly Top 5 PNG" /></div>
      <div class="png-wrap hidden" id="pngLobbyWrap"><img id="pngLobby" class="png-img" alt="Round Lobby PNG" /></div>
    </div>

    <!-- Round Lobby feature at bottom -->
    <div class="card">
      <div class="card-head">
        <h2 class="h2"><span class="txt-nudge">Round Lobby Builder</span></h2>
        <div class="controls" style="justify-content:flex-end;">
          <button class="btn" id="buildLobbyBtn" type="button"><span class="txt-nudge">Build Lobby Card</span></button>
        </div>
      </div>

      <div class="lobby-grid">
        <div class="lobby-box">
          <div class="lobby-label"><span class="txt-nudge">Enter up to 8 player names</span></div>
          <textarea id="lobbyInput" class="lobby-input" placeholder="One per line (or comma-separated)"></textarea>
        </div>

        <div class="lobby-box">
          <div class="lobby-label"><span class="txt-nudge">Status</span></div>
          <div class="mini-status" id="lobbyStatus"><span class="txt-nudge">Waiting for input…</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden render surface -->
  <div class="render-surface" aria-hidden="true">
    <div id="teamsCard" class="card">
      <div class="card-head"><h2 class="h2"><span class="txt-nudge">Team Rankings</span></h2></div>
      <div class="header-row">
        <span><span class="txt-nudge">Rank</span></span>
        <span><span class="txt-nudge">Team</span></span>
        <span><span class="txt-nudge">Score</span></span>
      </div>
      <div id="teamsList" class="resultsList"></div>
    </div>

    <div id="playersCard" class="card">
      <div class="card-head"><h2 class="h2"><span class="txt-nudge">Player Rankings</span></h2></div>
      <div class="header-row">
        <span><span class="txt-nudge">Rank</span></span>
        <span style="justify-content:center;padding-left:0;"><span class="txt-nudge">Player</span></span>
        <span><span class="txt-nudge">Score</span></span>
      </div>
      <div id="playersList" class="resultsList"></div>
    </div>

    <div id="weeklyCard" class="card">
      <div class="card-head"><h2 class="h2" id="weeklyTitle"><span class="txt-nudge">Weekly Top 5</span></h2></div>

      <div class="weekly-header-row">
        <span><span class="txt-nudge">Rank</span></span>
        <span><span class="txt-nudge">Player</span></span>
        <span class="weekly-hide-mobile"><span class="txt-nudge" id="wkR1">1-1</span></span>
        <span class="weekly-hide-mobile"><span class="txt-nudge" id="wkR2">1-2</span></span>
        <span><span class="txt-nudge">Score</span></span>
      </div>

      <div id="weeklyList" class="resultsList"></div>
    </div>

    <div id="lobbyCard" class="card lobby-card hidden">
      <div class="card-head"><h2 class="h2"><span class="txt-nudge">ROUND LOBBY</span></h2></div>
      <div id="lobbyList" class="resultsList lobby-list"></div>
    </div>
  </div>

  <script>
    // ---------------- CONFIG ----------------
    const WORKER_URL  = "https://small-mud-2771.nextweekmedia.workers.dev/";
    const SHEET_ID    = "1qIM0HKhx9Y-3eCJCFzBqrbATwiPrK3C1ynATwZzRC1o";

    const SEASON_CONFIG = {
      6: { sheet: "Season 6, Stage 1", rosters: "A3:S250", teamRank: "U4:X15" },
      5: { sheet: "Season 5",         rosters: "A3:S250", teamRank: "U4:X15" },
      4: { sheet: "Season 4",         rosters: "A3:S250", teamRank: "U4:X13" },
      3: { sheet: "Season 3",         rosters: "A3:S250", teamRank: "U4:X12" },
      2: { sheet: "Season 2",         rosters: "A3:S250", teamRank: "U4:X11" },
      1: { sheet: "Season 1",         rosters: "A3:S250", teamRank: "U4:X10" },
    };

    const RANGE_PLAYER_STANDINGS_A1 = "AE4:AH101";
    const RANGE_W1_A1 = "Z4:AC13";
    const RANGE_W2_A1 = "Z16:AC25";
    const RANGE_W3_A1 = "Z28:AC37";
    const RANGE_W4_A1 = "Z40:AC49";
    const LOOKUP_RANGE_A1 = "A3:S250";

    const TEAM_LOGO_DIR = "logos";
    const TEAM_LOGO_EXT = "png";

    const TEAM_STYLES = {
      "ANIMALS":         { bg: "#2b2020", fg: "#ffffff" },
      "TERRIFIC TIGERS": { bg: "#fe6d01", fg: "#000000" },
      "BREAKERS":        { bg: "#f1c232", fg: "#1c4487" },
      "DAGGERS":         { bg: "#ea9999", fg: "#1d2244" },
      "SNIPERS":         { bg: "#275318", fg: "#ffe6cd" },
      "MCSTROKERS":      { bg: "#4d94d8", fg: "#ffffff" },
      "INFERNIX":        { bg: "#f6b26b", fg: "#000000" },
      "INFERNIX*":       { bg: "#f6b26b", fg: "#000000" },
      "DOUBLE-EAGLES":   { bg: "#1c4487", fg: "#ffffff" },
      "PHANTOM TROUPE":  { bg: "#674ea7", fg: "#ffffff" },
      "ASTERISM":        { bg: "#ba2636", fg: "#ffffff" },
      "CARROTS":         { bg: "#ff9966", fg: "#000000" },
      "SPOCCO COWS":     { bg: "#78206e", fg: "#ffffff" },
      "BURGERS":         { bg: "#7e5444", fg: "#ffffff" },
      "TREEMEISTERS":    { bg: "#2d6316", fg: "#ffffff" },
      "REVERIE":         { bg: "#d9d2e9", fg: "#00367a" },
    };

    // ---------------- DOM ----------------
    const statusEl = document.getElementById("status");
    const seasonSelect = document.getElementById("seasonSelect");
    const reloadBtn = document.getElementById("reloadBtn");

    // render targets (hidden)
    const teamsCard   = document.getElementById("teamsCard");
    const playersCard = document.getElementById("playersCard");
    const weeklyCard  = document.getElementById("weeklyCard");
    const lobbyCard   = document.getElementById("lobbyCard");

    const teamsList   = document.getElementById("teamsList");
    const playersList = document.getElementById("playersList");
    const weeklyList  = document.getElementById("weeklyList");
    const weeklyTitleEl = document.getElementById("weeklyTitle");
    const wkR1 = document.getElementById("wkR1");
    const wkR2 = document.getElementById("wkR2");

    const lobbyList = document.getElementById("lobbyList");
    const lobbyInput = document.getElementById("lobbyInput");
    const buildLobbyBtn = document.getElementById("buildLobbyBtn");
    const lobbyStatus = document.getElementById("lobbyStatus");

    // png previews (visible)
    const pngTeams  = document.getElementById("pngTeams");
    const pngPlayers= document.getElementById("pngPlayers");
    const pngWeekly = document.getElementById("pngWeekly");
    const pngLobbyWrap = document.getElementById("pngLobbyWrap");
    const pngLobby  = document.getElementById("pngLobby");

    // ---------------- HELPERS ----------------
    function escapeHtml(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }
    function rowHasAnyValue(row){
      return Array.isArray(row) && row.some(c => String(c ?? "").trim() !== "");
    }
    function slugify(name){
      return String(name).trim().toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, "");
    }
    function toNum(v){
      const s = String(v ?? "").trim();
      if(!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }
    function fmtScore(v){
      if (v === null || v === undefined) return "-";
      const s = String(v).trim();
      if (s === "") return "-";
      const n = Number(s);
      if (!Number.isFinite(n)) return s;
      if (n === 0 || Object.is(n, -0)) return "E";
      return n > 0 ? `+${n}` : String(n);
    }
    function rankClass(rank){
      return rank === 1 ? "gold" : rank === 2 ? "silver" : rank === 3 ? "bronze" : "";
    }
    function getTeamStyle(name) {
      if (!name) return null;
      const key = String(name).trim().toUpperCase();
      return TEAM_STYLES[key] || null;
    }
    function teamLogoSrc(teamName){
      const rel = `${TEAM_LOGO_DIR}/${slugify(teamName)}.${TEAM_LOGO_EXT}`;
      return new URL(rel, location.href).href;
    }

    function normalizeValues(resp){
      if(!resp) return [];
      if(Array.isArray(resp)) return resp;
      if(Array.isArray(resp.values)) return resp.values;
      if(Array.isArray(resp.data?.values)) return resp.data.values;
      if(Array.isArray(resp.result?.values)) return resp.result.values;
      return [];
    }

    async function fetchRange(range){
      const payload = { sheetId: SHEET_ID, range };

      // POST first
      try{
        const r = await fetch(WORKER_URL, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload),
        });
        if(r.ok) return normalizeValues(await r.json());
      }catch(e){}

      // fallback GET
      const u = new URL(WORKER_URL);
      u.searchParams.set("sheetId", SHEET_ID);
      u.searchParams.set("range", range);
      const r2 = await fetch(u.toString());
      if(!r2.ok){
        const text = await r2.text().catch(()=>"");
        throw new Error(`Worker request failed (${r2.status}). ${text}`.trim());
      }
      return normalizeValues(await r2.json());
    }

    function normalizeStandingsGeneric(rows){
      return (rows || [])
        .filter(rowHasAnyValue)
        .map(r=>{
          const arr = Array.isArray(r) ? r : [];
          const rank = arr[0];
          const name = arr.length >= 2 ? arr[arr.length - 2] : "";
          const score = arr.length >= 1 ? arr[arr.length - 1] : "";
          if(!rank || !name) return null;
          return {
            rank: Number(rank),
            name: String(name).trim(),
            displayName: String(name).trim().toUpperCase(),
            slug: slugify(name),
            score: (String(score ?? "").trim() !== "") ? Number(score) : null
          };
        })
        .filter(Boolean)
        .sort((a,b)=>a.rank-b.rank);
    }

    function parsePlayerTeamMap(values){
      const cleaned = (values || []).filter(rowHasAnyValue);
      const playerToTeam = new Map();
      if (!cleaned.length) return playerToTeam;

      const rows = cleaned.slice(1);
      for(let i=0; i<rows.length; i+=5){
        const teamRow = rows[i] || [];
        const teamName = String(teamRow[2] ?? "").trim();
        if(!teamName) continue;

        const playerRows = [rows[i+1], rows[i+2], rows[i+3], rows[i+4]].filter(Boolean);
        for (const pr of playerRows){
          const pName = String(pr?.[2] ?? "").trim();
          if(pName) playerToTeam.set(pName, teamName);
        }
      }
      return playerToTeam;
    }

    function parseLookupRounds(values){
      const cleaned = (values || []).filter(rowHasAnyValue);
      const byPlayer = new Map();
      if(!cleaned.length) return byPlayer;

      const rows = cleaned.slice(1);
      for (const r of rows){
        const name = String(r?.[2] ?? "").trim();
        if(!name) continue;
        const overallRank = toNum(r?.[0]);
        if (overallRank === null) continue;
        byPlayer.set(name, { rounds: Array.from({length:8}, (_,k)=> toNum(r?.[11 + k])) });
      }
      return byPlayer;
    }

    async function waitForImages(rootEl){
      const imgs = Array.from(rootEl.querySelectorAll("img"));
      await Promise.all(imgs.map(img => {
        if (img.complete) return Promise.resolve();
        return new Promise(res => {
          img.addEventListener("load", res, { once:true });
          img.addEventListener("error", res, { once:true });
        });
      }));
    }

    // ---------------- RENDER ----------------
    function makeRow({rank, label, score, bg, fg, logoSrc, rankMedals=false}){
      const row = document.createElement("div");
      row.className = "entry";

      const styleBg = bg || "rgba(255,255,255,0.08)";
      const styleFg = fg || "#ffffff";

      const nameCell = document.createElement("div");
      nameCell.className = "team-cell";
      nameCell.style.background = styleBg;
      nameCell.style.color = styleFg;

      const logo = logoSrc ? `
        <img class="team-logo"
             src="${escapeHtml(logoSrc)}"
             crossorigin="anonymous"
             alt=""
             loading="eager"
             decoding="async"
             onerror="this.style.display='none'; this.removeAttribute('src');" />
      ` : "";

      nameCell.innerHTML = `
        <span class="team-logo-slot">${logo}</span>
        <span class="name-text"><span class="txt-nudge">${escapeHtml(label)}</span></span>
      `;

      row.innerHTML = `
        <div class="place ${rankMedals ? rankClass(rank) : ""}">
          <span class="txt-nudge">${escapeHtml(rank)}</span>
        </div>
        <div class="mid"></div>
        <div class="score-col">
          <span class="txt-nudge">${escapeHtml(fmtScore(score))}</span>
        </div>
      `;
      row.querySelector(".mid").replaceWith(nameCell);
      return row;
    }

    function renderTeams(teamStandings){
      teamsList.innerHTML = "";
      teamStandings.forEach(t=>{
        const style = getTeamStyle(t.name) || {};
        teamsList.appendChild(makeRow({
          rank: t.rank,
          label: t.displayName,
          score: t.score,
          bg: style.bg,
          fg: style.fg,
          logoSrc: teamLogoSrc(t.name),
          rankMedals: true
        }));
      });
    }

    // top 10 ranks (including ties) => rank <= 10
    function renderPlayers(playerStandings, playerToTeam){
      playersList.innerHTML = "";
      const top10 = (playerStandings || []).filter(p => Number(p.rank) <= 10);
      top10.forEach(p=>{
        const teamName = playerToTeam.get(p.name) || null;
        const style = teamName ? (getTeamStyle(teamName) || {}) : {};
        playersList.appendChild(makeRow({
          rank: p.rank,
          label: p.displayName,
          score: p.score,
          bg: style.bg,
          fg: style.fg,
          logoSrc: teamName ? teamLogoSrc(teamName) : null,
          rankMedals: true
        }));
      });
    }

    function renderWeekly(weekNum, weekList, lookupRounds, playerToTeam){
      weeklyTitleEl.innerHTML = `<span class="txt-nudge">Week ${escapeHtml(weekNum)} Top 5</span>`;
      wkR1.innerHTML = `<span class="txt-nudge">${escapeHtml(weekNum)}-1</span>`;
      wkR2.innerHTML = `<span class="txt-nudge">${escapeHtml(weekNum)}-2</span>`;

      weeklyList.innerHTML = "";
      weekList.slice(0,5).forEach(p=>{
        const stat = lookupRounds.get(p.name);
        const idx1 = (weekNum - 1) * 2;
        const idx2 = idx1 + 1;
        const r1 = stat?.rounds?.[idx1] ?? null;
        const r2 = stat?.rounds?.[idx2] ?? null;

        const teamName = playerToTeam.get(p.name) || null;
        const style = teamName ? (getTeamStyle(teamName) || {}) : {};
        const bg = style.bg || "rgba(255,255,255,0.08)";
        const fg = style.fg || "#ffffff";

        const row = document.createElement("div");
        row.className = "weekly-entry";

        const nameCell = document.createElement("div");
        nameCell.className = "team-cell";
        nameCell.style.background = bg;
        nameCell.style.color = fg;

        const logo = teamName ? `
          <img class="team-logo"
               src="${escapeHtml(teamLogoSrc(teamName))}"
               crossorigin="anonymous"
               alt=""
               loading="eager"
               decoding="async"
               onerror="this.style.display='none'; this.removeAttribute('src');" />
        ` : "";

        nameCell.innerHTML = `
          <span class="team-logo-slot">${logo}</span>
          <span class="name-text"><span class="txt-nudge">${escapeHtml(p.displayName)}</span></span>
        `;

        row.innerHTML = `
          <div class="place ${rankClass(p.rank)}">
            <span class="txt-nudge">${escapeHtml(p.rank)}</span>
          </div>
          <div class="mid"></div>
          <div class="weekly-round weekly-hide-mobile">
            <span class="txt-nudge">${escapeHtml(fmtScore(r1))}</span>
          </div>
          <div class="weekly-round weekly-hide-mobile">
            <span class="txt-nudge">${escapeHtml(fmtScore(r2))}</span>
          </div>
          <div class="score-col">
            <span class="txt-nudge">${escapeHtml(fmtScore(p.score))}</span>
          </div>
        `;
        row.querySelector(".mid").replaceWith(nameCell);
        weeklyList.appendChild(row);
      });
    }

    // ---------------- PNG GENERATION (preview images on page) ----------------
    const EXPORT_SCALE = 4; // high-res

    const blobUrlByKey = new Map();
    function setPreviewImgSrc(key, imgEl, blobUrl){
      const prev = blobUrlByKey.get(key);
      if (prev && prev !== blobUrl){
        try{ URL.revokeObjectURL(prev); }catch(e){}
      }
      blobUrlByKey.set(key, blobUrl);
      imgEl.src = blobUrl;
    }

    async function buildPngBlob(cardEl){
      await waitForImages(cardEl);
      if (document.fonts && document.fonts.ready) await document.fonts.ready;

      const canvas = await html2canvas(cardEl, {
        scale: EXPORT_SCALE,
        backgroundColor: null,
        useCORS: true,
        allowTaint: false,
        logging: false,
        foreignObjectRendering: false
      });

      const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png"));
      if (!blob) throw new Error("PNG generation failed (canvas.toBlob returned null).");
      return blob;
    }

    async function renderCardToImg(cardEl, imgEl, key){
      const blob = await buildPngBlob(cardEl);
      const url = URL.createObjectURL(blob);
      setPreviewImgSrc(key, imgEl, url);

      // ✅ Stabilize preview scaling to avoid mobile resampling/kerning artifacts:
      const cssW = Math.round(cardEl.getBoundingClientRect().width);
      if (cssW > 0){
        imgEl.style.width = cssW + "px";
        imgEl.style.height = "auto";
      }
    }

    async function generateAllPreviews(hasLobby){
      statusEl.innerHTML = `<span class="txt-nudge">Generating PNG previews…</span>`;

      await renderCardToImg(teamsCard, pngTeams, "teams");
      await renderCardToImg(playersCard, pngPlayers, "players");
      await renderCardToImg(weeklyCard, pngWeekly, "weekly");

      if (hasLobby){
        pngLobbyWrap.classList.remove("hidden");
        await renderCardToImg(lobbyCard, pngLobby, "lobby");
      }

      statusEl.innerHTML = `<span class="txt-nudge">Ready</span>`;
    }

    // ---------------- LOBBY ----------------
    let state_playerToTeam = new Map();
    let state_nameResolver = new Map();

    function buildNameResolver(playerStandings){
      const m = new Map();
      const add = (n)=>{
        const s = String(n || "").trim();
        if(!s) return;
        const key = s.toUpperCase();
        if(!m.has(key)) m.set(key, s);
      };
      for (const p of playerStandings) add(p.name);
      for (const [name] of state_playerToTeam.entries()) add(name);
      state_nameResolver = m;
    }

    function parseLobbyNames(text){
      const raw = String(text || "");
      const parts = raw
        .split(/\n|,/g)
        .map(s => s.trim())
        .filter(Boolean);

      const seen = new Set();
      const out = [];
      for (const p of parts){
        const key = p.toUpperCase();
        if (seen.has(key)) continue;
        seen.add(key);
        out.push(p);
        if (out.length >= 8) break;
      }
      return out;
    }

    function resolvePlayerName(input){
      const key = String(input || "").trim().toUpperCase();
      return state_nameResolver.get(key) || null;
    }

    function renderLobbyCard(names){
      lobbyList.innerHTML = "";

      names.forEach((name)=>{
        const teamName = state_playerToTeam.get(name) || null;
        const style = teamName ? (getTeamStyle(teamName) || {}) : {};
        const bg = style.bg || "rgba(255,255,255,0.08)";
        const fg = style.fg || "#ffffff";

        const logo = teamName ? `
          <img class="team-logo"
               src="${escapeHtml(teamLogoSrc(teamName))}"
               crossorigin="anonymous"
               alt=""
               loading="eager"
               decoding="async"
               onerror="this.style.display='none'; this.removeAttribute('src');" />
        ` : "";

        const row = document.createElement("div");
        row.className = "lobby-entry";

        const cell = document.createElement("div");
        cell.className = "team-cell";
        cell.style.background = bg;
        cell.style.color = fg;

        cell.innerHTML = `
          <span class="team-logo-slot">${logo}</span>
          <span class="name-text"><span class="txt-nudge">${escapeHtml(String(name).toUpperCase())}</span></span>
        `;

        row.appendChild(cell);
        lobbyList.appendChild(row);
      });

      lobbyCard.classList.remove("hidden");
    }

    buildLobbyBtn.addEventListener("click", async ()=>{
      const requested = parseLobbyNames(lobbyInput.value);
      if (!requested.length){
        lobbyStatus.innerHTML = `<span class="txt-nudge">Please enter at least 1 name.</span>`;
        return;
      }

      const matched = [];
      const skipped = [];
      for (const n of requested){
        const canonical = resolvePlayerName(n);
        if (canonical) matched.push(canonical);
        else skipped.push(n);
      }

      if (!matched.length){
        lobbyStatus.innerHTML = `<span class="txt-nudge">No matches found.</span>`;
        return;
      }

      renderLobbyCard(matched);

      const msg = [];
      msg.push(`Built lobby with ${matched.length} player(s).`);
      if (skipped.length) msg.push(`Skipped: ${skipped.slice(0,6).join(", ")}${skipped.length>6 ? "…" : ""}`);
      lobbyStatus.innerHTML = `<span class="txt-nudge">${escapeHtml(msg.join(" "))}</span>`;

      try{
        pngLobbyWrap.classList.remove("hidden");
        statusEl.innerHTML = `<span class="txt-nudge">Generating lobby PNG…</span>`;
        await renderCardToImg(lobbyCard, pngLobby, "lobby");
        statusEl.innerHTML = `<span class="txt-nudge">Ready</span>`;
      }catch(err){
        console.error(err);
        statusEl.innerHTML = `<span class="txt-nudge">Lobby PNG failed (see console).</span>`;
      }
    });

    // ---------------- MAIN LOAD ----------------
    async function loadSeason(seasonNum){
      const cfg = SEASON_CONFIG[seasonNum] || SEASON_CONFIG[6];
      const sheet = cfg.sheet;

      statusEl.innerHTML = `<span class="txt-nudge">Loading…</span>`;

      const ranges = {
        teamStandings: `'${sheet}'!${cfg.teamRank}`,
        playerStandings: `'${sheet}'!${RANGE_PLAYER_STANDINGS_A1}`,
        wk1: `'${sheet}'!${RANGE_W1_A1}`,
        wk2: `'${sheet}'!${RANGE_W2_A1}`,
        wk3: `'${sheet}'!${RANGE_W3_A1}`,
        wk4: `'${sheet}'!${RANGE_W4_A1}`,
        rosters: `'${sheet}'!${cfg.rosters}`,
        lookup: `'${sheet}'!${LOOKUP_RANGE_A1}`,
      };

      const [
        teamRows, playerRows, wk1, wk2, wk3, wk4, rosterRows, lookupRows
      ] = await Promise.all([
        fetchRange(ranges.teamStandings),
        fetchRange(ranges.playerStandings),
        fetchRange(ranges.wk1),
        fetchRange(ranges.wk2),
        fetchRange(ranges.wk3),
        fetchRange(ranges.wk4),
        fetchRange(ranges.rosters),
        fetchRange(ranges.lookup),
      ]);

      const teamStandings = normalizeStandingsGeneric(teamRows);
      const playerStandingsAll = normalizeStandingsGeneric(playerRows);

      state_playerToTeam = parsePlayerTeamMap(rosterRows);
      const lookupRounds = parseLookupRounds(lookupRows);
      buildNameResolver(playerStandingsAll);

      const weeklyByWeek = new Map();
      const w1 = normalizeStandingsGeneric(wk1);
      const w2 = normalizeStandingsGeneric(wk2);
      const w3 = normalizeStandingsGeneric(wk3);
      const w4 = normalizeStandingsGeneric(wk4);
      if (w1.length) weeklyByWeek.set(1, w1);
      if (w2.length) weeklyByWeek.set(2, w2);
      if (w3.length) weeklyByWeek.set(3, w3);
      if (w4.length) weeklyByWeek.set(4, w4);

      const weeks = Array.from(weeklyByWeek.keys()).sort((a,b)=>b-a);
      const latestWeek = weeks.length ? weeks[0] : 1;
      const latestList = weeklyByWeek.get(latestWeek) || [];

      renderTeams(teamStandings);
      renderPlayers(playerStandingsAll, state_playerToTeam);

      if (latestList.length){
        renderWeekly(latestWeek, latestList, lookupRounds, state_playerToTeam);
      } else {
        weeklyTitleEl.innerHTML = `<span class="txt-nudge">Weekly Top 5</span>`;
        wkR1.innerHTML = `<span class="txt-nudge">1-1</span>`;
        wkR2.innerHTML = `<span class="txt-nudge">1-2</span>`;
        weeklyList.innerHTML = `<div style="padding:14px; font-weight:900; opacity:.8; text-transform:uppercase; letter-spacing:.12em;"><span class="txt-nudge">Not posted yet.</span></div>`;
      }

      const hasLobby = !lobbyCard.classList.contains("hidden");
      await generateAllPreviews(hasLobby);
    }

    // boot
    (function boot(){
      const qs = new URLSearchParams(location.search);
      const s = Number(qs.get("season") || 6);
      if (SEASON_CONFIG[s]) seasonSelect.value = String(s);

      reloadBtn.addEventListener("click", ()=>{
        const seasonNum = Number(seasonSelect.value) || 6;
        loadSeason(seasonNum).catch(err=>{
          console.error(err);
          statusEl.innerHTML = `<span class="txt-nudge">Load failed (see console).</span>`;
          alert(err.message || "Load failed.");
        });
      });

      seasonSelect.addEventListener("change", ()=>{
        const u = new URL(location.href);
        u.searchParams.set("season", seasonSelect.value);
        history.replaceState(null, "", u.toString());
      });

      loadSeason(Number(seasonSelect.value) || 6).catch(err=>{
        console.error(err);
        statusEl.innerHTML = `<span class="txt-nudge">Load failed (see console).</span>`;
        alert(err.message || "Load failed.");
      });
    })();
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NSS Golf Super League</title>

  <style>
    :root{
      --bg1:#061C3B; --bg2:#04142E; --bg3:#020B18;

      --card-bg: rgba(15,23,42,1);
      --card-shadow: 0 32px 32px rgba(0,0,0,0.65);

      --text: #e9eef8;
      --title: #c7d7ff;
      --muted: #9ca3c7;

      --border-lite: rgba(148,163,184,0.20);
      --btn-bg: rgba(255,255,255,0.06);
      --btn-bg-hover: rgba(255,255,255,0.10);
      --btn-border: rgba(255,255,255,0.15);
      --btn-border-hover: rgba(255,255,255,0.28);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(to bottom, var(--bg1), var(--bg2), var(--bg3));
    }

    .topbar{
      position: sticky; top:0; z-index:10;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(3,18,42,.70);
      backdrop-filter: blur(10px);
    }
    .topbar-inner{
      max-width:1100px;
      margin:0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .home-badge{
      width:40px; height:40px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.05);
      display:grid; place-items:center;
      overflow:hidden;
      user-select:none;
    }
    .home-badge img{
      width:70%;
      height:70%;
      object-fit: contain;
      display:block;
      pointer-events:none;
    }

    .kicker{
      font-size:11px;
      letter-spacing:.25em;
      text-transform:uppercase;
      color: rgba(255,255,255,.65);
      font-weight:900;
    }

    .container{
      max-width:1100px;
      margin:0 auto;
      padding: 28px 18px 56px;
      display:flex;
      justify-content:center;
    }

    .card{
      width: min(920px, 100%);
      background: var(--card-bg);
      border-radius: 20px;
      padding: 26px 20px;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255,255,255,0.10);
      display:grid;
      gap:16px;
    }

    .headline{
      font-size: 22px;
      font-weight: 950;
      color: var(--title);
      letter-spacing: .035em;
      text-transform: uppercase;
      margin: 0;
      text-align: center;
    }

    .subhead{
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.45;
    }

    .status{
      color: var(--muted);
      font-size: 13px;
      margin: 0;
    }

    .division-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
      align-items:start;
    }

    .division-card{
      border: 1px solid var(--border-lite);
      border-radius: 16px;
      padding: 12px;
      background: rgba(15,23,42,0.55);
      overflow-x: auto;
    }

    .division-title{
      margin: 0 0 12px;
      font-size: 12px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: rgba(231,238,255,0.92);
      text-align: center;
    }

    table.rankings{
      width:100%;
      border-collapse: collapse;
      min-width: 0;
      table-layout: fixed;
      font-size: 12px;
    }

    .rankings thead th{
      text-align:center;
      color: rgba(231,238,255,0.9);
      font-weight: 700;
      letter-spacing: .02em;
      font-size: 10px;
      text-transform: uppercase;
      padding: 8px 6px;
      border-bottom: 1px solid rgba(255,255,255,0.20);
    }

    .rankings tbody td{
      padding: 8px 6px;
      border-bottom: 1px solid rgba(148,163,184,0.16);
      color: var(--text);
      white-space: nowrap;
      font-size: 12px;
    }

    .rankings tbody tr:last-child td{
      border-bottom: 0;
    }

    .col-rank,
    .col-matches,
    .col-games,
    .col-diff{
      width: 44px;
      text-align: center;
    }

    .col-player{
      width: 96px;
      min-width: 0;
      text-align: left;
    }

    .rankings tbody .col-player{
      text-transform: uppercase;
      font-weight: 800;
    }

    .rankings tbody .col-player.qf-player{
      color: #9ca3af;
    }

    .error{
      margin: 0;
      color: #fecaca;
      font-size: 13px;
      background: rgba(127,29,29,0.22);
      border: 1px solid rgba(248,113,113,0.45);
      border-radius: 10px;
      padding: 10px 12px;
      display:none;
    }

    .error.show{ display:block; }

    .schedule-wrap{
      margin-top: 8px;
      display:grid;
      gap:12px;
    }

    .schedule-head{
      position: relative;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: 44px;
      padding: 2px 0;
    }

    .schedule-title{
      margin:0;
      font-size: 22px;
      font-weight: 950;
      color: var(--title);
      letter-spacing: .035em;
      text-transform: uppercase;
      text-align:center;
      width:100%;
      padding: 0 54px;
      line-height: 1.1;
    }

    .nav-btn{
      position:absolute;
      top:50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      font-weight: 950;
      display:grid;
      place-items:center;
      user-select:none;
    }
    .nav-btn:hover{
      background: var(--btn-bg-hover);
      border-color: var(--btn-border-hover);
    }
    .nav-btn:disabled{ opacity:.35; cursor:not-allowed; }
    .nav-left{ left:0; }
    .nav-right{ right:0; }

    .schedule-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
      align-items:start;
    }

    .schedule-division{
      border: 1px solid var(--border-lite);
      border-radius: 16px;
      padding: 12px;
      background: rgba(15,23,42,0.55);
      min-height: 90px;
      display:grid;
      gap: 10px;
      align-content:start;
    }

    .schedule-division-title{
      text-align:center;
      margin:0;
      font-size: 12px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: rgba(231,238,255,0.92);
    }

    .schedule-empty{
      margin:0;
      color: var(--muted);
      font-size: 12px;
    }

    .match-grid{
      display:grid;
      gap:10px;
    }

    .match-card{
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      overflow:hidden;
    }

    .match-row{
      display:flex;
      align-items:stretch;
      min-height: 36px;
      background: rgba(255,255,255,0.06);
      border: 1px solid transparent;
    }
    .match-row:nth-child(2){ background: rgba(255,255,255,0.045); }
    .match-row.winner{
      background: rgba(34,197,94,0.12);
      border-color: rgba(34,197,94,0.55);
    }
    .match-row.winner:first-child{
      border-top-left-radius: 13px;
      border-top-right-radius: 13px;
    }
    .match-row.winner:last-child{
      border-bottom-left-radius: 13px;
      border-bottom-right-radius: 13px;
    }

    .match-player{
      flex: 1 1 auto;
      min-width: 0;
      padding: 8px 10px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .02em;
      white-space: nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      display:flex;
      align-items:center;
      font-size: 11px;
    }

    .match-stats{
      display:grid;
      grid-template-columns: minmax(28px, auto) repeat(3, minmax(20px, auto));
      gap:8px;
      padding: 6px 8px;
      min-width: 124px;
      align-items:center;
      justify-items:center;
      font-size: 10px;
      font-weight: 850;
      font-variant-numeric: tabular-nums;
    }

    .stat.games{
      border-radius: 4px;
      min-height: 18px;
      min-width: 24px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,0.95);
      color: #000;
      padding: 4px 8px;
      font-size: 16px;
      font-weight: 800;
    }

    .round-score{
      color: rgba(233,238,248,0.9);
      line-height: 1;
      font-size: 11px;
    }

    .round-score.losing-score{
      color: #9ca3af;
    }

    .round-score.bold-score{
      font-weight: 950;
      color: #fff;
    }

    @media (max-width: 1080px){
      .division-grid{ grid-template-columns: 1fr; }
      .schedule-grid{ grid-template-columns: 1fr; }
    }

    @media (max-width: 760px){
      .container{ padding: 20px 12px 44px; }
      .topbar-inner{ padding: 12px 12px; flex-wrap: nowrap; }
      .brand{ flex: 1; min-width: 0; }
      .headline{ font-size: 18px; }
      .card{ padding: 20px 14px; border-radius: 18px; }
      .division-card{ padding: 10px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="home-badge" aria-hidden="true">
          <img src="/logos/golf.png" alt="Home" loading="eager" decoding="async" />
        </div>
        <div>
          <div class="kicker">Super League</div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <div>
        <h1 class="headline">Season 6 Standings</h1>
      </div>

      <p class="status" id="status"></p>
      <p class="error" id="error"></p>

      <div class="division-grid" id="divisionGrid"></div>

      <section class="schedule-wrap" id="scheduleWrap" hidden>
        <div class="schedule-head">
          <button class="nav-btn nav-left" id="weekPrev" type="button" aria-label="Previous week">←</button>
          <h2 class="schedule-title" id="scheduleTitle">Week</h2>
          <button class="nav-btn nav-right" id="weekNext" type="button" aria-label="Next week">→</button>
        </div>
        <div class="schedule-grid" id="scheduleGrid"></div>
      </section>
    </div>
  </div>

  <script>
    const WORKER_URL = "https://small-mud-2771.nextweekmedia.workers.dev/";
    const SHEET_ID = "1BbT8t6erCVdx-Bdshv_hax9r9JSRzU1WygjWxW3vPkY";
    const SHEET_NAME = "Season 6";

    const DIVISIONS = [
      { title: "Division 1", range: "B3:G10" },
      { title: "Division 2", range: "B13:G20" },
      { title: "Division 3", range: "B23:G30" },
    ];
    const SCHEDULE_RANGE = "I2:AB85";

    let scheduleWeeks = [];
    let currentWeekIdx = 0;

    function normalizeValues(resp){
      if(!resp) return [];
      if(Array.isArray(resp)) return resp;
      if(Array.isArray(resp.values)) return resp.values;
      if(Array.isArray(resp.data?.values)) return resp.data.values;
      if(Array.isArray(resp.result?.values)) return resp.result.values;
      return [];
    }

    async function fetchRange(a1){
      const range = `'${SHEET_NAME}'!${a1}`;
      const payload = { sheetId: SHEET_ID, range };

      try{
        const r = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if(r.ok) return normalizeValues(await r.json());
      }catch(e){}

      const u = new URL(WORKER_URL);
      u.searchParams.set("sheetId", SHEET_ID);
      u.searchParams.set("range", range);
      const r2 = await fetch(u.toString());
      if(!r2.ok){
        const text = await r2.text().catch(() => "");
        throw new Error(`Worker request failed (${r2.status}). ${text}`.trim());
      }
      return normalizeValues(await r2.json());
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&39;");
    }

    function numOrZero(value){
      const n = Number(String(value ?? "").trim());
      return Number.isFinite(n) ? n : 0;
    }

    function formatDiff(value){
      const n = numOrZero(value);
      if(n > 0) return `+${n}`;
      if(n < 0) return `${n}`;
      return "0";
    }

    function mapRows(values){
      return values
        .map((row = []) => {
          const player = String(row[0] ?? "").trim();
          const matchesWon = numOrZero(row[1]);
          const matchesLost = numOrZero(row[2]);
          const gamesWon = numOrZero(row[3]);
          const gamesLost = numOrZero(row[4]);
          const diff = row[5];

          return {
            player,
            matches: `${matchesWon}-${matchesLost}`,
            games: `${gamesWon}-${gamesLost}`,
            diff: formatDiff(diff),
          };
        })
        .filter((row) => row.player !== "");
    }

    function renderDivision(division, values){
      const rows = mapRows(values);

      const wrapper = document.createElement("section");
      wrapper.className = "division-card";

      const title = document.createElement("h2");
      title.className = "division-title";
      title.textContent = division.title;
      wrapper.appendChild(title);

      const table = document.createElement("table");
      table.className = "rankings";
      table.innerHTML = `
        <thead>
          <tr>
            <th class="col-rank">Rank</th>
            <th class="col-player">Player</th>
            <th class="col-matches">W-L</th>
            <th class="col-games">GMS</th>
            <th class="col-diff">DIF.</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tbody = table.querySelector("tbody");

      rows.forEach((row, index) => {
        const tr = document.createElement("tr");
        const qfPlayerClass = row.player.toUpperCase().startsWith("QF") ? " qf-player" : "";
        tr.innerHTML = `
          <td class="col-rank">${index + 1}</td>
          <td class="col-player${qfPlayerClass}">${escapeHtml(row.player)}</td>
          <td class="col-matches">${escapeHtml(row.matches)}</td>
          <td class="col-games">${escapeHtml(row.games)}</td>
          <td class="col-diff">${escapeHtml(row.diff)}</td>
        `;
        tbody.appendChild(tr);
      });

      if(rows.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" style="text-align:center; color: var(--muted);">No data available.</td>`;
        tbody.appendChild(tr);
      }

      wrapper.appendChild(table);
      return wrapper;
    }

    function formatStatValue(value){
      const str = String(value ?? "").trim();
      return str === "" ? "-" : escapeHtml(str);
    }

    function numericScore(value){
      const str = String(value ?? "").trim();
      if(str === "") return null;
      const n = Number(str);
      return Number.isFinite(n) ? n : null;
    }

    function parseScheduleRows(values){
      const byWeek = new Map();

      values.forEach((row = []) => {
        const week = String(row[0] ?? "").trim();
        const division = String(row[1] ?? "").trim();

        const p1Name = String(row[3] ?? "").trim();
        const p2Name = String(row[12] ?? "").trim();
        if(!week || !division || (!p1Name && !p2Name)) return;

        const round1P1 = row[4];
        const round2P1 = row[5];
        const round3P1 = row[6];
        const gamesWonP1 = row[7];
        const resultP1 = String(row[10] ?? "").trim().toUpperCase();

        const round1P2 = row[13];
        const round2P2 = row[14];
        const round3P2 = row[15];
        const gamesWonP2 = row[16];
        const resultP2 = String(row[19] ?? "").trim().toUpperCase();

        const matchup = {
          division,
          p1: { name: p1Name, rounds: [round1P1, round2P1, round3P1], gamesWon: gamesWonP1, result: resultP1 },
          p2: { name: p2Name, rounds: [round1P2, round2P2, round3P2], gamesWon: gamesWonP2, result: resultP2 },
        };

        if(!byWeek.has(week)) byWeek.set(week, []);
        byWeek.get(week).push(matchup);
      });

      const weekSort = (a, b) => {
        const an = Number(a), bn = Number(b);
        if(Number.isFinite(an) && Number.isFinite(bn)) return an - bn;
        return a.localeCompare(b, undefined, { numeric: true, sensitivity: "base" });
      };

      return Array.from(byWeek.keys())
        .sort(weekSort)
        .map((week) => ({ week, matchups: byWeek.get(week) || [] }));
    }

    function isRoundWinner(roundA, roundB){
      const a = numericScore(roundA);
      const b = numericScore(roundB);
      if(a === null || b === null) return { a: false, b: false };
      if(a < b) return { a: true, b: false };
      if(b < a) return { a: false, b: true };
      return { a: true, b: true };
    }

    function renderMatchup(matchup){
      const card = document.createElement("article");
      card.className = "match-card";

      const roundWinners = [
        isRoundWinner(matchup.p1.rounds[0], matchup.p2.rounds[0]),
        isRoundWinner(matchup.p1.rounds[1], matchup.p2.rounds[1]),
        isRoundWinner(matchup.p1.rounds[2], matchup.p2.rounds[2]),
      ];

      const p1Winner = matchup.p1.result === "W";
      const p2Winner = matchup.p2.result === "W";

      const p1Row = document.createElement("div");
      p1Row.className = `match-row${p1Winner ? " winner" : ""}`;
      p1Row.innerHTML = `
        <div class="match-player">${escapeHtml(matchup.p1.name || "TBD")}</div>
        <div class="match-stats">
          <div class="stat games">${formatStatValue(matchup.p1.gamesWon)}</div>
          <span class="round-score${roundWinners[0].a ? " bold-score" : ""}${(!roundWinners[0].a && roundWinners[0].b) ? " losing-score" : ""}">${formatStatValue(matchup.p1.rounds[0])}</span>
          <span class="round-score${roundWinners[1].a ? " bold-score" : ""}${(!roundWinners[1].a && roundWinners[1].b) ? " losing-score" : ""}">${formatStatValue(matchup.p1.rounds[1])}</span>
          <span class="round-score${roundWinners[2].a ? " bold-score" : ""}${(!roundWinners[2].a && roundWinners[2].b) ? " losing-score" : ""}">${formatStatValue(matchup.p1.rounds[2])}</span>
        </div>
      `;

      const p2Row = document.createElement("div");
      p2Row.className = `match-row${p2Winner ? " winner" : ""}`;
      p2Row.innerHTML = `
        <div class="match-player">${escapeHtml(matchup.p2.name || "TBD")}</div>
        <div class="match-stats">
          <div class="stat games">${formatStatValue(matchup.p2.gamesWon)}</div>
          <span class="round-score${roundWinners[0].b ? " bold-score" : ""}${(!roundWinners[0].b && roundWinners[0].a) ? " losing-score" : ""}">${formatStatValue(matchup.p2.rounds[0])}</span>
          <span class="round-score${roundWinners[1].b ? " bold-score" : ""}${(!roundWinners[1].b && roundWinners[1].a) ? " losing-score" : ""}">${formatStatValue(matchup.p2.rounds[1])}</span>
          <span class="round-score${roundWinners[2].b ? " bold-score" : ""}${(!roundWinners[2].b && roundWinners[2].a) ? " losing-score" : ""}">${formatStatValue(matchup.p2.rounds[2])}</span>
        </div>
      `;

      card.appendChild(p1Row);
      card.appendChild(p2Row);
      return card;
    }

    function renderScheduleWeek(){
      const wrap = document.getElementById("scheduleWrap");
      const titleEl = document.getElementById("scheduleTitle");
      const gridEl = document.getElementById("scheduleGrid");
      const prevBtn = document.getElementById("weekPrev");
      const nextBtn = document.getElementById("weekNext");

      if(!scheduleWeeks.length){
        wrap.hidden = true;
        return;
      }

      wrap.hidden = false;
      const weekData = scheduleWeeks[currentWeekIdx];
      titleEl.textContent = `Week ${weekData.week} Schedule & Results`;
      prevBtn.disabled = currentWeekIdx <= 0;
      nextBtn.disabled = currentWeekIdx >= scheduleWeeks.length - 1;

      const divisionMap = new Map([
        ["1", []], ["2", []], ["3", []],
        ["Division 1", []], ["Division 2", []], ["Division 3", []],
      ]);

      weekData.matchups.forEach((m) => {
        if(divisionMap.has(m.division)) divisionMap.get(m.division).push(m);
      });

      const normalizeDivision = (idx) => {
        if(divisionMap.get(String(idx)).length) return divisionMap.get(String(idx));
        return divisionMap.get(`Division ${idx}`);
      };

      gridEl.innerHTML = "";
      [1, 2, 3].forEach((divNum) => {
        const pane = document.createElement("section");
        pane.className = "schedule-division";

        const h3 = document.createElement("h3");
        h3.className = "schedule-division-title";
        h3.textContent = `Division ${divNum}`;
        pane.appendChild(h3);

        const matchups = normalizeDivision(divNum) || [];
        if(!matchups.length){
          const empty = document.createElement("p");
          empty.className = "schedule-empty";
          empty.textContent = "No matchups available.";
          pane.appendChild(empty);
        }else{
          const matchGrid = document.createElement("div");
          matchGrid.className = "match-grid";
          matchups.forEach((m) => matchGrid.appendChild(renderMatchup(m)));
          pane.appendChild(matchGrid);
        }

        gridEl.appendChild(pane);
      });
    }

    function setupScheduleNav(){
      const prevBtn = document.getElementById("weekPrev");
      const nextBtn = document.getElementById("weekNext");

      prevBtn.addEventListener("click", () => {
        if(currentWeekIdx <= 0) return;
        currentWeekIdx -= 1;
        renderScheduleWeek();
      });

      nextBtn.addEventListener("click", () => {
        if(currentWeekIdx >= scheduleWeeks.length - 1) return;
        currentWeekIdx += 1;
        renderScheduleWeek();
      });
    }

    async function loadRankings(){
      const statusEl = document.getElementById("status");
      const errorEl = document.getElementById("error");
      const gridEl = document.getElementById("divisionGrid");

      try{
        const all = await Promise.all([
          ...DIVISIONS.map((division) => fetchRange(division.range)),
          fetchRange(SCHEDULE_RANGE),
        ]);
        gridEl.innerHTML = "";

        DIVISIONS.forEach((division, idx) => {
          gridEl.appendChild(renderDivision(division, all[idx]));
        });

        const scheduleRows = all[DIVISIONS.length] || [];
        scheduleWeeks = parseScheduleRows(scheduleRows);
        currentWeekIdx = 0;
        renderScheduleWeek();

        statusEl.textContent = "";
      }catch(err){
        statusEl.textContent = "Could not load rankings.";
        errorEl.textContent = String(err?.message || err || "Unknown error");
        errorEl.classList.add("show");
      }
    }

    setupScheduleNav();
    loadRankings();
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>beat aidan challenge</title>

  <style>
    :root{
      --bg1:#061C3B; --bg2:#04142E; --bg3:#020B18;
      --card-bg: rgba(15,23,42,1);
      --card-shadow: 0 32px 32px rgba(0,0,0,0.65);
      --row-bg: rgba(255,255,255,0.06);
      --row-bg-2: rgba(255,255,255,0.045);
      --text: #e9eef8;
      --title: #c7d7ff;
      --muted: rgba(255,255,255,.72);
      --link-blue: rgba(147,197,253,0.98);
      --accent: rgba(56,189,248,0.5);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(to bottom, var(--bg1), var(--bg2), var(--bg3));
      text-transform: uppercase;
    }

    a{ color: inherit; text-decoration: none; }
    a:hover{ text-decoration: underline; text-underline-offset: 3px; }

    .topbar{
      position: sticky; top:0; z-index:10;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(3,18,42,.70);
      backdrop-filter: blur(10px);
    }
    .topbar-inner{
      max-width:1100px;
      margin:0 auto;
      padding: 14px 18px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:12px; align-items:center;}

    .home-btn{
      width:40px; height:40px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.05);
      display:grid; place-items:center;
      overflow:hidden;
      text-decoration:none;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .home-btn:hover{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.25);
    }
    .home-btn img{
      width: 70%;
      height: 70%;
      object-fit: contain;
      display:block;
      pointer-events:none;
    }

    .kicker{
      font-size:11px; letter-spacing:.25em; text-transform:uppercase;
      color: rgba(255,255,255,.65); font-weight:900;
    }

    .container{
      max-width:1100px;
      margin:0 auto;
      padding: 18px 18px 48px;
    }

    .page-title{
      font-size: 26px;
      font-weight: 900;
      letter-spacing: .02em;
      color: var(--title);
      margin: 8px 0 6px;
    }

    .page-subtitle{
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 20px;
    }

    .card{
      background: var(--card-bg);
      border-radius: 20px;
      padding: 18px 18px 20px;
      box-shadow: var(--card-shadow);
    }

    .status{
      color: rgba(233,238,248,0.92);
      font-size: 16px;
      font-weight: 700;
      text-align:center;
      padding: 24px 0;
    }

    .week-card{
      background: rgba(10,22,44,0.85);
      border: 1px solid rgba(148,163,184,0.12);
      border-radius: 18px;
      padding: 16px 16px 18px;
      margin-bottom: 18px;
      position: relative;
    }

    .week-header{
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
      text-align: center;
    }

    .week-title{
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .2em;
      text-transform: uppercase;
      color: rgba(226,232,240,0.85);
    }

    .week-select{
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .2em;
      text-transform: uppercase;
      color: rgba(226,232,240,0.92);
      border: 1px solid rgba(148,163,184,0.25);
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(15,23,42,0.6);
      appearance: none;
      cursor: pointer;
    }

    .week-nav{
      position: absolute;
      top: 12px;
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.8);
      color: rgba(226,232,240,0.9);
      display: grid;
      place-items: center;
      font-size: 16px;
      cursor: pointer;
    }
    .week-nav[disabled]{
      opacity: 0.4;
      cursor: not-allowed;
    }
    .week-prev{ left: 12px; }
    .week-next{ right: 12px; }

    .table-wrap{
      width: 100%;
      overflow-x: auto;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.12);
      padding-bottom: 0;
      scrollbar-gutter: stable both-edges;
    }

    table{
      width: calc(100% + (var(--playoff-holes, 0) * var(--hole-width, 68px)));
      min-width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    thead tr,
    tbody tr{
      display: grid;
      grid-template-columns: var(--pos-width, 68px) 1fr repeat(9, var(--hole-width, 68px)) var(--total-width, 72px) repeat(var(--playoff-holes, 0), var(--hole-width, 68px));
    }

    thead th{
      text-align: center;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .12em;
      padding: 8px 10px;
      color: rgba(226,232,240,0.86);
      background: rgba(15,23,42,0.9);
      border-bottom: 1px solid rgba(148,163,184,0.18);
      position: sticky;
      top: 0;
      vertical-align: middle;
    }

    tbody td{
      padding: 10px 10px;
      text-align: center;
      font-size: 14px;
      color: rgba(226,232,240,0.92);
    }

    tbody tr:nth-child(odd){
      background: var(--row-bg);
    }
    tbody tr:nth-child(even){
      background: var(--row-bg-2);
    }

    tbody td.name{
      text-align: left;
      font-weight: 700;
      letter-spacing: .02em;
      color: rgba(255,255,255,0.85);
    }

    tbody td.total{
      font-weight: 700;
      color: rgba(255,255,255,0.85);
    }

    th.col-name,
    th.col-total,
    td.col-name,
    td.col-total{
      background: rgba(59,130,246,0.18);
    }

    .hole-score.score-gold{ color: #f5d76e; }
    .hole-score.score-purple{ color: #c084fc; }
    .hole-score.score-blue{ color: #60a5fa; }
    .hole-score.score-green{ color: #4ade80; }
    .hole-score.score-red{ color: #f87171; }

    .col-pos{ width: var(--pos-width, 68px); }
    .col-name{ width: auto; }
    .col-total{ width: var(--total-width, 72px); }
    .col-hole{ width: var(--hole-width, 68px); }

    .hole-score,
    .finish-pos{
      font-weight: 700;
    }

    .finish-gold{ color: #f5d76e; }
    .finish-silver{ color: #cbd5f5; }
    .finish-bronze{ color: #f2a65a; }

    .hole-header{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 4px;
    }

    .hole-header-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 0px;
      width: 100%;
    }

    .wind{
      font-size: 11px;
      font-weight: 700;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 2px;
      min-width: 30px;
    }

    .wind-speed{
      letter-spacing: .08em;
    }

    .wind-0{ color: rgba(255,255,255,0.9); }
    .wind-low{ color: #60a5fa; }
    .wind-mid{ color: #facc15; }
    .wind-high{ color: #c0267d; }

    .pin-position{
      font-size: 6px;
      letter-spacing: .04em;
      color: rgba(148,163,184,0.75);
      text-transform: uppercase;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      justify-content:center;
      line-height: 1.05;
    }

    .pin-position span{
      line-height: 1.05;
    }

    .pin-position.pin-single{
      justify-content:center;
    }

    .hole-number{
      font-size: 14px;
      font-weight: 800;
      color: rgba(147,197,253,0.98);
      letter-spacing: .04em;
    }

    .hole-number-row{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 4px;
    }

    .hole-par{
      font-size: 9px;
      font-weight: 700;
      color: rgba(148,163,184,0.8);
      letter-spacing: .08em;
    }

    .hole-chip{
      display:inline-block;
      min-width: 28px;
      padding: 4px 6px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.3);
      background: rgba(30,41,59,0.6);
    }

    .week-table-actions{
      display:flex;
      justify-content:flex-end;
      margin: 8px 4px 12px;
    }

    .playoff-btn{
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.8);
      color: rgba(226,232,240,0.9);
      font-size: 11px;
      font-weight: 800;
      letter-spacing: .16em;
      padding: 6px 12px;
      text-transform: uppercase;
      cursor: pointer;
    }

    .playoff-btn:hover{
      background: rgba(30,41,59,0.8);
    }

    .footer{
      text-align:center;
      color: rgba(148,163,184,0.6);
      font-size: 11px;
      margin-top: 22px;
      letter-spacing: .2em;
      text-transform: uppercase;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <a class="home-btn" href="/" aria-label="Home">
          <img src="/logos/golf.png" alt="Home" />
        </a>
        <div>
          <div class="kicker">Weekly Matches</div>
          <div class="page-title">beat aidan challenge</div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <div id="status" class="status">Loading weekly results…</div>
      <div id="weeks"></div>
    </div>

    <div class="footer">Beataidan Weekly Matches</div>
  </div>

  <script>
    const WORKER_URL = "https://small-mud-2771.nextweekmedia.workers.dev/";
    const SHEET_ID = "1sbAQKwAoHzhGaRX2aI6v79wrsU7nuO7hI8xnaOexOiM";
    const SHEET_NAME = "Inputs";
    const REFRESH_MS = 60000;

    function normalizeValues(resp){
      if(!resp) return [];
      if(Array.isArray(resp)) return resp;
      if(Array.isArray(resp.values)) return resp.values;
      if(Array.isArray(resp.data?.values)) return resp.data.values;
      if(Array.isArray(resp.result?.values)) return resp.result.values;
      return [];
    }

    async function fetchRange(a1){
      const range = `'${SHEET_NAME}'!${a1}`;
      const payload = { sheetId: SHEET_ID, range };

      try{
        const r = await fetch(WORKER_URL, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload),
        });
        if(r.ok) return normalizeValues(await r.json());
      }catch(e){}

      const u = new URL(WORKER_URL);
      u.searchParams.set("sheetId", SHEET_ID);
      u.searchParams.set("range", range);
      const r2 = await fetch(u.toString());
      if(!r2.ok){
        const text = await r2.text().catch(()=> "");
        throw new Error(`Worker request failed (${r2.status}). ${text}`.trim());
      }
      return normalizeValues(await r2.json());
    }

    function isRowEmpty(row){
      return !row || row.every(cell => String(cell ?? "").trim() === "");
    }

    function formatCell(value){
      const s = String(value ?? "").trim();
      return s === "" ? "—" : s;
    }

    function formatScoreDisplay(value){
      const s = String(value ?? "").trim();
      if(s === "") return "—";
      if(s === "0") return "E";
      return s;
    }

    function formatHoleScoreDisplay(value){
      const s = String(value ?? "").trim();
      if(s === "") return "";
      if(s === "0") return "E";
      return s;
    }

    function parseHoleHeader(raw){
      const text = String(raw ?? "").trim();
      const numbers = text.match(/\d+/g) ?? [];
      const letters = text.match(/[A-Za-z]+/g) ?? [];
      const holeNumber = numbers[0] ?? "";
      const windSpeed = numbers[1] ? Number.parseInt(numbers[1], 10) : null;
      const windDir = letters[1] ? letters[1].toUpperCase() : "";
      const pinCode = letters[0] ? letters[0].toUpperCase() : "";
      return {
        holeNumber,
        windSpeed: Number.isNaN(windSpeed) ? null : windSpeed,
        windDir,
        pinCode,
      };
    }

    function formatPinPosition(code){
      const map = { B: "back", F: "front", M: "middle", L: "left", R: "right" };
      return String(code ?? "")
        .split("")
        .map(letter => map[letter])
        .filter(Boolean)
        .join(" ");
    }

    function getWindArrow(direction){
      const arrows = {
        N: "↑",
        S: "↓",
        E: "→",
        W: "←",
        NE: "↗",
        NW: "↖",
        SE: "↘",
        SW: "↙",
      };
      return arrows[direction] ?? "";
    }

    function getWindClass(speed){
      if(speed === 0) return "wind-0";
      if(speed >= 2 && speed <= 11) return "wind-low";
      if(speed >= 13 && speed <= 22) return "wind-mid";
      if(speed >= 24 && speed <= 33) return "wind-high";
      return "";
    }

    function getFinishClass(value){
      const finish = Number.parseInt(String(value ?? "").trim(), 10);
      if(finish === 1) return "finish-gold";
      if(finish === 2) return "finish-silver";
      if(finish === 3) return "finish-bronze";
      return "";
    }

    function getParForHole(value){
      const holeNumber = Number.parseInt(String(value ?? "").trim(), 10);
      if(Number.isNaN(holeNumber)) return null;
      const parMap = {
        1: 4,
        2: 3,
        3: 5,
        4: 3,
        5: 5,
        6: 4,
        7: 4,
        8: 3,
        9: 5,
        10: 4,
        11: 3,
        12: 5,
        13: 3,
        14: 5,
        15: 4,
        16: 4,
        17: 3,
        18: 5,
        19: 4,
        20: 4,
        21: 4,
      };
      return parMap[holeNumber] ?? null;
    }

    function renderHoleHeader(hole){
      const windSpeed = hole.windSpeed;
      const windText = windSpeed !== null ? `${windSpeed}` : "—";
      const windClass = getWindClass(windSpeed);
      const arrow = windSpeed && windSpeed > 0 ? getWindArrow(hole.windDir) : "";
      const pinText = formatPinPosition(hole.pinCode);
      const pinWords = pinText ? pinText.split(" ").filter(Boolean) : [];
      const holeNumber = hole.holeNumber || "—";
      const holePar = getParForHole(holeNumber);

      return `
        <div class="hole-header">
          <div class="hole-header-top">
            <div class="pin-position ${pinWords.length === 1 ? "pin-single" : ""}">
              ${pinWords.length ? pinWords.map(word => `<span>${escapeHtml(word)}</span>`).join("") : "<span>—</span>"}
            </div>
            <div class="wind ${windClass}">
              ${arrow ? `<span class="wind-arrow">${arrow}</span>` : ""}
              <span class="wind-speed">${escapeHtml(windText)}</span>
            </div>
          </div>
          <div class="hole-number-row">
            <span class="hole-number">${escapeHtml(holeNumber)}</span>
            ${holePar ? `<span class="hole-par">${holePar}</span>` : ""}
          </div>
        </div>
      `;
    }

    function getScoreClass(value){
      const score = Number.parseInt(String(value ?? "").trim(), 10);
      if(Number.isNaN(score)) return "";
      if(score <= -3) return "score-gold";
      if(score === -2) return "score-purple";
      if(score === -1) return "score-blue";
      if(score === 0) return "score-green";
      if(score >= 1) return "score-red";
      return "";
    }

    function parseWeeks(values){
      const weeks = [];
      const blockSize = 9; // header + 8 players

      for(let i=0; i < values.length; i += blockSize){
        const header = values[i] ?? [];
        const players = values.slice(i + 1, i + 1 + 8);
        if(isRowEmpty(header) && players.every(isRowEmpty)){
          continue;
        }

        const weekNumber = (() => {
          for(const row of players){
            const w = String(row?.[0] ?? "").trim();
            if(w) return w;
          }
          return String(header?.[0] ?? "").trim() || "—";
        })();

        const holeColumns = [];
        const maxCols = Math.max(
          header.length,
          ...players.map(row => row?.length ?? 0),
        );

        for(let col = 4; col < maxCols; col += 5){
          const headerValue = String(header?.[col] ?? "").trim();
          const hasPlayerValue = players.some(row => String(row?.[col] ?? "").trim() !== "");
          if(!headerValue && !hasPlayerValue){
            continue;
          }
          const holeMeta = parseHoleHeader(headerValue);
          holeColumns.push({
            col,
            holeNumber: holeMeta.holeNumber || "—",
            windSpeed: holeMeta.windSpeed,
            windDir: holeMeta.windDir,
            pinCode: holeMeta.pinCode,
          });
        }

        const playerRows = players
          .filter(row => !isRowEmpty(row))
          .map(row => ({
            finish: formatCell(row?.[1]),
            name: formatCell(row?.[3]),
            total: row?.[2] ?? "",
            holes: holeColumns.map(hole => row?.[hole.col] ?? ""),
          }))
          .sort((a, b) => {
            const aFinish = Number.parseInt(a.finish, 10);
            const bFinish = Number.parseInt(b.finish, 10);
            const aScore = Number.isNaN(aFinish) ? Number.POSITIVE_INFINITY : aFinish;
            const bScore = Number.isNaN(bFinish) ? Number.POSITIVE_INFINITY : bFinish;
            return aScore - bScore;
          });

        if(playerRows.length){
          weeks.push({
            weekNumber,
            holeColumns,
            playerRows,
          });
        }
      }

      return weeks;
    }

    function getWeekSortValue(week){
      const match = String(week.weekNumber ?? "").match(/\d+/);
      return match ? Number.parseInt(match[0], 10) : -1;
    }

    function renderWeek(weeks, index){
      const container = document.getElementById("weeks");
      container.innerHTML = "";

      if(!weeks.length){
        container.innerHTML = `<div class="status">No match data available yet.</div>`;
        return;
      }

      const week = weeks[index];
      if(!week){
        container.innerHTML = `<div class="status">No match data available yet.</div>`;
        return;
      }

      const mainHoles = week.holeColumns.slice(0, 9);
      const playoffHoles = week.holeColumns.slice(9);

      const card = document.createElement("div");
      card.className = "week-card";

      card.innerHTML = `
        <button class="week-nav week-prev" type="button" aria-label="Previous week" ${index === 0 ? "disabled" : ""}>&larr;</button>
        <button class="week-nav week-next" type="button" aria-label="Next week" ${index === weeks.length - 1 ? "disabled" : ""}>&rarr;</button>
        <div class="week-header">
          <select class="week-select" aria-label="Select week">
            ${weeks.map((entry, i) => `
              <option value="${i}" ${i === index ? "selected" : ""}>Week ${escapeHtml(entry.weekNumber)}</option>
            `).join("")}
          </select>
        </div>
        ${playoffHoles.length ? `
          <div class="week-table-actions">
            <button class="playoff-btn" type="button">Playoff →</button>
          </div>
        ` : ""}
        <div class="table-wrap">
          <table style="--playoff-holes: ${playoffHoles.length};">
            <thead>
              <tr>
                <th class="col-pos">Pos.</th>
                <th class="col-name">Player</th>
                ${mainHoles.map(hole => `<th class="col-hole">${renderHoleHeader(hole)}</th>`).join("")}
                <th class="col-total">Score</th>
                ${playoffHoles.map(hole => `<th class="col-hole">${renderHoleHeader(hole)}</th>`).join("")}
              </tr>
            </thead>
            <tbody>
              ${week.playerRows.map(player => `
                <tr>
                  <td class="finish-pos col-pos ${getFinishClass(player.finish)}">${escapeHtml(player.finish)}</td>
                  <td class="name col-name">${escapeHtml(player.name)}</td>
                  ${mainHoles.map((_, i) => {
                    const value = player.holes[i] ?? "";
                    return `<td class="hole-score col-hole ${getScoreClass(value)}">${escapeHtml(formatHoleScoreDisplay(value))}</td>`;
                  }).join("")}
                  <td class="total col-total">${escapeHtml(formatScoreDisplay(player.total))}</td>
                  ${playoffHoles.map((_, i) => {
                    const value = player.holes[i + 9] ?? "";
                    return `<td class="hole-score col-hole ${getScoreClass(value)}">${escapeHtml(formatHoleScoreDisplay(value))}</td>`;
                  }).join("")}
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;

      container.appendChild(card);

      const select = card.querySelector(".week-select");
      const prevBtn = card.querySelector(".week-prev");
      const nextBtn = card.querySelector(".week-next");
      const playoffBtn = card.querySelector(".playoff-btn");
      const tableWrap = card.querySelector(".table-wrap");
      select?.addEventListener("change", (event) => {
        const target = event.target;
        const nextIndex = Number.parseInt(target.value, 10);
        if(Number.isNaN(nextIndex)) return;
        currentWeekIndex = nextIndex;
        renderWeek(weeks, currentWeekIndex);
      });
      prevBtn?.addEventListener("click", () => {
        if(currentWeekIndex <= 0) return;
        currentWeekIndex -= 1;
        renderWeek(weeks, currentWeekIndex);
      });
      nextBtn?.addEventListener("click", () => {
        if(currentWeekIndex >= weeks.length - 1) return;
        currentWeekIndex += 1;
        renderWeek(weeks, currentWeekIndex);
      });
      playoffBtn?.addEventListener("click", () => {
        if(!tableWrap) return;
        tableWrap.scrollTo({ left: tableWrap.scrollWidth, behavior: "smooth" });
      });
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    async function load(){
      const status = document.getElementById("status");
      status.textContent = "Loading weekly results…";
      try{
        const values = await fetchRange("A1:CH500");
        const weeks = parseWeeks(values).sort((a, b) => getWeekSortValue(a) - getWeekSortValue(b));
        currentWeekIndex = Math.max(weeks.length - 1, 0);
        status.remove();
        renderWeek(weeks, currentWeekIndex);
      }catch(err){
        status.textContent = "Unable to load weekly results.";
        console.error(err);
      }
    }

    let currentWeekIndex = 0;
    load();
    setInterval(load, REFRESH_MS);
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shotgun Pro League</title>

  <style>
    :root{
      --bg1:#061C3B; --bg2:#04142E; --bg3:#020B18;

      --card-bg: rgba(15,23,42,1);
      --card-shadow: 0 32px 32px rgba(0,0,0,0.65);
      --header-bg: rgba(148,163,184,0.12);
      --row-bg: rgba(255,255,255,0.06);
      --row-bg-2: rgba(255,255,255,0.045);
      --text: #e9eef8;
      --title: #c7d7ff;
      --muted: #9ca3c7;

      --border-lite: rgba(148,163,184,0.20);
      --sep: rgba(148,163,184,0.26);

      --top10-bg: rgba(16,185,129,0.18);

      --gold:  #ffd700;
      --silver:#c0c0c0;
      --bronze:#cd7f32;

      --logo-slot: 40px;

      /* Desktop-first row sizing */
      --rank-col: 100px;
      --score-col: 120px;

      --wk-rank-col: 100px;
      --wk-round-col: 88px;
      --wk-score-col: 120px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(to bottom, var(--bg1), var(--bg2), var(--bg3));
    }

    /* Topbar */
    .topbar{
      position: sticky; top:0; z-index:10;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(3,18,42,.70);
      backdrop-filter: blur(10px);
    }
    .topbar-inner{
      max-width:1100px;
      margin:0 auto;
      padding: 14px 18px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:12px; align-items:center;}

    .home-btn{
      width:40px; height:40px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.05);
      display:grid; place-items:center;
      overflow:hidden;
      text-decoration:none;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .home-btn:hover{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.25);
    }
    .home-btn img{
      width: 70%;
      height: 70%;
      object-fit: contain;
      display:block;
      pointer-events:none;
    }

    .kicker{font-size:11px; letter-spacing:.25em; text-transform:uppercase; color: rgba(255,255,255,.65); font-weight:900;}
    .page-nav-select{
      background: rgba(2,6,23,.85);
      color: inherit;
      border: 1px solid rgba(125,211,252,.35);
      border-radius: 10px;
      padding: 6px 32px 6px 10px;
      font: inherit;
      letter-spacing: inherit;
      text-transform: uppercase;
      max-width: min(56vw, 420px);
      cursor: pointer;
    }
    .page-nav-select:focus-visible{
      outline: 2px solid rgba(125,211,252,.6);
      outline-offset: 2px;
    }


    /* Dropdowns */
    .select-wrap{
      display:flex;
      align-items:center;
      gap:10px;
      position: relative;
    }
    .select-label{
      font-size: 11px;
      letter-spacing: .22em;
      text-transform: uppercase;
      color: rgba(255,255,255,.65);
      font-weight: 900;
      white-space: nowrap;
    }
    .select{
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.90);
      padding: 10px 42px 10px 14px;
      border-radius: 12px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: 12px;
      cursor: pointer;
      outline: none;
      min-width: 210px;
    }
    .select-wrap::after{
      content:"▾";
      position:absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255,255,255,.75);
      pointer-events:none;
      font-weight: 900;
    }
    .select:focus{
      border-color: rgba(255,255,255,.35);
      background: rgba(255,255,255,.09);
    }

    .header-controls{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }

    .container{
      max-width:1100px;
      margin:0 auto;
      padding: 18px 18px 48px;
    }

    /* Cards */
    .card{
      background: var(--card-bg);
      border-radius: 20px;
      padding: 18px 18px;
      box-shadow: var(--card-shadow);
    }
    .card + .card{ margin-top: 16px; }

    .card-head{
      display:flex;
      gap:14px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .card-head .h2{
      font-size: 22px;
      font-weight: 900;
      color: var(--title);
      letter-spacing: .035em;
      text-transform: uppercase;
      margin: 0;
    }

    /* Main header row + entries */
    .header-row, .entry{
      display:grid;
      grid-template-columns: var(--rank-col) 1fr var(--score-col);
      align-items:center;
      min-width: 0;
    }

    .header-row{
      height: 40px;
      background: var(--header-bg);
      border-radius: 10px;
      font-size: 14px;
      font-weight: 800;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: .08em;
      margin-bottom: 8px;
    }
    .header-row span{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0 10px;
      height: 18px;
      min-width: 0;
    }
    .header-row span:nth-child(2){
      justify-content:flex-start;
      padding-left: 18px;
    }

    .resultsList{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }

    .entry{
      height: 48px;
      background: var(--row-bg);
      border-radius: 10px;
      overflow:hidden;
      font-size: 18px;
      font-weight: 700;
      transition: background .25s ease;
      min-width: 0;
    }

    .place{
      font-size: 22px;
      font-weight: 900;
      text-align:center;
      color: var(--title);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0 10px;
      height: 100%;
      background: transparent;
      min-width: 0;
      font-variant-numeric: tabular-nums;
    }
    .place.top10bg{ background: var(--top10-bg); }

    .gold{color:var(--gold);}
    .silver{color:var(--silver);}
    .bronze{color:var(--bronze);}

    /* Team/Player name cell */
    .team-cell{
      position: relative;
      height: 100%;
      width: 100%;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      padding: 0 12px;
      border:none;
      background: rgba(255,255,255,0.08);
      color:#fff;
      cursor:pointer;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .02em;
      overflow:hidden;
      border-radius: 0;
      gap: 0;
      min-width: 0;
    }
    .team-cell:hover{ filter: brightness(1.04); }

    .team-cell.static{
      cursor: default !important;
      user-select: none;
    }
    .team-cell.static:hover{ filter: none !important; }

    .team-logo-slot{
      width: var(--logo-slot);
      height: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0;
      flex: 0 0 auto;
    }
    .team-logo{
      height: calc(100%);
      width: auto;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      display:block;
      border:none;
      outline:none;
      box-shadow:none;
      pointer-events:none;
    }

    .team-cell .name-text{
      font-size: 20px;
      font-weight: 950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-transform: uppercase;
      position: relative;
      z-index: 1;
      flex: 1 1 auto;
      min-width: 0;
      text-align: left;
      justify-content: flex-start;
      padding-left: 10px;
    }

    button.team-cell{
      font-family: inherit !important;
      font-size: inherit !important;
      font-weight: 900 !important;
      letter-spacing: inherit !important;
      text-transform: uppercase !important;
      line-height: 1 !important;
      -webkit-appearance: none;
      appearance: none;
    }
    button.team-cell .name-text{
      font-weight: 950 !important;
      text-transform: uppercase !important;
    }

    .score-col{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#d9d9d9;
      color:#000;
      font-size: 22px;
      font-weight: 900;
      padding: 0 10px;
      min-width: 0;
      font-variant-numeric: tabular-nums;
    }

    /* Weekly */
    .wk-hide-mobile{ }

    .weekly-header-row, .weekly-entry{
      display:grid;
      grid-template-columns: var(--wk-rank-col) 1fr var(--wk-round-col) var(--wk-round-col) var(--wk-score-col);
      align-items:center;
      min-width: 0;
    }

    .weekly-header-row{
      height: 40px;
      background: var(--header-bg);
      border-radius: 10px;
      font-size: 14px;
      font-weight: 800;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: .08em;
      margin-bottom: 8px;
    }
    .weekly-header-row span{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0 10px;
      height: 18px;
      white-space: nowrap;
      min-width: 0;
    }
    .weekly-header-row span:nth-child(2){
      justify-content:flex-start;
      padding-left: 18px;
    }

    .weekly-entry{
      height: 48px;
      background: var(--row-bg);
      border-radius: 10px;
      overflow:hidden;
      font-size: 18px;
      font-weight: 700;
      min-width: 0;
    }
    .weekly-round{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,0.06);
      color: #ffffff;
      font-size: 22px;
      font-weight: 900;
      min-width: 0;
      font-variant-numeric: tabular-nums;
    }

    /* Collapsible roster / stats */
    .roster-wrap{
      margin-top: 4px;
      margin-bottom: 10px;
      padding-top: 2px;
    }
    .roster-title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 10px 6px 10px;
      gap: 10px;
      flex-wrap: wrap;
    }
    .roster-title{
      font-size: 12px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: var(--muted);
    }

    .roster-scroll{
      max-height: 280px;
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 4px;
    }
    .roster-scroll::-webkit-scrollbar { width: 10px; height: 10px; }
    .roster-scroll::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,0.22);
      border-radius: 999px;
    }
    .roster-scroll::-webkit-scrollbar-track { background: transparent; }

    table.roster-table{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 6px;
      table-layout: fixed;
    }

    col.c-rank{  width: 54px; }
    col.c-name{  width: 156px; }
    col.c-stage{ width: 62px; }
    col.c-best{  width: 54px; }
    col.c-week{  width: 52px; }
    col.c-round{ width: 44px; }

    .roster-table thead th{
      position: sticky;
      top: 0;
      z-index: 3;
      background: rgba(15,23,42,0.92);
      backdrop-filter: blur(6px);
      padding: 6px 6px;
      border-bottom: none;
      color: var(--muted);
      font-size: 10px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .10em;
      white-space: nowrap;
      text-align: center;
    }

    .roster-table tbody tr{ background: transparent !important; }
    .roster-table tbody td{ background: var(--row-bg); }
    .roster-table tbody tr:nth-child(even) td{ background: var(--row-bg-2); }

    .roster-table,
    .roster-table thead th,
    .roster-table tbody tr,
    .roster-table tbody td{
      border-radius: 0 !important;
      clip-path: none !important;
      mask: none !important;
    }

    .roster-table td{
      padding: 8px 6px;
      font-size: 11px;
      color: rgba(233,238,248,0.92);
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      border-top: 1px solid rgba(255,255,255,0.02);
      border-bottom: 1px solid rgba(255,255,255,0.02);
      text-align: center;
      font-variant-numeric: tabular-nums;
      background-clip: padding-box;
      font-weight: 900;
      line-height: 1.05;
    }

    .cell-rank{
      color: rgba(156,163,199,0.95);
      letter-spacing: .10em;
      text-transform: uppercase;
    }

    .cell-name{
      text-transform: uppercase;
      color: var(--title);
      text-align: center;
      padding-left: 0;
      line-height: 1.05;
    }
    .cell-name .name-inline{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      max-width: 100%;
      min-width: 0;
    }
    .cell-name .name-inline span{
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      line-height: 1.05;
    }

    .captain-icon{
      width: 14px;
      height: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 auto;
      align-self: center;
      color: currentColor;
      background-color: currentColor;
      -webkit-mask: url("logos/Captain.svg") no-repeat center / contain;
      mask: url("logos/Captain.svg") no-repeat center / contain;
      opacity: 0.95;
    }

    .clickable-player{ cursor: pointer; }
    .clickable-player:hover{
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .roster-table tbody .sep-right{ border-right: 2px solid var(--sep) !important; }
    .roster-table thead .sep-right{ border-right: 2px solid transparent !important; }

    .stageScore{
      background: rgba(217,217,217,0.14) !important;
      color: #ffffff;
    }
    .counted{
      background: rgba(52,211,153,0.16) !important;
      color: #ffffff;
    }

    .full-stats-btn{
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.90);
      padding: 8px 12px;
      border-radius: 12px;
      font-weight: 950;
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: 11px;
      cursor: pointer;
      outline: none;
      line-height: 1;
    }
    .full-stats-btn:hover{
      background: rgba(255,255,255,.09);
      border-color: rgba(255,255,255,.28);
    }

    .status{
      color: rgba(233,238,248,0.92);
      font-size: 18px;
      font-weight: 800;
      text-align:center;
      padding: 24px 0;
    }
    .error{
      color: rgba(233,238,248,0.92);
      font-size: 16px;
      text-align:center;
      padding: 24px 12px;
    }

    .hidden{ display:none !important; }

    .search{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--border-lite);
      background: rgba(148,163,184,0.10);
      padding: 10px 12px;
      border-radius: 10px;
      min-width: 260px;
    }
    .search span{color: var(--muted); font-weight:900;}
    .search input{
      width:100%;
      background:transparent;
      border:none;
      outline:none;
      color: var(--text);
      font-size:14px;
    }
    .search input::placeholder{color: rgba(156,163,199,.70);}

    .footer{
      margin-top: 18px;
      text-align:center;
      font-size:12px;
      color: rgba(233,238,248,0.55);
    }

    /* ---------------- MODAL ---------------- */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(10px);
    }
    .modal-backdrop.show{ display:flex; }

    .modal-wrap{
      position: relative;
      width: min(980px, 100%);
      padding-top: 56px;
    }

    .modal-close-float{
      position: absolute;
      top: 0;
      right: 0;
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(15,23,42,0.75);
      color: rgba(255,255,255,.92);
      cursor: pointer;
      font-weight: 950;
      line-height: 1;
      display:grid;
      place-items:center;
      box-shadow: 0 18px 24px rgba(0,0,0,0.45);
      backdrop-filter: blur(10px);
      z-index: 2;
    }
    .modal-close-float:hover{
      background: rgba(15,23,42,0.90);
      border-color: rgba(255,255,255,.28);
    }

    .modal-card{
      width: 100%;
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255,255,255,.10);
      overflow: hidden;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
    }

    .modal-loading{
      min-height: 360px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-size: 16px;
      font-weight: 950;
      color: rgba(233,238,248,0.92);
      text-transform: uppercase;
      letter-spacing: 0.18em;
      padding: 24px;
      width: 100%;
    }

    .modal-body{
      padding: 14px;
      display:flex;
      gap: 12px;
      align-items: flex-start;
    }
    @media (max-width: 860px){
      .modal-wrap{ padding-top: 52px; }
      .modal-body{
        flex-direction: column;
        align-items: stretch;
      }
      .modal-column{
        width: 100%;
      }
      .modal-pane{
        width: 100%;
      }
      .modal-loading{ min-height: 300px; }
    }

    .modal-pane{
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 12px;
    }

    .modal-column{
      flex: 1.25;
      display:flex;
      flex-direction: column;
      gap: 12px;
      min-width: 0;
    }

    .trophies-pane{
      flex: 1;
      min-width: 0;
    }

    .modal-left{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .player-hero{
      display:flex;
      align-items:center;
      gap: 12px;
    }
    .hero-team{
      width: 52px; height: 52px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.15);
      overflow: hidden;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,0.05);
      flex: 0 0 auto;
    }
    .hero-team img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      display:block;
    }
    .hero-text{ min-width: 0; }
    .hero-name{
      font-size: 18px;
      font-weight: 950;
      text-transform: uppercase;
      letter-spacing: .03em;
      color: var(--title);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .hero-sub{
      margin-top: 4px;
      font-size: 11px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: rgba(255,255,255,0.86);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .hero-sub.solo{
      text-transform: uppercase;
      letter-spacing: .10em;
      color: rgba(255,255,255,0.75);
    }

    .info-btn-grid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 8px;
    }
    @media (max-width: 860px){
      .info-btn-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .info-btn.span-2{ grid-column: span 2; }
    }
    .info-btn{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      border-radius: 14px;
      padding: 10px 8px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      min-height: 62px;
    }
    .info-btn .lbl{
      font-size: 9px;
      font-weight: 950;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: rgba(156,163,199,0.95);
      line-height: 1.15;
      margin-bottom: 6px;
      white-space: normal;
      overflow: visible;
      width: 100%;
    }
    .info-btn .val{
      font-size: 16px;
      font-weight: 950;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: rgba(255,255,255,0.92);
      line-height: 1.05;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
      font-variant-numeric: tabular-nums;
    }
    .info-btn.span-2{ grid-column: span 2; }
    .info-btn.tier-green{
      border-color: rgba(34,197,94,0.40);
      background: rgba(34,197,94,0.09);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.10) inset, 0 0 18px rgba(34,197,94,0.22);
    }
    .info-btn.tier-green .val{ color: rgba(187,247,208,0.96); }

    .info-btn.tier-blue{
      border-color: rgba(56,189,248,0.35);
      background: rgba(56,189,248,0.08);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.10) inset, 0 0 18px rgba(56,189,248,0.22);
    }
    .info-btn.tier-blue .val{ color: rgba(186,230,253,0.95); }

    .info-btn.tier-purple{
      border-color: rgba(168,85,247,0.35);
      background: rgba(168,85,247,0.08);
      box-shadow: 0 0 0 1px rgba(168,85,247,0.10) inset, 0 0 18px rgba(168,85,247,0.22);
    }
    .info-btn.tier-purple .val{ color: rgba(233,213,255,0.95); }

    .info-btn.tier-gold{
      border-color: rgba(253,224,71,0.40);
      background: rgba(253,224,71,0.10);
      box-shadow: 0 0 0 1px rgba(253,224,71,0.12) inset, 0 0 18px rgba(253,224,71,0.24);
    }
    .info-btn.tier-gold .val{ color: rgba(254,240,138,0.98); }

    .info-btn.tier-silver{
      border-color: rgba(226,232,240,0.38);
      background: rgba(226,232,240,0.08);
      box-shadow: 0 0 0 1px rgba(226,232,240,0.10) inset, 0 0 18px rgba(226,232,240,0.20);
    }
    .info-btn.tier-silver .val{ color: rgba(241,245,249,0.98); }

    .info-btn.tier-bronze{
      border-color: rgba(251,146,60,0.40);
      background: rgba(251,146,60,0.09);
      box-shadow: 0 0 0 1px rgba(251,146,60,0.10) inset, 0 0 18px rgba(251,146,60,0.20);
    }
    .info-btn.tier-bronze .val{ color: rgba(254,215,170,0.96); }

    .trophy-title{
      font-size: 11px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: rgba(255,255,255,.65);
      margin-bottom: 10px;
    }
    .trophy-grid{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-start;
    }

    .trophy{
      display:inline-flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      width: fit-content;
      max-width: 100%;
      flex: 0 0 auto;
    }
    .trophy-left{
      display:flex;
      align-items:center;
      gap: 8px;
      min-width: 0;
      flex: 0 1 auto;
    }
    .trophy-icon{
      width: 28px;
      height: 28px;
      border-radius: 10px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,0.07);
      border: 1px solid rgba(255,255,255,0.10);
      font-size: 16px;
      flex: 0 0 auto;
      color: rgba(255,255,255,0.92);
    }
    .trophy-icon.captain{
      font-size: 0;
      position: relative;
    }
    .trophy-icon.captain::before{
      content:"";
      width: 16px;
      height: 16px;
      display:block;
      background-color: currentColor;
      -webkit-mask: url("logos/Captain.svg") no-repeat center / contain;
      mask: url("logos/Captain.svg") no-repeat center / contain;
      opacity: 0.95;
    }

    .trophy-text{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 2px;
      max-width: 280px;
    }
    .trophy.no-sub .trophy-text{
      justify-content: center;
    }
    .trophy-main{
      font-size: 11px;
      font-weight: 950;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: rgba(255,255,255,0.92);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .trophy-sub{
      font-size: 10px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .14em;
      color: rgba(156,163,199,0.95);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .trophy-count{
      flex: 0 0 auto;
      font-size: 12px;
      font-weight: 950;
      text-transform: uppercase;
      letter-spacing: .10em;
      color: rgba(233,238,248,0.92) !important;
      white-space: nowrap;
    }

    /* Trophy tiers: default / green / blue / purple / bronze / silver / gold */
    .trophy.tier-default{
      border-color: rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.06) inset;
    }
    .trophy.tier-green{
      border-color: rgba(34,197,94,0.40);
      background: rgba(34,197,94,0.09);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.10) inset, 0 0 18px rgba(34,197,94,0.22);
    }
    .trophy.tier-green .trophy-main,
    .trophy.tier-green .trophy-icon{ color: rgba(187,247,208,0.96); }
    .trophy.tier-green .trophy-icon{
      border-color: rgba(34,197,94,0.40);
      background: rgba(34,197,94,0.11);
    }

    .trophy.tier-blue{
      border-color: rgba(56,189,248,0.35);
      background: rgba(56,189,248,0.08);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.10) inset, 0 0 18px rgba(56,189,248,0.22);
    }
    .trophy.tier-blue .trophy-main,
    .trophy.tier-blue .trophy-icon{ color: rgba(186,230,253,0.95); }
    .trophy.tier-blue .trophy-icon{
      border-color: rgba(56,189,248,0.35);
      background: rgba(56,189,248,0.10);
    }

    .trophy.tier-purple{
      border-color: rgba(168,85,247,0.35);
      background: rgba(168,85,247,0.08);
      box-shadow: 0 0 0 1px rgba(168,85,247,0.10) inset, 0 0 18px rgba(168,85,247,0.22);
    }
    .trophy.tier-purple .trophy-main,
    .trophy.tier-purple .trophy-icon{ color: rgba(233,213,255,0.95); }
    .trophy.tier-purple .trophy-icon{
      border-color: rgba(168,85,247,0.35);
      background: rgba(168,85,247,0.10);
    }

    .trophy.tier-gold{
      border-color: rgba(253,224,71,0.40);
      background: rgba(253,224,71,0.10);
      box-shadow: 0 0 0 1px rgba(253,224,71,0.12) inset, 0 0 18px rgba(253,224,71,0.24);
    }
    .trophy.tier-gold .trophy-main,
    .trophy.tier-gold .trophy-icon{ color: rgba(254,240,138,0.98); }
    .trophy.tier-gold .trophy-icon{
      border-color: rgba(253,224,71,0.40);
      background: rgba(253,224,71,0.12);
    }

    .trophy.tier-silver{
      border-color: rgba(226,232,240,0.38);
      background: rgba(226,232,240,0.08);
      box-shadow: 0 0 0 1px rgba(226,232,240,0.10) inset, 0 0 18px rgba(226,232,240,0.20);
    }
    .trophy.tier-silver .trophy-main,
    .trophy.tier-silver .trophy-icon{ color: rgba(241,245,249,0.98); }
    .trophy.tier-silver .trophy-icon{
      border-color: rgba(226,232,240,0.38);
      background: rgba(226,232,240,0.10);
    }

    .trophy.tier-bronze{
      border-color: rgba(251,146,60,0.40);
      background: rgba(251,146,60,0.09);
      box-shadow: 0 0 0 1px rgba(251,146,60,0.10) inset, 0 0 18px rgba(251,146,60,0.20);
    }
    .trophy.tier-bronze .trophy-main,
    .trophy.tier-bronze .trophy-icon{ color: rgba(254,215,170,0.96); }
    .trophy.tier-bronze .trophy-icon{
      border-color: rgba(251,146,60,0.40);
      background: rgba(251,146,60,0.11);
    }

    /* Season performance (modal) */
    .season-title{
      font-size: 11px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: rgba(255,255,255,.65);
      margin-bottom: 10px;
    }

    .season-entry{
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .season-entry + .season-entry{ margin-top: 10px; }

    .season-entry-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .season-entry-name{
      font-size: 12px;
      font-weight: 950;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: rgba(255,255,255,0.92);
    }

    .stage-block{
      padding-top: 8px;
    }
    .stage-block + .stage-block{
      margin-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.10); /* subtle border between stages */
      padding-top: 12px;
    }
    .stage-header{
      font-size: 10px;
      font-weight: 950;
      text-transform: uppercase;
      letter-spacing: .18em;
      color: rgba(255,255,255,0.70);
      margin-bottom: 8px;
    }

    .btn-row{
      display:flex;
      align-items:center;
      gap: 6px;
      flex-wrap: nowrap;
      overflow-x: auto;
      padding-bottom: 2px;
      justify-content: flex-end;
      -webkit-overflow-scrolling: touch;
    }
    .btn-row + .btn-row{ margin-top: 8px; }

    .btn-row::-webkit-scrollbar { height: 10px; }
    .btn-row::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,0.22);
      border-radius: 999px;
    }
    .btn-row::-webkit-scrollbar-track { background: transparent; }

    .chip{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      border-radius: 12px;
      padding: 6px 8px;
      font-size: 11px;
      font-weight: 950;
      text-transform: uppercase;
      letter-spacing: .10em;
      line-height: 1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: fit-content;
      max-width: 100%;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-variant-numeric: tabular-nums;
      flex: 0 0 auto;
    }
    .chip.solo{ text-transform: uppercase; letter-spacing: .10em; }

    .chip.rank{
      background: rgba(255,255,255,0.04);
      color: var(--title);
      border-color: rgba(255,255,255,0.10);
    }
    .chip.rank.gold{
      color: var(--gold);
      border-color: rgba(250,204,21,0.65);
    }
    .chip.rank.silver{
      color: var(--silver);
      border-color: rgba(226,232,240,0.65);
    }
    .chip.rank.bronze{
      color: var(--bronze);
      border-color: rgba(251,146,60,0.6);
    }
    .chip.rank.blue{
      color: rgba(186,230,253,0.95);
      border-color: rgba(56,189,248,0.6);
    }

    .chip.team{
      background: var(--team-bg, rgba(255,255,255,0.06));
      color: var(--team-fg, rgba(255,255,255,0.92));
      border-color: rgba(255,255,255,0.14);
      justify-content: center;
      text-align: center;
    }

    .chip.score{
      background: #d9d9d9;
      color: #000000;
      border-color: rgba(0,0,0,0.08);
      letter-spacing: .08em;
    }

    /* Modal stage rounds table */
    table.stage-rounds{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 6px;
      table-layout: fixed;
      margin-top: 10px;
    }
    .stage-rounds thead th{
      position: sticky;
      top: 0;
      z-index: 3;
      background: rgba(15,23,42,0.92);
      backdrop-filter: blur(6px);
      padding: 6px 6px;
      border-bottom: none;
      color: var(--muted);
      font-size: 9px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .12em;
      white-space: nowrap;
      text-align: center;
    }
    .stage-rounds td{
      padding: 8px 6px;
      font-size: 10px;
      color: rgba(233,238,248,0.92);
      text-align: center;
      font-weight: 950;
      background: var(--row-bg);
      border-top: 1px solid rgba(255,255,255,0.02);
      border-bottom: 1px solid rgba(255,255,255,0.02);
      font-variant-numeric: tabular-nums;
    }
    .stage-rounds tr:nth-child(even) td{ background: var(--row-bg-2); }
    .stage-rounds td.sep-right{ border-right: 2px solid var(--sep); }

    /* ---------------- CHAMPIONSHIP LAYOUT ---------------- */
    .champ-grid{
      display:grid;
      grid-template-columns: 1fr 1.55fr;
      gap: 16px;
      align-items: start;
    }
    @media (max-width: 860px){
      .champ-grid{ grid-template-columns: 1fr; }
    }

    .bracket-card{
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 12px;
    }
    .bracket-title{
      font-size: 11px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: rgba(255,255,255,.65);
      margin-bottom: 10px;
    }
    .bracket-subtitle{
      font-size: 11px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: rgba(255,255,255,.65);
      margin: 14px 0 10px;
    }
    .bracket-round-label{
      display: none;
      font-size: 11px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: rgba(255,255,255,.65);
      margin: 0 0 8px;
      text-align: left;
    }

    /* Championship list rows (Stage Winners + Wildcards) */
    .champ-list-row{
      display:grid;
      grid-template-columns: var(--rank-col) 1fr var(--score-col);
      align-items:center;
      min-width: 0;
      height: 48px;
      background: var(--row-bg);
      border-radius: 10px;
      overflow:hidden;
    }

    /* IMPORTANT: no medal coloring on championship page */
    #champView .gold, #champView .silver, #champView .bronze{ color: var(--title) !important; }

    .team-cell.compact .name-text{ font-size: 18px; }
    .team-cell.compact .team-logo{ height: calc(100%); }

    .champ-score{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#d9d9d9;
      color:#000;
      font-size: 16px;
      font-weight: 950;
      padding: 0 10px;
      font-variant-numeric: tabular-nums;
      min-width:0;
    }

    .subheading{
      margin: 12px 0 8px;
      font-size: 11px;
      font-weight: 950;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: rgba(255,255,255,0.72);
    }
    .thin-sep{
      height: 1px;
      width: 100%;
      background: rgba(255,255,255,0.12);
      margin: 12px 0;
    }

    /* Bracket grid */
    .tourney{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items: start;
    }
    @media (max-width: 860px){
      .tourney{ grid-template-columns: 1fr; }
      .bracket-round-label{ display: block; }
      .round-col{ gap: 12px; }
      .round-col .bracket-round-label + .match-box{ margin-top: -14px; }
    }

    .round-col{
      display:flex;
      flex-direction:column;
      gap: 18px;
    }
    .match-box{
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 10px;
    }
    .match-box .roster-wrap:last-child{
      margin-bottom: 2px;
    }
    .match-gap{ margin-top: 6px; }

    .finals-col{
      display:flex;
      flex-direction:column;
      gap: 0;
      justify-content:center;
    }
    .finals-col .match-box{
      margin-top: 62px;
    }
    @media (max-width: 860px){
      .finals-col .match-box{ margin-top: 0; }
    }

    .champ-bracket-row{
      display:grid;
      grid-template-columns: var(--br-seed-col, var(--rank-col)) 1fr var(--br-score-col, var(--score-col));
      height: 48px;
      background: var(--row-bg);
      border-radius: 10px;
      overflow:hidden;
      align-items:center;
      min-width:0;
    }
    .champ-bracket-row + .champ-bracket-row{ margin-top: 6px; }

    .champ-seed{
      font-size: 22px;
      font-weight: 900;
      text-align:center;
      color: var(--title);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0 10px;
      height: 100%;
      background: transparent;
      min-width: 0;
      font-variant-numeric: tabular-nums;
    }
    #champView #bracketWrap .champ-seed.win-seed{
      background: rgba(20, 83, 45, 0.38);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.10) inset;
      border-radius: 10px 0 0 10px;
    }

    /* Champion block glow */
    .champion-wrap{
      border-radius: 16px;
      overflow: hidden;
      background: rgba(255,255,255,0.06);
      border: 1px solid transparent;
      box-shadow:
        0 0 0 1px rgba(253,224,71,0.14) inset,
        0 0 26px rgba(253,224,71,0.22);
    }
    .champion-row{
      height: 50px;
      overflow:hidden;
    }
    .champion-row .team-cell{
      height: 100%;
      padding: 0 12px;
    }
    .champion-row .team-cell .name-text{
      font-size: 20px;
      padding-left: 10px;
      font-weight: 950;
    }

    .champion-roster-strip{
      border-top: 1px solid rgba(255,255,255,0.12);
      padding: 10px 12px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 10px;
      align-items:center;
      background: rgba(255,255,255,0.03);
    }
    .champion-roster-strip .p{
      text-transform: uppercase;
      letter-spacing: .06em;
      font-weight: 950;
      font-size: 11px;
      color: rgba(255,255,255,0.92);
      text-align:center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Bracket roster table (compact, only columns requested) */
    table.champ-roster{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 6px;
      table-layout: fixed;
      margin: 0;
    }
    .champ-roster thead th{
      position: sticky;
      top: 0;
      z-index: 3;
      background: rgba(15,23,42,0.92);
      backdrop-filter: blur(6px);
      padding: 5px 5px;
      color: var(--muted);
      font-size: 9px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .10em;
      white-space: nowrap;
      text-align: center;
    }
    .champ-roster td{
      padding: 7px 5px;
      font-size: 10px;
      color: rgba(233,238,248,0.92);
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      border-top: 1px solid rgba(255,255,255,0.02);
      border-bottom: 1px solid rgba(255,255,255,0.02);
      text-align: center;
      font-variant-numeric: tabular-nums;
      background-clip: padding-box;
      font-weight: 900;
      line-height: 1.02;
      background: var(--row-bg);
    }
    .champ-roster tr:nth-child(even) td{ background: var(--row-bg-2); }
    .champ-roster .pname{
      text-align: left;
      color: rgba(233,238,248,0.92);
      text-transform: uppercase;
      padding-left: 10px;
    }
    .champ-roster .pname .name-inline{
      display: inline-flex;
      align-items: center;
      justify-content: flex-start;
      gap: 6px;
      max-width: 100%;
      min-width: 0;
    }
    .champ-roster .pname .name-inline span{
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      line-height: 1.05;
    }

    /* --- Championship compact overrides (global for championship view) --- */
    #champView{
      --rank-col: 56px;
      --score-col: 72px;
      --logo-slot: 28px;
    }
    #champView .place{
      font-size: 14px;
      padding: 0 4px;
      letter-spacing: .08em;
    }
    #champView .champ-list-row{ height: 38px; }
    #champView .team-cell{ padding: 0 8px; }
    #champView .team-cell.compact .name-text,
    #champView .team-cell .name-text{
      font-size: 14px;
      letter-spacing: .03em;
    }
    #champView .team-logo{ height: calc(100%); }
    #champView .champ-score{
      font-size: 14px;
      font-weight: 900;
    }
    #champView .match-box{ padding: 8px; }

    /* Bracket-specific: narrower rows + smaller text + narrower seed/score columns */
    #champView #bracketWrap{
      --br-seed-col: 42px;
      --br-score-col: 56px;
    }
    #champView #bracketWrap .champ-bracket-row{ height: 32px; }
    #champView #bracketWrap .champ-seed{
      font-size: 12px;
      padding: 0 4px;
      letter-spacing: .08em;
    }
    #champView #bracketWrap .team-cell{ padding: 0 6px; }
    #champView #bracketWrap .team-cell .name-text{
      font-size: 12px;
      padding-left: 6px;
      letter-spacing: .03em;
    }
    #champView #bracketWrap .team-logo-slot{ width: 22px; }
    #champView #bracketWrap .team-logo{ height: calc(100%); }
    #champView #bracketWrap .champ-score{
      font-size: 12px;
      padding: 0 4px;
      font-weight: 900;
    }

    /* IMPORTANT: Champion row (only this row) should resemble main list rows (bigger) */
    #champView .champion-row{
      height: 48px;
    }
    #champView .champion-row .team-logo-slot{
      width: 48px;
    }
    #champView .champion-row .team-logo{
      height: calc(100%);
    }
    #champView .champion-row .team-cell{
      padding: 0 12px;
    }
    #champView .champion-row .team-cell .name-text{
      font-size: 20px;
      letter-spacing: .02em;
      font-weight: 950;
    }
    #champView #bracketWrap .champion-row .team-cell .name-text{
      font-size: 20px;
      padding-left: 10px;
      letter-spacing: .02em;
      font-weight: 950;
    }
    #champView #bracketWrap .champion-row .team-cell{
      padding: 0 12px;
      gap: 0;
    }
    #champView #bracketWrap .champion-row .team-logo-slot{
      width: 36px;
      height: 100%;
    }
    #champView #bracketWrap .champion-row .team-logo{
      height: calc(100%);
    }

    /* ---------------- MOBILE OPTIMIZATION ---------------- */
    @media (max-width: 760px){
      :root{
        --rank-col: 60px;
        --score-col: 70px;
        --wk-rank-col: 60px;
        --wk-round-col: 48px;
        --wk-score-col: 70px;
        --logo-slot: 34px;
      }

      .container{ padding: 14px 12px 40px; }
      .topbar-inner{
        padding: 12px 12px;
        flex-wrap: wrap;
        align-items: flex-start;
      }
      .brand{
        flex: 1 1 100%;
        min-width: 0;
      }
      .brand > div{ min-width: 0; }
      .page-nav-select{ width: min(100%, 420px); max-width: 100%; }
      .header-controls{
        flex: 1 1 100%;
        width: 100%;
      }
      .select-wrap{
        flex: 1 1 220px;
        min-width: 0;
      }
      .select{
        min-width: 0;
        width: 100%;
      }

      .card{ padding: 14px 12px; border-radius: 18px; }
      .card-head .h2{ font-size: 18px; }

      .header-row, .weekly-header-row{ height: 36px; font-size: 12px; }
      .entry, .weekly-entry{ height: 44px; }
      .place{ font-size: 18px; padding: 0 6px; }
      .score-col{ font-size: 18px; padding: 0 6px; }

      .team-cell{ padding: 0 8px; }
      .team-cell .name-text{ font-size: 16px; padding-left: 8px; }
      .team-logo{ height: calc(100%); }

      .weekly-round{ font-size: 18px; }

      .search{ min-width: 0; width: 100%; }

      .roster-scroll{
        overflow-x: auto;
        padding-right: 0;
        -webkit-overflow-scrolling: touch;
      }
      table.roster-table{
        width: max-content;
        min-width: 820px;
      }

      /* Weekly Top 5: on mobile show only Rank | Player | Score */
      .wk-hide-mobile{ display:none !important; }
      .weekly-header-row, .weekly-entry{
        grid-template-columns: var(--wk-rank-col) 1fr var(--wk-score-col);
      }

      /* Champ tighter on mobile too */
      #champView{
        --rank-col: 48px;
        --score-col: 64px;
        --logo-slot: 26px;
      }
      #champView .champ-list-row{ height: 36px; }
      #champView .champ-list-row .place,
      #champView .champ-list-row .champ-score{
        font-size: 16px;
        font-weight: 900;
      }

      /* Bracket: even tighter */
      #champView #bracketWrap{
        --br-seed-col: 40px;
        --br-score-col: 54px;
      }
      #champView #bracketWrap .champ-bracket-row{ height: 36px; }
      #champView #bracketWrap .champ-seed{ font-size: 16px; }
      #champView #bracketWrap .champ-score{ font-size: 16px; }
      #champView #bracketWrap .team-cell .name-text{ font-size: 14px; }
      #champView #bracketWrap .team-logo-slot{ width: var(--logo-slot); }

      /* Champion row still larger than bracket */
      #champView .champion-row .team-logo-slot{ width: 36px; }
      #champView .champion-row .team-cell .name-text{ font-size: 18px; }
    }

    @media (max-width: 420px){
      :root{
        --rank-col: 54px;
        --score-col: 62px;
        --wk-rank-col: 54px;
        --wk-round-col: 44px;
        --wk-score-col: 62px;
        --logo-slot: 30px;
      }

      .select{ min-width: 170px; padding: 10px 38px 10px 12px; }
      .select-label{ font-size: 10px; }
      .kicker{ font-size: 10px; }

      .entry, .weekly-entry{ height: 42px; }
      .team-cell .name-text{ font-size: 15px; }

      table.roster-table{ min-width: 860px; }

      /* Bracket even tighter */
      #champView #bracketWrap{
        --br-seed-col: 38px;
        --br-score-col: 52px;
      }
      #champView #bracketWrap .champ-seed{ font-size: 16px; }
      #champView #bracketWrap .team-logo-slot{ width: var(--logo-slot); }
      #champView #bracketWrap .team-cell .name-text{ font-size: 14px; }
      #champView #bracketWrap .champ-score{ font-size: 16px; }

      #champView .champion-row .team-cell .name-text{ font-size: 17px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <a class="home-btn" href="/" aria-label="Home">
          <img src="/logos/golf.png" alt="Home" loading="eager" decoding="async" />
        </a>
        <div>
                    <select class="kicker page-nav-select" aria-label="Select page" onchange="if (this.value) window.location.href=this.value;">
            <option value="/index.html">Home</option>
            <option value="/worldopen/index.html">World Open</option>
            <option value="/proleague/index.html" selected>Shotgun Pro League</option>
            <option value="/superleague/index.html">Super League</option>
            <option value="/lightningcup/index.html">Lightning Cup</option>
            <option value="/beataidan/index.html">Beat Aidan</option>
          </select>
        </div>
      </div>

      <div class="header-controls">
        <div class="select-wrap" aria-label="Season selector">
          <label class="select-label" for="seasonSelect">Season</label>
          <select id="seasonSelect" class="select"></select>
        </div>

        <div id="stageWrap" class="select-wrap hidden" aria-label="Stage selector">
          <label class="select-label" for="stageSelect">Stage</label>
          <select id="stageSelect" class="select"></select>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div id="statusCard" class="card">
      <div class="status">Loading standings…</div>
    </div>

    <div id="content" class="hidden">
      <!-- Normal (non-championship) stacked sections -->
      <div id="normalStack">
        <div id="teamsView" class="card">
          <div class="card-head">
            <h2 class="h2">Team Rankings</h2>
          </div>

          <div class="header-row">
            <span>Rank</span>
            <span>Team</span>
            <span>Score</span>
          </div>

          <div id="teamsList" class="resultsList"></div>
        </div>

        <div id="weeklyView" class="card">
          <div class="card-head">
            <h2 class="h2">Weekly Top 5</h2>
          </div>
          <div id="weeklyCards"></div>
        </div>

        <div id="playersView" class="card">
          <div class="card-head">
            <h2 class="h2">Player Rankings</h2>
            <div class="search">
              <span>⌕</span>
              <input id="playerSearch" type="text" placeholder="Search…" />
            </div>
          </div>

          <div class="header-row">
            <span>Rank</span>
            <span>Player</span>
            <span>Score</span>
          </div>

          <div id="playersList" class="resultsList"></div>
        </div>
      </div>

      <!-- Championship view -->
      <div id="champView" class="card hidden">
        <div class="card-head">
          <h2 class="h2">Championship</h2>
        </div>

        <div class="champ-grid">
          <div>
            <div class="bracket-card" style="margin-bottom:12px;">
              <div class="bracket-title">Automatic Qualifiers: Stage Winners</div>
              <div id="stageWinnersList" class="resultsList"></div>
            </div>

            <div class="bracket-card">
              <div class="bracket-title">Wildcard Qualifier Standings</div>

              <div class="subheading">IN</div>
              <div id="wildcardInList" class="resultsList"></div>

              <div class="thin-sep"></div>

              <div class="subheading">OUT</div>
              <div id="wildcardOutList" class="resultsList"></div>
            </div>
          </div>

          <div class="bracket-card">
            <div class="bracket-title">Bracket</div>
            <div id="bracketWrap"></div>
          </div>
        </div>
      </div>

      <div class="footer">Shotgun Pro League</div>
    </div>
  </div>

  <!-- Player Modal -->
  <div id="playerModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-wrap">
      <button id="playerModalClose" class="modal-close-float" type="button" aria-label="Close">✕</button>
      <div class="modal-card" role="dialog" aria-modal="true" aria-label="Player details">
        <div id="playerModalContent" class="modal-body"></div>
      </div>
    </div>
  </div>

  <script>
    const WORKER_URL  = "https://small-mud-2771.nextweekmedia.workers.dev/";
    const SHEET_ID    = "1qIM0HKhx9Y-3eCJCFzBqrbATwiPrK3C1ynATwZzRC1o";

    // ---------------- Manual initial period (page-load default) ----------------
    // If enabled, this is used on first load *unless URL query params are present*.
    // Examples:
    //   { enabled:true, season:6, stage:2 }
    //   { enabled:true, season:6, stage:"championship" }
    //   { enabled:true, season:5, stage:null }
    const MANUAL_INITIAL_PERIOD = { enabled: false, season: 6, stage: "championship" };

    // detection (future-proof ceiling)
    const MAX_SEASON_TO_CHECK = 25;

    // Sheet ranges
    const RANGE_PLAYER_STANDINGS_A1 = "AE4:AH101";
    const RANGE_W1_A1 = "Z4:AC13";
    const RANGE_W2_A1 = "Z16:AC25";
    const RANGE_W3_A1 = "Z28:AC37";
    const RANGE_W4_A1 = "Z40:AC49";
    const LOOKUP_RANGE_A1 = "A3:S250";

    // Detection ranges (must remain separate due to header rows between)
    const DETECT_R1 = "L5:S63";
    const DETECT_R2 = "L66:S101";

    // Championship ranges
    const CH_STAGE_WINNERS = "J4:L6";
    const CH_WILDCARDS     = "J13:L24";
    const CH_WILDCARD_SLOTS= "L10:L10";
    const CH_ROSTER        = "B3:H23"; // header row, then team row + 4 player rows x4 teams

    // Manual bracket cells
    const CH_SEMIS_BLOCK   = "O3:P9";
    const CH_FINALS_TOP    = "R4:S4";
    const CH_FINALS_BOTTOM = "R8:S8";
    const CH_CHAMPION_CELL = "U6:U6";

    // Seasons 1-5 varying roster/teamRank sizes
    const LEGACY_SEASON_CONFIG = {
      5: { sheet: "Season 5", rosters: "A3:S63", teamRank: "U4:X15" },
      4: { sheet: "Season 4", rosters: "A3:S53", teamRank: "U4:X13" },
      3: { sheet: "Season 3", rosters: "A3:S48", teamRank: "U4:X12" },
      2: { sheet: "Season 2", rosters: "A3:S43", teamRank: "U4:X11" },
      1: { sheet: "Season 1", rosters: "A3:S38", teamRank: "U4:X10" },
    };

    // Seasons 6+ stage sheets share same format
    const STAGED_FORMAT = { rosters: "A3:S63", teamRank: "U4:X15" };

    const TEAM_STYLES = {
      "ANIMALS":         { bg: "#2b2020", fg: "#ffffff" },
      "TERRIFIC TIGERS": { bg: "#fe6d01", fg: "#000000" },
      "BREAKERS":        { bg: "#f1c232", fg: "#1c4487" },
      "DAGGERS":         { bg: "#ea9999", fg: "#1d2244" },
      "SNIPERS":         { bg: "#275318", fg: "#ffe6cd" },
      "MCSTROKERS":      { bg: "#4d94d8", fg: "#ffffff" },
      "INFERNIX":        { bg: "#f6b26b", fg: "#000000" },
      "INFERNIX*":       { bg: "#f6b26b", fg: "#000000" },
      "DOUBLE-EAGLES":   { bg: "#1c4487", fg: "#ffffff" },
      "PHANTOM TROUPE":  { bg: "#674ea7", fg: "#ffffff" },
      "ASTERISM":        { bg: "#ba2636", fg: "#ffffff" },
      "CARROTS":         { bg: "#ff9966", fg: "#000000" },
      "SPOCCO COWS":     { bg: "#78206e", fg: "#ffffff" },
      "BURGERS":         { bg: "#7e5444", fg: "#ffffff" },
      "TREEMEISTERS":    { bg: "#2d6316", fg: "#ffffff" },
      "REVERIE":         { bg: "#d9d2e9", fg: "#00367a" },
    };

    function getTeamStyle(name) {
      if (!name) return null;
      const key = String(name).trim().toUpperCase();
      return TEAM_STYLES[key] || null;
    }

    function normalizeValues(resp){
      if(!resp) return [];
      if(Array.isArray(resp)) return resp;
      if(Array.isArray(resp.values)) return resp.values;
      if(Array.isArray(resp.data?.values)) return resp.data.values;
      if(Array.isArray(resp.result?.values)) return resp.result.values;
      return [];
    }

    async function fetchRange(range){
      const payload = { sheetId: SHEET_ID, range };

      try{
        const r = await fetch(WORKER_URL, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload),
        });
        if(r.ok) return normalizeValues(await r.json());
      }catch(e){}

      const u = new URL(WORKER_URL);
      u.searchParams.set("sheetId", SHEET_ID);
      u.searchParams.set("range", range);
      const r2 = await fetch(u.toString());
      if(!r2.ok){
        const text = await r2.text().catch(()=>"");
        throw new Error(`Worker request failed (${r2.status}). ${text}`.trim());
      }
      return normalizeValues(await r2.json());
    }

    function rowHasAnyValue(row){
      return Array.isArray(row) && row.some(c => String(c ?? "").trim() !== "");
    }
    function slugify(name){
      return String(name).trim().toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, "");
    }
    function escapeHtml(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }
    function toNum(v){
      const s = String(v ?? "").trim();
      if(!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    // blanks => "-" ; 0 => "E"; positives => +N
    function fmtScore(v){
      if (v === null || v === undefined) return "-";
      const s = String(v).trim();
      if (s === "") return "-";
      const n = Number(s);
      if (!Number.isFinite(n)) return s;
      if (n === 0 || Object.is(n, -0)) return "E";
      return n > 0 ? `+${n}` : String(n);
    }
    function fmtScoreAvg(n){
      if (n === null || n === undefined || !Number.isFinite(n)) return "-";
      const rounded = Math.round(n * 10) / 10;
      if (rounded === 0) return "E";
      return rounded > 0 ? `+${rounded}` : String(rounded);
    }

    function rankClass(rank){
      return rank === 1 ? "gold" : rank === 2 ? "silver" : rank === 3 ? "bronze" : "";
    }

    function normalizeStandingsGeneric(rows){
      return (rows || [])
        .filter(rowHasAnyValue)
        .map(r=>{
          const arr = Array.isArray(r) ? r : [];
          const rank = arr[0];
          const name = arr.length >= 2 ? arr[arr.length - 2] : "";
          const score = arr.length >= 1 ? arr[arr.length - 1] : "";
          if(!rank || !name) return null;
          return {
            rank: Number(rank),
            name: String(name).trim(),
            displayName: String(name).trim().toUpperCase(),
            slug: slugify(name),
            score: (String(score ?? "").trim() !== "") ? Number(score) : null
          };
        })
        .filter(Boolean)
        .sort((a,b)=>a.rank-b.rank);
    }

    // Highlight exactly up to 3 played rounds (blanks never considered)
    function pickTop3RoundIndices(rounds){
      const played = (rounds || [])
        .map((v, idx) => ({ v, idx }))
        .filter(o => o.v !== null && o.v !== undefined && Number.isFinite(o.v));
      if (!played.length) return new Set();

      const sortedVals = played.map(o => o.v).slice().sort((a,b)=>a-b);
      const chosenVals = sortedVals.slice(0, Math.min(3, sortedVals.length));

      const need = new Map();
      for (const v of chosenVals) need.set(v, (need.get(v) || 0) + 1);

      const picked = new Set();
      for (const o of played){
        const remaining = need.get(o.v) || 0;
        if (remaining > 0){
          picked.add(o.idx);
          need.set(o.v, remaining - 1);
        }
        if (picked.size >= chosenVals.length) break;
      }
      return picked;
    }

    function parseTeamRosters(values){
      const cleaned = (values || []).filter(rowHasAnyValue);
      const byTeam = new Map();
      const byPlayer = new Map();
      const playerTeamByName = new Map();
      const captains = new Set();

      if(!cleaned.length) return { byTeam, byPlayer, playerTeamByName, captains };

      const rows = cleaned.slice(1); // drop header row

      for(let i=0; i<rows.length; i+=5){
        const teamRow = rows[i] || [];
        const teamName = String(teamRow[2] ?? "").trim();
        if(!teamName) continue;

        const playerRows = [rows[i+1], rows[i+2], rows[i+3], rows[i+4]].filter(Boolean);

        const players = playerRows.map(pr=>{
          const r = pr || [];
          const pName = String(r[2] ?? "").trim();

          const stat = {
            overallRank: toNum(r[0]),
            name: pName,
            displayName: pName ? pName.toUpperCase() : "",
            stageScore: toNum(r[3]),
            best: [toNum(r[4]), toNum(r[5]), toNum(r[6])],
            weekTotals: [toNum(r[7]), toNum(r[8]), toNum(r[9]), toNum(r[10])],
            rounds: Array.from({length:8}, (_,k)=> toNum(r[11 + k]))
          };

          if (pName) {
            byPlayer.set(pName, stat);
            playerTeamByName.set(pName, teamName);
          }
          return stat;
        });

        const capName = String(playerRows?.[0]?.[2] ?? "").trim();
        if (capName) captains.add(capName);

        byTeam.set(teamName, { teamName, displayTeamName: teamName.toUpperCase(), players });
      }

      return { byTeam, byPlayer, playerTeamByName, captains };
    }

    function parseLookupStats(values){
      const cleaned = (values || []).filter(rowHasAnyValue);
      const byPlayer = new Map();
      if(!cleaned.length) return byPlayer;

      const rows = cleaned.slice(1);
      for (const r of rows){
        const name = String(r?.[2] ?? "").trim();
        if(!name) continue;

        const overallRank = toNum(r?.[0]);
        if (overallRank === null) continue; // skip team header rows

        byPlayer.set(name, {
          overallRank,
          name,
          displayName: name.toUpperCase(),
          stageScore: toNum(r?.[3]),
          best: [toNum(r?.[4]), toNum(r?.[5]), toNum(r?.[6])],
          weekTotals: [toNum(r?.[7]), toNum(r?.[8]), toNum(r?.[9]), toNum(r?.[10])],
          rounds: Array.from({length:8}, (_,k)=> toNum(r?.[11 + k]))
        });
      }
      return byPlayer;
    }

    const TEAM_LOGO_DIR = "logos";
    const TEAM_LOGO_EXT = "png";
    function teamLogoSrc(teamName){
      return `${TEAM_LOGO_DIR}/${slugify(teamName)}.${TEAM_LOGO_EXT}`;
    }

    function isStagedSeason(seasonNum){
      return Number(seasonNum) >= 6;
    }
    function periodDisplayLabel(season, stage){
      const s = Number(season);
      if (!isStagedSeason(s)) return `Season ${s}`;
      if (stage === "championship") return `Season ${s}, Championship`;
      return `Season ${s}, Stage ${Number(stage)}`;
    }
    function formatOrdinal(value){
      const n = Number(value);
      if (!Number.isFinite(n)) return "-";
      const mod100 = Math.abs(n) % 100;
      if (mod100 >= 11 && mod100 <= 13) return `${n}th`;
      switch (Math.abs(n) % 10){
        case 1: return `${n}st`;
        case 2: return `${n}nd`;
        case 3: return `${n}rd`;
        default: return `${n}th`;
      }
    }
    function sheetNameForPeriod(season, stage){
      const s = Number(season);
      if (!isStagedSeason(s)) return `Season ${s}`;
      if (stage === "championship") return `Season ${s}, Championship`;
      return `Season ${s}, Stage ${Number(stage)}`;
    }

    function getPeriodConfig(season, stage){
      const s = Number(season);
      if (!isStagedSeason(s)){
        const legacy = LEGACY_SEASON_CONFIG[s];
        return legacy ? { sheet: legacy.sheet, rosters: legacy.rosters, teamRank: legacy.teamRank } : null;
      }
      if (stage === "championship"){
        return { sheet: sheetNameForPeriod(s, "championship") };
      }
      return { sheet: sheetNameForPeriod(s, stage), rosters: STAGED_FORMAT.rosters, teamRank: STAGED_FORMAT.teamRank };
    }

    function normalizeRoundValue(v){
      if (v === null || v === undefined) return null;
      const s = String(v).trim();
      if (s === "") return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    // Determine if a stage/season period is concluded (for placement trophies / best finishes)
    let DETECTED_CURRENT_SEASON = 6;
    let DETECTED_CURRENT_STAGE = 1; // only meaningful for seasons >= 6
    function isPeriodConcluded(seasonNum, stageVal){
      const s = Number(seasonNum);
      if (s < DETECTED_CURRENT_SEASON) return true;
      if (s > DETECTED_CURRENT_SEASON) return false;

      if (s < 6) return false;
      if (stageVal === "championship") return false;

      const curStage = Number(DETECTED_CURRENT_STAGE || "1");
      const st = Number(stageVal);
      if (!Number.isFinite(st)) return false;
      return st < curStage;
    }

    // DOM refs
    const statusCard = document.getElementById("statusCard");
    const contentEl  = document.getElementById("content");

    const seasonSelect = document.getElementById("seasonSelect");
    const stageWrap   = document.getElementById("stageWrap");
    const stageSelect = document.getElementById("stageSelect");

    const normalStack = document.getElementById("normalStack");
    const champView   = document.getElementById("champView");

    const teamsList   = document.getElementById("teamsList");
    const playersList = document.getElementById("playersList");
    const weeklyCards = document.getElementById("weeklyCards");
    const playerSearch= document.getElementById("playerSearch");

    // Championship DOM
    const stageWinnersList = document.getElementById("stageWinnersList");
    const wildcardInList   = document.getElementById("wildcardInList");
    const wildcardOutList  = document.getElementById("wildcardOutList");
    const bracketWrap      = document.getElementById("bracketWrap");

    // Player modal refs
    const playerModal = document.getElementById("playerModal");
    const playerModalClose = document.getElementById("playerModalClose");
    const playerModalContent = document.getElementById("playerModalContent");

    // state
    let teamStandings = [];
    let playerStandings = [];
    let weeklyByWeek = new Map();

    let rosterByTeam = new Map();
    let playerStatsByName = new Map();
    let playerTeamByName = new Map();
    let captainsSet = new Set();

    const expandedTeams = new Set();
    const expandedPlayers = new Set();

    // Championship state
    let champStageWinners = [];
    let champWildcards = [];
    let champWildcardSlots = 0;

    let champTeams = [];
    let champTeamByName = new Map();  // ALWAYS sourced from B3:H23 roster
    let champSeedByName = new Map();  // ALWAYS sourced from B3:H23 roster

    let champSemis = { s1:"", s2:"", s3:"", s4:"", p1:null, p2:null, p3:null, p4:null };
    let champFinals = { t1:"", t2:"", s1:null, s2:null };
    let champChampionName = "";

    // only for bracket expand/collapse (NOT champion row)
    const expandedChampTeams = new Set();

    // availability
    let AVAILABLE_SEASONS = [1,2,3,4,5];
    let STAGE_DATA_BY_SEASON = new Map();

    function currentSelectedSeason(){
      const n = Number(seasonSelect.value);
      return Number.isFinite(n) ? n : DETECTED_CURRENT_SEASON;
    }
    function currentSelectedStage(){
      const s = currentSelectedSeason();
      if (!isStagedSeason(s)) return null;
      const v = (stageSelect.value || "1").toLowerCase();
      if (v === "championship") return "championship";
      const n = Number(v);
      return Number.isFinite(n) ? n : 1;
    }

    // ---- URL sync (persist season/stage across refresh) ----
    function syncUrlToSelection(){
      const season = currentSelectedSeason();
      const stage = currentSelectedStage();

      const params = new URLSearchParams(window.location.search);
      params.set("season", String(season));

      if (isStagedSeason(season)){
        params.set("stage", stage === "championship" ? "championship" : String(stage));
      } else {
        params.delete("stage");
      }

      const qs = params.toString();
      const newUrl = `${window.location.pathname}${qs ? "?" + qs : ""}${window.location.hash || ""}`;
      history.replaceState(null, "", newUrl);
    }

    function showPlayerLoading(){
      playerModalContent.className = "modal-loading";
      playerModalContent.innerHTML = `LOADING PLAYER DATA...`;
      const card = playerModal.querySelector(".modal-card");
      if (card) card.scrollTop = 0;
    }

    function closePlayerModal(){
      playerModal.classList.remove("show");
      playerModal.setAttribute("aria-hidden", "true");
      showPlayerLoading();
    }

    playerModalClose.addEventListener("click", closePlayerModal);
    playerModal.addEventListener("click", (e)=>{
      if (e.target === playerModal) closePlayerModal();
    });
    window.addEventListener("keydown", (e)=>{
      if (e.key === "Escape" && playerModal.classList.contains("show")) closePlayerModal();
    });

    // -------------------- Rendering helpers (non-championship) --------------------
    function renderTeamRosterTable(roster){
      const wrap = document.createElement("div");
      wrap.className = "roster-wrap";

      const titleRow = document.createElement("div");
      titleRow.className = "roster-title-row";
      titleRow.innerHTML = `<div class="roster-title">Roster</div>`;
      wrap.appendChild(titleRow);

      if(!roster || !roster.players || !roster.players.length){
        wrap.innerHTML += `<div class="error" style="padding:10px 10px 4px;">Roster not found.</div>`;
        return wrap;
      }

      const scroll = document.createElement("div");
      scroll.className = "roster-scroll";

      const table = document.createElement("table");
      table.className = "roster-table";

      table.innerHTML = `
        <colgroup>
          <col class="c-rank">
          <col class="c-name">
          <col class="c-stage">
          <col class="c-best"><col class="c-best"><col class="c-best">
          <col class="c-week"><col class="c-week"><col class="c-week"><col class="c-week">
          <col class="c-round"><col class="c-round"><col class="c-round"><col class="c-round">
          <col class="c-round"><col class="c-round"><col class="c-round"><col class="c-round">
        </colgroup>
        <thead>
          <tr>
            <th>Rank</th>
            <th>Player</th>
            <th>Total</th>
            <th>1st</th><th>2nd</th><th>3rd</th>
            <th>WK1</th><th>WK2</th><th>WK3</th><th class="sep-right">WK4</th>
            <th>1-1</th><th class="sep-right">1-2</th>
            <th>2-1</th><th class="sep-right">2-2</th>
            <th>3-1</th><th class="sep-right">3-2</th>
            <th>4-1</th><th>4-2</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tbody = table.querySelector("tbody");

      roster.players.forEach((p, idxOnTeam)=>{
        const rounds = (p.rounds || Array(8).fill(null));
        const highlightIdx = pickTop3RoundIndices(rounds);

        const weekTotals = (p.weekTotals || [null,null,null,null]);
        const best = (p.best || [null,null,null]);

        const isCaptain = (idxOnTeam === 0);
        const captainMark = isCaptain ? `<span class="captain-icon" aria-label="Captain" title="Captain"></span>` : ``;

        const cells = [];
        cells.push(`<td class="cell-rank">${escapeHtml(String(p.overallRank ?? "-"))}</td>`);
        cells.push(`
          <td class="cell-name clickable-player" data-player="${escapeHtml(p.name)}">
            <span class="name-inline">
              <span>${escapeHtml((p.displayName || p.name || "").toUpperCase())}</span>
              ${captainMark}
            </span>
          </td>
        `);
        cells.push(`<td class="stageScore">${escapeHtml(fmtScore(p.stageScore))}</td>`);

        for(let i=0;i<3;i++){
          cells.push(`<td class="counted">${escapeHtml(fmtScore(best[i]))}</td>`);
        }

        for(let i=0;i<4;i++){
          const cls = (i===3) ? "sep-right" : "";
          cells.push(`<td class="${cls}">${escapeHtml(fmtScore(weekTotals[i]))}</td>`);
        }

        for(let i=0;i<8;i++){
          const v = rounds[i];
          const isHighlighted = highlightIdx.has(i);
          const isWeekEnd = (i===1 || i===3 || i===5);
          const cls = `${isHighlighted ? "counted" : ""} ${isWeekEnd ? "sep-right" : ""}`.trim();
          cells.push(`<td class="${cls}">${escapeHtml(fmtScore(v))}</td>`);
        }

        const tr = document.createElement("tr");
        tr.innerHTML = cells.join("");
        tbody.appendChild(tr);
      });

      scroll.appendChild(table);
      wrap.appendChild(scroll);
      return wrap;
    }

    function renderPlayerStatsTable(stat, playerName){
      const wrap = document.createElement("div");
      wrap.className = "roster-wrap";

      const titleRow = document.createElement("div");
      titleRow.className = "roster-title-row";
      titleRow.innerHTML = `
        <div class="roster-title">Stats</div>
        <button class="full-stats-btn" type="button" data-player="${escapeHtml(playerName)}">Full Player Stats</button>
      `;
      wrap.appendChild(titleRow);

      if(!stat){
        wrap.innerHTML += `<div class="error" style="padding:10px 10px 4px;">Stats not found.</div>`;
        return wrap;
      }

      const scroll = document.createElement("div");
      scroll.className = "roster-scroll";

      const table = document.createElement("table");
      table.className = "roster-table";

      table.innerHTML = `
        <colgroup>
          <col class="c-best"><col class="c-best"><col class="c-best">
          <col class="c-week"><col class="c-week"><col class="c-week"><col class="c-week">
          <col class="c-round"><col class="c-round"><col class="c-round"><col class="c-round">
          <col class="c-round"><col class="c-round"><col class="c-round"><col class="c-round">
        </colgroup>
        <thead>
          <tr>
            <th>1st</th><th>2nd</th><th>3rd</th>
            <th>WK1</th><th>WK2</th><th>WK3</th><th class="sep-right">WK4</th>
            <th>1-1</th><th class="sep-right">1-2</th>
            <th>2-1</th><th class="sep-right">2-2</th>
            <th>3-1</th><th class="sep-right">3-2</th>
            <th>4-1</th><th>4-2</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tbody = table.querySelector("tbody");

      const best = stat.best || [null,null,null];
      const weekTotals = stat.weekTotals || [null,null,null,null];
      const rounds = stat.rounds || Array(8).fill(null);
      const highlightIdx = pickTop3RoundIndices(rounds);

      const cells = [];

      for(let i=0;i<3;i++){
        cells.push(`<td class="counted">${escapeHtml(fmtScore(best[i]))}</td>`);
      }

      for(let i=0;i<4;i++){
        const cls = (i===3) ? "sep-right" : "";
        cells.push(`<td class="${cls}">${escapeHtml(fmtScore(weekTotals[i]))}</td>`);
      }

      for(let i=0;i<8;i++){
        const v = rounds[i];
        const isHighlighted = highlightIdx.has(i);
        const isWeekEnd = (i===1 || i===3 || i===5);
        const cls = `${isHighlighted ? "counted" : ""} ${isWeekEnd ? "sep-right" : ""}`.trim();
        cells.push(`<td class="${cls}">${escapeHtml(fmtScore(v))}</td>`);
      }

      const tr = document.createElement("tr");
      tr.innerHTML = cells.join("");
      tbody.appendChild(tr);

      scroll.appendChild(table);
      wrap.appendChild(scroll);
      return wrap;
    }

    function renderTeams(){
      teamsList.innerHTML = "";
      if(!teamStandings.length){
        teamsList.innerHTML = `<div class="error">No teams found.</div>`;
        return;
      }

      for (const team of teamStandings){
        const row = document.createElement("div");
        row.className = "entry";

        const style = getTeamStyle(team.name) || {};
        const bg = style.bg || "rgba(255,255,255,0.08)";
        const fg = style.fg || "#ffffff";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "team-cell";
        btn.setAttribute("data-team", team.name);
        btn.style.background = bg;
        btn.style.color = fg;

        const logoSrc = teamLogoSrc(team.name);
        btn.innerHTML = `
          <span class="team-logo-slot">
            <img class="team-logo"
                 src="${escapeHtml(logoSrc)}"
                 alt="${escapeHtml(team.displayName)} logo"
                 loading="lazy"
                 decoding="async"
                 onerror="this.style.display='none'; this.removeAttribute('src'); this.parentElement.style.width='40px';" />
          </span>
          <span class="name-text">${escapeHtml(team.displayName)}</span>
        `;

        row.innerHTML = `
          <div class="place ${rankClass(team.rank)}">${team.rank}</div>
          <div id="teamHost-${team.slug}"></div>
          <div class="score-col">${escapeHtml(fmtScore(team.score))}</div>
        `;
        row.querySelector(`#teamHost-${team.slug}`).replaceWith(btn);
        teamsList.appendChild(row);

        teamsList.appendChild(expandedTeams.has(team.name)
          ? renderTeamRosterTable(rosterByTeam.get(team.name))
          : Object.assign(document.createElement("div"), { className: "roster-wrap hidden" })
        );
      }
    }

    function renderPlayers(){
      const q = playerSearch.value.trim().toLowerCase();
      playersList.innerHTML = "";

      const view = playerStandings.filter(p=>{
        if(!q) return true;
        return (p.name + " " + (p.score ?? "") + " " + p.rank).toLowerCase().includes(q);
      });

      if(!view.length){
        playersList.innerHTML = `<div class="error">No players found.</div>`;
        return;
      }

      view.forEach(p=>{
        const row = document.createElement("div");
        row.className = "entry";

        const teamName = playerTeamByName.get(p.name) || null;
        const style = teamName ? (getTeamStyle(teamName) || {}) : null;
        const bg = style?.bg || "rgba(255,255,255,0.08)";
        const fg = style?.fg || "#ffffff";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "team-cell";
        btn.setAttribute("data-player", p.name);
        btn.style.background = bg;
        btn.style.color = fg;

        const logoHtml = teamName
          ? `
            <img class="team-logo"
                 src="${escapeHtml(teamLogoSrc(teamName))}"
                 alt="${escapeHtml(String(teamName).toUpperCase())} logo"
                 loading="lazy"
                 decoding="async"
                 onerror="this.style.display='none'; this.removeAttribute('src');" />
          `
          : "";

        btn.innerHTML = `
          <span class="team-logo-slot">${logoHtml}</span>
          <span class="name-text">${escapeHtml(p.displayName)}</span>
        `;

        const top10Class = (Number(p.rank) <= 10) ? " top10bg" : "";

        row.innerHTML = `
          <div class="place ${rankClass(p.rank)}${top10Class}">${p.rank}</div>
          <div id="playerHost-${p.slug}"></div>
          <div class="score-col">${escapeHtml(fmtScore(p.score))}</div>
        `;
        row.querySelector(`#playerHost-${p.slug}`).replaceWith(btn);
        playersList.appendChild(row);

        playersList.appendChild(expandedPlayers.has(p.name)
          ? renderPlayerStatsTable(playerStatsByName.get(p.name), p.name)
          : Object.assign(document.createElement("div"), { className: "roster-wrap hidden" })
        );
      });
    }

    function renderWeekly(){
      weeklyCards.innerHTML = "";
      const weeks = Array.from(weeklyByWeek.keys()).sort((a,b)=>b-a);

      if(!weeks.length){
        weeklyCards.innerHTML = `<div class="status">Weekly Top 5 has not been posted yet.</div>`;
        return;
      }

      weeks.forEach(weekNum=>{
        const list = weeklyByWeek.get(weekNum) || [];
        if(!list.length) return;

        const card = document.createElement("div");
        card.className = "card";

        const r1Label = `${weekNum}-1`;
        const r2Label = `${weekNum}-2`;

        card.innerHTML = `
          <div class="card-head">
            <h2 class="h2">Week ${weekNum} Top 5</h2>
          </div>

          <div class="weekly-header-row">
            <span>Rank</span>
            <span>Player</span>
            <span class="wk-hide-mobile">${r1Label}</span>
            <span class="wk-hide-mobile">${r2Label}</span>
            <span>Score</span>
          </div>

          <div class="resultsList" id="weekList-${weekNum}"></div>
        `;

        const holder = card.querySelector(`#weekList-${weekNum}`);
        list.forEach(p=>{
          const row = document.createElement("div");
          row.className = "weekly-entry";

          const stat = playerStatsByName.get(p.name);
          const idx1 = (weekNum - 1) * 2;
          const idx2 = idx1 + 1;
          const round1 = stat?.rounds?.[idx1] ?? null;
          const round2 = stat?.rounds?.[idx2] ?? null;

          const teamName = playerTeamByName.get(p.name) || null;
          const style = teamName ? (getTeamStyle(teamName) || {}) : null;
          const bg = style?.bg || "rgba(255,255,255,0.08)";
          const fg = style?.fg || "#ffffff";

          const nameCell = document.createElement("button");
          nameCell.type = "button";
          nameCell.className = "team-cell";
          nameCell.dataset.player = p.name;
          nameCell.style.cursor = "pointer";
          nameCell.style.background = bg;
          nameCell.style.color = fg;

          const logoHtml = teamName
            ? `
              <img class="team-logo"
                   src="${escapeHtml(teamLogoSrc(teamName))}"
                   alt="${escapeHtml(String(teamName).toUpperCase())} logo"
                   loading="lazy"
                   decoding="async"
                   onerror="this.style.display='none'; this.removeAttribute('src');" />
            `
            : "";

          nameCell.innerHTML = `
            <span class="team-logo-slot">${logoHtml}</span>
            <span class="name-text">${escapeHtml(p.displayName)}</span>
          `;

          row.innerHTML = `
            <div class="place ${rankClass(p.rank)}">${p.rank}</div>
            <div id="wkName-${weekNum}-${p.slug}"></div>
            <div class="weekly-round wk-hide-mobile">${escapeHtml(fmtScore(round1))}</div>
            <div class="weekly-round wk-hide-mobile">${escapeHtml(fmtScore(round2))}</div>
            <div class="score-col">${escapeHtml(fmtScore(p.score))}</div>
          `;
          row.querySelector(`#wkName-${weekNum}-${p.slug}`).replaceWith(nameCell);
          holder.appendChild(row);
        });

        weeklyCards.appendChild(card);
      });
    }

    // -------------------- Championship parsing + rendering --------------------
    function parseChampionshipRoster(values){
      const cleaned = (values || []);
      if (!cleaned.length) return { teams: [], byName: new Map(), seedByName: new Map() };

      const rows = cleaned.slice(1); // drop header row at B3
      const teams = [];
      const byName = new Map();
      const seedByName = new Map();

      for (let i=0; i<rows.length; i+=5){
        const teamRow = rows[i] || [];
        const teamName = String(teamRow?.[0] ?? "").trim(); // column B

        const players = [];
        for (let k=1; k<=4; k++){
          const r = rows[i+k] || [];
          players.push({
            name: String(r?.[0] ?? "").trim(), // B
            semi1: toNum(r?.[3]), // E
            semi2: toNum(r?.[4]), // F
            fin1:  toNum(r?.[5]), // G
            fin2:  toNum(r?.[6]), // H
          });
        }

        const seed = teams.length + 1;
        const t = { seed, name: teamName, displayName: teamName ? teamName.toUpperCase() : "", players };
        teams.push(t);

        if (teamName){
          byName.set(teamName, t);
          seedByName.set(teamName, seed);
        }
      }

      return { teams, byName, seedByName };
    }

    function parseManualSemis(block){
      const pick = (idx) => {
        const r = block?.[idx] || [];
        return { team: String(r?.[0] ?? "").trim(), score: toNum(r?.[1]) };
      };
      const seed1 = pick(0); // O3
      const seed4 = pick(2); // O5
      const seed2 = pick(4); // O7
      const seed3 = pick(6); // O9
      return {
        s1: seed1.team, p1: seed1.score,
        s2: seed2.team, p2: seed2.score,
        s3: seed3.team, p3: seed3.score,
        s4: seed4.team, p4: seed4.score
      };
    }

    function parseManualFinals(block){
      const pick = (idx) => {
        const r = block?.[idx] || [];
        return { team: String(r?.[0] ?? "").trim(), score: toNum(r?.[1]) };
      };
      const a = pick(0); // R4
      const b = pick(1); // R5
      return { t1: a.team, s1: a.score, t2: b.team, s2: b.score };
    }

    // Non-clickable rows for stage winners + wildcards
    function renderChampListRow(num, teamName, scoreVal){
      const row = document.createElement("div");
      row.className = "champ-list-row";

      const style = teamName ? (getTeamStyle(teamName) || {}) : null;
      const bg = style?.bg || "rgba(255,255,255,0.08)";
      const fg = style?.fg || "#ffffff";

      const cell = document.createElement("div");
      cell.className = "team-cell compact static";
      cell.style.background = bg;
      cell.style.color = fg;

      const logoHtml = teamName
        ? `
          <img class="team-logo"
               src="${escapeHtml(teamLogoSrc(teamName))}"
               alt="${escapeHtml(String(teamName).toUpperCase())} logo"
               loading="lazy"
               decoding="async"
               onerror="this.style.display='none'; this.removeAttribute('src');" />
        `
        : "";

      cell.innerHTML = `
        <span class="team-logo-slot">${logoHtml}</span>
        <span class="name-text">${escapeHtml(teamName ? teamName.toUpperCase() : "-")}</span>
      `;

      row.innerHTML = `
        <div class="place">${escapeHtml(String(num ?? "-"))}</div>
        <div></div>
        <div class="champ-score">${escapeHtml(fmtScore(scoreVal))}</div>
      `;
      row.children[1].replaceWith(cell);
      return row;
    }

    // For bracket only: counted = lower (better) score among the pair
    function countedPairClasses(a, b){
      const na = (a === null || a === undefined) ? null : Number(a);
      const nb = (b === null || b === undefined) ? null : Number(b);

      const fa = Number.isFinite(na);
      const fb = Number.isFinite(nb);

      if (fa && fb){
        if (na < nb) return { a: "counted", b: "" };
        if (nb < na) return { a: "", b: "counted" };
        return { a: "counted", b: "" };
      }
      if (fa) return { a: "counted", b: "" };
      if (fb) return { a: "", b: "counted" };
      return { a: "", b: "" };
    }

    function champRosterTable(teamObj, mode){
      const wrap = document.createElement("div");
      wrap.className = "roster-wrap";
      wrap.style.marginTop = "2px";
      wrap.style.marginBottom = "6px";
      wrap.style.paddingTop = "0";

      const scroll = document.createElement("div");
      scroll.className = "roster-scroll";
      scroll.style.maxHeight = "240px";

      const table = document.createElement("table");
      table.className = "champ-roster";

      const h1 = (mode === "final") ? "F 1" : "SF 1";
      const h2 = (mode === "final") ? "F 2" : "SF 2";

      table.innerHTML = `
        <colgroup>
          <col style="width:66%;">
          <col style="width:17%;">
          <col style="width:17%;">
        </colgroup>
        <thead>
          <tr>
            <th style="text-align:left;padding-left:10px;">Player</th>
            <th>${h1}</th>
            <th>${h2}</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tbody = table.querySelector("tbody");

      // IMPORTANT: Championship bracket rosters are ALWAYS sourced from B3:H23,
      // and the team names in bracket cells will always match those roster team names.
      // So we render exactly those 4 player rows (and keep "-" if a cell is blank).
      const players = (teamObj?.players && Array.isArray(teamObj.players)) ? teamObj.players.slice(0,4) : [];
      while (players.length < 4) players.push({ name:"", semi1:null, semi2:null, fin1:null, fin2:null });

      players.forEach((p, idxOnTeam)=>{
        const a = (mode === "final") ? toNum(p.fin1) : toNum(p.semi1);
        const b = (mode === "final") ? toNum(p.fin2) : toNum(p.semi2);
        const cls = countedPairClasses(a, b);
        const name = String(p.name || "").trim();
        const isCaptain = idxOnTeam === 0 && name;
        const captainMark = isCaptain ? `<span class="captain-icon" aria-label="Captain" title="Captain"></span>` : ``;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="pname clickable-player" data-player="${escapeHtml(name)}">
            <span class="name-inline">
              <span>${escapeHtml(name ? name.toUpperCase() : "-")}</span>
              ${captainMark}
            </span>
          </td>
          <td class="${cls.a}">${escapeHtml(fmtScore(a))}</td>
          <td class="${cls.b}">${escapeHtml(fmtScore(b))}</td>
        `;
        tbody.appendChild(tr);
      });

      scroll.appendChild(table);
      wrap.appendChild(scroll);
      return wrap;
    }

    // DOM builder for bracket rows
    function bracketSeedForTeam(name){
      const n = String(name || "").trim();
      if (!n) return null;
      return champSeedByName.get(n) || null;
    }

    function renderBracketTeamRow(seedNum, teamName, scoreVal, isWinner, rowKey){
      const row = document.createElement("div");
      row.className = "champ-bracket-row";

      const style = teamName ? (getTeamStyle(teamName) || {}) : null;
      const bg = style?.bg || "rgba(255,255,255,0.08)";
      const fg = style?.fg || "#ffffff";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "team-cell compact";
      btn.style.background = bg;
      btn.style.color = fg;
      btn.disabled = !teamName;
      btn.style.cursor = teamName ? "pointer" : "default";

      const logoHtml = teamName
        ? `
          <img class="team-logo"
               src="${escapeHtml(teamLogoSrc(teamName))}"
               alt="${escapeHtml(String(teamName).toUpperCase())} logo"
               loading="lazy"
               decoding="async"
               onerror="this.style.display='none'; this.removeAttribute('src');" />
        `
        : "";

      btn.innerHTML = `
        <span class="team-logo-slot">${logoHtml}</span>
        <span class="name-text">${escapeHtml(teamName ? teamName.toUpperCase() : "-")}</span>
      `;

      btn.addEventListener("click", ()=>{
        if (!teamName) return;
        expandedChampTeams.has(rowKey) ? expandedChampTeams.delete(rowKey) : expandedChampTeams.add(rowKey);
        renderChampionship();
      });

      const seedCls = `champ-seed ${isWinner ? "win-seed" : ""}`.trim();

      row.innerHTML = `
        <div class="${seedCls}">${escapeHtml(seedNum ? String(seedNum) : "-")}</div>
        <div></div>
        <div class="champ-score">${escapeHtml(fmtScore(scoreVal))}</div>
      `;
      row.children[1].replaceWith(btn);
      return row;
    }

    function renderChampionBlock(teamName){
      const champTeamName = String(teamName || "").trim();

      const champStyle = champTeamName ? (getTeamStyle(champTeamName) || {}) : null;
      const bg = champStyle?.bg || "rgba(255,255,255,0.08)";
      const fg = champStyle?.fg || "#ffffff";

      const teamRow = document.createElement("div");
      teamRow.className = "champion-row";

      const cell = document.createElement("div");
      cell.className = "team-cell static";
      cell.style.background = bg;
      cell.style.color = fg;

      const logoHtml = champTeamName
        ? `
          <img class="team-logo"
               src="${escapeHtml(teamLogoSrc(champTeamName))}"
               alt="${escapeHtml(String(champTeamName).toUpperCase())} logo"
               loading="lazy"
               decoding="async"
               onerror="this.style.display='none'; this.removeAttribute('src');" />
        `
        : "";

      cell.innerHTML = `
        <span class="team-logo-slot">${logoHtml}</span>
        <span class="name-text">${escapeHtml(champTeamName ? champTeamName.toUpperCase() : "-")}</span>
      `;
      teamRow.appendChild(cell);

      const rosterStrip = document.createElement("div");
      rosterStrip.className = "champion-roster-strip";

      // Champion roster is ALWAYS sourced from B3:H23
      const teamObj = champTeamByName.get(champTeamName);
      const names = (teamObj?.players || []).map(p => String(p?.name || "").trim()).slice(0,4);
      while (names.length < 4) names.push("");

      for (let i=0;i<4;i++){
        const d = document.createElement("div");
        d.className = "p";
        const label = names[i] ? names[i].toUpperCase() : "-";
        d.innerHTML = escapeHtml(label);
        rosterStrip.appendChild(d);
      }

      const wrap = document.createElement("div");
      wrap.className = "champion-wrap";
      wrap.appendChild(teamRow);
      wrap.appendChild(rosterStrip);

      return wrap;
    }

    function renderChampionship(){
      stageWinnersList.innerHTML = "";
      const winners = (champStageWinners || []);
      for (let i=0;i<3;i++){
        const w = winners[i] || { stage: (i+1), team: "", best: null };
        stageWinnersList.appendChild(renderChampListRow(w.stage ?? (i+1), w.team, w.best));
      }

      wildcardInList.innerHTML = "";
      wildcardOutList.innerHTML = "";

      const slots = Math.max(0, Number(champWildcardSlots) || 0);
      const wc = (champWildcards || []);

      for (let i=0;i<12;i++){
        const r = wc[i] || { rank: i+1, team: "", best: null };
        const rowEl = renderChampListRow(r.rank ?? (i+1), r.team, r.best);
        if (i < slots) wildcardInList.appendChild(rowEl);
        else wildcardOutList.appendChild(rowEl);
      }

      bracketWrap.innerHTML = "";

      const finalsTeams = new Set([champFinals.t1, champFinals.t2].filter(Boolean));
      const championName = String(champChampionName || "").trim();

      const semiWin = (name) => name && finalsTeams.has(name);
      const finalWin = (name) => name && championName && name === championName;

      const seedOf = (name) => bracketSeedForTeam(name);

      const tourney = document.createElement("div");
      tourney.className = "tourney";

      const semisCol = document.createElement("div");
      semisCol.className = "round-col";
      const semisLabel = document.createElement("div");
      semisLabel.className = "bracket-round-label";
      semisLabel.textContent = "Semi-finals";
      semisCol.appendChild(semisLabel);

      const m1 = document.createElement("div");
      m1.className = "match-box";
      const semisKey1 = "semis-1";
      m1.appendChild(renderBracketTeamRow(seedOf(champSemis.s1), champSemis.s1, champSemis.p1, semiWin(champSemis.s1), semisKey1));
      if (expandedChampTeams.has(semisKey1) && champSemis.s1){
        m1.appendChild(champRosterTable(champTeamByName.get(champSemis.s1), "semi"));
      }
      m1.appendChild(document.createElement("div")).className = "match-gap";
      const semisKey4 = "semis-4";
      m1.appendChild(renderBracketTeamRow(seedOf(champSemis.s4), champSemis.s4, champSemis.p4, semiWin(champSemis.s4), semisKey4));
      if (expandedChampTeams.has(semisKey4) && champSemis.s4){
        m1.appendChild(champRosterTable(champTeamByName.get(champSemis.s4), "semi"));
      }

      const m2 = document.createElement("div");
      m2.className = "match-box";
      const semisKey2 = "semis-2";
      m2.appendChild(renderBracketTeamRow(seedOf(champSemis.s2), champSemis.s2, champSemis.p2, semiWin(champSemis.s2), semisKey2));
      if (expandedChampTeams.has(semisKey2) && champSemis.s2){
        m2.appendChild(champRosterTable(champTeamByName.get(champSemis.s2), "semi"));
      }
      m2.appendChild(document.createElement("div")).className = "match-gap";
      const semisKey3 = "semis-3";
      m2.appendChild(renderBracketTeamRow(seedOf(champSemis.s3), champSemis.s3, champSemis.p3, semiWin(champSemis.s3), semisKey3));
      if (expandedChampTeams.has(semisKey3) && champSemis.s3){
        m2.appendChild(champRosterTable(champTeamByName.get(champSemis.s3), "semi"));
      }

      semisCol.appendChild(m1);
      semisCol.appendChild(m2);

      const finalsCol = document.createElement("div");
      finalsCol.className = "finals-col";
      const finalsLabel = document.createElement("div");
      finalsLabel.className = "bracket-round-label";
      finalsLabel.textContent = "Finals";
      finalsCol.appendChild(finalsLabel);

      const mf = document.createElement("div");
      mf.className = "match-box";

      const finalsKey1 = "finals-1";
      mf.appendChild(renderBracketTeamRow(seedOf(champFinals.t1), champFinals.t1, champFinals.s1, finalWin(champFinals.t1), finalsKey1));
      if (expandedChampTeams.has(finalsKey1) && champFinals.t1){
        mf.appendChild(champRosterTable(champTeamByName.get(champFinals.t1), "final"));
      }
      mf.appendChild(document.createElement("div")).className = "match-gap";
      const finalsKey2 = "finals-2";
      mf.appendChild(renderBracketTeamRow(seedOf(champFinals.t2), champFinals.t2, champFinals.s2, finalWin(champFinals.t2), finalsKey2));
      if (expandedChampTeams.has(finalsKey2) && champFinals.t2){
        mf.appendChild(champRosterTable(champTeamByName.get(champFinals.t2), "final"));
      }

      finalsCol.appendChild(mf);

      tourney.appendChild(semisCol);
      tourney.appendChild(finalsCol);
      bracketWrap.appendChild(tourney);

      const champLabel = document.createElement("div");
      champLabel.className = "bracket-subtitle";
      champLabel.textContent = "Champion";
      bracketWrap.appendChild(champLabel);

      bracketWrap.appendChild(renderChampionBlock(championName || ""));
    }

    // -------------------- Interactions --------------------
    teamsList.addEventListener("click", (e)=>{
      const btn = e.target.closest("button.team-cell[data-team]");
      if(!btn) return;
      const teamName = btn.getAttribute("data-team");
      if(!teamName) return;

      expandedTeams.has(teamName) ? expandedTeams.delete(teamName) : expandedTeams.add(teamName);
      renderTeams();
    });

    playersList.addEventListener("click", (e)=>{
      const btn = e.target.closest("button.team-cell[data-player]");
      if(!btn) return;
      const playerName = btn.getAttribute("data-player");
      if(!playerName) return;

      expandedPlayers.has(playerName) ? expandedPlayers.delete(playerName) : expandedPlayers.add(playerName);
      renderPlayers();
    });

    document.getElementById("teamsView").addEventListener("click", (e)=>{
      const cell = e.target.closest("td.clickable-player[data-player]");
      if(!cell) return;
      const name = cell.getAttribute("data-player") || "";
      if(!name) return;
      openPlayerModal(name);
    });

    document.getElementById("playersView").addEventListener("click", (e)=>{
      const btn = e.target.closest("button.full-stats-btn[data-player]");
      if(!btn) return;
      const name = btn.getAttribute("data-player") || "";
      if(!name) return;
      openPlayerModal(name);
    });

    document.getElementById("weeklyView").addEventListener("click", (e)=>{
      const btn = e.target.closest("button.team-cell[data-player]");
      if(!btn) return;
      const name = btn.getAttribute("data-player") || "";
      if(!name) return;
      openPlayerModal(name);
    });

    document.getElementById("champView").addEventListener("click", (e)=>{
      const cell = e.target.closest("td.clickable-player[data-player]");
      if(!cell) return;
      const name = cell.getAttribute("data-player") || "";
      if(!name) return;
      openPlayerModal(name);
    });

    playerSearch.addEventListener("input", renderPlayers);

    // -------------------- Period data cache --------------------
    const periodCache = new Map();
    const champCache = new Map();

    function periodKey(season, stage){
      if (!isStagedSeason(season)) return `S${season}`;
      return `S${season}-${stage === "championship" ? "championship" : `stage${stage}`}`;
    }

    async function getPeriodHistoryData(season, stage){
      const key = periodKey(season, stage);
      if (periodCache.has(key)) return periodCache.get(key);

      const cfg = getPeriodConfig(season, stage);
      if (!cfg) throw new Error("Unknown season/stage config.");

      const sheet = cfg.sheet;

      const ranges = {
        teamStandings: `'${sheet}'!${cfg.teamRank}`,
        rosters: `'${sheet}'!${cfg.rosters}`,
        lookup: `'${sheet}'!${LOOKUP_RANGE_A1}`,
        playerStandings: `'${sheet}'!${RANGE_PLAYER_STANDINGS_A1}`,
      };

      const [teamRows, rosterRows, lookupRows, playerRows] = await Promise.all([
        fetchRange(ranges.teamStandings),
        fetchRange(ranges.rosters),
        fetchRange(ranges.lookup),
        fetchRange(ranges.playerStandings),
      ]);

      const teamList = normalizeStandingsGeneric(teamRows);
      const playerList = normalizeStandingsGeneric(playerRows);

      const teamMap = new Map(teamList.map(t => [t.name, t]));
      const playerMap = new Map(playerList.map(p => [p.name, p]));

      const parsed = parseTeamRosters(rosterRows);
      const lookupMap = parseLookupStats(lookupRows);

      const playerStatsMap = new Map();
      for (const [n, s] of lookupMap.entries()) playerStatsMap.set(n, s);
      for (const [n, s] of parsed.byPlayer.entries()) playerStatsMap.set(n, s);

      const data = {
        seasonNum: Number(season),
        stage,
        sheet,
        teamMap,
        playerMap,
        playerToTeam: parsed.playerTeamByName,
        playerStatsMap,
        captains: parsed.captains
      };

      periodCache.set(key, data);
      return data;
    }

    async function getChampionshipData(season){
      const s = Number(season);
      const key = `S${s}-championship`;
      if (champCache.has(key)) return champCache.get(key);

      const sheet = sheetNameForPeriod(s, "championship");
      const ranges = {
        winners: `'${sheet}'!${CH_STAGE_WINNERS}`,
        wildcards: `'${sheet}'!${CH_WILDCARDS}`,
        slots: `'${sheet}'!${CH_WILDCARD_SLOTS}`,
        roster: `'${sheet}'!${CH_ROSTER}`,

        semis: `'${sheet}'!${CH_SEMIS_BLOCK}`,
        finalsTop: `'${sheet}'!${CH_FINALS_TOP}`,
        finalsBottom: `'${sheet}'!${CH_FINALS_BOTTOM}`,
        champion: `'${sheet}'!${CH_CHAMPION_CELL}`,
      };

      const [
        winnersRows, wildcardRows, slotsRows, rosterRows,
        semisBlock, finalsTopRows, finalsBottomRows, champCell
      ] = await Promise.all([
        fetchRange(ranges.winners).catch(()=>[]),
        fetchRange(ranges.wildcards).catch(()=>[]),
        fetchRange(ranges.slots).catch(()=>[]),
        fetchRange(ranges.roster).catch(()=>[]),

        fetchRange(ranges.semis).catch(()=>[]),
        fetchRange(ranges.finalsTop).catch(()=>[]),
        fetchRange(ranges.finalsBottom).catch(()=>[]),
        fetchRange(ranges.champion).catch(()=>[]),
      ]);
      const finalsBlock = [
        ...(finalsTopRows || []),
        ...(finalsBottomRows || [])
      ];

      const winners = (winnersRows || []).slice(0,3).map((r, idx)=>{
        const stage = toNum(r?.[0]) ?? (idx+1);
        const team  = String(r?.[1] ?? "").trim();
        const best  = toNum(r?.[2]);
        return { stage, team, best };
      });

      const wildcards = (wildcardRows || []).slice(0,12).map((r, idx)=>{
        const rank = toNum(r?.[0]) ?? (idx+1);
        const team = String(r?.[1] ?? "").trim();
        const best = toNum(r?.[2]);
        return { rank, team, best };
      });

      const slots = toNum(slotsRows?.[0]?.[0]) ?? 0;

      // IMPORTANT: roster source of truth for championship rosters
      const parsed = parseChampionshipRoster(rosterRows || []);
      const semis = parseManualSemis(semisBlock || []);
      const finals = parseManualFinals(finalsBlock || []);
      const championName = String(champCell?.[0]?.[0] ?? "").trim();

      const data = {
        season: s,
        sheet,
        winners,
        wildcards,
        slots,
        rosterTeams: parsed.teams,
        rosterByName: parsed.byName,
        seedByName: parsed.seedByName,
        semis,
        finals,
        championName
      };

      champCache.set(key, data);
      return data;
    }

    // -------------------- Auto detection --------------------
    function anyNonBlank(values){
      for (const row of (values || [])){
        for (const c of (row || [])){
          if (String(c ?? "").trim() !== "") return true;
        }
      }
      return false;
    }

    async function hasRoundsDataForStageSheet(season, stage){
      const sheet = sheetNameForPeriod(season, stage);
      const r1 = await fetchRange(`'${sheet}'!${DETECT_R1}`).catch(()=>[]);
      const r2 = await fetchRange(`'${sheet}'!${DETECT_R2}`).catch(()=>[]);
      return anyNonBlank(r1) || anyNonBlank(r2);
    }

    function nextStagePeriod(season, stage){
      const s = Number(season);
      const st = Number(stage);
      if (st < 3) return { season: s, stage: st + 1 };
      return { season: s + 1, stage: 1 };
    }

    async function initialDetectCurrent(){
      STAGE_DATA_BY_SEASON = new Map();

      let curSeason = 5;
      let curStage  = 1;

      let s = 6;
      let st = 1;

      while (s <= MAX_SEASON_TO_CHECK){
        const ok = await hasRoundsDataForStageSheet(s, st).catch(()=>false);
        if (!ok) break;

        STAGE_DATA_BY_SEASON.set(s, Math.max(STAGE_DATA_BY_SEASON.get(s) || 0, st));
        curSeason = s;
        curStage  = st;

        const nxt = nextStagePeriod(s, st);
        s = nxt.season;
        st = nxt.stage;
      }

      if (curSeason >= 6){
        DETECTED_CURRENT_SEASON = curSeason;
        DETECTED_CURRENT_STAGE = curStage;
      } else {
        DETECTED_CURRENT_SEASON = 5;
        DETECTED_CURRENT_STAGE = 1;
      }

      const maxSeason = Math.max(DETECTED_CURRENT_SEASON, 5);
      AVAILABLE_SEASONS = [];
      for (let i=1; i<=maxSeason; i++) AVAILABLE_SEASONS.push(i);

      for (let i=6; i<=maxSeason; i++){
        if (!STAGE_DATA_BY_SEASON.has(i)){
          STAGE_DATA_BY_SEASON.set(i, 3);
        }
      }
    }

    async function checkForNewStagePeriod(){
      if (DETECTED_CURRENT_SEASON < 6) {
        const ok = await hasRoundsDataForStageSheet(6, 1).catch(()=>false);
        if (ok){
          DETECTED_CURRENT_SEASON = 6;
          DETECTED_CURRENT_STAGE = 1;
          STAGE_DATA_BY_SEASON.set(6, 1);
          AVAILABLE_SEASONS = [];
          for (let i=1; i<=6; i++) AVAILABLE_SEASONS.push(i);
          buildSeasonDropdown();
          applyStageDropdownForSeason(currentSelectedSeason(), true);
          syncUrlToSelection();
        }
        return;
      }

      const nxt = nextStagePeriod(DETECTED_CURRENT_SEASON, DETECTED_CURRENT_STAGE);
      if (nxt.season > MAX_SEASON_TO_CHECK) return;

      const ok = await hasRoundsDataForStageSheet(nxt.season, nxt.stage).catch(()=>false);
      if (!ok) return;

      DETECTED_CURRENT_SEASON = nxt.season;
      DETECTED_CURRENT_STAGE = nxt.stage;

      STAGE_DATA_BY_SEASON.set(nxt.season, Math.max(STAGE_DATA_BY_SEASON.get(nxt.season) || 0, nxt.stage));

      if (!AVAILABLE_SEASONS.includes(nxt.season)){
        const max = nxt.season;
        AVAILABLE_SEASONS = [];
        for (let i=1; i<=max; i++) AVAILABLE_SEASONS.push(i);
        for (let i=6; i<=max; i++){
          if (!STAGE_DATA_BY_SEASON.has(i)) STAGE_DATA_BY_SEASON.set(i, 1);
        }
        buildSeasonDropdown();
      }

      applyStageDropdownForSeason(currentSelectedSeason(), false);
      syncUrlToSelection();
    }

    // -------------------- Dropdowns --------------------
    function buildSeasonDropdown(){
      seasonSelect.innerHTML = "";
      const seasonsDesc = AVAILABLE_SEASONS.slice().sort((a,b)=>b-a);
      for (const s of seasonsDesc){
        const opt = document.createElement("option");
        opt.value = String(s);
        opt.textContent = `Season ${s}`;
        seasonSelect.appendChild(opt);
      }
    }

    function applyStageDropdownForSeason(seasonNum, resetIfInvalid){
      const s = Number(seasonNum);
      if (!isStagedSeason(s)){
        stageWrap.classList.add("hidden");
        stageSelect.innerHTML = "";
        return;
      }

      stageWrap.classList.remove("hidden");
      stageSelect.innerHTML = "";

      let maxStage = 3;
      if (s === DETECTED_CURRENT_SEASON){
        maxStage = Number(DETECTED_CURRENT_STAGE || 1);
      }

      for (let st=1; st<=3; st++){
        if (s === DETECTED_CURRENT_SEASON && st > maxStage) continue;
        const opt = document.createElement("option");
        opt.value = String(st);
        opt.textContent = `Stage ${st}`;
        stageSelect.appendChild(opt);
      }

      const optC = document.createElement("option");
      optC.value = "championship";
      optC.textContent = "Championship";
      stageSelect.appendChild(optC);

      const curVal = (stageSelect.value || "").toLowerCase();
      if (resetIfInvalid || !curVal || !Array.from(stageSelect.options).some(o=>o.value===curVal)){
        const desired = (s === DETECTED_CURRENT_SEASON) ? String(DETECTED_CURRENT_STAGE) : "1";
        if (Array.from(stageSelect.options).some(o=>o.value===desired)) stageSelect.value = desired;
        else stageSelect.value = stageSelect.options[0]?.value || "championship";
      }
    }

    seasonSelect.addEventListener("change", ()=>{
      expandedTeams.clear();
      expandedPlayers.clear();
      expandedChampTeams.clear();
      playerSearch.value = "";

      applyStageDropdownForSeason(currentSelectedSeason(), true);
      syncUrlToSelection();
      update(true);
    });

    stageSelect.addEventListener("change", ()=>{
      expandedTeams.clear();
      expandedPlayers.clear();
      expandedChampTeams.clear();
      playerSearch.value = "";

      syncUrlToSelection();
      update(true);
    });

    // -------------------- Player modal (restored season-stacked layout) --------------------
    function stageRank(stage){
      if (stage === "championship") return 99;
      const n = Number(stage);
      return Number.isFinite(n) ? n : 0;
    }

    function addTrophy(map, key, { icon, main, sub, tier, stackable = false, category = "other", season = null, stage = null }){
      const cur = map.get(key) || { count:0, icon, main, sub, tier, stackable, category, season: null, stage: null };
      cur.count += 1;
      if (!cur.category) cur.category = category;
      if (season != null || stage != null){
        const nextSeason = season != null ? Number(season) : null;
        const curSeason = cur.season != null ? Number(cur.season) : null;
        const nextStageRank = stageRank(stage);
        const curStageRank = stageRank(cur.stage);
        const isNewer = (curSeason == null && nextSeason != null)
          || (curSeason != null && nextSeason != null && nextSeason > curSeason)
          || (curSeason != null && nextSeason != null && nextSeason === curSeason && nextStageRank > curStageRank);
        if (isNewer || curSeason == null){
          cur.season = season ?? cur.season;
          cur.stage = stage ?? cur.stage;
        }
      }
      map.set(key, cur);
    }

    function trophyTier(key){
      if (key === "gold") return "tier-gold";
      if (key === "silver") return "tier-silver";
      if (key === "bronze") return "tier-bronze";
      if (key === "purple") return "tier-purple";
      if (key === "blue") return "tier-blue";
      if (key === "green") return "tier-green";
      return "tier-default";
    }

    function scoreTier(score, thresholds){
      if (!Number.isFinite(score)) return "";
      if (score <= thresholds.gold) return trophyTier("gold");
      if (score <= thresholds.purple) return trophyTier("purple");
      if (score <= thresholds.blue) return trophyTier("blue");
      return "";
    }

    function ordinalSuffix(n){
      if (n === 1) return "1st";
      if (n === 2) return "2nd";
      if (n === 3) return "3rd";
      return `${n}th`;
    }

    function renderTrophyChips(trophyMap){
      const wrap = document.createElement("div");
      wrap.className = "trophy-grid";

      const tierOrder = [
        "tier-gold",
        "tier-silver",
        "tier-bronze",
        "tier-purple",
        "tier-blue",
        "tier-green",
        "tier-default"
      ];
      const categoryOrder = ["team", "individual", "other"];
      const entries = Array.from(trophyMap.values())
        .filter(t => t.count > 0)
        .sort((a,b)=>{
          const tierDiff = tierOrder.indexOf(a.tier || "tier-default") - tierOrder.indexOf(b.tier || "tier-default");
          if (tierDiff !== 0) return tierDiff;
          const categoryDiff = categoryOrder.indexOf(a.category || "other") - categoryOrder.indexOf(b.category || "other");
          if (categoryDiff !== 0) return categoryDiff;
          const seasonA = Number.isFinite(Number(a.season)) ? Number(a.season) : -1;
          const seasonB = Number.isFinite(Number(b.season)) ? Number(b.season) : -1;
          if (seasonA !== seasonB) return seasonB - seasonA;
          const stageA = stageRank(a.stage);
          const stageB = stageRank(b.stage);
          if (stageA !== stageB) return stageB - stageA;
          if (b.count !== a.count) return b.count - a.count;
          return a.main.localeCompare(b.main);
        });

      if (!entries.length){
        wrap.innerHTML = `<div class="error" style="padding:8px 0 0; font-size:14px;">No trophies yet.</div>`;
        return wrap;
      }

      for (const t of entries){
        const div = document.createElement("div");
        const hasSub = Boolean(t.sub && String(t.sub).trim());
        div.className = `trophy ${t.tier || "tier-default"}${hasSub ? "" : " no-sub"}`;
        const countMarkup = (t.stackable && t.count > 1)
          ? `<div class="trophy-count">×${t.count}</div>`
          : "";
        const subMarkup = hasSub ? `<div class="trophy-sub">${escapeHtml(t.sub)}</div>` : "";
        div.innerHTML = `
          <div class="trophy-left">
            <div class="trophy-icon ${t.icon === "captain" ? "captain" : ""}">${t.icon === "captain" ? "" : escapeHtml(t.icon || "🏆")}</div>
            <div class="trophy-text">
              <div class="trophy-main">${escapeHtml(t.main)}</div>
              ${subMarkup}
            </div>
          </div>
          ${countMarkup}
        `;
        wrap.appendChild(div);
      }

      return wrap;
    }

    function stageWeight(stage){
      if (stage === "championship") return 4;
      if (stage === null || stage === undefined) return 4; // seasons 1-5
      const n = Number(stage);
      return Number.isFinite(n) ? n : 0;
    }
    function stageHeaderText(season, stage){
      const s = Number(season);
      if (!isStagedSeason(s)) return "Season";
      if (stage === "championship") return "Championship";
      return `Stage ${Number(stage)}`;
    }

    function renderStageRoundsTable(stats){
      const rounds = stats?.rounds || [];
      const highlightIdx = pickTop3RoundIndices(rounds);

      const table = document.createElement("table");
      table.className = "stage-rounds";
      table.innerHTML = `
        <thead>
          <tr>
            <th>1-1</th><th class="sep-right">1-2</th>
            <th>2-1</th><th class="sep-right">2-2</th>
            <th>3-1</th><th class="sep-right">3-2</th>
            <th>4-1</th><th>4-2</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            ${Array.from({length:8}, (_,i)=>{
              const isSep = (i===1 || i===3 || i===5);
              const cls = `${highlightIdx.has(i) ? "counted" : ""} ${isSep ? "sep-right" : ""}`.trim();
              return `<td class="${cls}">${escapeHtml(fmtScore(rounds[i] ?? null))}</td>`;
            }).join("")}
          </tr>
        </tbody>
      `;
      return table;
    }

    // Season bubble, with stages stacked inside (most recent stage on top).
    // Each stage shows: header, team performance row, individual performance row, and rounds table.
    function renderSeasonStackedPerformance(summaries){
      const container = document.createElement("div");
      container.innerHTML = `<div class="season-title">Season Performance</div>`;

      // Group by season
      const bySeason = new Map();
      for (const s of (summaries || [])){
        if (!bySeason.has(s.season)) bySeason.set(s.season, []);
        bySeason.get(s.season).push(s);
      }

      const seasons = Array.from(bySeason.keys()).sort((a,b)=>b-a);

      for (const season of seasons){
        const box = document.createElement("div");
        box.className = "season-entry";

        const head = document.createElement("div");
        head.className = "season-entry-head";
        head.innerHTML = `<div class="season-entry-name">${escapeHtml(`Season ${season}`)}</div>`;
        box.appendChild(head);

        const entries = bySeason.get(season)
          .slice()
          .sort((a,b)=> stageWeight(b.stage) - stageWeight(a.stage));

        for (const e of entries){
          const stageBlock = document.createElement("div");
          stageBlock.className = "stage-block";

          if (isStagedSeason(season)){
            const hdr = document.createElement("div");
            hdr.className = "stage-header";
            hdr.textContent = stageHeaderText(season, e.stage);
            stageBlock.appendChild(hdr);
          }

          // TEAM PERFORMANCE ROW
          const row1 = document.createElement("div");
          row1.className = "btn-row";

          if (e.teamName){
            const ts = getTeamStyle(e.teamName) || {};
            const teamChip = document.createElement("div");
            teamChip.className = "chip team";
            teamChip.style.setProperty("--team-bg", ts.bg || "rgba(255,255,255,0.06)");
            teamChip.style.setProperty("--team-fg", ts.fg || "rgba(255,255,255,0.92)");
            teamChip.textContent = String(e.teamName).toUpperCase();
            row1.appendChild(teamChip);
          } else {
            const c = document.createElement("div");
            c.className = "chip solo";
            c.textContent = "SOLO PLAYER";
            row1.appendChild(c);
          }

          // For championship stage in the modal: show team only (no ranks/scores)
          if (!e.isChampionship){
            if (e.teamRank != null){
              const c = document.createElement("div");
              c.className = `chip rank ${rankClass(e.teamRank)}`.trim();
              c.textContent = `#${e.teamRank} TEAM`.toUpperCase();
              row1.appendChild(c);
            }
            if (e.teamScore != null){
              const c = document.createElement("div");
              c.className = "chip score";
              c.textContent = fmtScore(e.teamScore);
              row1.appendChild(c);
            }
          } else if (e.champResult){
            const c = document.createElement("div");
            const champClass = e.champResult === "champion"
              ? "gold"
              : e.champResult === "runner-up"
                ? "silver"
                : "blue";
            c.className = `chip rank ${champClass}`.trim();
            c.textContent = String(e.champResult).toUpperCase();
            row1.appendChild(c);
          }
          stageBlock.appendChild(row1);

          // INDIVIDUAL PERFORMANCE ROW
          if (!e.isChampionship){
            const row2 = document.createElement("div");
            row2.className = "btn-row";

            if (e.playerRank != null){
              const c = document.createElement("div");
              c.className = `chip rank ${rankClass(e.playerRank)}`.trim();
              c.textContent = `#${e.playerRank} OVERALL`.toUpperCase();
              row2.appendChild(c);
            }
            if (e.playerScore != null){
              const c = document.createElement("div");
              c.className = "chip score";
              c.textContent = fmtScore(e.playerScore);
              row2.appendChild(c);
            }

            stageBlock.appendChild(row2);
          }

          // ROUNDS TABLE (for non-championship stages/seasons; uses that period's rounds)
          if (!e.isChampionship && e.stats && Array.isArray(e.stats.rounds)){
            stageBlock.appendChild(renderStageRoundsTable(e.stats));
          }

          box.appendChild(stageBlock);
        }

        container.appendChild(box);
      }

      return container;
    }

    async function openPlayerModal(playerName){
      const cleanName = String(playerName).trim();
      if(!cleanName) return;

      playerModal.classList.add("show");
      playerModal.setAttribute("aria-hidden", "false");
      showPlayerLoading();

      const card = playerModal.querySelector(".modal-card");
      if (card) card.scrollTop = 0;

      try{
        const periods = [];
        const maxSeason = Math.max(...AVAILABLE_SEASONS);

        for (let s=1; s<=maxSeason; s++){
          if (!isStagedSeason(s)){
            periods.push({ season: s, stage: null });
          } else {
            const maxStage = (s === DETECTED_CURRENT_SEASON)
              ? Number(DETECTED_CURRENT_STAGE || 1)
              : Number(STAGE_DATA_BY_SEASON.get(s) || 3);
            for (let st=1; st<=maxStage; st++){
              periods.push({ season: s, stage: st });
            }
            periods.push({ season: s, stage: "championship" });
          }
        }

        const summaries = [];
        const allRoundsAgg = [];
        const periodTotalsAgg = [];

        let season60 = 0, season70 = 0, season80 = 0;
        let round20 = 0, round25 = 0, round30 = 0;
        let captainCount = 0;

        const seasonChampionTeams = new Map();

        let headerTeam = null;
        if (DETECTED_CURRENT_SEASON < 6){
          const curData = await getPeriodHistoryData(DETECTED_CURRENT_SEASON, null);
          headerTeam = curData.playerToTeam.get(cleanName) || null;
        } else {
          const curData = await getPeriodHistoryData(DETECTED_CURRENT_SEASON, DETECTED_CURRENT_STAGE);
          headerTeam = curData.playerToTeam.get(cleanName) || null;
        }

        for (const p of periods){
          const isChamp = (p.stage === "championship");

          if (isChamp && isStagedSeason(p.season)){
            const ch = await getChampionshipData(p.season).catch(()=>null);
            if (!ch) continue;
            if (!ch.championName) continue;

            // Player appears in one of the 4 championship rosters (B3:H23)
            const inRosterTeam = (ch.rosterTeams || []).find(t => (t.players || []).some(pl => String(pl.name||"").trim() === cleanName));
            if (!inRosterTeam) continue;

            // Season Champion trophy: player listed on champion roster
            if (ch.championName && inRosterTeam?.name && String(inRosterTeam.name).trim() === String(ch.championName).trim()){
              seasonChampionTeams.set(p.season, String(inRosterTeam.name).trim());
            }

            const finalsTeams = new Set([ch.finals?.t1, ch.finals?.t2].filter(Boolean));
            const rosterName = String(inRosterTeam?.name || "").trim();
            const championName = String(ch.championName || "").trim();
            let champResult = "semi-finalist";
            if (finalsTeams.has(rosterName)) champResult = "runner-up";
            if (rosterName && championName && rosterName === championName) champResult = "champion";

            summaries.push({
              season: p.season,
              stage: "championship",
              teamName: inRosterTeam?.name || null,
              teamRank: null,
              teamScore: null,
              playerRank: null,
              playerScore: null,
              stats: null,
              isChampionship: true,
              champResult
            });
            continue;
          }

          const data = await getPeriodHistoryData(p.season, p.stage);

          const teamName = data.playerToTeam.get(cleanName) || null;
          const teamStanding = teamName ? (data.teamMap.get(teamName) || null) : null;

          const playerStanding = data.playerMap.get(cleanName) || null;
          const stats = data.playerStatsMap.get(cleanName) || null;

          const hasAny = !!teamName || !!playerStanding || !!stats;
          if(!hasAny) continue;

          if (stats && Array.isArray(stats.rounds)){
            for (const v of stats.rounds){
              const n = normalizeRoundValue(v);
              if (Number.isFinite(n)){
                allRoundsAgg.push(n);
                if (n <= -20) round20++;
                if (n <= -25) round25++;
                if (n <= -30) round30++;
              }
            }
          }

          const periodTotal = (playerStanding?.score ?? stats?.stageScore);
          if (Number.isFinite(periodTotal)){
            periodTotalsAgg.push(Number(periodTotal));
            if (periodTotal <= -60) season60++;
            if (periodTotal <= -70) season70++;
            if (periodTotal <= -80) season80++;
          }

          if (data.captains?.has(cleanName)) captainCount++;

          summaries.push({
            season: p.season,
            stage: p.stage,
            teamName,
            teamRank: teamStanding?.rank ?? null,
            teamScore: teamStanding?.score ?? null,
            playerRank: playerStanding?.rank ?? null,
            playerScore: (playerStanding?.score ?? stats?.stageScore) ?? null,
            stats: stats || null,
            isChampionship: false
          });
        }

        const headerLogo = headerTeam ? teamLogoSrc(headerTeam) : null;

        const bestRound = allRoundsAgg.length ? Math.min(...allRoundsAgg) : null;
        const avgRound  = allRoundsAgg.length ? (allRoundsAgg.reduce((a,b)=>a+b,0) / allRoundsAgg.length) : null;

        const bestPeriod = periodTotalsAgg.length ? Math.min(...periodTotalsAgg) : null;
        const avgPeriod  = periodTotalsAgg.length ? (periodTotalsAgg.reduce((a,b)=>a+b,0) / periodTotalsAgg.length) : null;

        const bestRoundTier = scoreTier(bestRound, { blue: -20, purple: -25, gold: -30 });
        const bestSeasonTier = scoreTier(bestPeriod, { blue: -60, purple: -70, gold: -80 });

        // TROPHIES (placement trophies only when concluded; others as they happen)
        const trophyMap = new Map();

        // Clubs
        for (let i=0;i<round20;i++) addTrophy(trophyMap, "r20", { icon:"⛳️", main:"-20 CLUB", sub:null, tier:trophyTier("blue"), stackable:true, category:"other" });
        for (let i=0;i<round25;i++) addTrophy(trophyMap, "r25", { icon:"⛳️", main:"-25 CLUB", sub:null, tier:trophyTier("purple"), stackable:true, category:"other" });
        for (let i=0;i<round30;i++) addTrophy(trophyMap, "r30", { icon:"⛳️", main:"-30 CLUB", sub:null, tier:trophyTier("gold"), stackable:true, category:"other" });

        for (let i=0;i<season60;i++) addTrophy(trophyMap, "s60", { icon:"🏅", main:"-60 CLUB", sub:null, tier:trophyTier("blue"), stackable:true, category:"other" });
        for (let i=0;i<season70;i++) addTrophy(trophyMap, "s70", { icon:"🏅", main:"-70 CLUB", sub:null, tier:trophyTier("purple"), stackable:true, category:"other" });
        for (let i=0;i<season80;i++) addTrophy(trophyMap, "s80", { icon:"🏅", main:"-80 CLUB", sub:null, tier:trophyTier("gold"), stackable:true, category:"other" });

        // Captain (green)
        for (let i=0;i<captainCount;i++) addTrophy(trophyMap, "cap", { icon:"captain", main:"Captain", sub:"", tier:trophyTier("green"), stackable:true, category:"other" });

        // Placement trophies only once concluded
        for (const s of summaries){
          if (s.isChampionship){
            if (s.champResult === "champion"){
              const champTeamName = s.teamName || seasonChampionTeams.get(s.season) || "";
              addTrophy(trophyMap, `championship-${s.season}-champ`, {
                icon:"🏆",
                main:"CHAMPION",
                sub: champTeamName ? `Season ${s.season}, ${champTeamName}` : `Season ${s.season}`,
                tier: trophyTier("gold"),
                category:"team",
                season: s.season,
                stage: "championship"
              });
            }
            if (s.champResult === "runner-up"){
              addTrophy(trophyMap, `championship-${s.season}-runner`, {
                icon:"🥈",
                main:"RUNNER-UP",
                sub: periodDisplayLabel(s.season, "championship"),
                tier: trophyTier("silver"),
                category:"team",
                season: s.season,
                stage: "championship"
              });
            }
            if (s.champResult === "semi-finalist"){
              addTrophy(trophyMap, `championship-${s.season}-semi`, {
                icon:"🏅",
                main:"SEMI-FINALIST",
                sub: periodDisplayLabel(s.season, "championship"),
                tier: trophyTier("blue"),
                category:"team",
                season: s.season,
                stage: "championship"
              });
            }
            continue;
          }
          const concluded = isPeriodConcluded(s.season, s.stage);

          if (concluded && (s.teamRank === 1 || s.teamRank === 2 || s.teamRank === 3)){
            const tierKey = (s.teamRank === 1) ? "gold" : (s.teamRank === 2) ? "silver" : "bronze";
            const icon = (s.teamRank === 1) ? "🥇" : (s.teamRank === 2) ? "🥈" : "🥉";
            addTrophy(trophyMap, `teamPod-${s.season}-${s.stage}-${s.teamRank}`, {
              icon,
              main:`#${s.teamRank} TEAM`,
              sub: periodDisplayLabel(s.season, s.stage),
              tier: trophyTier(tierKey),
              category:"team",
              season: s.season,
              stage: s.stage
            });
          }
          if (concluded && (s.playerRank === 1 || s.playerRank === 2 || s.playerRank === 3)){
            const tierKey = (s.playerRank === 1) ? "gold" : (s.playerRank === 2) ? "silver" : "bronze";
            const icon = (s.playerRank === 1) ? "🥇" : (s.playerRank === 2) ? "🥈" : "🥉";
            addTrophy(trophyMap, `indPod-${s.season}-${s.stage}-${s.playerRank}`, {
              icon,
              main:`#${s.playerRank} OVERALL`,
              sub: periodDisplayLabel(s.season, s.stage),
              tier: trophyTier(tierKey),
              category:"individual",
              season: s.season,
              stage: s.stage
            });
          }

          if (concluded && Number.isFinite(s.playerRank) && s.playerRank <= 10){
            addTrophy(trophyMap, "top10", {
              icon:"🏅",
              main:"top 10",
              sub:null,
              tier: trophyTier("blue"),
              stackable:true,
              category:"other",
              season: s.season,
              stage: s.stage
            });
          }
        }

        const left = document.createElement("div");
        left.className = "modal-pane modal-left";

        const hero = document.createElement("div");
        hero.className = "player-hero";
        hero.innerHTML = `
          <div class="hero-team">
            ${headerLogo ? `<img src="${escapeHtml(headerLogo)}" alt="Team logo" loading="lazy" decoding="async" onerror="this.style.display='none';" />` : ``}
          </div>
          <div class="hero-text">
            <div class="hero-name">${escapeHtml(cleanName.toUpperCase())}</div>
            <div class="hero-sub ${headerTeam ? "" : "solo"}">${escapeHtml(headerTeam ? String(headerTeam).toUpperCase() : "SOLO PLAYER")}</div>
          </div>
        `;
        left.appendChild(hero);

        const info = document.createElement("div");
        info.className = "info-btn-grid";
        info.innerHTML = `
          <div class="info-btn ${bestRoundTier}"><div class="lbl">Best Round</div><div class="val">${escapeHtml(fmtScore(bestRound))}</div></div>
          <div class="info-btn"><div class="lbl">Avg Round</div><div class="val">${escapeHtml(fmtScoreAvg(avgRound))}</div></div>
          <div class="info-btn ${bestSeasonTier}"><div class="lbl">Best Total</div><div class="val">${escapeHtml(fmtScore(bestPeriod))}</div></div>
          <div class="info-btn"><div class="lbl">Avg Total</div><div class="val">${escapeHtml(fmtScoreAvg(avgPeriod))}</div></div>
        `;
        left.appendChild(info);

        const trophiesPane = document.createElement("div");
        trophiesPane.className = "modal-pane trophies-pane";
        trophiesPane.innerHTML = `<div class="trophy-title">Trophies</div>`;
        trophiesPane.appendChild(renderTrophyChips(trophyMap));

        const seasonPane = document.createElement("div");
        seasonPane.className = "modal-pane";
        seasonPane.appendChild(renderSeasonStackedPerformance(summaries));

        const leftColumn = document.createElement("div");
        leftColumn.className = "modal-column";
        leftColumn.appendChild(left);
        leftColumn.appendChild(trophiesPane);

        const rightColumn = document.createElement("div");
        rightColumn.className = "modal-column";
        rightColumn.appendChild(seasonPane);

        playerModalContent.className = "modal-body";
        playerModalContent.innerHTML = "";
        playerModalContent.appendChild(leftColumn);
        playerModalContent.appendChild(rightColumn);

      }catch(err){
        playerModalContent.className = "modal-body";
        playerModalContent.innerHTML = `
          <div class="modal-pane" style="grid-column:1 / -1;">
            <div class="error"><b>Couldn’t load player history</b><div style="margin-top:8px;opacity:.85;">${escapeHtml(err.message || "Failed to load.")}</div></div>
          </div>
        `;
      }
    }

    // -------------------- Data update --------------------
    let updating = false;

    async function update(force=false){
      if(updating && !force) return;
      updating = true;

      try{
        const seasonNum = currentSelectedSeason();
        const stageVal = currentSelectedStage();
        const isChamp = (stageVal === "championship" && isStagedSeason(seasonNum));

        normalStack.classList.toggle("hidden", isChamp);
        champView.classList.toggle("hidden", !isChamp);

        if (isChamp){
          const ch = await getChampionshipData(seasonNum).catch(()=>null);

          champStageWinners = ch?.winners || [{},{},{}];
          champWildcards = ch?.wildcards || [];
          champWildcardSlots = ch?.slots || 0;

          champTeams = ch?.rosterTeams || [];
          champTeamByName = ch?.rosterByName || new Map();
          champSeedByName = ch?.seedByName || new Map();

          champSemis = ch?.semis || { s1:"",s2:"",s3:"",s4:"",p1:null,p2:null,p3:null,p4:null };
          champFinals = ch?.finals || { t1:"",t2:"",s1:null,s2:null };
          champChampionName = ch?.championName || "";

          renderChampionship();

          statusCard.classList.add("hidden");
          contentEl.classList.remove("hidden");
          return;
        }

        const cfg = getPeriodConfig(seasonNum, stageVal);
        if (!cfg) throw new Error("Unknown season/stage.");

        const sheet = cfg.sheet;

        const ranges = {
          teamStandings: `'${sheet}'!${cfg.teamRank}`,
          rosters: `'${sheet}'!${cfg.rosters}`,
          lookup: `'${sheet}'!${LOOKUP_RANGE_A1}`,

          playerStandings: `'${sheet}'!${RANGE_PLAYER_STANDINGS_A1}`,
          week1: `'${sheet}'!${RANGE_W1_A1}`,
          week2: `'${sheet}'!${RANGE_W2_A1}`,
          week3: `'${sheet}'!${RANGE_W3_A1}`,
          week4: `'${sheet}'!${RANGE_W4_A1}`,
        };

        const [
          teamRows, rosterRows, lookupRows,
          playerRows, wk1, wk2, wk3, wk4
        ] = await Promise.all([
          fetchRange(ranges.teamStandings),
          fetchRange(ranges.rosters),
          fetchRange(ranges.lookup),

          fetchRange(ranges.playerStandings),
          fetchRange(ranges.week1),
          fetchRange(ranges.week2),
          fetchRange(ranges.week3),
          fetchRange(ranges.week4),
        ]);

        teamStandings = normalizeStandingsGeneric(teamRows);
        playerStandings = normalizeStandingsGeneric(playerRows);

        const parsedTeams = parseTeamRosters(rosterRows);
        rosterByTeam = parsedTeams.byTeam;
        playerTeamByName = parsedTeams.playerTeamByName;
        captainsSet = parsedTeams.captains;

        const lookupMap = parseLookupStats(lookupRows);

        playerStatsByName = new Map();
        for (const [name, stat] of lookupMap.entries()) playerStatsByName.set(name, stat);
        for (const [name, stat] of parsedTeams.byPlayer.entries()) playerStatsByName.set(name, stat);

        weeklyByWeek = new Map();
        const w1 = normalizeStandingsGeneric(wk1);
        const w2 = normalizeStandingsGeneric(wk2);
        const w3 = normalizeStandingsGeneric(wk3);
        const w4 = normalizeStandingsGeneric(wk4);

        if (w1.length) weeklyByWeek.set(1, w1);
        if (w2.length) weeklyByWeek.set(2, w2);
        if (w3.length) weeklyByWeek.set(3, w3);
        if (w4.length) weeklyByWeek.set(4, w4);

        renderTeams();
        renderPlayers();
        renderWeekly();

        statusCard.classList.add("hidden");
        contentEl.classList.remove("hidden");
      }catch(err){
        statusCard.classList.remove("hidden");
        contentEl.classList.add("hidden");
        statusCard.innerHTML =
          `<div class="error"><b>Couldn’t load data</b>` +
          `<div style="margin-top:8px;opacity:.85;">${escapeHtml(err.message || "Failed to load standings.")}</div></div>`;
        console.error(err);
      }finally{
        updating = false;
      }
    }

    // -------------------- Boot --------------------
    (async function boot(){
      showPlayerLoading();

      await initialDetectCurrent();

      buildSeasonDropdown();

      const params = new URLSearchParams(location.search);
      const seasonParam = Number(params.get("season"));
      const stageParamRaw = (params.get("stage") || "").toLowerCase();

      const hasUrlSeason = Number.isFinite(seasonParam) && AVAILABLE_SEASONS.includes(seasonParam);
      const hasUrlStage = !!stageParamRaw;

      let seasonInit = DETECTED_CURRENT_SEASON;
      if (hasUrlSeason){
        seasonInit = seasonParam;
      } else if (MANUAL_INITIAL_PERIOD?.enabled && Number.isFinite(Number(MANUAL_INITIAL_PERIOD.season))){
        const ms = Number(MANUAL_INITIAL_PERIOD.season);
        if (AVAILABLE_SEASONS.includes(ms)) seasonInit = ms;
      }

      seasonSelect.value = String(seasonInit);
      applyStageDropdownForSeason(seasonInit, true);

      if (isStagedSeason(seasonInit)){
        let desiredStage = null;

        if (hasUrlStage){
          desiredStage = stageParamRaw;
        } else if (MANUAL_INITIAL_PERIOD?.enabled && MANUAL_INITIAL_PERIOD.stage != null){
          desiredStage = String(MANUAL_INITIAL_PERIOD.stage).toLowerCase();
        }

        if (desiredStage){
          const ok = Array.from(stageSelect.options).some(o => o.value === desiredStage);
          if (ok) stageSelect.value = desiredStage;
        }
      }

      syncUrlToSelection();

      await update(true);

    })();
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NSS Golf Super League</title>

  <style>
    :root{
      --bg1:#061C3B; --bg2:#04142E; --bg3:#020B18;

      --card-bg: rgba(15,23,42,1);
      --card-shadow: 0 32px 32px rgba(0,0,0,0.65);
      --header-bg: rgba(148,163,184,0.12);
      --row-bg: rgba(255,255,255,0.06);

      --text: #e9eef8;
      --title: #c7d7ff;
      --muted: #9ca3c7;

      --border-lite: rgba(148,163,184,0.20);
      --btn-bg: rgba(255,255,255,0.06);
      --btn-bg-hover: rgba(255,255,255,0.10);
      --btn-border: rgba(255,255,255,0.15);
      --btn-border-hover: rgba(255,255,255,0.28);

      --division-1-bg: rgba(234,179,8,0.16);
      --division-2-bg: rgba(203,213,225,0.13);
      --division-3-bg: rgba(180,83,9,0.14);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(to bottom, var(--bg1), var(--bg2), var(--bg3));
    }

    .topbar{
      position: sticky; top:0; z-index:10;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(3,18,42,.70);
      backdrop-filter: blur(10px);
    }
    .topbar-inner{
      max-width:1100px;
      margin:0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .topbar-actions{
      display:flex;
      gap:8px;
      align-items:center;
    }

    .view-btn{
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: rgba(255,255,255,.92);
      border-radius: 999px;
      padding: 9px 14px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
      font-weight: 850;
      cursor: pointer;
    }
    .view-btn:hover{
      background: var(--btn-bg-hover);
      border-color: var(--btn-border-hover);
    }
    .view-btn.is-active{
      background: rgba(255,255,255,0.18);
      border-color: rgba(255,255,255,0.45);
      color: #fff;
    }
    .home-badge{
      width:40px; height:40px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.05);
      display:grid; place-items:center;
      overflow:hidden;
      user-select:none;
    }
    .home-badge img{
      width:70%;
      height:70%;
      object-fit: contain;
      display:block;
      pointer-events:none;
    }

    .kicker{
      font-size:11px;
      letter-spacing:.25em;
      text-transform:uppercase;
      color: rgba(255,255,255,.65);
      font-weight:900;
    }

    .container{
      max-width:1100px;
      margin:0 auto;
      padding: 28px 18px 56px;
      display:grid;
      gap: 12px;
      justify-items:center;
    }

    .main-view-switch{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .card{
      width: min(920px, 100%);
      background: var(--card-bg);
      border-radius: 20px;
      padding: 26px 20px;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255,255,255,0.10);
      display:grid;
      gap:16px;
    }

    .headline{
      font-size: 22px;
      font-weight: 950;
      color: var(--title);
      letter-spacing: .035em;
      text-transform: uppercase;
      margin: 0;
      text-align: center;
    }

    .season-head{
      min-height: 44px;
      padding: 2px 0;
      margin-bottom: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .subhead{
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.45;
    }

    .status{
      color: var(--muted);
      font-size: 13px;
      margin: 0;
    }

    .division-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
      align-items:start;
    }

    .division-card{
      border: 1px solid var(--border-lite);
      border-radius: 16px;
      padding: 12px;
      background: rgba(15,23,42,0.55);
      overflow-x: auto;
    }

    .division-title{
      margin: 0 0 10px;
      font-size: 12px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: rgba(231,238,255,0.92);
      text-align: center;
    }
    .division-title.division-1,
    .schedule-division-title.division-1{ color: #fcd34d; }
    .division-title.division-2,
    .schedule-division-title.division-2{ color: #e5e7eb; }
    .division-title.division-3,
    .schedule-division-title.division-3{ color: #fdba74; }

    table.rankings{
      width:100%;
      border-collapse: separate;
      border-spacing: 0 6px;
      min-width: 0;
      table-layout: fixed;
      font-size: 12px;
    }

    .rankings thead th{
      text-align:center;
      color: var(--muted);
      font-weight: 800;
      letter-spacing: .03em;
      font-size: 8px;
      text-transform: uppercase;
      padding: 8px 6px;
      background: var(--header-bg);
    }

    .rankings thead th:first-child{
      border-radius: 10px 0 0 10px;
    }

    .rankings thead th:last-child{
      border-radius: 0 10px 10px 0;
    }

    .rankings tbody td{
      padding: 8px 6px;
      border-bottom: 0;
      background: var(--row-bg);
      color: var(--text);
      white-space: nowrap;
      font-size: 12px;
    }

    .rankings tbody td:first-child{
      border-radius: 10px 0 0 10px;
    }

    .rankings tbody td:last-child{
      border-radius: 0 10px 10px 0;
    }

    .col-rank,
    .col-matches,
    .col-games,
    .col-diff{
      width: 42px;
      text-align: center;
    }

    .col-player{
      width: calc(100% - 132px);
      min-width: 0;
      text-align: center;
    }

    .rankings tbody .col-player{
      text-transform: uppercase;
      font-weight: 800;
      white-space: normal;
      overflow-wrap: anywhere;
    }

    .player-btn{
      border: 0;
      background: transparent;
      color: inherit;
      padding: 0;
      margin: 0;
      font: inherit;
      text-transform: inherit;
      letter-spacing: inherit;
      font-weight: inherit;
      cursor: pointer;
      text-align: inherit;
    }

    .rankings .player-btn{
      text-align: center;
      width: 100%;
      display: block;
    }

    .player-btn:hover,
    .player-btn:focus-visible{
      text-decoration: none;
      outline: none;
    }

    .rankings tbody .col-player.qf-player{
      color: #9ca3af;
    }

    .error{
      margin: 0;
      color: #fecaca;
      font-size: 13px;
      background: rgba(127,29,29,0.22);
      border: 1px solid rgba(248,113,113,0.45);
      border-radius: 10px;
      padding: 10px 12px;
      display:none;
    }

    .error.show{ display:block; }

    .schedule-wrap{
      margin-top: 8px;
      display:grid;
      gap:12px;
    }

    .schedule-head{
      position: relative;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: 44px;
      padding: 2px 0;
    }

    .schedule-title{
      margin:0;
      font-size: 22px;
      font-weight: 950;
      color: var(--title);
      letter-spacing: .035em;
      text-transform: uppercase;
      text-align:center;
      width:100%;
      padding: 0 54px;
      line-height: 1.1;
    }

    .nav-btn{
      position:absolute;
      top:50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      font-weight: 950;
      display:grid;
      place-items:center;
      user-select:none;
    }
    .nav-btn:hover{
      background: var(--btn-bg-hover);
      border-color: var(--btn-border-hover);
    }
    .nav-btn:disabled{ opacity:.35; cursor:not-allowed; }
    .nav-left{ left:0; }
    .nav-right{ right:0; }

    .schedule-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
      align-items:start;
    }

    .schedule-division{
      border: 1px solid var(--border-lite);
      border-radius: 16px;
      padding: 12px;
      background: rgba(15,23,42,0.55);
      min-height: 90px;
      display:grid;
      gap: 10px;
      align-content:start;
    }

    .schedule-division-title{
      text-align:center;
      margin:0;
      font-size: 12px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: rgba(231,238,255,0.92);
    }

    .schedule-empty{
      margin:0;
      color: var(--muted);
      font-size: 12px;
    }

    .match-grid{
      display:grid;
      gap:10px;
    }

    .match-card{
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      overflow:hidden;
    }

    .match-row{
      display:flex;
      align-items:stretch;
      min-height: 36px;
      background: rgba(255,255,255,0.06);
      border: 1px solid transparent;
    }
    .match-row + .match-row{
      border-top: 1px solid rgba(148,163,184,0.28);
    }
    .match-row:nth-child(2){ background: rgba(255,255,255,0.045); }
    .match-row.winner{
      background: rgba(34,197,94,0.12);
      border-color: rgba(34,197,94,0.55);
    }
    .match-row.winner:first-child{
      border-top-left-radius: 13px;
      border-top-right-radius: 13px;
    }
    .match-row.winner:last-child{
      border-bottom-left-radius: 13px;
      border-bottom-right-radius: 13px;
    }

    .match-player{
      flex: 1 1 auto;
      min-width: 0;
      padding: 8px 10px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .02em;
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      word-break: break-word;
      display:flex;
      align-items:center;
      font-size: 11px;
    }

    .match-player.qf-player{
      color: #9ca3af;
    }

    .match-player .player-btn{
      white-space: normal;
      overflow-wrap: anywhere;
    }

    .player-modal{
      position: fixed;
      inset: 0;
      border: 0;
      width: 100%;
      height: 100%;
      max-width: none;
      max-height: none;
      margin: 0;
      padding: 0;
      background: rgba(2, 8, 24, 0.72);
      backdrop-filter: blur(4px);
    }

    .player-modal::backdrop{
      background: rgba(2, 8, 24, 0.72);
    }

    .player-modal-content{
      width: min(820px, calc(100% - 24px));
      border: 1px solid var(--border-lite);
      border-radius: 16px;
      background: rgba(15,23,42,0.98);
      color: #fff;
      padding: 18px;
      display: grid;
      gap: 12px;
    }

    .player-modal-shell{
      width: min(820px, calc(100% - 24px));
      margin: 28px auto;
      display:grid;
      gap: 10px;
    }

    .player-modal-close{
      justify-self: end;
      width: 32px;
      height: 32px;
      border-radius: 10px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: rgba(255,255,255,.92);
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
    }

    .player-modal-meta{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }

    .player-modal-meta-cell{
      background: var(--row-bg);
      border-radius: 10px;
      padding: 8px 6px;
      text-align:center;
    }

    .player-modal-meta-label{
      margin: 0;
      font-size: 8px;
      text-transform: uppercase;
      letter-spacing: .03em;
      color: var(--muted);
      font-weight: 800;
    }

    .player-modal-meta-value{
      margin: 4px 0 0;
      font-size: 18px;
      font-weight: 900;
      color: #fff;
      font-variant-numeric: tabular-nums;
    }

    .player-modal-name{
      margin: 0;
      text-align: center;
      font-size: 18px;
      font-weight: 950;
      text-transform: uppercase;
      letter-spacing: .03em;
    }

    .player-modal-head{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
    }

    .player-modal-division{
      margin: 0;
      text-align: center;
      font-size: 18px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .08em;
    }

    .player-modal-divider{
      color: var(--muted);
      font-size: 18px;
      font-weight: 800;
      line-height: 1;
    }

    .player-modal-division.division-1{ color: #fcd34d; }
    .player-modal-division.division-2{ color: #e5e7eb; }
    .player-modal-division.division-3{ color: #fdba74; }

    table.player-weekly{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
      table-layout: fixed;
      font-size: 18px;
    }

    .player-weekly th,
    .player-weekly td{
      padding: 8px 6px;
      color: #fff;
      background: var(--row-bg);
      border: 0;
      vertical-align: middle;
      text-align: center;
      font-variant-numeric: tabular-nums;
    }

    .player-weekly th{
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: 15px;
      font-weight: 800;
      background: var(--header-bg);
      color: var(--muted);
    }

    .player-weekly thead th:first-child{
      border-radius: 10px 0 0 10px;
    }

    .player-weekly thead th:last-child{
      border-radius: 0 10px 10px 0;
    }

    .player-weekly tbody td:first-child{
      border-radius: 10px 0 0 10px;
    }

    .player-weekly tbody td:last-child{
      border-radius: 0 10px 10px 0;
    }

    .weekly-col-week{ width: 64px; }
    .weekly-col-opponent{ width: 118px; text-align: left; }
    .weekly-col-result{ width: 64px; }
    .weekly-col-games{ width: 80px; }
    .weekly-col-round{ width: 80px; }

    .weekly-round-group{ text-align: center; }

    .round-pair{
      display:inline-flex;
      align-items:center;
      gap:4px;
      justify-content:center;
    }

    .round-sep{
      color: rgba(233,238,248,0.72);
      font-weight: inherit;
    }

    .player-weekly .opponent-name{
      text-transform: uppercase;
      font-weight: 900;
    }

    .score-win{ color: #86efac; }
    .score-loss{ color: #fca5a5; }

    .score-dash{
      color: #fff;
      font-weight: 900;
    }

    .result-win{ color: #86efac; font-weight: 900; }
    .result-loss{ color: #fca5a5; font-weight: 900; }
    .result-pending{ color: #fff; font-weight: 900; }

    .qualifiers-wrap{
      margin-top: 4px;
      display:grid;
      gap:10px;
    }

    .page-switch{
      min-height: 44px;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom: 8px;
    }

    .qualifiers-layout{
      display:grid;
      grid-template-columns: minmax(180px, 240px) minmax(0, 1fr);
      gap: 12px;
      align-items: stretch;
    }

    .qualifier-seeds,
    .qualifier-bracket{
      border: 1px solid var(--border-lite);
      border-radius: 16px;
      padding: 12px;
      background: rgba(15,23,42,0.55);
      display:grid;
      gap:10px;
      align-content:start;
    }

    .qualifier-title{
      margin:0;
      font-size: 12px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .12em;
      text-align: center;
      color: rgba(231,238,255,0.92);
    }

    .qualifier-seed-list{
      display:grid;
      gap:6px;
    }

    .qualifier-seed-head,
    .qualifier-seed-row{
      display:grid;
      grid-template-columns: 42px 1fr;
      align-items:center;
      text-align:center;
    }

    .qualifier-seed-head{
      background: var(--header-bg);
      border-radius: 10px;
      padding: 8px 6px;
      color: var(--muted);
      font-size: 8px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: .03em;
    }

    .qualifier-seed-row{
      background: var(--row-bg);
      border-radius: 10px;
      padding: 8px 6px;
    }

    .qualifier-seed-number{
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .03em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .qualifier-seed-player{
      font-size: 13px;
      font-weight: 850;
      text-transform: uppercase;
      overflow-wrap:anywhere;
      text-align:center;
    }

    .qualifier-bracket-placeholder{
      min-height: 320px;
      border: 1px dashed rgba(148,163,184,0.45);
      border-radius: 14px;
      display:grid;
      place-items:center;
      font-weight: 850;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .08em;
      text-align:center;
      padding: 12px;
    }

    .match-stats{
      display:grid;
      grid-template-columns: minmax(28px, auto) repeat(3, minmax(20px, auto));
      gap:8px;
      padding: 6px 8px;
      min-width: 124px;
      align-items:center;
      justify-items:center;
      font-size: 10px;
      font-weight: 850;
      font-variant-numeric: tabular-nums;
    }

    .match-stats{ background: transparent; }

    .stat.games{
      border-radius: 4px;
      min-height: 18px;
      min-width: 24px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,0.95);
      color: #000;
      padding: 4px 8px;
      font-size: 16px;
      font-weight: 800;
    }

    .round-score{
      color: rgba(233,238,248,0.9);
      line-height: 1;
      font-size: 11px;
    }

    .round-score.losing-score{
      color: #9ca3af;
    }

    @media (max-width: 1080px){
      .division-grid{ grid-template-columns: 1fr; }
      .schedule-grid{ grid-template-columns: 1fr; }
      .qualifiers-layout{ grid-template-columns: 1fr; }
    }

    @media (max-width: 760px){
      .container{ padding: 20px 12px 44px; }
      .topbar-inner{ padding: 12px 12px; flex-wrap: nowrap; }
      .brand{ flex: 1; min-width: 0; }
      .topbar-actions{ gap:6px; }
      .view-btn{ font-size: 11px; padding: 8px 10px; }
      .headline{ font-size: 18px; }
      .card{ padding: 20px 14px; border-radius: 18px; }
      .division-card{ padding: 10px; }

      .player-modal-content{
        width: calc(100% - 16px);
        padding: 12px;
      }

      .player-modal-shell{
        width: calc(100% - 16px);
        margin: 12px auto;
      }

      .player-modal-meta{
        gap: 6px;
      }

      .player-modal-head{
        gap: 6px;
      }

      .player-modal-name,
      .player-modal-division,
      .player-modal-divider{
        font-size: 14px;
      }

      .player-modal-meta-label{
        font-size: 8px;
        letter-spacing: .03em;
      }

      .player-modal-meta-value{
        font-size: 12px;
      }

      table.player-weekly{
        font-size: 10px;
        border-spacing: 0 6px;
      }

      .player-weekly th,
      .player-weekly td{
        padding: 6px 4px;
      }

      .player-weekly th{
        font-size: 8px;
        letter-spacing: .04em;
      }

      .weekly-col-week{ width: 34px; }
      .weekly-col-opponent{ width: 72px; }
      .weekly-col-result{ width: 42px; }
      .weekly-col-games{ width: 50px; }
      .weekly-col-round{ width: 40px; }

      .round-pair{
        gap: 1px;
        font-size: 8px;
        letter-spacing: 0em;
        line-height: 1;
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
      }

      .player-weekly .opponent-name{
        font-size: 10px;
      }

      .main-view-switch{
        margin-bottom: 2px;
      }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="home-badge" aria-hidden="true">
          <img src="/logos/golf.png" alt="Home" loading="eager" decoding="async" />
        </div>
        <div>
          <div class="kicker">Super League</div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="main-view-switch" role="tablist" aria-label="Super League page selector">
      <button class="view-btn is-active" id="seasonViewBtn" type="button">Super League Season 6</button>
      <button class="view-btn" id="qualifiersViewBtn" type="button">Qualifiers</button>
    </div>

    <div class="card">
      <section id="seasonPage">
        <div class="season-head">
          <h1 class="headline">Season 6 Standings</h1>
        </div>

        <p class="status" id="status"></p>
        <p class="error" id="error"></p>

        <div class="division-grid" id="divisionGrid"></div>

        <section class="schedule-wrap" id="scheduleWrap" hidden>
          <div class="schedule-head">
            <button class="nav-btn nav-left" id="weekPrev" type="button" aria-label="Previous week">←</button>
            <h2 class="schedule-title" id="scheduleTitle">Week</h2>
            <button class="nav-btn nav-right" id="weekNext" type="button" aria-label="Next week">→</button>
          </div>
          <div class="schedule-grid" id="scheduleGrid"></div>
        </section>
      </section>

      <section id="qualifiersPage" hidden>
        <div class="season-head">
          <h1 class="headline">Season 6 Qualifiers</h1>
        </div>

        <div class="qualifiers-layout">
          <aside class="qualifier-seeds" aria-label="Qualifier seeds">
            <h2 class="qualifier-title">Open Signups</h2>
            <div class="qualifier-seed-list" id="qualifierSeedList"></div>
          </aside>

          <section class="qualifier-bracket" aria-label="Qualifier bracket">
            <h2 class="qualifier-title">Double-Elimination Bracket</h2>
            <div class="qualifier-bracket-placeholder">Coming soon</div>
          </section>
        </div>
      </section>

      <dialog class="player-modal" id="playerModal" aria-labelledby="playerModalName">
        <div class="player-modal-shell">
          <button class="player-modal-close" id="playerModalClose" type="button" aria-label="Close player details">×</button>
          <div class="player-modal-content">
          <div class="player-modal-head">
            <h2 class="player-modal-name" id="playerModalName"></h2>
            <span class="player-modal-divider" aria-hidden="true">|</span>
            <p class="player-modal-division" id="playerModalDivision"></p>
          </div>
          <div class="player-modal-meta" id="playerModalMeta">
            <div class="player-modal-meta-cell">
              <p class="player-modal-meta-label">Rank</p>
              <p class="player-modal-meta-value" id="playerMetaRank">—</p>
            </div>
            <div class="player-modal-meta-cell">
              <p class="player-modal-meta-label">W-L</p>
              <p class="player-modal-meta-value" id="playerMetaMatches">—</p>
            </div>
            <div class="player-modal-meta-cell">
              <p class="player-modal-meta-label">Games</p>
              <p class="player-modal-meta-value" id="playerMetaGames">—</p>
            </div>
            <div class="player-modal-meta-cell">
              <p class="player-modal-meta-label">Diff.</p>
              <p class="player-modal-meta-value" id="playerMetaDiff">—</p>
            </div>
          </div>
          <table class="player-weekly" id="playerWeeklyTable">
            <thead>
              <tr>
                <th class="weekly-col-week">Week</th>
                <th class="weekly-col-opponent">Opponent</th>
                <th class="weekly-col-result">Result</th>
                <th class="weekly-col-games">Games</th>
                <th class="weekly-round-group">R1</th>
                <th class="weekly-round-group">R2</th>
                <th class="weekly-round-group">R3</th>
              </tr>
            </thead>
            <tbody id="playerWeeklyBody"></tbody>
          </table>
          </div>
        </div>
      </dialog>
    </div>
  </div>

  <script>
    const WORKER_URL = "https://small-mud-2771.nextweekmedia.workers.dev/";
    const SHEET_ID = "1BbT8t6erCVdx-Bdshv_hax9r9JSRzU1WygjWxW3vPkY";
    const SHEET_NAME = "Season 6";

    const DIVISIONS = [
      { title: "Division 1", range: "B3:G10" },
      { title: "Division 2", range: "B13:G20" },
      { title: "Division 3", range: "B23:G30" },
    ];
    const SCHEDULE_RANGE = "I2:AB85";
    const QUALIFIER_LIST_RANGE = "A:B";
    let scheduleWeeks = [];
    let currentWeekIdx = 0;
    const playerDivisionLookup = new Map();
    const playerStatsLookup = new Map();

    function divisionClassFromLabel(label){
      const normalized = String(label ?? "").toLowerCase();
      if(normalized.includes("1")) return "division-1";
      if(normalized.includes("2")) return "division-2";
      if(normalized.includes("3")) return "division-3";
      return "";
    }

    function setupViewNav(){
      const seasonBtn = document.getElementById("seasonViewBtn");
      const qualifiersBtn = document.getElementById("qualifiersViewBtn");
      const seasonPage = document.getElementById("seasonPage");
      const qualifiersPage = document.getElementById("qualifiersPage");

      const setPage = (page) => {
        const showSeason = page === "season";
        seasonPage.hidden = !showSeason;
        qualifiersPage.hidden = showSeason;
        seasonBtn.classList.toggle("is-active", showSeason);
        qualifiersBtn.classList.toggle("is-active", !showSeason);
        window.scrollTo({ top: 0, behavior: "smooth" });
      };

      seasonBtn.addEventListener("click", () => setPage("season"));
      qualifiersBtn.addEventListener("click", () => setPage("qualifiers"));
    }

    function normalizeValues(resp){
      if(!resp) return [];
      if(Array.isArray(resp)) return resp;
      if(Array.isArray(resp.values)) return resp.values;
      if(Array.isArray(resp.data?.values)) return resp.data.values;
      if(Array.isArray(resp.result?.values)) return resp.result.values;
      return [];
    }

    async function fetchRange(a1, sheetName = SHEET_NAME){
      const range = `'${sheetName}'!${a1}`;
      const payload = { sheetId: SHEET_ID, range };

      try{
        const r = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if(r.ok) return normalizeValues(await r.json());
      }catch(e){}

      const u = new URL(WORKER_URL);
      u.searchParams.set("sheetId", SHEET_ID);
      u.searchParams.set("range", range);
      const r2 = await fetch(u.toString());
      if(!r2.ok){
        const text = await r2.text().catch(() => "");
        throw new Error(`Worker request failed (${r2.status}). ${text}`.trim());
      }
      return normalizeValues(await r2.json());
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&39;");
    }

    function numOrZero(value){
      const n = Number(String(value ?? "").trim());
      return Number.isFinite(n) ? n : 0;
    }

    function formatDiff(value){
      const n = numOrZero(value);
      if(n > 0) return `+${n}`;
      if(n < 0) return `${n}`;
      return "0";
    }

    function mapRows(values){
      return values
        .map((row = []) => {
          const player = String(row[0] ?? "").trim();
          const matchesWon = numOrZero(row[1]);
          const matchesLost = numOrZero(row[2]);
          const gamesWon = numOrZero(row[3]);
          const gamesLost = numOrZero(row[4]);
          const diff = row[5];

          return {
            player,
            matches: `${matchesWon}-${matchesLost}`,
            games: `${gamesWon}-${gamesLost}`,
            diff: formatDiff(diff),
          };
        })
        .filter((row) => row.player !== "");
    }

    function renderDivision(division, values){
      const rows = mapRows(values);
      const divisionClass = divisionClassFromLabel(division.title);

      const wrapper = document.createElement("section");
      wrapper.className = `division-card ${divisionClass}`.trim();

      const title = document.createElement("h2");
      title.className = `division-title ${divisionClass}`.trim();
      title.textContent = division.title;
      wrapper.appendChild(title);

      const table = document.createElement("table");
      table.className = "rankings";
      table.innerHTML = `
        <thead>
          <tr>
            <th class="col-rank">Rank</th>
            <th class="col-player">Player</th>
            <th class="col-matches">W-L</th>
            <th class="col-games">Games</th>
            <th class="col-diff">Diff.</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tbody = table.querySelector("tbody");

      rows.forEach((row, index) => {
        const tr = document.createElement("tr");
        const qfPlayerClass = row.player.toUpperCase().startsWith("QF") ? " qf-player" : "";
        if(row.player){
          playerDivisionLookup.set(row.player.toUpperCase(), {
            divisionTitle: division.title,
            divisionClass,
          });
        }
        tr.innerHTML = `
          <td class="col-rank">${index + 1}</td>
          <td class="col-player${qfPlayerClass}"><button class="player-btn" type="button" data-player="${escapeHtml(row.player)}">${escapeHtml(row.player)}</button></td>
          <td class="col-matches">${escapeHtml(row.matches)}</td>
          <td class="col-games">${escapeHtml(row.games)}</td>
          <td class="col-diff">${escapeHtml(row.diff)}</td>
        `;
        tbody.appendChild(tr);
      });

      if(rows.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" style="text-align:center; color: var(--muted);">No data available.</td>`;
        tbody.appendChild(tr);
      }

      wrapper.appendChild(table);
      return wrapper;
    }

    function formatStatValue(value, placeholder = "-"){
      const str = String(value ?? "").trim();
      return str === "" ? placeholder : escapeHtml(str);
    }

    function formatPlayerLabel(name){
      const value = String(name ?? "").trim();
      if(!value) return "TBD";
      return `<button class="player-btn" type="button" data-player="${escapeHtml(value)}">${escapeHtml(value)}</button>`;
    }

    function isQfPlayerName(name){
      return /^QF\b/i.test(String(name ?? "").trim());
    }

    function formatResultChip(value, isWin){
      const cls = isWin ? "result-win" : "result-loss";
      return `<span class="${cls}">${escapeHtml(value)}</span>`;
    }

    function getRoundCellHtml(playerScore, opponentScore, side){
      const score = side === "player" ? playerScore : opponentScore;
      const safeScore = formatStatValue(score, "–");

      if(side !== "player") return `<span>${safeScore}</span>`;

      const winners = isRoundWinner(playerScore, opponentScore);
      if(winners.a && !winners.b) return `<span class="score-win">${safeScore}</span>`;
      if(!winners.a && winners.b) return `<span class="score-loss">${safeScore}</span>`;
      return `<span>${safeScore}</span>`;
    }

    function formatRoundPair(roundCell){
      return `<span class="round-pair">${roundCell.player}<span class="round-sep">|</span>${roundCell.opponent}</span>`;
    }

    function getPlayerWeekResult(playerName, weekData){
      const playerKey = String(playerName ?? "").trim().toUpperCase();
      const matchup = weekData.matchups.find((m) => (
        String(m.p1.name ?? "").trim().toUpperCase() === playerKey ||
        String(m.p2.name ?? "").trim().toUpperCase() === playerKey
      ));

      if(!matchup) return null;

      const isP1 = String(matchup.p1.name ?? "").trim().toUpperCase() === playerKey;
      const playerSide = isP1 ? matchup.p1 : matchup.p2;
      const opponentSide = isP1 ? matchup.p2 : matchup.p1;
      const isWin = playerSide.result === "W";
      const hasRecordedResult = [
        playerSide.result,
        playerSide.gamesWon,
        opponentSide.gamesWon,
        ...playerSide.rounds,
        ...opponentSide.rounds,
      ].some((value) => String(value ?? "").trim() !== "");

      const round3NotPlayed =
        String(playerSide.rounds[2] ?? "").trim() === "" &&
        String(opponentSide.rounds[2] ?? "").trim() === "" &&
        (numOrZero(playerSide.gamesWon) === 2 || numOrZero(opponentSide.gamesWon) === 2);

      const resultHtml = hasRecordedResult
        ? formatResultChip(isWin ? "W" : "L", isWin)
        : '<span class="result-pending">—</span>';
      const gamesRecord = `${formatStatValue(playerSide.gamesWon, "—")}-${formatStatValue(opponentSide.gamesWon, "—")}`;
      const gamesHtml = hasRecordedResult
        ? formatResultChip(gamesRecord, isWin)
        : '<span class="result-pending">—</span>';

      return {
        opponent: opponentSide.name || "TBD",
        resultHtml,
        gamesHtml,
        roundCells: [0, 1, 2].map((idx) => {
          if(idx === 2 && round3NotPlayed){
            return { player: '<span class="score-dash">–</span>', opponent: '<span class="score-dash">–</span>' };
          }
          return {
            player: getRoundCellHtml(playerSide.rounds[idx], opponentSide.rounds[idx], "player"),
            opponent: getRoundCellHtml(playerSide.rounds[idx], opponentSide.rounds[idx], "opponent"),
          };
        }),
      };
    }

    function openPlayerModal(playerName){
      const modal = document.getElementById("playerModal");
      const nameEl = document.getElementById("playerModalName");
      const divisionEl = document.getElementById("playerModalDivision");
      const tbody = document.getElementById("playerWeeklyBody");
      const lookup = playerDivisionLookup.get(String(playerName ?? "").trim().toUpperCase());
      const stats = playerStatsLookup.get(String(playerName ?? "").trim().toUpperCase());

      nameEl.textContent = playerName;
      divisionEl.className = "player-modal-division";
      divisionEl.textContent = lookup?.divisionTitle || "Division unavailable";
      if(lookup?.divisionClass) divisionEl.classList.add(lookup.divisionClass);

      document.getElementById("playerMetaRank").textContent = stats?.rank || "—";
      document.getElementById("playerMetaMatches").textContent = stats?.matches || "—";
      document.getElementById("playerMetaGames").textContent = stats?.games || "—";
      document.getElementById("playerMetaDiff").textContent = stats?.diff || "—";

      tbody.innerHTML = "";
      for(let week = 1; week <= 7; week += 1){
        const weekData = scheduleWeeks.find((w) => Number(w.week) === week);
        const row = document.createElement("tr");
        const result = weekData ? getPlayerWeekResult(playerName, weekData) : null;

        if(!result){
          row.innerHTML = `
            <td class="weekly-col-week">${week}</td>
            <td class="weekly-col-opponent"><span class="opponent-name">—</span></td>
            <td class="weekly-col-result"><span class="result-pending">—</span></td>
            <td class="weekly-col-games"><span class="result-pending">—</span></td>
            <td class="weekly-col-round"><span class="score-dash">–</span></td>
            <td class="weekly-col-round"><span class="score-dash">–</span></td>
            <td class="weekly-col-round"><span class="score-dash">–</span></td>
          `;
          tbody.appendChild(row);
          continue;
        }
        row.innerHTML = `
          <td class="weekly-col-week">${week}</td>
          <td class="weekly-col-opponent"><button class="player-btn opponent-name" type="button" data-player="${escapeHtml(result.opponent)}">${escapeHtml(result.opponent)}</button></td>
          <td class="weekly-col-result">${result.resultHtml}</td>
          <td class="weekly-col-games">${result.gamesHtml}</td>
          <td class="weekly-col-round">${formatRoundPair(result.roundCells[0])}</td>
          <td class="weekly-col-round">${formatRoundPair(result.roundCells[1])}</td>
          <td class="weekly-col-round">${formatRoundPair(result.roundCells[2])}</td>
        `;
        tbody.appendChild(row);
      }

      if(typeof modal.showModal === "function"){
        modal.showModal();
      }else{
        modal.setAttribute("open", "open");
      }
    }

    function closePlayerModal(){
      const modal = document.getElementById("playerModal");
      if(typeof modal.close === "function"){
        modal.close();
      }else{
        modal.removeAttribute("open");
      }
    }

    function setupPlayerModal(){
      const modal = document.getElementById("playerModal");
      const closeBtn = document.getElementById("playerModalClose");

      document.addEventListener("click", (event) => {
        const trigger = event.target.closest(".player-btn[data-player]");
        if(!trigger) return;
        const player = String(trigger.getAttribute("data-player") || "").trim();
        if(!player || /^TBD$/i.test(player) || /^QF\b/i.test(player)) return;
        openPlayerModal(player);
      });

      closeBtn.addEventListener("click", closePlayerModal);

      modal.addEventListener("click", (event) => {
        if(event.target === modal) closePlayerModal();
      });
    }

    function numericScore(value){
      const str = String(value ?? "").trim();
      if(str === "") return null;
      const n = Number(str);
      return Number.isFinite(n) ? n : null;
    }

    function parseScheduleRows(values){
      const byWeek = new Map();

      values.forEach((row = []) => {
        const week = String(row[0] ?? "").trim();
        const division = String(row[1] ?? "").trim();

        const p1Name = String(row[3] ?? "").trim();
        const p2Name = String(row[12] ?? "").trim();
        if(!week || !division || (!p1Name && !p2Name)) return;

        const round1P1 = row[4];
        const round2P1 = row[5];
        const round3P1 = row[6];
        const gamesWonP1 = row[7];
        const resultP1 = String(row[10] ?? "").trim().toUpperCase();

        const round1P2 = row[13];
        const round2P2 = row[14];
        const round3P2 = row[15];
        const gamesWonP2 = row[16];
        const resultP2 = String(row[19] ?? "").trim().toUpperCase();

        const matchup = {
          division,
          p1: { name: p1Name, rounds: [round1P1, round2P1, round3P1], gamesWon: gamesWonP1, result: resultP1 },
          p2: { name: p2Name, rounds: [round1P2, round2P2, round3P2], gamesWon: gamesWonP2, result: resultP2 },
        };

        if(!byWeek.has(week)) byWeek.set(week, []);
        byWeek.get(week).push(matchup);
      });

      const weekSort = (a, b) => {
        const an = Number(a), bn = Number(b);
        if(Number.isFinite(an) && Number.isFinite(bn)) return an - bn;
        return a.localeCompare(b, undefined, { numeric: true, sensitivity: "base" });
      };

      return Array.from(byWeek.keys())
        .sort(weekSort)
        .map((week) => ({ week, matchups: byWeek.get(week) || [] }));
    }

    function isRoundWinner(roundA, roundB){
      const a = numericScore(roundA);
      const b = numericScore(roundB);
      if(a === null || b === null) return { a: false, b: false };
      if(a < b) return { a: true, b: false };
      if(b < a) return { a: false, b: true };
      return { a: true, b: true };
    }

    function renderMatchup(matchup){
      const card = document.createElement("article");
      card.className = "match-card";

      const roundWinners = [
        isRoundWinner(matchup.p1.rounds[0], matchup.p2.rounds[0]),
        isRoundWinner(matchup.p1.rounds[1], matchup.p2.rounds[1]),
        isRoundWinner(matchup.p1.rounds[2], matchup.p2.rounds[2]),
      ];

      const p1Winner = matchup.p1.result === "W";
      const p2Winner = matchup.p2.result === "W";
      const p1QfClass = isQfPlayerName(matchup.p1.name) ? " qf-player" : "";
      const p2QfClass = isQfPlayerName(matchup.p2.name) ? " qf-player" : "";

      const p1Row = document.createElement("div");
      p1Row.className = `match-row${p1Winner ? " winner" : ""}`;
      p1Row.innerHTML = `
        <div class="match-player${p1QfClass}">${formatPlayerLabel(matchup.p1.name)}</div>
        <div class="match-stats">
          <div class="stat games">${formatStatValue(matchup.p1.gamesWon, "–")}</div>
          <span class="round-score${(!roundWinners[0].a && roundWinners[0].b) ? " losing-score" : ""}">${formatStatValue(matchup.p1.rounds[0], "–")}</span>
          <span class="round-score${(!roundWinners[1].a && roundWinners[1].b) ? " losing-score" : ""}">${formatStatValue(matchup.p1.rounds[1], "–")}</span>
          <span class="round-score${(!roundWinners[2].a && roundWinners[2].b) ? " losing-score" : ""}">${formatStatValue(matchup.p1.rounds[2], "–")}</span>
        </div>
      `;

      const p2Row = document.createElement("div");
      p2Row.className = `match-row${p2Winner ? " winner" : ""}`;
      p2Row.innerHTML = `
        <div class="match-player${p2QfClass}">${formatPlayerLabel(matchup.p2.name)}</div>
        <div class="match-stats">
          <div class="stat games">${formatStatValue(matchup.p2.gamesWon, "–")}</div>
          <span class="round-score${(!roundWinners[0].b && roundWinners[0].a) ? " losing-score" : ""}">${formatStatValue(matchup.p2.rounds[0], "–")}</span>
          <span class="round-score${(!roundWinners[1].b && roundWinners[1].a) ? " losing-score" : ""}">${formatStatValue(matchup.p2.rounds[1], "–")}</span>
          <span class="round-score${(!roundWinners[2].b && roundWinners[2].a) ? " losing-score" : ""}">${formatStatValue(matchup.p2.rounds[2], "–")}</span>
        </div>
      `;

      card.appendChild(p1Row);
      card.appendChild(p2Row);
      return card;
    }

    function renderScheduleWeek(){
      const wrap = document.getElementById("scheduleWrap");
      const titleEl = document.getElementById("scheduleTitle");
      const gridEl = document.getElementById("scheduleGrid");
      const prevBtn = document.getElementById("weekPrev");
      const nextBtn = document.getElementById("weekNext");

      if(!scheduleWeeks.length){
        wrap.hidden = true;
        return;
      }

      wrap.hidden = false;
      const weekData = scheduleWeeks[currentWeekIdx];
      titleEl.textContent = `Week ${weekData.week} Schedule & Results`;
      prevBtn.disabled = currentWeekIdx <= 0;
      nextBtn.disabled = currentWeekIdx >= scheduleWeeks.length - 1;

      const divisionMap = new Map([
        ["1", []], ["2", []], ["3", []],
        ["Division 1", []], ["Division 2", []], ["Division 3", []],
      ]);

      weekData.matchups.forEach((m) => {
        if(divisionMap.has(m.division)) divisionMap.get(m.division).push(m);
      });

      const normalizeDivision = (idx) => {
        if(divisionMap.get(String(idx)).length) return divisionMap.get(String(idx));
        return divisionMap.get(`Division ${idx}`);
      };

      gridEl.innerHTML = "";
      [1, 2, 3].forEach((divNum) => {
        const pane = document.createElement("section");
        pane.className = `schedule-division ${divisionClassFromLabel(divNum)}`.trim();

        const h3 = document.createElement("h3");
        h3.className = `schedule-division-title ${divisionClassFromLabel(divNum)}`.trim();
        h3.textContent = `Division ${divNum}`;
        pane.appendChild(h3);

        const matchups = normalizeDivision(divNum) || [];
        if(!matchups.length){
          const empty = document.createElement("p");
          empty.className = "schedule-empty";
          empty.textContent = "No matchups available.";
          pane.appendChild(empty);
        }else{
          const matchGrid = document.createElement("div");
          matchGrid.className = "match-grid";
          matchups.forEach((m) => matchGrid.appendChild(renderMatchup(m)));
          pane.appendChild(matchGrid);
        }

        gridEl.appendChild(pane);
      });
    }

    function setupScheduleNav(){
      const prevBtn = document.getElementById("weekPrev");
      const nextBtn = document.getElementById("weekNext");

      prevBtn.addEventListener("click", () => {
        if(currentWeekIdx <= 0) return;
        currentWeekIdx -= 1;
        renderScheduleWeek();
      });

      nextBtn.addEventListener("click", () => {
        if(currentWeekIdx >= scheduleWeeks.length - 1) return;
        currentWeekIdx += 1;
        renderScheduleWeek();
      });
    }

    function renderQualifierSeeds(values){
      const listEl = document.getElementById("qualifierSeedList");
      const rows = values
        .slice(1)
        .map((row = []) => ({
          seed: String(row[0] ?? "").trim(),
          player: String(row[1] ?? "").trim(),
        }))
        .filter((row) => row.seed || row.player);

      listEl.innerHTML = "";
      if(!rows.length){
        listEl.innerHTML = '<p class="schedule-empty" style="text-align:center;">No qualifier signups available.</p>';
        return;
      }

      const head = document.createElement("div");
      head.className = "qualifier-seed-head";
      head.innerHTML = "<div>Seed</div><div>Player</div>";
      listEl.appendChild(head);

      rows.forEach((row) => {
        const item = document.createElement("article");
        item.className = "qualifier-seed-row";
        item.innerHTML = `
          <div class="qualifier-seed-number">${escapeHtml(row.seed || "—")}</div>
          <div class="qualifier-seed-player">${escapeHtml(row.player || "TBD")}</div>
        `;
        listEl.appendChild(item);
      });
    }

    async function loadQualifiers(){
      const qualifierValues = await fetchRange(QUALIFIER_LIST_RANGE, "Season 6 Qualifiers");
      renderQualifierSeeds(qualifierValues);
    }

    async function loadRankings(){
      const statusEl = document.getElementById("status");
      const errorEl = document.getElementById("error");
      const gridEl = document.getElementById("divisionGrid");

      try{
        const all = await Promise.all([
          ...DIVISIONS.map((division) => fetchRange(division.range)),
          fetchRange(SCHEDULE_RANGE),
          loadQualifiers(),
        ]);
        gridEl.innerHTML = "";
        playerDivisionLookup.clear();

        DIVISIONS.forEach((division, idx) => {
          gridEl.appendChild(renderDivision(division, all[idx]));
        });

        playerStatsLookup.clear();
        Array.from(gridEl.querySelectorAll(".rankings tbody tr")).forEach((tr) => {
          const playerName = tr.querySelector(".col-player .player-btn")?.textContent?.trim();
          if(!playerName) return;
          playerStatsLookup.set(playerName.toUpperCase(), {
            rank: tr.querySelector(".col-rank")?.textContent?.trim() || "—",
            matches: tr.querySelector(".col-matches")?.textContent?.trim() || "—",
            games: tr.querySelector(".col-games")?.textContent?.trim() || "—",
            diff: tr.querySelector(".col-diff")?.textContent?.trim() || "—",
          });
        });

        const scheduleRows = all[DIVISIONS.length] || [];
        scheduleWeeks = parseScheduleRows(scheduleRows);
        currentWeekIdx = 0;
        renderScheduleWeek();

        statusEl.textContent = "";
      }catch(err){
        statusEl.textContent = "Could not load rankings.";
        errorEl.textContent = String(err?.message || err || "Unknown error");
        errorEl.classList.add("show");
      }
    }

    setupViewNav();
    setupScheduleNav();
    setupPlayerModal();
    loadRankings();
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shotgun Pro League - Season 6</title>

  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      background: transparent;
      font-family: Inter, system-ui, sans-serif;
      display: flex; justify-content: center; align-items: center;
      overflow: hidden;
    }

    /* --- Card style matched from your Season 5 page --- */
    .card {
      width: 880px;
      height: 880px;
      background: rgba(15,23,42,1);
      border-radius: 20px;
      padding: 32px 40px;
      display: flex;
      flex-direction: column;
      color: #e9eef8;
      box-shadow: 0 32px 32px rgba(0,0,0,0.65);
      box-sizing: border-box;
    }

    .title {
      font-size: 46px;
      font-weight: 900;
      color: #c7d7ff;
      text-align: center;
      margin-bottom: 14px;
      text-transform: uppercase;
      letter-spacing: .035em;
      flex-shrink: 0;
    }

    /* Tabs (kept minimal, using same palette) */
    .tabs {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 14px;
      flex-shrink: 0;
    }
    .tabbtn {
      background: rgba(148,163,184,0.12);
      border: 1px solid rgba(148,163,184,0.20);
      color: #c7d7ff;
      font-size: 14px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: .08em;
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background .2s ease, transform .08s ease;
    }
    .tabbtn:hover { background: rgba(148,163,184,0.18); }
    .tabbtn:active { transform: translateY(1px); }
    .tabbtn.active {
      background: rgba(255,255,255,0.16);
      border-color: rgba(255,255,255,0.22);
      color: #e9eef8;
    }

    .header-row, .entry {
      display: grid;
      grid-template-columns: 120px 1fr 130px; /* Rank, Name, Score */
      align-items: center;
    }

    .header-row {
      height: 46px;
      margin-bottom: 10px;
      background: rgba(148,163,184,0.12);
      border-radius: 10px;
      font-size: 20px;
      font-weight: 700;
      text-transform: uppercase;
      color: #9ca3c7;
      flex-shrink: 0;
    }

    /* scroll area for list (so rosters can expand) */
    .scroll {
      flex: 1 1 auto;
      overflow: auto;
      padding-right: 6px; /* little breathing room for scrollbar */
    }
    .scroll::-webkit-scrollbar { width: 10px; }
    .scroll::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,0.22);
      border-radius: 999px;
    }
    .scroll::-webkit-scrollbar-track { background: transparent; }

    .resultsList {
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: opacity .3s ease, gap .3s ease;
    }

    .entry {
      height: 60px;
      background: rgba(255,255,255,0.06);
      border-radius: 10px;
      font-size: 24px;
      font-weight: 600;
      transition: background .25s ease, box-shadow .25s ease;
      overflow: hidden;
    }

    /* Base cell styling */
    .header-row span {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 12px;
      box-sizing: border-box;
      height: 20px;
      border-right: none;
    }

    .entry > span, .entry > button {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 12px;
      box-sizing: border-box;
      height: 100%;
      border-right: none;
    }

    /* Header "Team/Player" alignment only */
    .header-row span:nth-child(2) {
      justify-content: flex-start;
      padding-left: 24px;
    }

    .place {
      font-size: 32px;
      font-weight: 750;
      text-align: center;
      color: #c7d7ff;
    }

    .name-text {
      font-size: 34px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Team/Player main cell (color bar + caps + logo) */
    .team-cell {
      position: relative;
      font-weight: 800;
      text-transform: uppercase;
      border-radius: 0;
      overflow: hidden;

      /* make it button-safe */
      background: transparent;
      border: none;
      cursor: pointer;

      /* match sample alignment */
      justify-content: flex-start;
      text-align: left;
      padding-left: 112px; /* room for chevron + logo overlay */
      color: #ffffff;
    }

    /* Chevron */
    .team-cell .chev {
      position: absolute;
      left: 18px;
      font-size: 20px;
      font-weight: 900;
      opacity: 0.85;
    }

    /* Logo overlay — driven by CSS variables set in JS */
    .team-cell::before {
      content: "";
      position: absolute;
      inset: 0;
      background-repeat: no-repeat;
      background-position: var(--icon-pos, 0px center);
      background-size: var(--icon-size, auto 180%);
      background-image: var(--icon, none);
      opacity: var(--icon-opacity, 0.20);
      pointer-events: none;
    }

    /* Score column: light gray background, black text */
    .score-col {
      font-size: 32px;
      font-weight: 750;
      text-align: center;
      background: #d9d9d9;
      color: #000000;
      border-radius: 0;
      justify-content: center;
    }

    .gold   { color: #ffd700; }
    .silver { color: #c0c0c0; }
    .bronze { color: #cd7f32; }

    /* Collapsible roster area (kept in same palette + rounding) */
    .roster-wrap {
      margin-top: 6px;
      margin-bottom: 10px;
      padding: 10px 0 0 0;
    }
    .roster-title {
      font-size: 16px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: #9ca3c7;
      padding: 0 12px 8px 12px;
    }
    .roster-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 0 0 0 0;
    }
    .roster-entry {
      height: 56px;
      background: rgba(255,255,255,0.06);
      border-radius: 10px;
      display: grid;
      grid-template-columns: 260px 1fr;
      align-items: center;
      overflow: hidden;
      padding: 0 12px;
      box-sizing: border-box;
      gap: 14px;
    }
    .roster-entry .pname {
      font-size: 22px;
      font-weight: 850;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-transform: uppercase;
      color: #c7d7ff;
    }
    .roster-entry .pstats {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 10px;
      justify-content: flex-start;
      align-items: center;
      font-size: 13px;
      color: rgba(233,238,248,0.85);
      overflow: hidden;
    }
    .pill {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(148,163,184,0.12);
      color: rgba(233,238,248,0.92);
      white-space: nowrap;
    }
    .pill span {
      color: rgba(156,163,199,0.95);
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: .06em;
      font-size: 11px;
    }

    .loading, .error {
      width: 100%;
      text-align: center;
      font-size: 28px;
      padding: 24px 0;
    }

    .hidden { display: none !important; }
  </style>
</head>

<body>
  <div class="card" id="card">
    <div class="title">Shotgun Pro League - Season 6</div>

    <div class="tabs" role="tablist" aria-label="Standings tabs">
      <button class="tabbtn active" data-tab="teams" role="tab" aria-selected="true">Team Standings</button>
      <button class="tabbtn" data-tab="players" role="tab" aria-selected="false">Player Standings</button>
    </div>

    <!-- Teams view -->
    <div id="teamsView">
      <div class="header-row">
        <span>Rank</span>
        <span>Team</span>
        <span>Score</span>
      </div>

      <div class="scroll">
        <div id="teamsList" class="resultsList">
          <div class="loading">Loading…</div>
        </div>
      </div>
    </div>

    <!-- Players view -->
    <div id="playersView" class="hidden">
      <div class="header-row">
        <span>Rank</span>
        <span>Player</span>
        <span>Score</span>
      </div>

      <div class="scroll">
        <div id="playersList" class="resultsList">
          <div class="loading">Loading…</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==============================
    // Config (not displayed publicly)
    // ==============================
    const WORKER_URL  = "https://small-mud-2771.nextweekmedia.workers.dev/";
    const SHEET_ID    = "1qIM0HKhx9Y-3eCJCFzBqrbATwiPrK3C1ynATwZzRC1o";

    const RANGE_TEAM_STANDINGS   = "'Season 6, Stage 1'!U4:X15";
    const RANGE_PLAYER_STANDINGS = "'Season 6, Stage 1'!AE4:AH101";
    const RANGE_TEAM_ROSTERS     = "'Season 6, Stage 1'!A3:S63"; // header + repeating: team row + 4 player rows

    const REFRESH_MS = 15000;

    // Logos live here (add files in this folder):
    //   ./logos/<fileName>.png  (or .webp/.svg)
    const LOGO_DIR = "logos";

    // In the full roster range, TEAM + PLAYER names are in Column C (index 2)
    const NAME_COL = 2;

    // ------------------------------
    // Team styles (UPDATE THIS)
    // Add new teams here with bg/fg + logo file name.
    // slug is auto-created; logo is just a filename inside ./logos/
    // ------------------------------
    const TEAM_STYLES = {
      // Examples (replace/update for Season 6):
      "ANIMALS":         { bg: "#cd7f32", fg: "#ffffff", logo: "animals.png" },
      "TERRIFIC TIGERS": { bg: "#fe6d01", fg: "#000000", logo: "terrific-tigers.png", iconPos: "0 47%" },
      "BREAKERS":        { bg: "#f1c232", fg: "#1c4487", logo: "breakers.png" },
      "DAGGERS":         { bg: "#ea9999", fg: "#0f0d36", logo: "daggers.png" },
      "SNIPERS":         { bg: "#275318", fg: "#ffe6cd", logo: "snipers.png", iconPos: "-11px 55%", iconSize: "auto 220%" },
      "MCSTROKERS":      { bg: "#4d94d8", fg: "#ffffff", logo: "mcstrokers.png", iconPos: "-3px 55%", iconSize: "auto 190%" },

      // Add NEW Season 6 teams here:
      // "NEW TEAM NAME": { bg: "#123456", fg: "#ffffff", logo: "new-team.png", iconPos: "0 center", iconSize: "auto 180%" },
    };

    function getTeamStyle(name){
      if(!name) return null;
      const key = String(name).trim().toUpperCase();
      return TEAM_STYLES[key] || null;
    }

    function slugify(name) {
      return String(name)
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-|-$/g, "");
    }

    function rowHasAnyValue(row){
      return Array.isArray(row) && row.some(c => String(c ?? "").trim() !== "");
    }

    async function fetchRange(range){
      // match your existing worker pattern (GET query params)
      const url = `${WORKER_URL}?sheetId=${SHEET_ID}&range=${encodeURIComponent(range)}`;
      const res = await fetch(url);
      const json = await res.json();
      return json.values || json.data?.values || json.result?.values || [];
    }

    // Team standings rows come back like: [rank, ?, teamName, score, ...]
    // You confirmed: teamName is in "points" column, score is in "notes" column,
    // which in practice is the last 2 cells of the row in this range.
    function normalizeTeamStandings(rows){
      return (rows || [])
        .map(r => {
          const arr = Array.isArray(r) ? r : [];
          const rank = arr[0];
          const name = arr.length >= 2 ? arr[arr.length - 2] : "";
          const score = arr.length >= 1 ? arr[arr.length - 1] : "";

          if(!rank || !name) return null;
          return {
            rank: Number(rank),
            name: String(name).trim(),
            slug: slugify(name),
            score: (score !== "" && score != null) ? Number(score) : null
          };
        })
        .filter(Boolean)
        .sort((a,b)=>a.rank-b.rank);
    }

    // Player standings: use same “last-2 cells are name+score” pattern for robustness
    function normalizePlayerStandings(rows){
      return (rows || [])
        .map(r => {
          const arr = Array.isArray(r) ? r : [];
          const rank = arr[0];
          const name = arr.length >= 2 ? arr[arr.length - 2] : "";
          const score = arr.length >= 1 ? arr[arr.length - 1] : "";

          if(!rank || !name) return null;
          return {
            rank: Number(rank),
            name: String(name).trim(),
            slug: slugify(name),
            score: (score !== "" && score != null) ? Number(score) : null
          };
        })
        .filter(Boolean)
        .sort((a,b)=>a.rank-b.rank);
    }

    // Roster parsing:
    // header row + repeating blocks: team row (name in col C) + 4 player rows (name in col C)
    function parseRosters(values){
      const cleaned = (values || []).filter(rowHasAnyValue);
      if(!cleaned.length) return new Map();

      const header = cleaned[0] || [];
      const rows = cleaned.slice(1);
      const headerLabels = header.map(h => String(h ?? "").trim());

      function labelForCol(j){
        return headerLabels[j] || `Col ${j+1}`;
      }

      function extractPlayerStats(row){
        const stats = [];
        const r = row || [];
        for(let j=0; j<r.length; j++){
          if(j === NAME_COL) continue;
          const v = String(r[j] ?? "").trim();
          if(!v) continue;
          stats.push({ key: labelForCol(j), value: v });
        }
        return stats;
      }

      const byTeam = new Map();

      for(let i=0; i<rows.length; i+=5){
        const teamRow = rows[i] || [];
        const teamName = String(teamRow[NAME_COL] ?? "").trim();
        if(!teamName) continue;

        const playerRows = [rows[i+1], rows[i+2], rows[i+3], rows[i+4]].filter(Boolean);

        const players = playerRows.map((pr, idx)=>{
          const playerName = String((pr||[])[NAME_COL] ?? "").trim() || `Player ${idx+1}`;
          const stats = extractPlayerStats(pr);
          return { name: playerName, stats };
        });

        byTeam.set(teamName, { teamName, players });
      }

      return byTeam;
    }

    // UI state
    let teamStandings = [];
    let playerStandings = [];
    let rosterByTeam = new Map();
    const expanded = new Set(); // teamName strings (exact match)

    // Tabs
    function setTab(tab){
      document.querySelectorAll(".tabbtn").forEach(b=>{
        const on = b.dataset.tab === tab;
        b.classList.toggle("active", on);
        b.setAttribute("aria-selected", on ? "true" : "false");
      });
      document.getElementById("teamsView").classList.toggle("hidden", tab !== "teams");
      document.getElementById("playersView").classList.toggle("hidden", tab !== "players");
    }
    document.querySelectorAll(".tabbtn").forEach(btn=>{
      btn.addEventListener("click", ()=> setTab(btn.dataset.tab));
    });

    function renderTeams(){
      const el = document.getElementById("teamsList");
      el.innerHTML = "";

      if(!teamStandings.length){
        el.innerHTML = `<div class="error">No team standings found.</div>`;
        return;
      }

      teamStandings.forEach(team=>{
        const row = document.createElement("div");
        row.className = "entry";

        const clr =
          team.rank === 1 ? "gold" :
          team.rank === 2 ? "silver" :
          team.rank === 3 ? "bronze" : "";

        const style = getTeamStyle(team.name) || {};
        const teamBg = style.bg || "rgba(255,255,255,0.08)";
        const teamFg = style.fg || "#ffffff";

        const isOpen = expanded.has(team.name);
        const chev = isOpen ? "▾" : "▸";

        const btn = document.createElement("button");
        btn.className = "name-text team-cell";
        btn.type = "button";
        btn.setAttribute("data-team", team.name);
        btn.style.background = teamBg;
        btn.style.color = teamFg;

        // logo (optional)
        if(style.logo){
          btn.style.setProperty("--icon", `url('${LOGO_DIR}/${style.logo}')`);
        }
        if(style.iconPos) btn.style.setProperty("--icon-pos", style.iconPos);
        if(style.iconSize) btn.style.setProperty("--icon-size", style.iconSize);
        if(style.iconOpacity) btn.style.setProperty("--icon-opacity", String(style.iconOpacity));

        btn.innerHTML = `<span class="chev" aria-hidden="true">${chev}</span>${team.name}`;

        row.innerHTML = `
          <span class="place ${clr}">${team.rank}</span>
          <span id="teamBtnHost-${team.slug}"></span>
          <span class="score-col">${team.score != null ? team.score : "—"}</span>
        `;

        row.querySelector(`#teamBtnHost-${team.slug}`).replaceWith(btn);
        el.appendChild(row);

        // Roster block
        const roster = rosterByTeam.get(team.name);
        const wrap = document.createElement("div");
        wrap.className = "roster-wrap";
        wrap.setAttribute("data-roster", team.name);
        wrap.classList.toggle("hidden", !isOpen);

        // Build roster rows
        const inner = document.createElement("div");
        inner.innerHTML = `<div class="roster-title">Roster</div>`;
        const list = document.createElement("div");
        list.className = "roster-list";

        if(!roster || !roster.players || !roster.players.length){
          const empty = document.createElement("div");
          empty.className = "error";
          empty.style.fontSize = "18px";
          empty.style.padding = "10px 12px";
          empty.textContent = "Roster not found.";
          list.appendChild(empty);
        } else {
          roster.players.forEach(p=>{
            const r = document.createElement("div");
            r.className = "roster-entry";

            const stats = document.createElement("div");
            stats.className = "pstats";

            // show all stats as pills (trim if you want fewer)
            p.stats.forEach(s=>{
              const pill = document.createElement("div");
              pill.className = "pill";
              pill.innerHTML = `<span>${s.key}</span>${s.value}`;
              stats.appendChild(pill);
            });

            r.innerHTML = `<div class="pname">${p.name}</div>`;
            r.appendChild(stats);

            list.appendChild(r);
          });
        }

        inner.appendChild(list);
        wrap.appendChild(inner);
        el.appendChild(wrap);
      });
    }

    function renderPlayers(){
      const el = document.getElementById("playersList");
      el.innerHTML = "";

      if(!playerStandings.length){
        el.innerHTML = `<div class="error">No player standings found.</div>`;
        return;
      }

      playerStandings.forEach(p=>{
        const row = document.createElement("div");
        row.className = "entry";

        const clr =
          p.rank === 1 ? "gold" :
          p.rank === 2 ? "silver" :
          p.rank === 3 ? "bronze" : "";

        // Player “name cell” uses the same team-cell visuals but without logo/color mapping
        const btn = document.createElement("button");
        btn.className = "name-text team-cell";
        btn.type = "button";
        btn.style.background = "rgba(255,255,255,0.08)";
        btn.style.color = "#ffffff";
        btn.style.cursor = "default";
        btn.style.setProperty("--icon", "none");
        btn.innerHTML = `<span class="chev" aria-hidden="true"></span>${p.name}`;

        row.innerHTML = `
          <span class="place ${clr}">${p.rank}</span>
          <span id="playerHost-${p.slug}"></span>
          <span class="score-col">${p.score != null ? p.score : "—"}</span>
        `;
        row.querySelector(`#playerHost-${p.slug}`).replaceWith(btn);

        el.appendChild(row);
      });
    }

    // Toggle rosters (event delegation)
    document.getElementById("teamsList").addEventListener("click", (e)=>{
      const btn = e.target.closest("button.team-cell");
      if(!btn) return;

      const teamName = btn.getAttribute("data-team");
      if(!teamName) return;

      if(expanded.has(teamName)) expanded.delete(teamName);
      else expanded.add(teamName);

      // re-render teams only (keeps style consistent + updates chevron)
      renderTeams();
    });

    async function update(){
      try{
        const [teamRows, playerRows, rosterRows] = await Promise.all([
          fetchRange(RANGE_TEAM_STANDINGS),
          fetchRange(RANGE_PLAYER_STANDINGS),
          fetchRange(RANGE_TEAM_ROSTERS),
        ]);

        teamStandings = normalizeTeamStandings(teamRows);
        playerStandings = normalizePlayerStandings(playerRows);
        rosterByTeam = parseRosters(rosterRows);

        // (Optional) auto-clean expanded set if a team disappears
        const teamNames = new Set(teamStandings.map(t=>t.name));
        [...expanded].forEach(n => { if(!teamNames.has(n)) expanded.delete(n); });

        renderTeams();
        renderPlayers();
      }catch(err){
        document.getElementById("teamsList").innerHTML = `<div class="error">${err.message}</div>`;
        document.getElementById("playersList").innerHTML = `<div class="error">${err.message}</div>`;
      }
    }

    // boot
    setTab("teams");
    update();
    setInterval(update, REFRESH_MS);
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beat Aidan Challenge — PNG Exports</title>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg1:#061C3B; --bg2:#04142E; --bg3:#020B18;
      --card-bg: rgba(15,23,42,1);
      --card-shadow: 0 32px 32px rgba(0,0,0,0.65);
      --row-bg: rgba(255,255,255,0.06);
      --row-bg-2: rgba(255,255,255,0.045);
      --text: #e9eef8;
      --title: #c7d7ff;
      --muted: rgba(255,255,255,.72);
      --accent: rgba(56,189,248,0.5);
      --hole-width: 58px;
      --pos-width: 68px;
      --total-width: 72px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(to bottom, var(--bg1), var(--bg2), var(--bg3));
      text-transform: uppercase;
    }

    .topbar{
      position: sticky; top:0; z-index:10;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(3,18,42,.70);
      backdrop-filter: blur(10px);
    }
    .topbar-inner{
      max-width:1200px;
      margin:0 auto;
      padding: 14px 18px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .kicker{
      font-size:11px; letter-spacing:.25em; text-transform:uppercase;
      color: rgba(255,255,255,.65); font-weight:900;
    }
    .page-title{
      font-size: 20px;
      font-weight: 900;
      letter-spacing: .05em;
      color: var(--title);
      margin: 4px 0 0;
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .select{
      appearance:none;
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      padding: 10px 38px 10px 12px;
      border-radius: 12px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: 12px;
      cursor:pointer;
      outline:none;
    }
    .btn{
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 950;
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: 11px;
      cursor: pointer;
      line-height: 1;
    }
    .btn:hover{ background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.28); }

    .container{
      max-width:1200px;
      margin:0 auto;
      padding: 18px 18px 48px;
      display:grid;
      gap: 16px;
    }

    .status{
      font-size: 12px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .14em;
      color: rgba(255,255,255,0.75);
    }

    .png-grid{
      display:grid;
      gap: 16px;
      justify-items: start;
    }
    .png-wrap{
      display:inline-block;
      width: fit-content;
      max-width: 100%;
    }
    .png-img{
      display:block;
      width: auto;
      max-width: 100%;
      border-radius: 20px;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255,255,255,0.10);
      user-select: none;
      -webkit-user-drag: none;
      cursor: context-menu;
    }

    .render-surface{
      position:absolute;
      left:-10000px;
      top:0;
      width: max-content;
      height: max-content;
      opacity: 0;
      pointer-events:none;
    }

    .card{
      background: var(--card-bg);
      border-radius: 20px;
      padding: 18px 18px 20px;
      box-shadow: var(--card-shadow);
      width: fit-content;
    }
    .card-head{
      display:flex;
      gap:14px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .h2{
      font-size: 18px;
      font-weight: 900;
      color: var(--title);
      letter-spacing: .06em;
      text-transform: uppercase;
      margin: 0;
    }

    .table-wrap{
      width: 100%;
      overflow: visible;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.12);
    }

    table{
      width: calc(100% + (var(--playoff-holes, 0) * var(--hole-width, 68px)));
      min-width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    thead tr,
    tbody tr{
      display: grid;
      grid-template-columns: var(--pos-width, 68px) 1fr repeat(9, var(--hole-width, 68px)) var(--total-width, 72px) repeat(var(--playoff-holes, 0), var(--hole-width, 68px));
    }

    thead th{
      text-align: center;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .12em;
      padding: 6px 8px;
      color: rgba(226,232,240,0.86);
      background: rgba(15,23,42,0.9);
      border-bottom: 1px solid rgba(148,163,184,0.18);
      position: sticky;
      top: 0;
      vertical-align: middle;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    tbody td{
      padding: 10px 10px;
      text-align: center;
      font-size: 25px;
      color: rgba(226,232,240,0.92);
    }

    tbody tr{
      position: relative;
    }

    tbody tr::after{
      content: "";
      position: absolute;
      inset: 0;
      background: transparent;
      z-index: 1;
      pointer-events: none;
    }

    tbody tr.row-gold::after{
      background: rgba(250,204,21,0.12);
    }

    tbody tr.row-aidan::after{
      background: rgba(15,175,255,0.16);
    }

    tbody tr > td{
      position: relative;
      z-index: 2;
    }

    tbody tr:nth-child(odd){
      background: var(--row-bg);
    }
    tbody tr:nth-child(even){
      background: var(--row-bg-2);
    }

    tbody td.name{
      text-align: left;
      font-weight: 700;
      letter-spacing: .02em;
      color: rgba(255,255,255,0.85);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .name-text{
      display: inline-block;
    }

    .name-buttons{
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: center;
      gap: 1px;
      align-self: center;
    }

    tbody td.total{
      font-weight: 700;
      color: rgba(255,255,255,0.85);
    }

    th.col-name,
    th.col-total,
    td.col-name,
    td.col-total{
      background: rgba(147,197,253,0.12);
    }

    .stats-table{
      width: 100%;
      min-width: 100%;
    }

    .stats-table thead tr,
    .stats-table tbody tr{
      grid-template-columns: var(--pos-width, 68px) 1fr 97px 97px 100px 100px 100px 100px;
    }

    .stats-table tbody td{
      font-size: 25px;
      padding: 12px 10px;
    }

    .stats-table tbody td.stat-record{
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stats-table th,
    .stats-table td{
      font-weight: 700;
    }

    .stats-table th.col-total,
    .stats-table td.col-total{
      background: transparent;
    }

    .hole-score.score-gold{ color: #f5d76e; }
    .hole-score.score-purple{ color: #c084fc; }
    .hole-score.score-blue{ color: #60a5fa; }
    .hole-score.score-green{ color: #4ade80; }
    .hole-score.score-red{ color: #f87171; }

    .col-pos{ width: var(--pos-width, 68px); }
    .col-name{ width: auto; }
    .col-total{ width: var(--total-width, 72px); }
    .col-hole{ width: var(--hole-width, 68px); }

    .hole-score,
    .finish-pos{
      font-weight: 700;
    }

    .finish-pos{
      color: var(--title);
    }

    .finish-gold{ color: #f5d76e; }
    .finish-silver{ color: #cbd5f5; }
    .finish-bronze{ color: #f2a65a; }

    .hole-header{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 1px;
      line-height: 1.02;
    }

    .wind{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 2px;
      font-size: 14px;
      font-weight: 800;
      letter-spacing: .02em;
    }

    .wind-speed{
      letter-spacing: .04em;
    }

    .wind-0{ color: rgba(255,255,255,0.9); }
    .wind-low{ color: #60a5fa; }
    .wind-mid{ color: #facc15; }
    .wind-high{ color: #c0267d; }

    .pin-position{
      font-size: 6px;
      letter-spacing: .08em;
      color: rgba(148,163,184,0.75);
      text-transform: uppercase;
      white-space: nowrap;
    }

    .hole-number{
      font-size: 22px;
      font-weight: 800;
      color: rgba(226,232,240,0.86);
      letter-spacing: .04em;
    }

    .score-button{
      width: 100%;
      padding: 10px 6px;
      background: transparent;
      border: none;
      color: inherit;
      font: inherit;
      letter-spacing: inherit;
      text-transform: inherit;
    }

    .beat-aidan-btn{
      margin-left: 0;
      padding: 2px 5px;
      border-radius: 999px;
      border: 1px solid rgba(250,204,21,0.7);
      background: transparent;
      color: rgba(250,204,21,0.95);
      font-size: 7px;
      font-weight: 800;
      letter-spacing: .12em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      vertical-align: middle;
      text-transform: uppercase;
    }

    .playoff-place-btn{
      margin-left: 0;
      padding: 2px 5px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: transparent;
      color: rgba(226,232,240,0.9);
      font-size: 7px;
      font-weight: 800;
      letter-spacing: .12em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      vertical-align: middle;
      text-transform: uppercase;
    }

    .playoff-place-gold{
      border-color: rgba(250,204,21,0.75);
      color: rgba(250,204,21,0.95);
    }

    .playoff-place-silver{
      border-color: rgba(226,232,240,0.75);
      color: rgba(226,232,240,0.95);
    }

    .playoff-place-bronze{
      border-color: rgba(251,146,60,0.75);
      color: rgba(251,146,60,0.95);
    }

    .playoff-place-blue{
      border-color: rgba(56,189,248,0.75);
      color: rgba(125,211,252,0.95);
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div>
        <div class="kicker">Weekly Matches</div>
        <div class="page-title">Beat Aidan Challenge — PNG Exports</div>
      </div>
      <div class="controls">
        <select id="weekSelect" class="select" aria-label="Select week"></select>
        <button id="reloadBtn" class="btn" type="button">Reload Data</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div id="status" class="status">Loading weekly results…</div>

    <div class="png-grid">
      <div class="png-wrap">
        <img id="pngResults" class="png-img" alt="Week results PNG" />
      </div>
      <div class="png-wrap">
        <img id="pngStats" class="png-img" alt="Week stats PNG" />
      </div>
    </div>
  </div>

  <div class="render-surface" aria-hidden="true">
    <div id="resultsCard" class="card">
      <div class="card-head"><h2 class="h2" id="resultsTitle">Week Results</h2></div>
      <div class="table-wrap" id="resultsTable"></div>
    </div>

    <div id="statsCard" class="card">
      <div class="card-head"><h2 class="h2" id="statsTitle">Week Stats</h2></div>
      <div class="table-wrap" id="statsTable"></div>
    </div>
  </div>

  <script>
    const WORKER_URL = "https://small-mud-2771.nextweekmedia.workers.dev/";
    const SHEET_ID = "1sbAQKwAoHzhGaRX2aI6v79wrsU7nuO7hI8xnaOexOiM";
    const SHEET_NAME = "Inputs";
    const PLAYER_STATS_SHEET = "Player Stats";
    const AIDAN_NAME = "NWN Aidan";

    const statusEl = document.getElementById("status");
    const weekSelect = document.getElementById("weekSelect");
    const reloadBtn = document.getElementById("reloadBtn");

    const resultsTitle = document.getElementById("resultsTitle");
    const statsTitle = document.getElementById("statsTitle");
    const resultsTable = document.getElementById("resultsTable");
    const statsTable = document.getElementById("statsTable");

    const resultsCard = document.getElementById("resultsCard");
    const statsCard = document.getElementById("statsCard");
    const pngResults = document.getElementById("pngResults");
    const pngStats = document.getElementById("pngStats");

    let currentWeeks = [];
    let currentWeekIndex = 0;
    let playerStatsMap = new Map();
    let avgHoleMap = new Map();

    function normalizeValues(resp){
      if(!resp) return [];
      if(Array.isArray(resp)) return resp;
      if(Array.isArray(resp.values)) return resp.values;
      if(Array.isArray(resp.data?.values)) return resp.data.values;
      if(Array.isArray(resp.result?.values)) return resp.result.values;
      return [];
    }

    async function fetchRange(a1, sheetName = SHEET_NAME){
      const range = `'${sheetName}'!${a1}`;
      const payload = { sheetId: SHEET_ID, range };

      try{
        const r = await fetch(WORKER_URL, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload),
        });
        if(r.ok) return normalizeValues(await r.json());
      }catch(e){}

      const u = new URL(WORKER_URL);
      u.searchParams.set("sheetId", SHEET_ID);
      u.searchParams.set("range", range);
      const r2 = await fetch(u.toString());
      if(!r2.ok){
        const text = await r2.text().catch(()=> "");
        throw new Error(`Worker request failed (${r2.status}). ${text}`.trim());
      }
      return normalizeValues(await r2.json());
    }

    function isRowEmpty(row){
      return !row || row.every(cell => String(cell ?? "").trim() === "");
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function formatCell(value){
      const s = String(value ?? "").trim();
      return s === "" ? "—" : s;
    }

    function formatScoreDisplay(value){
      const s = String(value ?? "").trim();
      if(s === "") return "—";
      if(s === "0") return "E";
      return s;
    }

    function formatHoleScoreDisplay(value){
      const s = String(value ?? "").trim();
      if(s === "") return "";
      if(s === "0") return "E";
      return s;
    }

    function parseCheckboxValue(value){
      if(value === true) return true;
      if(value === false) return false;
      const normalized = String(value ?? "").trim().toLowerCase();
      if(normalized === "true") return true;
      if(normalized === "false") return false;
      return null;
    }

    function parseHoleHeader(raw){
      const text = String(raw ?? "").trim();
      const numbers = text.match(/\d+/g) ?? [];
      const letters = text.match(/[A-Za-z]+/g) ?? [];
      const holeNumber = numbers[0] ?? "";
      const windSpeed = numbers[1] ? Number.parseInt(numbers[1], 10) : null;
      const windDir = letters[1] ? letters[1].toUpperCase() : "";
      const pinCode = letters[0] ? letters[0].toUpperCase() : "";
      return {
        holeNumber,
        windSpeed: Number.isNaN(windSpeed) ? null : windSpeed,
        windDir,
        pinCode,
      };
    }

    function formatPinPosition(code){
      const map = { B: "back", F: "front", M: "middle", L: "left", R: "right" };
      return String(code ?? "")
        .split("")
        .map(letter => map[letter])
        .filter(Boolean)
        .join(" ");
    }

    function getWindArrow(direction){
      const arrows = {
        N: "↑",
        S: "↓",
        E: "→",
        W: "←",
        NE: "↗",
        NW: "↖",
        SE: "↘",
        SW: "↙",
      };
      return arrows[direction] ?? "";
    }

    function formatWindSpeed(speed){
      if(speed === null || speed === undefined) return "—";
      return speed;
    }

    function getWindClass(speed){
      if(speed === 0) return "wind-0";
      if(speed >= 2 && speed <= 11) return "wind-low";
      if(speed >= 13 && speed <= 22) return "wind-mid";
      if(speed >= 24 && speed <= 33) return "wind-high";
      return "";
    }

    function getFinishClass(value){
      const finish = Number.parseInt(String(value ?? "").trim(), 10);
      if(finish === 1) return "finish-gold";
      if(finish === 2) return "finish-silver";
      if(finish === 3) return "finish-bronze";
      return "";
    }

    function getPlayoffPlaceClass(value){
      const finish = Number.parseInt(String(value ?? "").trim(), 10);
      if(finish === 1) return "playoff-place-gold";
      if(finish === 2) return "playoff-place-silver";
      if(finish === 3) return "playoff-place-bronze";
      return "playoff-place-blue";
    }

    function formatOrdinalSuffix(value){
      const number = Number.parseInt(String(value ?? "").trim(), 10);
      if(Number.isNaN(number)) return "";
      const mod100 = number % 100;
      if(mod100 >= 11 && mod100 <= 13) return "th";
      switch(number % 10){
        case 1:
          return "st";
        case 2:
          return "nd";
        case 3:
          return "rd";
        default:
          return "th";
      }
    }

    function formatPlayoffLabel(value){
      const match = String(value ?? "").match(/\d+/);
      const numberText = match ? match[0] : String(value ?? "").trim();
      if(!numberText) return "PLAYOFF";
      const suffix = formatOrdinalSuffix(numberText);
      return `PLAYOFF ${numberText}${suffix}`.toUpperCase();
    }

    function normalizeName(value){
      return String(value ?? "").trim().toLowerCase();
    }

    function buildPlayerStatsMap(values){
      const map = new Map();
      values.forEach(row => {
        const name = String(row?.[0] ?? "").trim();
        if(!name || normalizeName(name) === "player") return;
        map.set(normalizeName(name), {
          name,
          vsAidan: {
            wins: row?.[1],
            losses: row?.[2],
            ties: row?.[3],
          },
          vsAll: {
            wins: row?.[5],
            losses: row?.[6],
            ties: row?.[7],
          },
        });
      });
      return map;
    }

    function buildAvgHoleMap(values){
      const map = new Map();
      values.forEach(row => {
        const name = String(row?.[0] ?? "").trim();
        if(!name || normalizeName(name) === "player") return;
        map.set(normalizeName(name), String(row?.[9] ?? "").trim());
      });
      return map;
    }

    function formatRecord(record){
      const values = [record?.wins, record?.losses, record?.ties];
      if(values.every(value => String(value ?? "").trim() === "")){
        return "—";
      }
      return values
        .map(value => String(value ?? "").trim() || "0")
        .join("-");
    }

    function formatPercent(value){
      if(value === null || value === undefined || Number.isNaN(value)) return "—";
      const rounded = Math.round(value * 10) / 10;
      if(Number.isInteger(rounded)){
        return `${rounded}%`;
      }
      return `${rounded.toFixed(1)}%`;
    }

    function lerp(a, b, t){
      return Math.round(a + (b - a) * t);
    }

    function colorForScale(value, minValue, midValue, maxValue){
      if(value === null || value === undefined || Number.isNaN(value)) return "";
      const red = { r: 248, g: 113, b: 113 };
      const yellow = { r: 250, g: 204, b: 21 };
      const green = { r: 74, g: 222, b: 128 };

      const ascending = minValue < maxValue;
      const lowerBound = ascending ? minValue : maxValue;
      const upperBound = ascending ? maxValue : minValue;

      if(value <= lowerBound){
        return `rgb(${ascending ? red.r : green.r}, ${ascending ? red.g : green.g}, ${ascending ? red.b : green.b})`;
      }
      if(value >= upperBound){
        return `rgb(${ascending ? green.r : red.r}, ${ascending ? green.g : red.g}, ${ascending ? green.b : red.b})`;
      }

      let from = red;
      let to = yellow;
      let t = 0;

      if(ascending){
        if(value >= midValue){
          from = yellow;
          to = green;
          t = (value - midValue) / (maxValue - midValue);
        }else{
          from = red;
          to = yellow;
          t = (value - minValue) / (midValue - minValue);
        }
      }else{
        if(value <= midValue){
          from = yellow;
          to = green;
          t = (midValue - value) / (midValue - maxValue);
        }else{
          from = red;
          to = yellow;
          t = (minValue - value) / (minValue - midValue);
        }
      }

      const r = lerp(from.r, to.r, t);
      const g = lerp(from.g, to.g, t);
      const b = lerp(from.b, to.b, t);
      return `rgb(${r}, ${g}, ${b})`;
    }

    function getHoleTotals(player){
      let totalHoles = 0;
      let greens = 0;
      let puttsMade = 0;
      let puttsAttempted = 0;
      let saves = 0;
      let saveAttempts = 0;

      player.holes.forEach(hole => {
        const score = String(hole?.score ?? "").trim();
        const greenHit = parseCheckboxValue(hole?.greenHit);
        const puttsRaw = String(hole?.putts ?? "").trim();
        const eventsRaw = String(hole?.events ?? "").trim();
        const playedHole = score !== "";
        if(playedHole){
          totalHoles += 1;
        }
        if(playedHole && greenHit){
          greens += 1;
        }
        const putts = Number.parseInt(puttsRaw, 10);
        if(Number.isFinite(putts) && putts > 0){
          puttsMade += 1;
          puttsAttempted += putts;
        }

        if(eventsRaw){
          eventsRaw
            .split(",")
            .map(entry => entry.trim().toLowerCase())
            .filter(Boolean)
            .forEach(entry => {
              if(entry === "sv"){
                saves += 1;
                saveAttempts += 1;
              }else if(entry === "xsv"){
                saveAttempts += 1;
              }
            });
        }
      });

      const greenPercent = totalHoles ? (greens / totalHoles) * 100 : null;
      const puttPercent = puttsAttempted ? (puttsMade / puttsAttempted) * 100 : null;
      const savePercent = saveAttempts ? (saves / saveAttempts) * 100 : null;

      return {
        totalHoles,
        greenPercent,
        savePercent,
        puttPercent,
      };
    }

    function getParForHole(value){
      const holeNumber = Number.parseInt(String(value ?? "").trim(), 10);
      if(Number.isNaN(holeNumber)) return null;
      const parMap = {
        1: 4,
        2: 3,
        3: 5,
        4: 3,
        5: 5,
        6: 4,
        7: 4,
        8: 3,
        9: 5,
        10: 4,
        11: 3,
        12: 5,
        13: 3,
        14: 5,
        15: 4,
        16: 4,
        17: 3,
        18: 5,
        19: 4,
        20: 4,
        21: 4,
      };
      return parMap[holeNumber] ?? null;
    }

    function renderHoleHeader(hole){
      const windSpeed = hole.windSpeed;
      const windText = `${formatWindSpeed(windSpeed)}`;
      const windClass = getWindClass(windSpeed);
      const arrow = windSpeed && windSpeed > 0 ? getWindArrow(hole.windDir) : "";
      const pinText = formatPinPosition(hole.pinCode);
      const holeNumber = hole.holeNumber || "—";
      const holePar = getParForHole(holeNumber);

      return `
        <div class="hole-header">
          <div class="wind ${windClass}">
            ${arrow ? `<span class="wind-arrow">${arrow}</span>` : ""}
            <span class="wind-speed">${escapeHtml(windText)}</span>
          </div>
          <div class="pin-position">${escapeHtml(pinText || "—")}</div>
          <div class="hole-number">${escapeHtml(holeNumber)}</div>
          ${holePar ? `
            <div class="pin-position">par ${holePar}</div>
          ` : ""}
        </div>
      `;
    }

    function getScoreClass(value){
      const score = Number.parseInt(String(value ?? "").trim(), 10);
      if(Number.isNaN(score)) return "";
      if(score <= -3) return "score-gold";
      if(score === -2) return "score-purple";
      if(score === -1) return "score-blue";
      if(score === 0) return "score-green";
      if(score >= 1) return "score-red";
      return "";
    }

    function parseWeeks(values){
      const weeks = [];
      const blockSize = 9;

      for(let i=0; i < values.length; i += blockSize){
        const header = values[i] ?? [];
        const players = values.slice(i + 1, i + 1 + 8);
        if(isRowEmpty(header) && players.every(isRowEmpty)){
          continue;
        }

        const weekNumber = (() => {
          for(const row of players){
            const w = String(row?.[0] ?? "").trim();
            if(w) return w;
          }
          return String(header?.[0] ?? "").trim() || "—";
        })();

        const holeColumns = [];
        const maxCols = Math.max(
          header.length,
          ...players.map(row => row?.length ?? 0),
        );

        for(let col = 4; col < maxCols; col += 5){
          const headerValue = String(header?.[col] ?? "").trim();
          const hasPlayerValue = players.some(row => String(row?.[col] ?? "").trim() !== "");
          if(!headerValue && !hasPlayerValue){
            continue;
          }
          const holeMeta = parseHoleHeader(headerValue);
          holeColumns.push({
            col,
            holeNumber: holeMeta.holeNumber || "—",
            windSpeed: holeMeta.windSpeed,
            windDir: holeMeta.windDir,
            pinCode: holeMeta.pinCode,
          });
        }

        const playerRows = players
          .filter(row => !isRowEmpty(row))
          .map(row => {
            const finish = formatCell(row?.[1]);
            const finishValue = Number.parseInt(String(finish ?? "").trim(), 10);
            const name = formatCell(row?.[3]);
            return {
              finish,
              finishValue,
              name,
              isAidan: String(name).toLowerCase() === AIDAN_NAME.toLowerCase(),
              total: row?.[2] ?? "",
              holes: holeColumns.map(hole => {
                const baseCol = hole.col;
                return {
                  score: row?.[baseCol] ?? "",
                  greenHit: row?.[baseCol + 1] ?? "",
                  holeOut: row?.[baseCol + 2] ?? "",
                  putts: row?.[baseCol + 3] ?? "",
                  events: row?.[baseCol + 4] ?? "",
                };
              }),
            };
          })
          .sort((a, b) => {
            const aScore = Number.isNaN(a.finishValue) ? Number.POSITIVE_INFINITY : a.finishValue;
            const bScore = Number.isNaN(b.finishValue) ? Number.POSITIVE_INFINITY : b.finishValue;
            if(aScore === bScore && a.isAidan !== b.isAidan){
              return a.isAidan ? -1 : 1;
            }
            return aScore - bScore;
          });

        if(playerRows.length){
          weeks.push({
            weekNumber,
            holeColumns,
            playerRows,
          });
        }
      }

      return weeks;
    }

    function getWeekSortValue(week){
      const match = String(week.weekNumber ?? "").match(/\d+/);
      return match ? Number.parseInt(match[0], 10) : -1;
    }

    function renderWeekTables(week){
      if(!week){
        resultsTable.innerHTML = "";
        statsTable.innerHTML = "";
        return;
      }

      const mainHoles = week.holeColumns.slice(0, 9);
      const playoffHoles = week.holeColumns.slice(9);
      const aidanFinish = week.playerRows.find(player => player.isAidan)?.finishValue;

      resultsTitle.textContent = `Week ${week.weekNumber} Results`;
      statsTitle.textContent = `Week ${week.weekNumber} Stats`;

      resultsTable.innerHTML = `
        <table style="--playoff-holes: ${playoffHoles.length};">
          <thead>
            <tr>
              <th class="col-pos">Pos.</th>
              <th class="col-name">Player</th>
              ${mainHoles.map(hole => `<th class="col-hole">${renderHoleHeader(hole)}</th>`).join("")}
              <th class="col-total">Score</th>
              ${playoffHoles.map(hole => `<th class="col-hole">${renderHoleHeader(hole)}</th>`).join("")}
            </tr>
          </thead>
          <tbody>
            ${week.playerRows.map(player => {
              const hasValidAidanFinish = Number.isFinite(aidanFinish);
              const hasValidFinish = Number.isFinite(player.finishValue);
              const isBetterThanAidan = hasValidAidanFinish && hasValidFinish && player.finishValue < aidanFinish;
              const rowClass = [
                isBetterThanAidan ? "row-gold" : "",
                player.isAidan ? "row-aidan" : "",
              ].filter(Boolean).join(" ");
              const starButton = isBetterThanAidan
                ? `<button class="beat-aidan-btn" type="button" aria-label="Beat Aidan">Beat Aidan</button>`
                : "";
              const playoffScores = playoffHoles.some((hole, i) => {
                const score = String(player.holes[i + 9]?.score ?? "").trim();
                return score !== "";
              });
              const playoffButton = playoffHoles.length && playoffScores
                ? `<button class="playoff-place-btn ${getPlayoffPlaceClass(player.finish)}" type="button" aria-label="${escapeHtml(formatPlayoffLabel(player.finish))}">${escapeHtml(formatPlayoffLabel(player.finish))}</button>`
                : "";
              const nameButtons = [starButton, playoffButton].filter(Boolean).join("");
              return `
                <tr class="${rowClass}">
                  <td class="finish-pos col-pos ${getFinishClass(player.finish)}">${escapeHtml(player.finish)}</td>
                  <td class="name col-name"><span class="name-text">${escapeHtml(player.name)}</span>${nameButtons ? `<div class="name-buttons">${nameButtons}</div>` : ""}</td>
                  ${mainHoles.map((hole, i) => {
                    const holeData = player.holes[i] ?? {};
                    const scoreValue = holeData.score ?? "";
                    return `<td class="hole-score col-hole ${getScoreClass(scoreValue)}" data-hole-number="${escapeHtml(hole.holeNumber)}">
                      <button class="score-button" type="button">${escapeHtml(formatHoleScoreDisplay(scoreValue))}</button>
                    </td>`;
                  }).join("")}
                  <td class="total col-total">${escapeHtml(formatScoreDisplay(player.total))}</td>
                  ${playoffHoles.map((hole, i) => {
                    const holeData = player.holes[i + 9] ?? {};
                    const scoreValue = holeData.score ?? "";
                    return `<td class="hole-score col-hole ${getScoreClass(scoreValue)}" data-hole-number="${escapeHtml(hole.holeNumber)}">
                      <button class="score-button" type="button">${escapeHtml(formatHoleScoreDisplay(scoreValue))}</button>
                    </td>`;
                  }).join("")}
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;

      statsTable.innerHTML = `
        <table class="stats-table">
          <thead>
            <tr>
              <th class="col-pos">Pos.</th>
              <th class="col-name">Player</th>
              <th>Vs. Aidan</th>
              <th>Vs. All Players</th>
              <th>Avg. Hole Score</th>
              <th>Green %</th>
              <th>Save %</th>
              <th>Putt %</th>
            </tr>
          </thead>
          <tbody>
            ${week.playerRows.map(player => {
              const hasValidAidanFinish = Number.isFinite(aidanFinish);
              const hasValidFinish = Number.isFinite(player.finishValue);
              const isBetterThanAidan = hasValidAidanFinish && hasValidFinish && player.finishValue < aidanFinish;
              const rowClass = [
                isBetterThanAidan ? "row-gold" : "",
                player.isAidan ? "row-aidan" : "",
              ].filter(Boolean).join(" ");
              const starButton = isBetterThanAidan
                ? `<button class="beat-aidan-btn" type="button" aria-label="Beat Aidan">Beat Aidan</button>`
                : "";
              const playerStats = playerStatsMap.get(normalizeName(player.name));
              const playoffScores = playoffHoles.some((hole, i) => {
                const score = String(player.holes[i + 9]?.score ?? "").trim();
                return score !== "";
              });
              const playoffButton = playoffHoles.length && playoffScores
                ? `<button class="playoff-place-btn ${getPlayoffPlaceClass(player.finish)}" type="button" aria-label="${escapeHtml(formatPlayoffLabel(player.finish))}">${escapeHtml(formatPlayoffLabel(player.finish))}</button>`
                : "";
              const nameButtons = [starButton, playoffButton].filter(Boolean).join("");
              const totals = getHoleTotals(player);
              const avgHole = avgHoleMap.get(normalizeName(player.name));
              const vsAidanText = player.isAidan ? "" : formatRecord(playerStats?.vsAidan);
              const avgHoleValue = Number.parseFloat(String(avgHole ?? "").trim());
              const avgHoleColor = Number.isFinite(avgHoleValue)
                ? colorForScale(avgHoleValue, -0.5, -0.9, -1.3)
                : "";
              const greenPercentColor = colorForScale(totals.greenPercent, 50, 75, 100);
              const puttPercentColor = colorForScale(totals.puttPercent, 50, 75, 100);
              const savePercentColor = colorForScale(totals.savePercent, 0, 25, 50);
              return `
                <tr class="${rowClass}">
                  <td class="finish-pos col-pos ${getFinishClass(player.finish)}">${escapeHtml(player.finish)}</td>
                  <td class="name col-name"><span class="name-text">${escapeHtml(player.name)}</span>${nameButtons ? `<div class="name-buttons">${nameButtons}</div>` : ""}</td>
                  <td class="stat-record">${escapeHtml(vsAidanText)}</td>
                  <td class="stat-record">${escapeHtml(formatRecord(playerStats?.vsAll))}</td>
                  <td style="${avgHoleColor ? `color: ${avgHoleColor};` : ""}">${escapeHtml(formatCell(avgHole))}</td>
                  <td style="${greenPercentColor ? `color: ${greenPercentColor};` : ""}">${escapeHtml(formatPercent(totals.greenPercent))}</td>
                  <td style="${savePercentColor ? `color: ${savePercentColor};` : ""}">${escapeHtml(formatPercent(totals.savePercent))}</td>
                  <td style="${puttPercentColor ? `color: ${puttPercentColor};` : ""}">${escapeHtml(formatPercent(totals.puttPercent))}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;
    }

    async function waitForImages(rootEl){
      const imgs = Array.from(rootEl.querySelectorAll("img"));
      await Promise.all(imgs.map(img => {
        if (img.complete) return Promise.resolve();
        return new Promise(res => {
          img.addEventListener("load", res, { once:true });
          img.addEventListener("error", res, { once:true });
        });
      }));
    }

    const EXPORT_SCALE = 4;
    const blobUrlByKey = new Map();

    function setPreviewImgSrc(key, imgEl, blobUrl){
      const prev = blobUrlByKey.get(key);
      if (prev && prev !== blobUrl){
        try{ URL.revokeObjectURL(prev); }catch(e){}
      }
      blobUrlByKey.set(key, blobUrl);
      imgEl.src = blobUrl;
    }

    async function buildPngBlob(cardEl){
      await waitForImages(cardEl);
      if (document.fonts && document.fonts.ready) await document.fonts.ready;

      const canvas = await html2canvas(cardEl, {
        scale: EXPORT_SCALE,
        backgroundColor: null,
        useCORS: true,
        allowTaint: false,
        logging: false,
        foreignObjectRendering: false
      });

      const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png"));
      if (!blob) throw new Error("PNG generation failed (canvas.toBlob returned null).");
      return blob;
    }

    async function renderCardToImg(cardEl, imgEl, key){
      const blob = await buildPngBlob(cardEl);
      const url = URL.createObjectURL(blob);
      setPreviewImgSrc(key, imgEl, url);
    }

    async function generatePreviews(){
      statusEl.textContent = "Generating PNG previews…";
      await renderCardToImg(resultsCard, pngResults, "results");
      await renderCardToImg(statsCard, pngStats, "stats");
      statusEl.textContent = "Ready";
    }

    function syncWeekSelect(){
      weekSelect.innerHTML = currentWeeks.map((week, index) => {
        return `<option value="${index}" ${index === currentWeekIndex ? "selected" : ""}>Week ${escapeHtml(week.weekNumber)}</option>`;
      }).join("");
    }

    async function load(){
      statusEl.textContent = "Loading weekly results…";
      try{
        const [values, playerStats] = await Promise.all([
          fetchRange("A1:CH500"),
          fetchRange("A1:J500", PLAYER_STATS_SHEET),
        ]);
        const weeks = parseWeeks(values).sort((a, b) => getWeekSortValue(a) - getWeekSortValue(b));
        currentWeeks = weeks;
        playerStatsMap = buildPlayerStatsMap(playerStats);
        avgHoleMap = buildAvgHoleMap(playerStats);
        currentWeekIndex = Math.max(weeks.length - 1, 0);
        syncWeekSelect();
        if(!weeks.length){
          statusEl.textContent = "No match data available yet.";
          return;
        }
        renderWeekTables(currentWeeks[currentWeekIndex]);
        await generatePreviews();
      }catch(err){
        statusEl.textContent = "Unable to load weekly results.";
        console.error(err);
      }
    }

    weekSelect.addEventListener("change", async (event) => {
      const nextIndex = Number.parseInt(event.target.value, 10);
      if(Number.isNaN(nextIndex)) return;
      currentWeekIndex = nextIndex;
      renderWeekTables(currentWeeks[currentWeekIndex]);
      await generatePreviews();
    });

    reloadBtn.addEventListener("click", () => load());

    load();
  </script>
</body>
</html>

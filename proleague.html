<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shotgun Pro League - Season 6</title>
    <style>
      :root{
        --bg1:#061C3B; --bg2:#04142E; --bg3:#020B18;
        --panel: rgba(255,255,255,.05);
        --panel2: rgba(4,20,46,.60);
        --border: rgba(255,255,255,.10);
        --border2: rgba(255,255,255,.15);
        --text: rgba(255,255,255,1);
        --muted: rgba(255,255,255,.70);
        --muted2: rgba(255,255,255,.60);
        --muted3: rgba(255,255,255,.45);
        --hover: rgba(255,255,255,.04);
      }

      *{box-sizing:border-box}
      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        color: var(--text);
        background: linear-gradient(to bottom, var(--bg1), var(--bg2), var(--bg3));
        min-height: 100vh;
      }
      .container{max-width:1100px; margin:0 auto; padding: 24px 18px 60px;}
      .topbar{
        position: sticky; top:0; z-index:10;
        border-bottom: 1px solid var(--border);
        background: rgba(3,18,42,.70);
        backdrop-filter: blur(10px);
      }
      .topbar-inner{
        max-width:1100px; margin:0 auto; padding: 14px 18px;
        display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      }
      .brand{display:flex; gap:12px; align-items:center;}
      .logo{
        width:40px; height:40px; border-radius:16px;
        border:1px solid var(--border2);
        background: var(--panel);
        display:grid; place-items:center;
        font-size:18px;
      }
      .kicker{font-size:11px; letter-spacing:.25em; text-transform:uppercase; color: var(--muted2);}
      .title{font-weight:900;}
      .tabs{display:flex; gap:10px; flex-wrap:wrap;}
      .tabbtn{
        border:1px solid var(--border2);
        background: var(--panel);
        color: rgba(255,255,255,.85);
        padding:10px 14px;
        border-radius: 12px;
        font-weight:900;
        cursor:pointer;
        transition: .15s ease;
      }
      .tabbtn:hover{background: rgba(255,255,255,.10)}
      .tabbtn.active{
        background: #fff;
        color: #061C3B;
        border-color: #fff;
      }

      .card{
        border:1px solid var(--border);
        background: var(--panel);
        border-radius: 22px;
        padding: 18px;
        box-shadow: 0 6px 24px rgba(0,0,0,.18);
      }
      .hero{border-radius: 26px; padding: 18px;}
      .row{display:flex; gap:14px; flex-wrap:wrap; align-items:flex-end; justify-content:space-between;}
      .pillgrid{display:flex; gap:10px; flex-wrap:wrap;}
      .metric{
        border:1px solid var(--border);
        background: var(--panel2);
        padding: 12px 14px;
        border-radius: 18px;
        min-width: 120px;
      }
      .metric .label{font-size:11px; letter-spacing:.08em; text-transform:uppercase; color: var(--muted2);}
      .metric .value{font-size:18px; font-weight:900; margin-top:2px;}
      .muted{color: var(--muted);}
      .muted2{color: var(--muted2);}
      .muted3{color: var(--muted3);}
      code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

      /* Table */
      .table-card{padding:0; overflow:hidden;}
      .table-head{
        padding: 16px 18px;
        border-bottom:1px solid var(--border);
        display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      }
      .h2{font-size:18px; font-weight:900; margin:2px 0 0;}
      .search{
        display:flex; align-items:center; gap:10px;
        border:1px solid var(--border);
        background: rgba(4,20,46,.60);
        padding: 10px 12px;
        border-radius: 14px;
        min-width: 260px;
      }
      .search input{
        width:100%;
        background:transparent;
        border:none;
        outline:none;
        color:#fff;
        font-size:14px;
      }
      .search input::placeholder{color: rgba(255,255,255,.40)}
      .table-wrap{overflow-x:auto;}
      table{width:100%; border-collapse:collapse; min-width: 640px;}
      thead th{
        text-align:left;
        font-size:11px;
        letter-spacing:.08em;
        text-transform:uppercase;
        color: var(--muted2);
        padding: 12px 18px;
        white-space:nowrap;
      }
      tbody td{
        padding: 12px 18px;
        border-top:1px solid var(--border);
        color: rgba(255,255,255,.80);
        font-size:14px;
        white-space:nowrap;
      }
      tbody tr:hover{background: var(--hover);}
      tbody tr.top3{background: rgba(255,255,255,.03);}
      td.highlight{font-weight:900; color:#fff;}

      /* Rosters */
      .section-kicker{font-size:11px; letter-spacing:.25em; text-transform:uppercase; color: var(--muted2);}
      .section-title{font-size:18px; font-weight:900; margin:6px 0 0;}
      .grid{display:grid; gap:14px;}
      @media (min-width: 980px){ .grid-2{grid-template-columns: 1fr 1fr;} }
      .team-card h3{margin: 6px 0 0; font-size:20px;}
      .team-top{display:flex; justify-content:space-between; gap:14px; align-items:flex-start;}
      .live{display:flex; align-items:center; gap:8px; font-size:12px; font-weight:900; letter-spacing:.06em; text-transform:uppercase; color: rgba(255,255,255,.80);}
      .dot{width:8px; height:8px; border-radius:999px; background:#fff; display:inline-block;}
      .statgrid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:14px;}
      @media (min-width: 640px){ .statgrid{grid-template-columns: repeat(4, minmax(0,1fr));} }
      .statpill{
        border:1px solid var(--border);
        background: var(--panel);
        border-radius: 14px;
        padding: 10px 12px;
      }
      .statpill .l{font-size:11px; text-transform:uppercase; letter-spacing:.06em; color: var(--muted2);}
      .statpill .v{font-size:14px; font-weight:900; margin-top:2px;}
      .rostergrid{display:grid; gap:10px; margin-top:12px;}
      @media (min-width: 640px){ .rostergrid{grid-template-columns: 1fr 1fr;} }
      .player-card{
        border:1px solid var(--border);
        background: var(--panel2);
        border-radius: 18px;
        padding: 12px 12px;
      }
      .player-name{font-weight:900; font-size:14px;}
      .player-stats{
        display:grid; grid-template-columns: 1fr 1fr;
        gap: 6px 10px;
        margin-top: 10px;
        font-size:12px;
        color: rgba(255,255,255,.70);
      }
      .player-stats span{color: rgba(255,255,255,.50)}
      .footer{margin-top:34px; text-align:center; font-size:12px; color: var(--muted3);}
      .hidden{display:none !important;}
      .status{padding: 16px 18px; color: rgba(255,255,255,.80);}
      .error{padding: 16px 18px;}
      .error b{display:block; margin-bottom:6px;}
      .small{font-size:12px;}
    </style>
  </head>
  <body>
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="logo">⚡</div>
          <div>
            <div class="kicker">Shotgun Pro League</div>
            <div class="title">Season 6</div>
          </div>
        </div>

        <div class="tabs" role="tablist" aria-label="Standings tabs">
          <button class="tabbtn active" data-tab="teams" role="tab" aria-selected="true">Team Rankings</button>
          <button class="tabbtn" data-tab="players" role="tab" aria-selected="false">Player Rankings</button>
          <button class="tabbtn" data-tab="rosters" role="tab" aria-selected="false">Rosters</button>
        </div>
      </div>
    </div>

    <div class="container">
      <div id="status" class="card status">Loading standings…</div>

      <div id="content" class="hidden">
        <!-- Hero (public-safe) -->
        <div class="card hero" style="margin-bottom:16px;">
          <div class="row">
            <div>
              <div class="kicker">Live Standings</div>
              <div class="muted small" style="margin-top:10px;">Updated from official league scoring.</div>
            </div>
            <div class="pillgrid">
              <div class="metric">
                <div class="label">Teams</div>
                <div class="value" id="teamCount">0</div>
              </div>
              <div class="metric">
                <div class="label">Players</div>
                <div class="value" id="playerCount">0</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Team standings -->
        <div id="view-teams" class="card table-card">
          <div class="table-head">
            <div>
              <div class="kicker">Standings</div>
              <div class="h2">Team Rankings</div>
            </div>
            <div class="search">
              <span class="muted2">⌕</span>
              <input id="teamSearch" type="text" placeholder="Search…" />
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr id="teamHead"></tr></thead>
              <tbody id="teamBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Player standings -->
        <div id="view-players" class="card table-card hidden">
          <div class="table-head">
            <div>
              <div class="kicker">Standings</div>
              <div class="h2">Player Rankings</div>
            </div>
            <div class="search">
              <span class="muted2">⌕</span>
              <input id="playerSearch" type="text" placeholder="Search…" />
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr id="playerHead"></tr></thead>
              <tbody id="playerBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Rosters -->
        <div id="view-rosters" class="hidden">
          <div style="margin: 0 0 12px;">
            <div class="section-kicker">Teams</div>
            <div class="section-title">Rosters</div>
            <div class="muted small" style="margin-top:8px;">
              The roster range has a header row (used to label stats). Teams are grouped into blocks of 5 rows:
              one team row + four player rows.
            </div>
          </div>
          <div id="rosterGrid" class="grid grid-2"></div>
        </div>

        <div class="footer">Shotgun Pro League • Season 6</div>
      </div>
    </div>

    <script>
      // ==============================
      // Config (not displayed publicly)
      // ==============================
      const WORKER_URL = "https://small-mud-2771.nextweekmedia.workers.dev/";
      const SHEET_ID   = "1qIM0HKhx9Y-3eCJCFzBqrbATwiPrK3C1ynATwZzRC1o";

      const RANGES = {
        teamInfo: "'Season 6, Stage 1'!A3:S63",
        teamStandings: "'Season 6, Stage 1'!U4:X15",
        playerStandings: "'Season 6, Stage 1'!AE4:AH101",
      };

      // If your standings ranges include header rows, set true
      const USE_FIRST_ROW_AS_HEADER = false;

      // IMPORTANT: Team standings "Notes" is not used publicly.
      // Your sheet has team name in the "Points" column and team score in the "Notes" column,
      // so we remap to: Rank | Team | Points (3 columns).
      const TEAM_STANDINGS_HEADERS   = ["Rank","Team","Points"];
      const PLAYER_STANDINGS_HEADERS = ["Rank","Player","Points","Notes"];

      // ==============================
      // Helpers
      // ==============================
      function normalizeValues(resp){
        if(!resp) return [];
        if(Array.isArray(resp)) return resp;
        if(Array.isArray(resp.values)) return resp.values;
        if(Array.isArray(resp.data?.values)) return resp.data.values;
        if(Array.isArray(resp.result?.values)) return resp.result.values;
        return [];
      }

      function rowHasAnyValue(row){
        return Array.isArray(row) && row.some(c => String(c ?? "").trim() !== "");
      }

      function firstNonEmptyCell(row){
        if(!Array.isArray(row)) return "";
        for(const cell of row){
          const v = String(cell ?? "").trim();
          if(v) return v;
        }
        return "";
      }

      async function fetchRange(range){
        const payload = { sheetId: SHEET_ID, range };

        // Try POST first
        try{
          const r = await fetch(WORKER_URL, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(payload),
          });
          if(r.ok) return await r.json();
        }catch(e){
          // ignore and fall back
        }

        // Fallback: GET params
        const u = new URL(WORKER_URL);
        u.searchParams.set("sheetId", SHEET_ID);
        u.searchParams.set("range", range);
        const r2 = await fetch(u.toString());
        if(!r2.ok){
          const text = await r2.text().catch(()=>"");
          throw new Error(`Worker request failed (${r2.status}). ${text}`.trim());
        }
        return await r2.json();
      }

      function splitHeaderAndRows(values, fallbackHeaders){
        const cleaned = (values || []).filter(rowHasAnyValue);
        if(!cleaned.length) return { headers: fallbackHeaders, rows: [] };

        if(USE_FIRST_ROW_AS_HEADER){
          const headers = cleaned[0].map((h,i)=> String(h ?? fallbackHeaders[i] ?? `Col ${i+1}`));
          return { headers, rows: cleaned.slice(1) };
        }
        return { headers: fallbackHeaders, rows: cleaned };
      }

      // Header-aware team chunking:
      // - First row of roster range is a header (labels)
      // - Remaining rows are grouped: team row + 4 player rows
      function chunkTeams(teamInfoValues, headerRow){
        const values = (teamInfoValues || []).filter(rowHasAnyValue);
        const headers = Array.isArray(headerRow) ? headerRow.map(h => String(h ?? "").trim()) : [];

        // Assumption: names are in column A (index 0)
        const nameCol = 0;

        function labelForCol(j){
          const h = headers[j];
          return (h && h.trim()) ? h.trim() : `Col ${j+1}`;
        }

        // OPTIONAL CHANGE APPLIED: no "Team:" / "Player:" prefixes — just header labels
        function extractStats(row){
          const stats = [];
          const r = row || [];
          for(let j=0; j<r.length; j++){
            if(j === nameCol) continue;
            const v = String(r[j] ?? "").trim();
            if(!v) continue;
            stats.push({ key: labelForCol(j), value: v });
          }
          return stats;
        }

        const teams = [];
        for(let i=0; i<values.length; i+=5){
          const teamRow = values[i] || [];
          const playerRows = [values[i+1], values[i+2], values[i+3], values[i+4]].filter(Boolean);

          const teamName =
            String(teamRow[nameCol] ?? "").trim() ||
            firstNonEmptyCell(teamRow) ||
            `Team ${Math.floor(i/5)+1}`;

          const teamStats = extractStats(teamRow);

          const players = playerRows.map((row, idx)=>{
            const playerName =
              String((row||[])[nameCol] ?? "").trim() ||
              firstNonEmptyCell(row) ||
              `Player ${idx+1}`;

            const stats = extractStats(row);
            return { name: playerName, stats };
          });

          teams.push({ teamName, teamStats, players });
        }

        return teams;
      }

      function el(tag, attrs={}, children=[]){
        const node = document.createElement(tag);
        for(const [k,v] of Object.entries(attrs)){
          if(k === "class") node.className = v;
          else if(k.startsWith("on") && typeof v === "function") node.addEventListener(k.slice(2).toLowerCase(), v);
          else node.setAttribute(k, v);
        }
        for(const ch of children){
          if(ch == null) continue;
          if(typeof ch === "string") node.appendChild(document.createTextNode(ch));
          else node.appendChild(ch);
        }
        return node;
      }

      function renderTable(headEl, bodyEl, headers, rows, highlightIdx=1, emptyText="No results."){
        headEl.innerHTML = "";
        bodyEl.innerHTML = "";

        headers.forEach(h => headEl.appendChild(el("th", {}, [String(h ?? "")])));

        if(!rows.length){
          bodyEl.appendChild(
            el("tr", {}, [
              el("td", { colspan: headers.length, class:"muted" }, [emptyText])
            ])
          );
          return;
        }

        rows.forEach((row, rIdx)=>{
          const tr = el("tr", { class: (rIdx < 3 ? "top3" : "") }, []);
          headers.forEach((_, cIdx)=>{
            const td = el("td", { class: (cIdx === highlightIdx ? "highlight" : "") }, [
              String(row?.[cIdx] ?? "").trim()
            ]);
            tr.appendChild(td);
          });
          bodyEl.appendChild(tr);
        });
      }

      function renderRosters(container, teams){
        container.innerHTML = "";
        teams.forEach(t=>{
          const teamCard = el("div", { class:"card team-card" }, [
            el("div", { class:"team-top" }, [
              el("div", {}, [
                el("div", { class:"section-kicker" }, ["Team"]),
                el("h3", {}, [t.teamName]),
              ]),
              el("div", { class:"live" }, [
                el("span", { class:"dot" }),
                el("span", {}, ["Live"]),
              ]),
            ]),
          ]);

          if(t.teamStats?.length){
            const statgrid = el("div", { class:"statgrid" }, []);
            t.teamStats.slice(0,4).forEach(s=>{
              statgrid.appendChild(
                el("div", { class:"statpill" }, [
                  el("div", { class:"l" }, [s.key]),
                  el("div", { class:"v" }, [s.value]),
                ])
              );
            });
            teamCard.appendChild(statgrid);
          }

          teamCard.appendChild(el("div", { style:"margin-top:16px" }, [
            el("div", { class:"section-kicker" }, ["Roster"])
          ]));

          const rosterGrid = el("div", { class:"rostergrid" }, []);
          t.players.forEach(p=>{
            const pc = el("div", { class:"player-card" }, [
              el("div", { class:"player-name" }, [p.name]),
            ]);

            if(p.stats?.length){
              const ps = el("div", { class:"player-stats" }, []);
              p.stats.slice(0,4).forEach(s=>{
                ps.appendChild(el("div", {}, [el("span", {}, [s.key + ": "]), s.value]));
              });
              pc.appendChild(ps);
            } else {
              pc.appendChild(el("div", { class:"muted3 small", style:"margin-top:6px" }, ["(No player stats found in this row.)"]));
            }
            rosterGrid.appendChild(pc);
          });

          teamCard.appendChild(rosterGrid);
          container.appendChild(teamCard);
        });
      }

      function setActiveTab(tab){
        document.querySelectorAll(".tabbtn").forEach(btn=>{
          const active = btn.dataset.tab === tab;
          btn.classList.toggle("active", active);
          btn.setAttribute("aria-selected", active ? "true" : "false");
        });

        document.getElementById("view-teams").classList.toggle("hidden", tab !== "teams");
        document.getElementById("view-players").classList.toggle("hidden", tab !== "players");
        document.getElementById("view-rosters").classList.toggle("hidden", tab !== "rosters");
      }

      // ==============================
      // App
      // ==============================
      const statusEl  = document.getElementById("status");
      const contentEl = document.getElementById("content");

      const teamCountEl = document.getElementById("teamCount");
      const playerCountEl = document.getElementById("playerCount");

      const teamHead = document.getElementById("teamHead");
      const teamBody = document.getElementById("teamBody");
      const playerHead = document.getElementById("playerHead");
      const playerBody = document.getElementById("playerBody");

      const teamSearch = document.getElementById("teamSearch");
      const playerSearch = document.getElementById("playerSearch");

      const rosterGrid = document.getElementById("rosterGrid");

      let rawTeamStandings = [];
      let rawPlayerStandings = [];
      let teams = [];

      // Remap team standings rows from sheet -> UI
      // Sheet columns (current): [Rank, (unused), TeamName(in Points), TeamScore(in Notes)]
      // UI columns (desired):   [Rank, Team, Points]
      function remapTeamStandingsRow(r){
        const rank = r?.[0] ?? "";
        const team = r?.[2] ?? "";   // points column
        const pts  = r?.[3] ?? "";   // notes column (score)
        return [rank, team, pts];
      }

      function applyFilters(){
        const tQ = teamSearch.value.trim().toLowerCase();
        const pQ = playerSearch.value.trim().toLowerCase();

        // Team standings: split then remap and drop Notes
        const tSplitRaw = splitHeaderAndRows(rawTeamStandings, ["Rank","(unused)","(team in points)","(score in notes)"]);
        const tMappedRows = tSplitRaw.rows.map(remapTeamStandingsRow);

        const tRows = tMappedRows.filter(r =>
          r.map(c => String(c ?? "").toLowerCase()).join(" ").includes(tQ)
        );

        // Player standings: unchanged
        const pSplit = splitHeaderAndRows(rawPlayerStandings, PLAYER_STANDINGS_HEADERS);
        const pRows = pSplit.rows.filter(r =>
          r.map(c => String(c ?? "").toLowerCase()).join(" ").includes(pQ)
        );

        renderTable(teamHead, teamBody, TEAM_STANDINGS_HEADERS, tRows, 1, "No teams found.");
        renderTable(playerHead, playerBody, pSplit.headers, pRows, 1, "No players found.");
      }

      document.querySelectorAll(".tabbtn").forEach(btn=>{
        btn.addEventListener("click", ()=> setActiveTab(btn.dataset.tab));
      });

      teamSearch.addEventListener("input", applyFilters);
      playerSearch.addEventListener("input", applyFilters);

      // boot
      (async function init(){
        try{
          statusEl.textContent = "Loading standings…";

          const [teamInfoResp, teamStResp, playerStResp] = await Promise.all([
            fetchRange(RANGES.teamInfo),
            fetchRange(RANGES.teamStandings),
            fetchRange(RANGES.playerStandings),
          ]);

          const teamInfoValues = normalizeValues(teamInfoResp);

          // Roster range has a header row:
          const rosterHeader = teamInfoValues?.length ? teamInfoValues[0] : [];
          const rosterData   = teamInfoValues?.length > 1 ? teamInfoValues.slice(1) : [];

          rawTeamStandings = normalizeValues(teamStResp);
          rawPlayerStandings = normalizeValues(playerStResp);

          teams = chunkTeams(rosterData, rosterHeader);

          teamCountEl.textContent = String(teams.length);
          playerCountEl.textContent = String(teams.length * 4);

          renderRosters(rosterGrid, teams);
          applyFilters();

          statusEl.classList.add("hidden");
          contentEl.classList.remove("hidden");
          setActiveTab("teams");
        }catch(err){
          statusEl.classList.remove("hidden");
          statusEl.classList.add("error");
          statusEl.innerHTML = `
            <b>Couldn’t load data</b>
            <div class="muted">${(err && err.message) ? err.message : "Failed to load standings."}</div>
            <div class="muted3 small" style="margin-top:10px;">
              Tip: your Worker might require a different request shape. Update <code>fetchRange()</code> in this file to match your existing site.
            </div>
          `;
          console.error(err);
        }
      })();
    </script>
  </body>
</html>
